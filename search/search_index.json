{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"ArtifactFlow","text":"<p>ArtifactFlow \u662f\u4e00\u4e2a\u57fa\u4e8e LangGraph \u6784\u5efa\u7684\u591a Agent \u534f\u4f5c\u6846\u67b6\uff0c\u91c7\u7528\u53cc Artifact \u67b6\u6784\u5b9e\u73b0\u590d\u6742\u4efb\u52a1\u7684\u89c4\u5212\u4e0e\u6267\u884c\u3002</p>"},{"location":"#\u8bbe\u8ba1\u7406\u5ff5","title":"\u8bbe\u8ba1\u7406\u5ff5","text":""},{"location":"#\u4e3a\u4ec0\u4e48\u9700\u8981\u591a-agent-\u534f\u4f5c","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u591a Agent \u534f\u4f5c\uff1f","text":"<p>\u5355\u4e00 LLM \u5728\u5904\u7406\u590d\u6742\u4efb\u52a1\u65f6\u9762\u4e34\u51e0\u4e2a\u6838\u5fc3\u6311\u6218\uff1a</p> <ul> <li>\u4e0a\u4e0b\u6587\u7a97\u53e3\u9650\u5236\uff1a\u957f\u7a0b\u4efb\u52a1\u5bb9\u6613\u4e22\u5931\u5173\u952e\u4fe1\u606f</li> <li>\u80fd\u529b\u8fb9\u754c\u6a21\u7cca\uff1a\u4e00\u4e2a prompt \u96be\u4ee5\u8986\u76d6\u6240\u6709\u4e13\u4e1a\u9886\u57df</li> <li>\u6267\u884c\u8fc7\u7a0b\u4e0d\u900f\u660e\uff1a\u7528\u6237\u96be\u4ee5\u5e72\u9884\u548c\u8c03\u6574\u6267\u884c\u65b9\u5411</li> </ul> <p>ArtifactFlow \u901a\u8fc7\u4e13\u4e1a\u5316\u5206\u5de5 + \u7ed3\u6784\u5316\u534f\u4f5c\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u3002</p>"},{"location":"#\u53cc-artifact-\u67b6\u6784","title":"\u53cc Artifact \u67b6\u6784","text":"<pre><code>flowchart BT\n    subgraph Agents[\"Agent System\"]\n        Lead[\"\ud83c\udfaf Lead Agent\"]\n        Search[\"\ud83d\udd0d Search Agent\"]\n        Crawl[\"\ud83c\udf10 Crawl Agent\"]\n    end\n\n    subgraph Artifacts[\"Artifacts\"]\n        TaskPlan[\"\ud83d\udccb Task Plan Artifact&lt;br/&gt;- \u4efb\u52a1\u5206\u89e3&lt;br/&gt;- \u8fdb\u5ea6\u8ffd\u8e2a&lt;br/&gt;- \u4f9d\u8d56\u5173\u7cfb\"]\n        Result[\"\ud83d\udcc4 Result Artifact&lt;br/&gt;- \u6267\u884c\u4ea7\u51fa&lt;br/&gt;- \u7248\u672c\u5386\u53f2&lt;br/&gt;- \u589e\u91cf\u66f4\u65b0\"]\n    end\n\n    Lead --&gt;|\u8bfb\u53d6/\u66f4\u65b0| TaskPlan\n    Lead --&gt;|\u5199\u5165| Result\n    Lead --&gt;|\u8c03\u5ea6| Search\n    Lead --&gt;|\u8c03\u5ea6| Crawl\n    Search --&gt;|\u8fd4\u56de\u7ed3\u679c| Lead\n    Crawl --&gt;|\u8fd4\u56de\u7ed3\u679c| Lead</code></pre> <p>Task Plan Artifact\uff1a\u8bb0\u5f55\u4efb\u52a1\u89c4\u5212\u3001\u5206\u89e3\u6b65\u9aa4\u3001\u5f53\u524d\u8fdb\u5ea6\uff0c\u786e\u4fdd\u957f\u7a0b\u4efb\u52a1\u4e0d\u4f1a\"\u8ff7\u8def\"</p> <p>Result Artifact\uff1a\u7d2f\u79ef\u6267\u884c\u4ea7\u51fa\uff0c\u652f\u6301\u7248\u672c\u8ffd\u6eaf\uff0c\u7528\u6237\u53ef\u968f\u65f6\u67e5\u770b\u4e2d\u95f4\u7ed3\u679c</p>"},{"location":"#\u6838\u5fc3\u4f18\u52bf","title":"\u6838\u5fc3\u4f18\u52bf","text":"\u7279\u6027 \u8bf4\u660e \u8ba1\u5212\u4e0e\u7ed3\u679c\u5206\u79bb \u4efb\u52a1\u89c4\u5212\u548c\u6267\u884c\u4ea7\u51fa\u72ec\u7acb\u7ba1\u7406\uff0c\u4e92\u4e0d\u5e72\u6270 \u53ef\u8ffd\u6eaf\u6027 Artifact \u7248\u672c\u5386\u53f2\u5b8c\u6574\u8bb0\u5f55\u6bcf\u6b21\u53d8\u66f4 \u4eba\u673a\u534f\u4f5c \u6743\u9650\u7cfb\u7edf\u652f\u6301\u5173\u952e\u64cd\u4f5c\u7684\u7528\u6237\u786e\u8ba4 \u6d41\u5f0f\u53cd\u9988 SSE \u5b9e\u65f6\u63a8\u9001\u6267\u884c\u72b6\u6001\uff0c\u524d\u7aef\u53ef\u5373\u65f6\u5c55\u793a \u53ef\u6269\u5c55 \u8f7b\u677e\u6dfb\u52a0\u65b0 Agent \u548c Tool \u5e94\u5bf9\u4e0d\u540c\u573a\u666f"},{"location":"#\u5e94\u7528\u573a\u666f","title":"\u5e94\u7528\u573a\u666f","text":"<p>ArtifactFlow \u662f\u4e00\u4e2a\u901a\u7528\u6846\u67b6\uff0c\u53ef\u9002\u914d\u591a\u79cd\u590d\u6742\u4efb\u52a1\u573a\u666f\uff1a</p> <ul> <li>\u4fe1\u606f\u68c0\u7d22\u4e0e\u6574\u5408\uff1a\u591a\u6e90\u641c\u7d22\u3001\u5185\u5bb9\u805a\u5408\u3001\u62a5\u544a\u751f\u6210</li> <li>\u6587\u6863\u64b0\u5199\uff1a\u5927\u7eb2\u89c4\u5212\u3001\u5206\u7ae0\u8282\u64b0\u5199\u3001\u8fed\u4ee3\u4fee\u8ba2</li> <li>\u4ee3\u7801\u4efb\u52a1\uff1a\u4ee3\u7801\u5ba1\u67e5\u3001\u91cd\u6784\u89c4\u5212\u3001\u591a\u6587\u4ef6\u4fee\u6539</li> <li>\u6570\u636e\u5206\u6790\uff1a\u6570\u636e\u91c7\u96c6\u3001\u6e05\u6d17\u3001\u5206\u6790\u3001\u53ef\u89c6\u5316</li> <li>\u5de5\u4f5c\u6d41\u81ea\u52a8\u5316\uff1a\u591a\u6b65\u9aa4\u4efb\u52a1\u7f16\u6392\u3001\u6761\u4ef6\u5206\u652f\u5904\u7406</li> </ul>"},{"location":"#\u6280\u672f\u6808","title":"\u6280\u672f\u6808","text":"\u7ec4\u4ef6 \u6280\u672f \u7528\u9014 \u7f16\u6392\u5f15\u64ce LangGraph \u591a Agent \u5de5\u4f5c\u6d41\u3001\u72b6\u6001\u7ba1\u7406\u3001\u65ad\u70b9\u6062\u590d API \u670d\u52a1 FastAPI REST API\u3001SSE \u6d41\u5f0f\u63a8\u9001 \u6570\u636e\u5b58\u50a8 SQLAlchemy + aiosqlite \u5bf9\u8bdd\u5386\u53f2\u3001Artifact \u6301\u4e45\u5316 LLM \u63a5\u53e3 LiteLLM \u7edf\u4e00\u63a5\u53e3\u652f\u6301 100+ \u6a21\u578b\u63d0\u4f9b\u5546 \u5185\u5bb9\u91c7\u96c6 crawl4ai \u7f51\u9875\u5185\u5bb9\u6293\u53d6\u4e0e\u89e3\u6790 \u524d\u7aef Next.js 15 / React 19 / Zustand / Tailwind CSS Web UI\u3001SSE \u6d41\u5f0f\u6e32\u67d3"},{"location":"#\u5feb\u901f\u5f00\u59cb","title":"\u5feb\u901f\u5f00\u59cb","text":"<pre><code># \u5b89\u88c5\u4f9d\u8d56\npip install -r requirements.txt\npip install -e .\n\n# \u521d\u59cb\u5316 crawl4ai\uff08\u9996\u6b21\u4f7f\u7528\u524d\u5fc5\u987b\uff09\ncrawl4ai-setup\n\n# \u8bbe\u7f6e JWT \u5bc6\u94a5\uff08\u5199\u5165 .env\uff0c\u5fc5\u987b\uff0c\u5426\u5219\u670d\u52a1\u65e0\u6cd5\u542f\u52a8\uff09\necho \"ARTIFACTFLOW_JWT_SECRET=$(python -c 'import secrets; print(secrets.token_urlsafe(32))')\" &gt;&gt; .env\n\n# \u521b\u5efa\u7ba1\u7406\u5458\u8d26\u53f7\uff08\u9996\u6b21\u4f7f\u7528\u524d\u5fc5\u987b\uff09\npython scripts/create_admin.py admin\n\n# \u542f\u52a8 API \u670d\u52a1\npython run_server.py\n\n# CLI \u4ea4\u4e92\uff08\u9996\u6b21\u9700\u8981\u767b\u5f55\uff09\npython run_cli.py login\npython run_cli.py chat\n</code></pre>"},{"location":"#\u6587\u6863\u5bfc\u822a","title":"\u6587\u6863\u5bfc\u822a","text":"<ul> <li>Frontend Guide - \u524d\u7aef\u67b6\u6784\u3001\u6587\u4ef6\u8be6\u89e3\u4e0e\u6570\u636e\u6d41</li> <li>Request Lifecycle - \u7406\u89e3\u4e00\u4e2a\u8bf7\u6c42\u7684\u5b8c\u6574\u751f\u547d\u5468\u671f</li> <li>Architecture - \u6df1\u5165\u4e86\u89e3\u5404\u6a21\u5757\u5b9e\u73b0</li> <li>Concurrency - \u5e76\u53d1\u6a21\u578b\u3001\u5df2\u77e5\u5c40\u9650\u4e0e\u6f14\u8fdb\u8def\u7ebf</li> <li>Streaming - \u6d41\u5f0f\u4e8b\u4ef6\u7cfb\u7edf\u8be6\u89e3</li> <li>Extension Guide - \u5982\u4f55\u6269\u5c55 Agent \u548c Tool</li> <li>API Reference - \u524d\u7aef\u96c6\u6210\u63a5\u53e3\u6587\u6863</li> <li>FAQ - \u5e38\u89c1\u95ee\u9898\u4e0e\u6392\u67e5</li> </ul>"},{"location":"api/","title":"API Reference","text":"<p>ArtifactFlow API \u6587\u6863\uff0c\u4f9b\u524d\u7aef\u96c6\u6210\u4f7f\u7528\u3002</p> <p>\u6ce8\u610f\uff1a \u4fee\u6539 <code>src/api/schemas/</code> \u4e0b\u7684 Pydantic model \u540e\uff0c\u9700\u8981\u540c\u6b65\u66f4\u65b0\u524d\u7aef TypeScript \u7c7b\u578b\u3002\u8be6\u89c1 frontend/README.md \u2014 API \u7c7b\u578b\u540c\u6b65\u3002</p>"},{"location":"api/#\u57fa\u7840\u4fe1\u606f","title":"\u57fa\u7840\u4fe1\u606f","text":"\u9879\u76ee \u503c Base URL <code>http://localhost:8000/api/v1</code> \u534f\u8bae HTTP/HTTPS \u6570\u636e\u683c\u5f0f JSON \u6d41\u5f0f\u63a8\u9001 Server-Sent Events (SSE) \u8ba4\u8bc1\u65b9\u5f0f Bearer Token (JWT)"},{"location":"api/#\u8ba4\u8bc1","title":"\u8ba4\u8bc1","text":"<p>\u6240\u6709 API \u7aef\u70b9\uff08\u9664 <code>/health</code> \u548c <code>/auth/login</code>\uff09\u5747\u9700\u8981 JWT \u8ba4\u8bc1\u3002</p>"},{"location":"api/#\u83b7\u53d6-token","title":"\u83b7\u53d6 Token","text":"<pre><code>POST /auth/login\n</code></pre> <pre><code>{\n  \"username\": \"admin\",\n  \"password\": \"your_password\"\n}\n</code></pre> <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"access_token\": \"eyJhbGciOiJIUzI1NiJ9...\",\n  \"token_type\": \"bearer\",\n  \"expires_in\": 604800,\n  \"user\": {\n    \"id\": \"user-xxx\",\n    \"username\": \"admin\",\n    \"display_name\": \"admin\",\n    \"role\": \"admin\"\n  }\n}\n</code></pre>"},{"location":"api/#\u4f7f\u7528-token","title":"\u4f7f\u7528 Token","text":"<p>\u6240\u6709\u540e\u7eed\u8bf7\u6c42\u9700\u643a\u5e26 <code>Authorization</code> header\uff1a</p> <pre><code>Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...\n</code></pre> <p>\u672a\u643a\u5e26\u6216 token \u8fc7\u671f\u8fd4\u56de <code>401 Unauthorized</code>\u3002\u8bbf\u95ee\u5176\u4ed6\u7528\u6237\u7684\u8d44\u6e90\u8fd4\u56de <code>404 Not Found</code>\uff08\u4e0d\u66b4\u9732\u5b58\u5728\u6027\uff09\u3002</p>"},{"location":"api/#\u7528\u6237\u7ba1\u7406\u4ec5-admin","title":"\u7528\u6237\u7ba1\u7406\uff08\u4ec5 Admin\uff09","text":"\u65b9\u6cd5 \u8def\u5f84 \u8bf4\u660e GET <code>/auth/me</code> \u5f53\u524d\u7528\u6237\u4fe1\u606f POST <code>/auth/users</code> \u521b\u5efa\u7528\u6237 GET <code>/auth/users</code> \u7528\u6237\u5217\u8868 PUT <code>/auth/users/{id}</code> \u66f4\u65b0/\u7981\u7528\u7528\u6237"},{"location":"api/#\u5feb\u901f\u5f00\u59cb","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"api/#\u5178\u578b\u8c03\u7528\u6d41\u7a0b","title":"\u5178\u578b\u8c03\u7528\u6d41\u7a0b","text":"<p>\u6b64\u56fe\u4e3a\u524d\u7aef\u96c6\u6210\u89c6\u89d2\u7684\u7b80\u5316\u7248\uff0c\u5b8c\u6574\u7684\u5185\u90e8\u6d41\u7a0b\u89c1 Request Lifecycle \u2014 \u6574\u4f53\u6d41\u7a0b\u3002</p> <pre><code>sequenceDiagram\n    participant Frontend\n    participant API\n\n    Frontend-&gt;&gt;API: POST /chat {content}\n    API-&gt;&gt;Frontend: {conversation_id, thread_id, message_id, stream_url}\n\n    Frontend-&gt;&gt;API: GET /stream/{thread_id}\n    loop SSE Events\n        API-&gt;&gt;Frontend: event: llm_chunk + data: {...}\n        API-&gt;&gt;Frontend: event: tool_complete + data: {...}\n    end\n    API-&gt;&gt;Frontend: event: complete + data: {...}\n\n    Frontend-&gt;&gt;API: GET /chat/{conversation_id}\n    API-&gt;&gt;Frontend: \u5bf9\u8bdd\u8be6\u60c5</code></pre>"},{"location":"api/#chat-api","title":"Chat API","text":""},{"location":"api/#\u53d1\u9001\u6d88\u606f","title":"\u53d1\u9001\u6d88\u606f","text":"<pre><code>POST /chat\n</code></pre> <p>\u8bf7\u6c42\u4f53\uff1a</p> <pre><code>{\n  \"content\": \"\u5e2e\u6211\u5206\u6790\u4e00\u4e0b Python \u5f02\u6b65\u7f16\u7a0b\",\n  \"conversation_id\": null,\n  \"parent_message_id\": null\n}\n</code></pre> \u5b57\u6bb5 \u7c7b\u578b \u5fc5\u9700 \u8bf4\u660e <code>content</code> string \u662f \u7528\u6237\u6d88\u606f\u5185\u5bb9 <code>conversation_id</code> string \u5426 \u5bf9\u8bdd ID\uff0cnull \u5219\u521b\u5efa\u65b0\u5bf9\u8bdd <code>parent_message_id</code> string | null \u5426 \u7236\u6d88\u606f ID\uff0c\u7528\u4e8e\u5206\u652f\u5bf9\u8bdd\u3002\u663e\u5f0f\u4f20 <code>null</code> \u521b\u5efa\u65b0\u7684\u6839\u6d88\u606f\uff1b\u4e0d\u4f20\u5219\u81ea\u52a8\u8ffd\u52a0\u5230\u5f53\u524d\u6d3b\u8dc3\u5206\u652f <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"conversation_id\": \"conv-550e8400e29b41d4a716446655440000\",\n  \"message_id\": \"msg-770e8400e29b41d4a716446655440002\",\n  \"thread_id\": \"thd-660e8400e29b41d4a716446655440001\",\n  \"stream_url\": \"/api/v1/stream/thd-660e8400e29b41d4a716446655440001\"\n}\n</code></pre> <p>\u8bf4\u660e\uff1a \u8bf7\u6c42\u7acb\u5373\u8fd4\u56de\uff0c\u5b9e\u9645\u6267\u884c\u5728\u540e\u53f0\u8fdb\u884c\u3002\u4f7f\u7528 <code>stream_url</code> \u8fde\u63a5 SSE \u83b7\u53d6\u6267\u884c\u4e8b\u4ef6\u3002</p>"},{"location":"api/#\u83b7\u53d6\u5bf9\u8bdd\u5217\u8868","title":"\u83b7\u53d6\u5bf9\u8bdd\u5217\u8868","text":"<pre><code>GET /chat\n</code></pre> <p>\u67e5\u8be2\u53c2\u6570\uff1a</p> \u53c2\u6570 \u7c7b\u578b \u9ed8\u8ba4\u503c \u8bf4\u660e <code>limit</code> int 20 \u8fd4\u56de\u6570\u91cf <code>offset</code> int 0 \u504f\u79fb\u91cf <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"conversations\": [\n    {\n      \"id\": \"conv-550e8400e29b41d4a716446655440000\",\n      \"title\": \"Python \u5f02\u6b65\u7f16\u7a0b\u5206\u6790\",\n      \"message_count\": 5,\n      \"created_at\": \"2024-01-15T10:30:00Z\",\n      \"updated_at\": \"2024-01-15T11:00:00Z\"\n    }\n  ],\n  \"total\": 42,\n  \"has_more\": true\n}\n</code></pre>"},{"location":"api/#\u83b7\u53d6\u5bf9\u8bdd\u8be6\u60c5","title":"\u83b7\u53d6\u5bf9\u8bdd\u8be6\u60c5","text":"<pre><code>GET /chat/{conversation_id}\n</code></pre> <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"id\": \"conv-550e8400e29b41d4a716446655440000\",\n  \"title\": \"Python \u5f02\u6b65\u7f16\u7a0b\u5206\u6790\",\n  \"active_branch\": \"msg-002\",\n  \"messages\": [\n    {\n      \"id\": \"msg-001\",\n      \"parent_id\": null,\n      \"content\": \"\u5e2e\u6211\u5206\u6790\u4e00\u4e0b Python \u5f02\u6b65\u7f16\u7a0b\",\n      \"response\": \"\u597d\u7684\uff0c\u8ba9\u6211\u6765\u5206\u6790...\",\n      \"created_at\": \"2024-01-15T10:30:00Z\",\n      \"children\": [\"msg-002\"]\n    },\n    {\n      \"id\": \"msg-002\",\n      \"parent_id\": \"msg-001\",\n      \"content\": \"\u80fd\u8be6\u7ec6\u8bf4\u8bf4 asyncio \u5417\uff1f\",\n      \"response\": \"asyncio \u662f...\",\n      \"created_at\": \"2024-01-15T10:35:00Z\",\n      \"children\": []\n    }\n  ],\n  \"session_id\": \"conv-550e8400e29b41d4a716446655440000\",\n  \"created_at\": \"2024-01-15T10:30:00Z\",\n  \"updated_at\": \"2024-01-15T10:35:00Z\"\n}\n</code></pre> <p>\u8bf4\u660e\uff1a <code>messages</code> \u662f\u6241\u5e73\u6570\u7ec4\uff0c\u901a\u8fc7 <code>parent_id</code> \u548c <code>children</code> \u6784\u5efa\u6811\u72b6\u7ed3\u6784\u3002<code>session_id</code> \u4e0e <code>conversation_id</code> \u76f8\u540c\u3002</p>"},{"location":"api/#\u5220\u9664\u5bf9\u8bdd","title":"\u5220\u9664\u5bf9\u8bdd","text":"<pre><code>DELETE /chat/{conversation_id}\n</code></pre> <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"success\": true,\n  \"message\": \"Conversation 'conv-xxx' deleted\"\n}\n</code></pre>"},{"location":"api/#\u6062\u590d\u6743\u9650\u4e2d\u65ad","title":"\u6062\u590d\u6743\u9650\u4e2d\u65ad","text":"<p>\u5f53\u5de5\u5177\u9700\u8981\u7528\u6237\u786e\u8ba4\u65f6\u4f7f\u7528\uff1a</p> <pre><code>POST /chat/{conversation_id}/resume\n</code></pre> <p>\u8bf7\u6c42\u4f53\uff1a</p> <pre><code>{\n  \"thread_id\": \"thd-660e8400e29b41d4a716446655440001\",\n  \"message_id\": \"msg-770e8400e29b41d4a716446655440002\",\n  \"approved\": true\n}\n</code></pre> \u5b57\u6bb5 \u7c7b\u578b \u5fc5\u9700 \u8bf4\u660e <code>thread_id</code> string \u662f \u4e2d\u65ad\u65f6\u7684 thread_id <code>message_id</code> string \u662f \u8981\u66f4\u65b0\u7684\u6d88\u606f ID <code>approved</code> boolean \u662f \u662f\u5426\u6279\u51c6\u6267\u884c <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"stream_url\": \"/api/v1/stream/thd-660e8400e29b41d4a716446655440001\"\n}\n</code></pre> <p>\u8bf4\u660e\uff1a \u8fd4\u56de\u65b0\u7684 SSE \u7aef\u70b9 URL\uff0c\u524d\u7aef\u9700\u91cd\u65b0\u8fde\u63a5\u4ee5\u63a5\u6536\u540e\u7eed\u4e8b\u4ef6\u3002</p>"},{"location":"api/#stream-api","title":"Stream API","text":""},{"location":"api/#sse-\u4e8b\u4ef6\u6d41","title":"SSE \u4e8b\u4ef6\u6d41","text":"<pre><code>GET /stream/{thread_id}\n</code></pre> <p>\u8fde\u63a5\u65b9\u5f0f\uff1a</p> <p>SSE \u7aef\u70b9\u9700\u8981\u8ba4\u8bc1\uff0c\u5fc5\u987b\u4f7f\u7528 <code>fetch</code>\uff08\u800c\u975e <code>EventSource</code>\uff09\u4ee5\u643a\u5e26 <code>Authorization</code> header\uff1a</p> <pre><code>const token = localStorage.getItem('af_token');\nconst res = await fetch('/api/v1/stream/{thread_id}', {\n  headers: {\n    Accept: 'text/event-stream',\n    Authorization: `Bearer ${token}`,\n  },\n});\n// \u7528 ReadableStream \u89e3\u6790 SSE \u4e8b\u4ef6\u6d41\n</code></pre> <p>\u4e8b\u4ef6\u683c\u5f0f\u8bf4\u660e\uff1a</p> <p>\u4f7f\u7528\u6807\u51c6 SSE <code>event:</code> \u5b57\u6bb5\u533a\u5206\u4e8b\u4ef6\u7c7b\u578b\uff0c<code>data:</code> JSON \u5185\u540c\u65f6\u4fdd\u7559 <code>type</code> \u5b57\u6bb5\uff1a</p> <pre><code>event: event_type\ndata: {\"type\":\"event_type\",\"timestamp\":\"...\",\"agent\":\"...\",\"data\":{...}}\n</code></pre> <p>\u524d\u7aef\u4f7f\u7528 <code>fetch + ReadableStream</code> \u9010\u884c\u89e3\u6790 SSE\uff0c\u6309 <code>event:</code> \u5b57\u6bb5\u5206\u53d1\u5904\u7406\u3002</p> <p>\u4e8b\u4ef6\u7c7b\u578b\uff1a</p>"},{"location":"api/#metadata","title":"metadata","text":"<p>\u6267\u884c\u5f00\u59cb\uff0c\u8fd4\u56de\u5143\u6570\u636e\u3002</p> <pre><code>{\n  \"type\": \"metadata\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"data\": {\n    \"conversation_id\": \"conv-xxx\",\n    \"thread_id\": \"thd-yyy\",\n    \"message_id\": \"msg-zzz\"\n  }\n}\n</code></pre>"},{"location":"api/#agent_start","title":"agent_start","text":"<p>Agent \u5f00\u59cb\u6267\u884c\u3002</p> <pre><code>{\n  \"type\": \"agent_start\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"lead_agent\"\n}\n</code></pre>"},{"location":"api/#llm_chunk","title":"llm_chunk","text":"<p>LLM \u6d41\u5f0f\u8f93\u51fa\u7247\u6bb5\u3002</p> <p>\u6ce8\u610f\uff1a <code>content</code> \u662f\u7d2f\u79ef\u7684\u5185\u5bb9\uff08\u4ece\u672c\u8f6e LLM \u8c03\u7528\u5f00\u59cb\u5230\u5f53\u524d\u7684\u6240\u6709\u8f93\u51fa\uff09\uff0c\u800c\u975e\u589e\u91cf delta\u3002\u524d\u7aef\u5982\u9700\u589e\u91cf\u663e\u793a\uff0c\u5e94\u81ea\u884c\u8ba1\u7b97\u5dee\u503c\u3002</p> <pre><code>{\n  \"type\": \"llm_chunk\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"lead_agent\",\n  \"data\": {\n    \"success\": true,\n    \"content\": \"\u8ba9\u6211\u6765\u5206\u6790\",\n    \"reasoning_content\": null,\n    \"metadata\": {\n      \"agent\": \"lead_agent\",\n      \"model\": \"qwen3-next-80b-thinking\",\n      \"started_at\": \"2024-01-15T10:30:00.000Z\"\n    },\n    \"routing\": null,\n    \"token_usage\": null\n  }\n}\n</code></pre> \u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e <code>content</code> string \u7d2f\u79ef\u7684 LLM \u8f93\u51fa\u5185\u5bb9 <code>reasoning_content</code> string|null \u63a8\u7406\u5185\u5bb9\uff08\u5982\u4f7f\u7528 extended thinking\uff09 <code>metadata</code> object Agent \u5143\u6570\u636e <code>routing</code> object|null \u8def\u7531\u4fe1\u606f\uff08\u4ec5\u5728\u89e3\u6790\u51fa\u5de5\u5177\u8c03\u7528\u65f6\u6709\u503c\uff09 <code>token_usage</code> object|null Token \u7edf\u8ba1\uff08\u4ec5\u5728 LLM \u5b8c\u6210\u540e\u6709\u503c\uff09"},{"location":"api/#llm_complete","title":"llm_complete","text":"<p>LLM \u5355\u6b21\u8c03\u7528\u5b8c\u6210\uff08\u6d41\u5f0f\u7ed3\u675f\uff09\u3002</p> <pre><code>{\n  \"type\": \"llm_complete\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"lead_agent\",\n  \"data\": {\n    \"success\": true,\n    \"content\": \"\u5b8c\u6574\u7684\u8f93\u51fa\u5185\u5bb9...\",\n    \"reasoning_content\": null,\n    \"metadata\": {\n      \"agent\": \"lead_agent\",\n      \"model\": \"qwen3-next-80b-thinking\",\n      \"started_at\": \"2024-01-15T10:30:00.000Z\"\n    },\n    \"routing\": null,\n    \"token_usage\": {\n      \"input_tokens\": 1000,\n      \"output_tokens\": 500\n    }\n  }\n}\n</code></pre> <p>\u8bf4\u660e\uff1a \u6b64\u65f6 <code>token_usage</code> \u5df2\u586b\u5145\uff0c\u540e\u7eed <code>agent_complete</code> \u4e8b\u4ef6\u4f1a\u643a\u5e26\u5b8c\u6574\u7684\u8def\u7531\u4fe1\u606f\u3002</p>"},{"location":"api/#agent_complete","title":"agent_complete","text":"<p>Agent \u5355\u8f6e\u6267\u884c\u5b8c\u6210\uff08\u53ef\u80fd\u643a\u5e26\u5de5\u5177\u8c03\u7528\u8def\u7531\uff09\u3002</p> <pre><code>{\n  \"type\": \"agent_complete\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"lead_agent\",\n  \"data\": {\n    \"success\": true,\n    \"content\": \"Agent \u7684\u5b8c\u6574\u54cd\u5e94\u5185\u5bb9\",\n    \"reasoning_content\": null,\n    \"metadata\": {\n      \"agent\": \"lead_agent\",\n      \"model\": \"qwen3-next-80b-thinking\",\n      \"started_at\": \"2024-01-15T10:30:00.000Z\"\n    },\n    \"routing\": {\n      \"type\": \"tool_call\",\n      \"tool_name\": \"web_search\",\n      \"params\": {\"query\": \"...\"}\n    },\n    \"token_usage\": {\n      \"input_tokens\": 1000,\n      \"output_tokens\": 500\n    }\n  }\n}\n</code></pre> \u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e <code>content</code> string Agent \u7684\u5b8c\u6574\u8f93\u51fa\u5185\u5bb9 <code>routing</code> object|null \u8def\u7531\u4fe1\u606f\uff1a<code>null</code> \u8868\u793a\u5b8c\u6210\uff0c\u5426\u5219\u5305\u542b\u5de5\u5177\u8c03\u7528\u6216\u5b50 agent \u8c03\u7528 <code>routing.type</code> string <code>\"tool_call\"</code> \u6216 <code>\"subagent\"</code> <code>routing.tool_name</code> string \u5de5\u5177\u540d\u79f0\uff08tool_call \u65f6\uff09 <code>routing.target</code> string \u5b50 agent \u540d\u79f0\uff08subagent \u65f6\uff09"},{"location":"api/#tool_start","title":"tool_start","text":"<p>\u5de5\u5177\u5f00\u59cb\u6267\u884c\u3002</p> <pre><code>{\n  \"type\": \"tool_start\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"search_agent\",\n  \"tool\": \"web_search\",\n  \"data\": {\n    \"params\": {\n      \"query\": \"Python async programming\"\n    }\n  }\n}\n</code></pre>"},{"location":"api/#tool_complete","title":"tool_complete","text":"<p>\u5de5\u5177\u6267\u884c\u5b8c\u6210\u3002\u5305\u542b\u5de5\u5177\u8c03\u7528\u53c2\u6570\u548c\u8fd4\u56de\u6570\u636e\uff0c\u524d\u7aef\u53ef\u7528\u4e8e\u8ffd\u8e2a\u5de5\u5177\u6267\u884c\u8be6\u60c5\uff08\u5982 Artifact \u64cd\u4f5c\u7684 <code>params.id</code>\uff09\u3002</p> <pre><code>{\n  \"type\": \"tool_complete\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"search_agent\",\n  \"tool\": \"web_search\",\n  \"data\": {\n    \"success\": true,\n    \"duration_ms\": 1234,\n    \"error\": null,\n    \"params\": {\n      \"query\": \"Python async programming\"\n    },\n    \"result_data\": \"&lt;search_results&gt;...&lt;/search_results&gt;\"\n  }\n}\n</code></pre> \u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e <code>success</code> boolean \u5de5\u5177\u662f\u5426\u6267\u884c\u6210\u529f <code>duration_ms</code> int \u5de5\u5177\u6267\u884c\u8017\u65f6\uff08\u6beb\u79d2\uff09 <code>error</code> string|null \u9519\u8bef\u4fe1\u606f\uff08\u5931\u8d25\u65f6\uff09 <code>params</code> object \u5de5\u5177\u8c03\u7528\u53c2\u6570\uff08\u4e0e <code>tool_start</code> \u4e2d\u7684 <code>params</code> \u76f8\u540c\uff09 <code>result_data</code> any|null \u5de5\u5177\u8fd4\u56de\u7684\u4e1a\u52a1\u6570\u636e\uff08\u6210\u529f\u65f6\uff09\uff0c\u5931\u8d25\u65f6\u4e3a <code>null</code> <p><code>result_data</code> \u793a\u4f8b\uff08\u6309\u5de5\u5177\u7c7b\u578b\uff09\uff1a</p> \u5de5\u5177 result_data <code>web_search</code> XML \u5b57\u7b26\u4e32\uff08\u641c\u7d22\u7ed3\u679c\uff09 <code>web_fetch</code> XML \u5b57\u7b26\u4e32\uff08\u6293\u53d6\u5185\u5bb9\uff09 <code>create_artifact</code> <code>{\"message\": \"Created artifact 'plan'\"}</code> <code>update_artifact</code> <code>{\"message\": \"...\", \"version\": 2}</code> <code>rewrite_artifact</code> <code>{\"message\": \"...\", \"version\": 3}</code>"},{"location":"api/#permission_request","title":"permission_request","text":"<p>\u8bf7\u6c42\u7528\u6237\u786e\u8ba4\u6743\u9650\u3002</p> <pre><code>{\n  \"type\": \"permission_request\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"crawl_agent\",\n  \"tool\": \"read_file\",\n  \"data\": {\n    \"permission_level\": \"confirm\",\n    \"params\": {\n      \"path\": \"/etc/config\"\n    }\n  }\n}\n</code></pre> <p>\u5904\u7406\u65b9\u5f0f\uff1a \u663e\u793a\u786e\u8ba4\u5bf9\u8bdd\u6846\uff0c\u7528\u6237\u786e\u8ba4\u540e\u8c03\u7528 <code>POST /chat/{id}/resume</code>\u3002</p>"},{"location":"api/#permission_result","title":"permission_result","text":"<p>\u6743\u9650\u786e\u8ba4\u7ed3\u679c\u3002</p> <pre><code>{\n  \"type\": \"permission_result\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"agent\": \"crawl_agent\",\n  \"tool\": \"read_file\",\n  \"data\": {\n    \"approved\": true\n  }\n}\n</code></pre>"},{"location":"api/#complete","title":"complete","text":"<p>\u6267\u884c\u5b8c\u6210\uff08\u6b63\u5e38\u5b8c\u6210\u6216\u6743\u9650\u4e2d\u65ad\uff09\u3002</p> <pre><code>{\n  \"type\": \"complete\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"data\": {\n    \"success\": true,\n    \"interrupted\": false,\n    \"conversation_id\": \"conv-xxx\",\n    \"message_id\": \"msg-yyy\",\n    \"thread_id\": \"thd-zzz\",\n    \"response\": \"\u6700\u7ec8\u54cd\u5e94\u5185\u5bb9\",\n    \"execution_metrics\": {\n      \"started_at\": \"2024-01-15T10:30:00.000Z\",\n      \"completed_at\": \"2024-01-15T10:30:05.000Z\",\n      \"total_duration_ms\": 5000,\n      \"agent_executions\": [...],\n      \"tool_calls\": [...]\n    }\n  }\n}\n</code></pre> \u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e <code>success</code> boolean \u6267\u884c\u662f\u5426\u6210\u529f <code>interrupted</code> boolean \u662f\u5426\u56e0\u6743\u9650\u4e2d\u65ad\uff08\u9700\u8981\u7528\u6237\u786e\u8ba4\uff09 <code>conversation_id</code> string \u5bf9\u8bdd ID <code>message_id</code> string \u6d88\u606f ID <code>thread_id</code> string LangGraph \u7ebf\u7a0b ID <code>response</code> string \u6700\u7ec8\u54cd\u5e94\u5185\u5bb9\uff08<code>interrupted=false</code> \u65f6\uff09 <code>interrupt_type</code> string \u4e2d\u65ad\u7c7b\u578b\uff08<code>interrupted=true</code> \u65f6\uff09 <code>interrupt_data</code> object \u4e2d\u65ad\u6570\u636e\uff08<code>interrupted=true</code> \u65f6\uff09 <code>execution_metrics</code> object \u6267\u884c\u6307\u6807 <p>\u6743\u9650\u4e2d\u65ad\u65f6\u7684\u54cd\u5e94\u793a\u4f8b\uff1a</p> <pre><code>{\n  \"type\": \"complete\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"data\": {\n    \"success\": true,\n    \"interrupted\": true,\n    \"conversation_id\": \"conv-xxx\",\n    \"message_id\": \"msg-yyy\",\n    \"thread_id\": \"thd-zzz\",\n    \"interrupt_type\": \"tool_permission\",\n    \"interrupt_data\": {\n      \"type\": \"tool_permission\",\n      \"tool_name\": \"read_file\",\n      \"params\": {\"path\": \"/etc/config\"},\n      \"permission_level\": \"confirm\",\n      \"message\": \"Tool 'read_file' requires confirm permission\"\n    },\n    \"execution_metrics\": {...}\n  }\n}\n</code></pre> <p>\u5904\u7406\u65b9\u5f0f\uff1a \u5f53 <code>interrupted=true</code> \u65f6\uff0c\u524d\u7aef\u5e94\u663e\u793a\u786e\u8ba4\u5bf9\u8bdd\u6846\uff0c\u7528\u6237\u786e\u8ba4\u540e\u8c03\u7528 <code>POST /chat/{id}/resume</code>\u3002</p>"},{"location":"api/#error","title":"error","text":"<p>\u6267\u884c\u9519\u8bef\u3002</p> <pre><code>{\n  \"type\": \"error\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"data\": {\n    \"success\": false,\n    \"conversation_id\": \"conv-xxx\",\n    \"message_id\": \"msg-yyy\",\n    \"thread_id\": \"thd-zzz\",\n    \"error\": \"\u9519\u8bef\u4fe1\u606f\"\n  }\n}\n</code></pre> \u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e <code>success</code> boolean \u59cb\u7ec8\u4e3a <code>false</code> <code>conversation_id</code> string \u5bf9\u8bdd ID <code>message_id</code> string \u6d88\u606f ID <code>thread_id</code> string LangGraph \u7ebf\u7a0b ID <code>error</code> string \u9519\u8bef\u4fe1\u606f"},{"location":"api/#artifact-api","title":"Artifact API","text":"<p>\u8bf4\u660e\uff1a Artifact \u4f7f\u7528 <code>(session_id, artifact_id)</code> \u590d\u5408\u952e\u6807\u8bc6\u3002<code>session_id</code> \u4e0e <code>conversation_id</code> \u76f8\u540c\u3002</p>"},{"location":"api/#\u83b7\u53d6-artifact-\u5217\u8868","title":"\u83b7\u53d6 Artifact \u5217\u8868","text":"<pre><code>GET /artifacts/{session_id}\n</code></pre> <p>\u8def\u5f84\u53c2\u6570\uff1a</p> \u53c2\u6570 \u7c7b\u578b \u8bf4\u660e <code>session_id</code> string \u4f1a\u8bdd ID\uff08\u4e0e conversation_id \u76f8\u540c\uff09 <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"session_id\": \"conv-550e8400e29b41d4a716446655440000\",\n  \"artifacts\": [\n    {\n      \"id\": \"task_plan\",\n      \"content_type\": \"markdown\",\n      \"title\": \"\u4efb\u52a1\u8ba1\u5212\",\n      \"current_version\": 3,\n      \"created_at\": \"2024-01-15T10:30:00Z\",\n      \"updated_at\": \"2024-01-15T11:00:00Z\"\n    }\n  ]\n}\n</code></pre>"},{"location":"api/#\u83b7\u53d6-artifact-\u8be6\u60c5","title":"\u83b7\u53d6 Artifact \u8be6\u60c5","text":"<pre><code>GET /artifacts/{session_id}/{artifact_id}\n</code></pre> <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"id\": \"task_plan\",\n  \"session_id\": \"conv-550e8400e29b41d4a716446655440000\",\n  \"content_type\": \"markdown\",\n  \"title\": \"\u4efb\u52a1\u8ba1\u5212\",\n  \"content\": \"# \u4efb\u52a1\u8ba1\u5212\\n\\n## \u6b65\u9aa4 1\\n...\",\n  \"current_version\": 3,\n  \"created_at\": \"2024-01-15T10:30:00Z\",\n  \"updated_at\": \"2024-01-15T11:00:00Z\"\n}\n</code></pre>"},{"location":"api/#\u83b7\u53d6\u7248\u672c\u5386\u53f2","title":"\u83b7\u53d6\u7248\u672c\u5386\u53f2","text":"<pre><code>GET /artifacts/{session_id}/{artifact_id}/versions\n</code></pre> <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"artifact_id\": \"task_plan\",\n  \"session_id\": \"conv-550e8400e29b41d4a716446655440000\",\n  \"versions\": [\n    {\n      \"version\": 3,\n      \"update_type\": \"update\",\n      \"created_at\": \"2024-01-15T11:00:00Z\"\n    },\n    {\n      \"version\": 2,\n      \"update_type\": \"update\",\n      \"created_at\": \"2024-01-15T10:45:00Z\"\n    },\n    {\n      \"version\": 1,\n      \"update_type\": \"create\",\n      \"created_at\": \"2024-01-15T10:30:00Z\"\n    }\n  ]\n}\n</code></pre>"},{"location":"api/#\u83b7\u53d6\u7279\u5b9a\u7248\u672c","title":"\u83b7\u53d6\u7279\u5b9a\u7248\u672c","text":"<pre><code>GET /artifacts/{session_id}/{artifact_id}/versions/{version}\n</code></pre> <p>\u54cd\u5e94\uff1a</p> <pre><code>{\n  \"version\": 2,\n  \"content\": \"\u7b2c\u4e8c\u7248\u5185\u5bb9...\",\n  \"update_type\": \"update\",\n  \"changes\": [[\"\u65e7\u5185\u5bb9\", \"\u65b0\u5185\u5bb9\"]],\n  \"created_at\": \"2024-01-15T10:45:00Z\"\n}\n</code></pre>"},{"location":"api/#\u9519\u8bef\u5904\u7406","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"api/#\u9519\u8bef\u54cd\u5e94\u683c\u5f0f","title":"\u9519\u8bef\u54cd\u5e94\u683c\u5f0f","text":"<p>\u4f7f\u7528 FastAPI \u9ed8\u8ba4\u683c\u5f0f\uff1a</p> <pre><code>{\n  \"detail\": \"Invalid username or password\"\n}\n</code></pre> <p>\u9a8c\u8bc1\u9519\u8bef\uff08422\uff09\u4f7f\u7528 Pydantic \u683c\u5f0f\uff1a</p> <pre><code>{\n  \"detail\": [\n    {\n      \"loc\": [\"body\", \"content\"],\n      \"msg\": \"Field required\",\n      \"type\": \"missing\"\n    }\n  ]\n}\n</code></pre>"},{"location":"api/#\u5e38\u89c1\u9519\u8bef\u72b6\u6001\u7801","title":"\u5e38\u89c1\u9519\u8bef\u72b6\u6001\u7801","text":"HTTP \u72b6\u6001 \u573a\u666f 401 \u672a\u8ba4\u8bc1\u6216 token \u8fc7\u671f 403 \u6743\u9650\u4e0d\u8db3\uff08\u5982\u975e Admin \u8bbf\u95ee\u7ba1\u7406\u7aef\u70b9\uff09 404 \u8d44\u6e90\u4e0d\u5b58\u5728\uff08\u6216\u65e0\u6743\u8bbf\u95ee\uff0c\u8de8\u7528\u6237\u8bbf\u95ee\u7edf\u4e00\u8fd4\u56de 404\uff09 409 \u51b2\u7a81\uff08\u5982\u7528\u6237\u540d\u5df2\u5b58\u5728\u3001Artifact \u7248\u672c\u51b2\u7a81\uff09 422 \u8bf7\u6c42\u53c2\u6570\u9a8c\u8bc1\u5931\u8d25 500 \u670d\u52a1\u5668\u5185\u90e8\u9519\u8bef"},{"location":"api/#\u524d\u7aef\u96c6\u6210\u793a\u4f8b","title":"\u524d\u7aef\u96c6\u6210\u793a\u4f8b","text":""},{"location":"api/#\u5b8c\u6574\u7684\u804a\u5929\u7ec4\u4ef6","title":"\u5b8c\u6574\u7684\u804a\u5929\u7ec4\u4ef6","text":"<pre><code>interface Message {\n  id: string;\n  role: 'user' | 'assistant';\n  content: string;\n  createdAt: Date;\n}\n\ninterface PermissionRequest {\n  threadId: string;\n  messageId: string;\n  tool: string;\n  params: Record&lt;string, any&gt;;\n  permissionLevel: string;\n}\n\ninterface ChatState {\n  conversationId: string | null;\n  messages: Message[];\n  isStreaming: boolean;\n  currentContent: string;\n  pendingPermission: PermissionRequest | null;\n  currentThreadId: string | null;\n  currentMessageId: string | null;\n}\n\nasync function sendMessage(\n  state: ChatState,\n  content: string\n): Promise&lt;void&gt; {\n  const token = localStorage.getItem('af_token');\n  const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};\n\n  // 1. \u53d1\u9001\u6d88\u606f\n  const res = await fetch('/api/v1/chat', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json', ...authHeaders },\n    body: JSON.stringify({\n      content,\n      conversation_id: state.conversationId\n    })\n  });\n\n  const { conversation_id, thread_id, message_id, stream_url } = await res.json();\n  state.conversationId = conversation_id;\n  state.currentThreadId = thread_id;\n  state.currentMessageId = message_id;\n  state.isStreaming = true;\n  state.currentContent = '';\n\n  // \u6dfb\u52a0\u7528\u6237\u6d88\u606f\n  state.messages.push({\n    id: message_id,\n    role: 'user',\n    content,\n    createdAt: new Date()\n  });\n\n  // 2. \u8fde\u63a5 SSE\uff08\u4f7f\u7528 fetch \u4ee5\u652f\u6301\u81ea\u5b9a\u4e49 Authorization header\uff09\n  const sseRes = await fetch(stream_url, {\n    headers: { Accept: 'text/event-stream', ...authHeaders },\n  });\n\n  if (sseRes.status === 401) {\n    // Token \u8fc7\u671f\u6216\u65e0\u6548\uff0c\u9700\u91cd\u65b0\u767b\u5f55\n    console.error('Session expired');\n    return;\n  }\n\n  const reader = sseRes.body!.getReader();\n  const decoder = new TextDecoder();\n  let buffer = '';\n\n  // 3. \u9010\u5757\u8bfb\u53d6 SSE \u4e8b\u4ef6\n  while (true) {\n    const { done, value } = await reader.read();\n    if (done) break;\n\n    buffer += decoder.decode(value, { stream: true });\n    const lines = buffer.split('\\n');\n    buffer = lines.pop() || '';\n\n    let eventType = '';\n    for (const line of lines) {\n      if (line.startsWith('event: ')) {\n        eventType = line.slice(7);\n      } else if (line.startsWith('data: ') &amp;&amp; eventType) {\n        const parsed = JSON.parse(line.slice(6));\n        handleSSEEvent(state, eventType, parsed, thread_id, message_id);\n        eventType = '';\n      }\n    }\n  }\n}\n\nfunction handleSSEEvent(\n  state: ChatState,\n  eventType: string,\n  parsed: any,\n  threadId: string,\n  messageId: string\n): void {\n  const { data } = parsed;\n\n  switch (eventType) {\n    case 'llm_chunk':\n      // data.content \u662f\u7d2f\u79ef\u5185\u5bb9\uff0c\u76f4\u63a5\u4f7f\u7528\n      state.currentContent = data.content;\n      break;\n\n    case 'agent_complete':\n      if (data.routing) state.currentContent = '';\n      break;\n\n    case 'permission_request':\n      state.pendingPermission = {\n        threadId, messageId,\n        tool: parsed.tool,\n        params: data.params,\n        permissionLevel: data.permission_level,\n      };\n      break;\n\n    case 'complete':\n      if (data.interrupted) {\n        console.log('Interrupted:', data.interrupt_data);\n      } else {\n        state.messages.push({\n          id: `${messageId}_response`,\n          role: 'assistant',\n          content: data.response,\n          createdAt: new Date(),\n        });\n      }\n      state.currentContent = '';\n      state.isStreaming = false;\n      break;\n\n    case 'error':\n      console.error('Execution error:', data.error);\n      state.isStreaming = false;\n      break;\n  }\n}\n\nasync function handlePermission(\n  state: ChatState,\n  approved: boolean\n): Promise&lt;void&gt; {\n  if (!state.pendingPermission) return;\n\n  const token = localStorage.getItem('af_token');\n  const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};\n\n  const res = await fetch(`/api/v1/chat/${state.conversationId}/resume`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json', ...authHeaders },\n    body: JSON.stringify({\n      thread_id: state.pendingPermission.threadId,\n      message_id: state.pendingPermission.messageId,\n      approved\n    })\n  });\n\n  const { stream_url } = await res.json();\n  state.pendingPermission = null;\n  state.isStreaming = true;\n\n  // \u91cd\u65b0\u8fde\u63a5 SSE\uff08\u540c\u6837\u4f7f\u7528 fetch + auth header\uff09\n  const sseRes = await fetch(stream_url, {\n    headers: { Accept: 'text/event-stream', ...authHeaders },\n  });\n  // ... \u7528 ReadableStream \u5904\u7406\u540e\u7eed\u4e8b\u4ef6\uff08\u540c sendMessage\uff09\n}\n</code></pre>"},{"location":"api/#artifact-\u67e5\u770b\u7ec4\u4ef6","title":"Artifact \u67e5\u770b\u7ec4\u4ef6","text":"<pre><code>function getAuthHeaders(): Record&lt;string, string&gt; {\n  const token = localStorage.getItem('af_token');\n  return token ? { Authorization: `Bearer ${token}` } : {};\n}\n\nasync function loadArtifacts(sessionId: string): Promise&lt;Artifact[]&gt; {\n  const res = await fetch(`/api/v1/artifacts/${sessionId}`, {\n    headers: getAuthHeaders(),\n  });\n  const { artifacts } = await res.json();\n  return artifacts;\n}\n\nasync function loadArtifactWithHistory(\n  sessionId: string,\n  artifactId: string\n): Promise&lt;{ artifact: Artifact; versions: Version[] }&gt; {\n  const headers = getAuthHeaders();\n  const [artifactRes, versionsRes] = await Promise.all([\n    fetch(`/api/v1/artifacts/${sessionId}/${artifactId}`, { headers }),\n    fetch(`/api/v1/artifacts/${sessionId}/${artifactId}/versions`, { headers })\n  ]);\n\n  return {\n    artifact: await artifactRes.json(),\n    versions: (await versionsRes.json()).versions\n  };\n}\n\nasync function loadSpecificVersion(\n  sessionId: string,\n  artifactId: string,\n  version: number\n): Promise&lt;VersionDetail&gt; {\n  const res = await fetch(\n    `/api/v1/artifacts/${sessionId}/${artifactId}/versions/${version}`,\n    { headers: getAuthHeaders() }\n  );\n  return await res.json();\n}\n</code></pre>"},{"location":"extension-guide/","title":"\u6269\u5c55\u6307\u5357","text":"<p>\u672c\u6307\u5357\u4ecb\u7ecd\u5982\u4f55\u6269\u5c55 ArtifactFlow\uff0c\u5305\u62ec\u6dfb\u52a0\u65b0\u7684 Agent \u548c Tool\u3002</p>"},{"location":"extension-guide/#\u6dfb\u52a0\u65b0-agent","title":"\u6dfb\u52a0\u65b0 Agent","text":""},{"location":"extension-guide/#\u6b65\u9aa4\u6982\u89c8","title":"\u6b65\u9aa4\u6982\u89c8","text":"<ol> <li>\u521b\u5efa Agent \u7c7b\uff08\u7ee7\u627f <code>BaseAgent</code>\uff09</li> <li>\u5b9a\u4e49\u914d\u7f6e\u548c\u6240\u9700\u5de5\u5177</li> <li>\u5b9e\u73b0\u7cfb\u7edf\u63d0\u793a\u8bcd</li> <li>\u6ce8\u518c\u5230 Graph</li> </ol>"},{"location":"extension-guide/#\u5b8c\u6574\u793a\u4f8bcodeagent","title":"\u5b8c\u6574\u793a\u4f8b\uff1aCodeAgent","text":"<p>\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e\u4ee3\u7801\u5206\u6790\u7684 Agent\uff1a</p> <pre><code># src/agents/code_agent.py\n\nfrom typing import Dict, Any, List, Optional\nfrom agents.base import BaseAgent, AgentConfig\n\nclass CodeAgent(BaseAgent):\n    \"\"\"\u4ee3\u7801\u5206\u6790 Agent\"\"\"\n\n    def __init__(self, config: Optional[AgentConfig] = None, toolkit=None):\n        if not config:\n            config = AgentConfig(\n                name=\"code_agent\",  # \u547d\u540d\u89c4\u8303\uff1axxx_agent\n                description=\"\u4ee3\u7801\u5206\u6790\u4e0e\u5ba1\u67e5\",\n                capabilities=[\n                    \"\u4ee3\u7801\u7ed3\u6784\u5206\u6790\",\n                    \"\u4ee3\u7801\u8d28\u91cf\u8bc4\u4f30\",\n                    \"\u91cd\u6784\u5efa\u8bae\"\n                ],\n                required_tools=[\n                    \"read_file\",      # \u9700\u8981\u5148\u521b\u5efa\u8fd9\u4e9b\u5de5\u5177\n                    \"analyze_code\"\n                ],\n                model=\"qwen3-next-80b-instruct\",\n                temperature=0.3,  # \u4ee3\u7801\u5206\u6790\u9700\u8981\u7cbe\u786e\n                max_tool_rounds=5,\n                streaming=True\n            )\n        super().__init__(config, toolkit)\n\n    def build_system_prompt(self, context: Optional[Dict[str, Any]] = None) -&gt; str:\n        \"\"\"\n        \u6784\u5efa\u7cfb\u7edf\u63d0\u793a\u8bcd\n\n        Args:\n            context: \u52a8\u6001\u4e0a\u4e0b\u6587\uff08\u5982 artifacts_inventory\uff09\n        \"\"\"\n        return \"\"\"# \u89d2\u8272\n\u4f60\u662f\u4e00\u4e2a\u4e13\u4e1a\u7684\u4ee3\u7801\u5206\u6790 Agent\uff0c\u8d1f\u8d23\u5206\u6790\u4ee3\u7801\u7ed3\u6784\u3001\u8bc4\u4f30\u4ee3\u7801\u8d28\u91cf\u3001\u63d0\u4f9b\u91cd\u6784\u5efa\u8bae\u3002\n\n# \u80fd\u529b\n- \u7406\u89e3\u591a\u79cd\u7f16\u7a0b\u8bed\u8a00\u7684\u4ee3\u7801\u7ed3\u6784\n- \u8bc6\u522b\u4ee3\u7801\u4e2d\u7684\u95ee\u9898\u548c\u6539\u8fdb\u70b9\n- \u63d0\u4f9b\u5177\u4f53\u7684\u91cd\u6784\u5efa\u8bae\n\n# \u5de5\u4f5c\u6d41\u7a0b\n1. \u63a5\u6536\u4ee3\u7801\u5206\u6790\u6307\u4ee4\n2. \u4f7f\u7528\u5de5\u5177\u8bfb\u53d6\u548c\u5206\u6790\u4ee3\u7801\n3. \u6574\u7406\u5206\u6790\u7ed3\u679c\n4. \u8fd4\u56de\u7ed3\u6784\u5316\u7684\u5206\u6790\u62a5\u544a\n\n# \u8f93\u51fa\u8981\u6c42\n- \u5206\u6790\u7ed3\u679c\u8981\u5177\u4f53\u3001\u53ef\u64cd\u4f5c\n- \u6307\u51fa\u95ee\u9898\u65f6\u7ed9\u51fa\u6539\u8fdb\u5efa\u8bae\n- \u4f7f\u7528\u4ee3\u7801\u793a\u4f8b\u8bf4\u660e\n\"\"\"\n        # \u6ce8\u610f\uff1a\u5de5\u5177\u8bf4\u660e\u7531 build_complete_system_prompt() \u81ea\u52a8\u8ffd\u52a0\n\n    def format_final_response(self, content: str) -&gt; str:\n        \"\"\"\n        \u683c\u5f0f\u5316\u6700\u7ec8\u54cd\u5e94\n\n        Args:\n            content: LLM \u7684\u6700\u7ec8\u56de\u590d\n        \"\"\"\n        return f\"\"\"## \u4ee3\u7801\u5206\u6790\u62a5\u544a\n\n{content}\n\"\"\"\n</code></pre>"},{"location":"extension-guide/#\u6ce8\u518c\u5230-graph","title":"\u6ce8\u518c\u5230 Graph","text":"<pre><code># src/core/graph.py\n\nfrom agents.code_agent import CodeAgent\n\nasync def create_multi_agent_graph(\n    tool_permissions: Optional[Dict[str, ToolPermission]] = None,\n    artifact_manager: Optional[ArtifactManager] = None,\n    checkpointer: Optional[Any] = None,\n    db_path: str = \"data/langgraph.db\"\n):\n    graph_builder = ExtendableGraph(artifact_manager=artifact_manager)\n\n    # \u521b\u5efa Agent \u5b9e\u4f8b\n    lead = LeadAgent()\n    search = SearchAgent()\n    crawl = CrawlAgent()\n    code = CodeAgent()  # \u65b0\u589e\n\n    # \u521b\u5efa\u5de5\u5177\u5305\u5e76\u7ed1\u5b9a\u5230 Agent\n    # \uff08toolkit \u521b\u5efa\u903b\u8f91\uff0c\u89c1 create_multi_agent_graph \u5b8c\u6574\u5b9e\u73b0\uff09\n\n    # \u6ce8\u518c\u5b50 Agent \u5230 Lead\uff08\u4f7f\u5176\u51fa\u73b0\u5728 Lead \u7684 system prompt \u4e2d\uff09\n    lead.register_subagent(search.config)\n    lead.register_subagent(crawl.config)\n    lead.register_subagent(code.config)  # \u65b0\u589e\n\n    # \u6ce8\u518c\u5230 Graph\uff08\u987a\u5e8f\uff1a\u5148 subagent\uff0c\u518d lead\uff09\n    graph_builder.register_agent(search)\n    graph_builder.register_agent(crawl)\n    graph_builder.register_agent(code)  # \u65b0\u589e\n    graph_builder.register_agent(lead)\n\n    # \u8bbe\u7f6e\u5165\u53e3\u70b9\n    graph_builder.set_entry_point(\"lead_agent\")\n\n    # \u7f16\u8bd1\n    return await graph_builder.compile(checkpointer=checkpointer)\n</code></pre>"},{"location":"extension-guide/#lead-agent-\u81ea\u52a8\u611f\u77e5","title":"Lead Agent \u81ea\u52a8\u611f\u77e5","text":"<p>\u901a\u8fc7 <code>lead.register_subagent(code.config)</code> \u6ce8\u518c\u540e\uff0cLead Agent \u7684\u7cfb\u7edf\u63d0\u793a\u8bcd\u4f1a\u81ea\u52a8\u5305\u542b\u65b0 Agent\uff1a</p> <pre><code># \u53ef\u8c03\u7528\u7684 SubAgent\n\n- **search_agent**: Web search and information retrieval specialist\n  - Capabilities: Web search, Information retrieval\n- **crawl_agent**: Web content extraction and cleaning specialist\n  - Capabilities: Deep content extraction, Web scraping\n- **code_agent**: \u4ee3\u7801\u5206\u6790\u4e0e\u5ba1\u67e5\n  - Capabilities: \u4ee3\u7801\u7ed3\u6784\u5206\u6790, \u4ee3\u7801\u8d28\u91cf\u8bc4\u4f30, \u91cd\u6784\u5efa\u8bae\n</code></pre>"},{"location":"extension-guide/#\u6dfb\u52a0\u65b0\u5de5\u5177","title":"\u6dfb\u52a0\u65b0\u5de5\u5177","text":""},{"location":"extension-guide/#\u6b65\u9aa4\u6982\u89c8_1","title":"\u6b65\u9aa4\u6982\u89c8","text":"<ol> <li>\u521b\u5efa\u5de5\u5177\u7c7b\uff08\u7ee7\u627f <code>BaseTool</code>\uff09</li> <li>\u5b9a\u4e49\u53c2\u6570\u548c\u6743\u9650</li> <li>\u5b9e\u73b0\u6267\u884c\u903b\u8f91</li> <li>\u6ce8\u518c\u5230 ToolRegistry</li> </ol>"},{"location":"extension-guide/#\u5b8c\u6574\u793a\u4f8breadfiletool","title":"\u5b8c\u6574\u793a\u4f8b\uff1aReadFileTool","text":"<pre><code># src/tools/implementations/file_ops.py\n\nfrom pathlib import Path\nfrom typing import List\nfrom tools.base import BaseTool, ToolParameter, ToolResult, ToolPermission\n\nclass ReadFileTool(BaseTool):\n    \"\"\"\u8bfb\u53d6\u6587\u4ef6\u5185\u5bb9\"\"\"\n\n    def __init__(self):\n        super().__init__(\n            name=\"read_file\",\n            description=\"\u8bfb\u53d6\u6307\u5b9a\u8def\u5f84\u7684\u6587\u4ef6\u5185\u5bb9\",\n            permission=ToolPermission.CONFIRM  # \u9700\u8981\u7528\u6237\u786e\u8ba4\n        )\n\n    def get_parameters(self) -&gt; List[ToolParameter]:\n        return [\n            ToolParameter(\n                name=\"path\",\n                type=\"string\",\n                description=\"\u6587\u4ef6\u8def\u5f84\",\n                required=True\n            ),\n            ToolParameter(\n                name=\"encoding\",\n                type=\"string\",\n                description=\"\u6587\u4ef6\u7f16\u7801\",\n                required=False,\n                default=\"utf-8\"\n            ),\n            ToolParameter(\n                name=\"max_lines\",\n                type=\"integer\",\n                description=\"\u6700\u5927\u8bfb\u53d6\u884c\u6570\uff0c0 \u8868\u793a\u4e0d\u9650\u5236\",\n                required=False,\n                default=0\n            )\n        ]\n\n    async def execute(\n        self,\n        path: str,\n        encoding: str = \"utf-8\",\n        max_lines: int = 0\n    ) -&gt; ToolResult:\n        try:\n            file_path = Path(path)\n\n            # \u5b89\u5168\u68c0\u67e5\n            if not file_path.exists():\n                return ToolResult(\n                    success=False,\n                    error=f\"\u6587\u4ef6\u4e0d\u5b58\u5728: {path}\"\n                )\n\n            if not file_path.is_file():\n                return ToolResult(\n                    success=False,\n                    error=f\"\u8def\u5f84\u4e0d\u662f\u6587\u4ef6: {path}\"\n                )\n\n            # \u8bfb\u53d6\u6587\u4ef6\n            content = file_path.read_text(encoding=encoding)\n\n            # \u9650\u5236\u884c\u6570\n            if max_lines &gt; 0:\n                lines = content.split('\\n')\n                if len(lines) &gt; max_lines:\n                    content = '\\n'.join(lines[:max_lines])\n                    content += f\"\\n... (truncated, {len(lines) - max_lines} more lines)\"\n\n            return ToolResult(\n                success=True,\n                data={\n                    \"path\": str(file_path.absolute()),\n                    \"content\": content,\n                    \"size\": file_path.stat().st_size,\n                    \"lines\": content.count('\\n') + 1\n                },\n                metadata={\n                    \"encoding\": encoding,\n                    \"truncated\": max_lines &gt; 0 and len(content.split('\\n')) &gt;= max_lines\n                }\n            )\n\n        except UnicodeDecodeError:\n            return ToolResult(\n                success=False,\n                error=f\"\u65e0\u6cd5\u4ee5 {encoding} \u7f16\u7801\u8bfb\u53d6\u6587\u4ef6\"\n            )\n        except PermissionError:\n            return ToolResult(\n                success=False,\n                error=f\"\u6ca1\u6709\u8bfb\u53d6\u6743\u9650: {path}\"\n            )\n        except Exception as e:\n            return ToolResult(\n                success=False,\n                error=str(e)\n            )\n</code></pre>"},{"location":"extension-guide/#\u6ce8\u518c\u5de5\u5177","title":"\u6ce8\u518c\u5de5\u5177","text":"<p>\u5728 <code>create_multi_agent_graph()</code> \u51fd\u6570\u4e2d\uff08<code>core/graph.py</code>\uff09\u6dfb\u52a0\u65b0\u5de5\u5177\uff1a</p> <pre><code>from tools.implementations.file_ops import ReadFileTool\n\n# \u5728 tools \u5217\u8868\u4e2d\u6dfb\u52a0\u65b0\u5de5\u5177\ntools = [\n    CallSubagentTool(),\n    WebSearchTool(),\n    WebFetchTool(),\n    ReadFileTool(),  # \u6dfb\u52a0\u65b0\u5de5\u5177\n]\n\n# \u6ce8\u518c\u5230 registry\nfor tool in tools:\n    registry.register_tool_to_library(tool)\n</code></pre>"},{"location":"extension-guide/#\u4e3a-agent-\u5206\u914d\u5de5\u5177","title":"\u4e3a Agent \u5206\u914d\u5de5\u5177","text":"<p>\u5728 Agent \u914d\u7f6e\u4e2d\u901a\u8fc7 <code>required_tools</code> \u6307\u5b9a\u6240\u9700\u5de5\u5177\uff1a</p> <pre><code># \u5728 Agent \u6a21\u5757\u4e2d\u5b9a\u4e49\uff08\u5982 agents/code_agent.py\uff09\ndef create_code_agent() -&gt; BaseAgent:\n    config = AgentConfig(\n        name=\"code_agent\",\n        # ...\n        required_tools=[\n            \"read_file\",      # \u65b0\u5de5\u5177\n            \"analyze_code\"\n        ]\n    )\n    return CodeAgent(config)\n</code></pre> <p><code>create_multi_agent_graph()</code> \u4f1a\u6839\u636e <code>required_tools</code> \u81ea\u52a8\u521b\u5efa\u5bf9\u5e94\u7684 <code>AgentToolkit</code> \u5e76\u7ed1\u5b9a\u5230 Agent\u3002</p>"},{"location":"extension-guide/#\u6743\u9650\u7ea7\u522b\u9009\u62e9\u6307\u5357","title":"\u6743\u9650\u7ea7\u522b\u9009\u62e9\u6307\u5357","text":"\u6743\u9650 \u9002\u7528\u573a\u666f \u793a\u4f8b <code>AUTO</code> \u65e0\u9700\u786e\u8ba4\u7684\u64cd\u4f5c \u641c\u7d22\u3001\u67e5\u8be2\u3001Artifact \u64cd\u4f5c <code>CONFIRM</code> \u654f\u611f\u6216\u9ad8\u98ce\u9669\u64cd\u4f5c \u8bfb\u53d6\u6587\u4ef6\u3001\u53d1\u9001\u90ae\u4ef6\u3001\u6267\u884c\u4ee3\u7801"},{"location":"extension-guide/#\u5de5\u5177\u53c2\u6570\u7c7b\u578b","title":"\u5de5\u5177\u53c2\u6570\u7c7b\u578b","text":"<p>\u652f\u6301\u7684\u53c2\u6570\u7c7b\u578b\uff1a</p> \u7c7b\u578b Python \u7c7b\u578b XML \u793a\u4f8b <code>string</code> <code>str</code> <code>&lt;param&gt;&lt;![CDATA[hello]]&gt;&lt;/param&gt;</code> <code>integer</code> <code>int</code> <code>&lt;param&gt;&lt;![CDATA[42]]&gt;&lt;/param&gt;</code> <code>number</code> <code>float</code> <code>&lt;param&gt;&lt;![CDATA[3.14]]&gt;&lt;/param&gt;</code> <code>boolean</code> <code>bool</code> <code>&lt;param&gt;&lt;![CDATA[true]]&gt;&lt;/param&gt;</code> <code>array</code> <code>list</code> <code>&lt;param&gt;&lt;item&gt;&lt;![CDATA[a]]&gt;&lt;/item&gt;&lt;item&gt;&lt;![CDATA[b]]&gt;&lt;/item&gt;&lt;/param&gt;</code>"},{"location":"extension-guide/#\u6dfb\u52a0\u65b0-artifact-\u7c7b\u578b","title":"\u6dfb\u52a0\u65b0 Artifact \u7c7b\u578b","text":"<p>Artifact \u7c7b\u578b\u901a\u8fc7 <code>content_type</code> \u5b57\u6bb5\u533a\u5206\uff0c\u53ef\u4ee5\u81ea\u7531\u6269\u5c55\uff1a</p> <pre><code># \u521b\u5efa\u81ea\u5b9a\u4e49\u7c7b\u578b\u7684 Artifact\nawait artifact_manager.create_artifact(\n    session_id=session_id,\n    artifact_id=\"code_review_report\",\n    content_type=\"markdown\",  # \u5185\u5bb9\u7c7b\u578b\uff1amarkdown, python, json \u7b49\n    title=\"Code Review Report\",\n    content=\"...\"\n)\n</code></pre>"},{"location":"extension-guide/#\u5efa\u8bae\u7684-content_type","title":"\u5efa\u8bae\u7684 content_type","text":"\u7c7b\u578b \u7528\u9014 <code>markdown</code> Markdown \u6587\u6863\uff08\u4efb\u52a1\u8ba1\u5212\u3001\u62a5\u544a\u7b49\uff09 <code>python</code> Python \u4ee3\u7801 <code>javascript</code> JavaScript \u4ee3\u7801 <code>json</code> JSON \u6570\u636e <code>yaml</code> YAML \u914d\u7f6e <code>text</code> \u7eaf\u6587\u672c"},{"location":"extension-guide/#\u5efa\u8bae\u7684-artifact_id-\u547d\u540d","title":"\u5efa\u8bae\u7684 artifact_id \u547d\u540d","text":"ID \u7528\u9014 <code>task_plan</code> \u4efb\u52a1\u8ba1\u5212\uff08\u7cfb\u7edf\u4fdd\u7559\uff09 <code>research_report</code> \u7814\u7a76\u62a5\u544a <code>code_review</code> \u4ee3\u7801\u5ba1\u67e5\u62a5\u544a <code>main.py</code> \u4ee3\u7801\u6587\u4ef6\uff08\u4f7f\u7528\u6587\u4ef6\u540d\uff09"},{"location":"extension-guide/#\u81ea\u5b9a\u4e49-llm-\u6a21\u578b","title":"\u81ea\u5b9a\u4e49 LLM \u6a21\u578b","text":""},{"location":"extension-guide/#\u6dfb\u52a0\u65b0\u6a21\u578b\u914d\u7f6e","title":"\u6dfb\u52a0\u65b0\u6a21\u578b\u914d\u7f6e","text":"<pre><code># src/models/llm.py\n\nMODEL_CONFIGS = {\n    # \u73b0\u6709\u914d\u7f6e...\n\n    # \u6dfb\u52a0\u65b0\u6a21\u578b\uff08\u9884\u5b9a\u4e49\u914d\u7f6e\u53ea\u652f\u6301 model \u548c reasoning \u6807\u5fd7\uff09\n    \"my-custom-model\": {\n        \"model\": \"dashscope/my-model-name\",  # LiteLLM \u683c\u5f0f\uff1aprovider/model\n        \"support_reasoning\": False,           # \u662f\u5426\u652f\u6301\u63a8\u7406\u6a21\u5f0f\n        \"auto_reasoning\": False,              # \u6a21\u578b\u662f\u5426\u81ea\u5e26\u63a8\u7406\uff08\u5982 DeepSeek R1\uff09\n        \"description\": \"My custom model\"\n    }\n}\n</code></pre>"},{"location":"extension-guide/#\u5728-agent-\u4e2d\u4f7f\u7528","title":"\u5728 Agent \u4e2d\u4f7f\u7528","text":"<pre><code>class MyAgent(BaseAgent):\n    def __init__(self):\n        super().__init__(AgentConfig(\n            # ...\n            model=\"my-custom-model\"  # \u4f7f\u7528\u9884\u5b9a\u4e49\u914d\u7f6e\u4e2d\u7684 key\n        ))\n</code></pre>"},{"location":"extension-guide/#\u81ea\u90e8\u7f72\u6a21\u578bollamavllm","title":"\u81ea\u90e8\u7f72\u6a21\u578b\uff08Ollama/vLLM\uff09","text":"<p>\u5bf9\u4e8e\u81ea\u90e8\u7f72\u7684 OpenAI \u517c\u5bb9\u63a5\u53e3\uff0c\u4f7f\u7528 <code>create_llm()</code> \u7684 <code>base_url</code> \u548c <code>api_key</code> \u53c2\u6570\uff1a</p> <pre><code>from models.llm import create_llm\n\nllm = create_llm(\n    model=\"llama3\",\n    base_url=\"http://localhost:11434/v1\",\n    api_key=\"ollama\"\n)\n</code></pre>"},{"location":"extension-guide/#\u6d4b\u8bd5\u65b0\u7ec4\u4ef6","title":"\u6d4b\u8bd5\u65b0\u7ec4\u4ef6","text":""},{"location":"extension-guide/#\u6d4b\u8bd5\u5de5\u5177","title":"\u6d4b\u8bd5\u5de5\u5177","text":"<pre><code># tests/test_tools.py\n\nimport pytest\nfrom tools.implementations.file_ops import ReadFileTool\n\n@pytest.mark.asyncio\nasync def test_read_file_tool():\n    tool = ReadFileTool()\n\n    # \u6d4b\u8bd5\u6b63\u5e38\u8bfb\u53d6\n    result = await tool.execute(path=\"test.txt\")\n    assert result.success\n    assert \"content\" in result.data\n\n    # \u6d4b\u8bd5\u6587\u4ef6\u4e0d\u5b58\u5728\n    result = await tool.execute(path=\"nonexistent.txt\")\n    assert not result.success\n    assert \"\u4e0d\u5b58\u5728\" in result.error\n</code></pre>"},{"location":"extension-guide/#\u6d4b\u8bd5-agent","title":"\u6d4b\u8bd5 Agent","text":"<pre><code># tests/test_agents.py\n\nimport pytest\nfrom agents.code_agent import CodeAgent\n\ndef test_code_agent_config():\n    agent = CodeAgent()\n    assert agent.config.name == \"code_agent\"\n    assert \"read_file\" in agent.config.required_tools\n\ndef test_code_agent_system_prompt():\n    agent = CodeAgent()\n    # build_system_prompt \u63a5\u53d7 context \u53c2\u6570\uff08\u53ef\u9009\uff09\n    prompt = agent.build_system_prompt(context=None)\n    assert \"\u4ee3\u7801\u5206\u6790\" in prompt\n\ndef test_code_agent_format_response():\n    agent = CodeAgent()\n    result = agent.format_final_response(\n        content=\"\u5206\u6790\u7ed3\u679c...\"\n    )\n    assert \"\u4ee3\u7801\u5206\u6790\u62a5\u544a\" in result\n</code></pre>"},{"location":"extension-guide/#\u6700\u4f73\u5b9e\u8df5","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"extension-guide/#agent-\u8bbe\u8ba1","title":"Agent \u8bbe\u8ba1","text":"<ol> <li>\u5355\u4e00\u804c\u8d23\uff1a\u6bcf\u4e2a Agent \u4e13\u6ce8\u4e8e\u4e00\u7c7b\u4efb\u52a1</li> <li>\u660e\u786e\u8fb9\u754c\uff1a\u6e05\u6670\u5b9a\u4e49 Agent \u7684\u80fd\u529b\u8303\u56f4</li> <li>\u5408\u7406\u7684\u5de5\u5177\u96c6\uff1a\u53ea\u5206\u914d\u5fc5\u8981\u7684\u5de5\u5177</li> <li>\u8be6\u7ec6\u7684\u63d0\u793a\u8bcd\uff1a\u5305\u542b\u89d2\u8272\u3001\u80fd\u529b\u3001\u5de5\u4f5c\u6d41\u7a0b\u3001\u8f93\u51fa\u683c\u5f0f</li> </ol>"},{"location":"extension-guide/#tool-\u8bbe\u8ba1","title":"Tool \u8bbe\u8ba1","text":"<ol> <li>\u539f\u5b50\u64cd\u4f5c\uff1a\u6bcf\u4e2a\u5de5\u5177\u505a\u4e00\u4ef6\u4e8b</li> <li>\u6e05\u6670\u7684\u53c2\u6570\uff1a\u53c2\u6570\u547d\u540d\u548c\u63cf\u8ff0\u8981\u660e\u786e</li> <li>\u5b8c\u5584\u7684\u9519\u8bef\u5904\u7406\uff1a\u8fd4\u56de\u6709\u610f\u4e49\u7684\u9519\u8bef\u4fe1\u606f</li> <li>\u5408\u9002\u7684\u6743\u9650\uff1a\u6839\u636e\u98ce\u9669\u9009\u62e9\u6743\u9650\u7ea7\u522b</li> </ol>"},{"location":"extension-guide/#\u6d4b\u8bd5","title":"\u6d4b\u8bd5","text":"<ol> <li>\u5355\u5143\u6d4b\u8bd5\uff1a\u6d4b\u8bd5\u5de5\u5177\u7684\u5404\u79cd\u8f93\u5165\u60c5\u51b5</li> <li>\u96c6\u6210\u6d4b\u8bd5\uff1a\u6d4b\u8bd5 Agent \u4e0e\u5de5\u5177\u7684\u534f\u4f5c</li> <li>\u7aef\u5230\u7aef\u6d4b\u8bd5\uff1a\u6d4b\u8bd5\u5b8c\u6574\u7684\u6267\u884c\u6d41\u7a0b</li> </ol>"},{"location":"faq/","title":"FAQ","text":"<p>\u5e38\u89c1\u95ee\u9898\u4e0e\u6392\u67e5\u6307\u5357\u3002</p>"},{"location":"faq/#\u73af\u5883\u4e0e\u5b89\u88c5","title":"\u73af\u5883\u4e0e\u5b89\u88c5","text":""},{"location":"faq/#\u4e3a\u4ec0\u4e48\u9700\u8981-python-311","title":"\u4e3a\u4ec0\u4e48\u9700\u8981 Python 3.11+\uff1f","text":"<p>LangGraph \u7684 <code>interrupt()</code> \u529f\u80fd\u4f9d\u8d56 Python 3.11 \u5f15\u5165\u7684\u5f02\u6b65\u7279\u6027\u3002\u4f4e\u7248\u672c Python \u4f1a\u5bfc\u81f4\uff1a</p> <ul> <li><code>interrupt()</code> \u65e0\u6cd5\u6b63\u786e\u6682\u505c\u6267\u884c</li> <li>\u6743\u9650\u786e\u8ba4\u6d41\u7a0b\u5931\u6548</li> <li>\u72b6\u6001\u6062\u590d\u5f02\u5e38</li> </ul> <p>\u68c0\u67e5\u7248\u672c\uff1a</p> <pre><code>python --version\n# \u9700\u8981 Python 3.11.0 \u6216\u66f4\u9ad8\n</code></pre>"},{"location":"faq/#crawl4ai-setup-\u5931\u8d25","title":"crawl4ai-setup \u5931\u8d25","text":"<p>\u5e38\u89c1\u9519\u8bef\uff1a</p> <pre><code>Error: Playwright browsers not installed\n</code></pre> <p>\u89e3\u51b3\u65b9\u6848\uff1a</p> <pre><code># \u5b89\u88c5 playwright \u6d4f\u89c8\u5668\nplaywright install chromium\n\n# \u91cd\u65b0\u8fd0\u884c setup\ncrawl4ai-setup\n</code></pre> <p>\u5982\u679c\u4ecd\u7136\u5931\u8d25\uff0c\u5c1d\u8bd5\uff1a</p> <pre><code># \u5b8c\u6574\u5b89\u88c5\npip uninstall crawl4ai\npip install crawl4ai[all]\ncrawl4ai-setup\n</code></pre>"},{"location":"faq/#aiosqlite-\u7248\u672c\u51b2\u7a81","title":"aiosqlite \u7248\u672c\u51b2\u7a81","text":"<p>\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>ERROR: pip's dependency resolver does not currently take into account all the packages...\n</code></pre> <p>\u539f\u56e0\uff1a LangGraph \u548c\u5176\u4ed6\u5305\u5bf9 aiosqlite \u7248\u672c\u8981\u6c42\u4e0d\u4e00\u81f4\u3002</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a</p> <pre><code># \u4f7f\u7528 requirements.txt \u4e2d\u9501\u5b9a\u7684\u7248\u672c\npip install -r requirements.txt --force-reinstall\n</code></pre>"},{"location":"faq/#\u8ba4\u8bc1\u95ee\u9898","title":"\u8ba4\u8bc1\u95ee\u9898","text":""},{"location":"faq/#\u670d\u52a1\u542f\u52a8\u62a5-artifactflow_jwt_secret-\u672a\u8bbe\u7f6e","title":"\u670d\u52a1\u542f\u52a8\u62a5 <code>ARTIFACTFLOW_JWT_SECRET</code> \u672a\u8bbe\u7f6e","text":"<p>\u670d\u52a1\u542f\u52a8\u65f6\u4f1a\u68c0\u67e5 JWT \u5bc6\u94a5\uff0c\u672a\u8bbe\u7f6e\u5219\u62d2\u7edd\u542f\u52a8\uff1a</p> <pre><code>RuntimeError: ARTIFACTFLOW_JWT_SECRET environment variable is not set.\n</code></pre> <p>\u89e3\u51b3\u65b9\u6848\uff1a</p> <pre><code># \u751f\u6210\u5e76\u8bbe\u7f6e JWT \u5bc6\u94a5\nexport ARTIFACTFLOW_JWT_SECRET=$(python -c \"import secrets; print(secrets.token_urlsafe(32))\")\n\n# \u6216\u5199\u5165 .env \u6587\u4ef6\uff08\u63a8\u8350\uff09\necho \"ARTIFACTFLOW_JWT_SECRET=$(python -c 'import secrets; print(secrets.token_urlsafe(32))')\" &gt;&gt; .env\n</code></pre>"},{"location":"faq/#\u5982\u4f55\u521b\u5efa\u7b2c\u4e00\u4e2a\u7ba1\u7406\u5458\u8d26\u53f7","title":"\u5982\u4f55\u521b\u5efa\u7b2c\u4e00\u4e2a\u7ba1\u7406\u5458\u8d26\u53f7\uff1f","text":"<pre><code>python scripts/create_admin.py admin\n# \u6309\u63d0\u793a\u8f93\u5165\u5bc6\u7801\n\n# \u6216\u76f4\u63a5\u6307\u5b9a\u5bc6\u7801\npython scripts/create_admin.py admin --password your_password\n</code></pre> <p>\u8be5\u811a\u672c\u4f1a\uff1a 1. \u521b\u5efa admin \u89d2\u8272\u7684\u7528\u6237 2. \u5c06\u6240\u6709 <code>user_id</code> \u4e3a\u7a7a\u7684\u5386\u53f2\u5bf9\u8bdd\u5f52\u5c5e\u5230\u8be5\u7528\u6237\uff08\u53ef\u7528 <code>--no-claim</code> \u8df3\u8fc7\uff09</p>"},{"location":"faq/#cli-\u62a5-401--not-authenticated","title":"CLI \u62a5 401 / \"Not authenticated\"","text":"<p>CLI \u9700\u8981\u5148\u767b\u5f55\u83b7\u53d6 token\uff1a</p> <pre><code>python run_cli.py login\n# \u8f93\u5165\u7528\u6237\u540d\u548c\u5bc6\u7801\n\n# \u9a8c\u8bc1\u767b\u5f55\u72b6\u6001\npython run_cli.py status\n</code></pre> <p>\u5982\u679c token \u8fc7\u671f\uff0c\u91cd\u65b0\u6267\u884c <code>login</code> \u5373\u53ef\u3002</p>"},{"location":"faq/#\u524d\u7aef\u8df3\u8f6c\u5230\u767b\u5f55\u9875--\u9891\u7e41\u767b\u51fa","title":"\u524d\u7aef\u8df3\u8f6c\u5230\u767b\u5f55\u9875 / \u9891\u7e41\u767b\u51fa","text":"<p>\u53ef\u80fd\u539f\u56e0\uff1a</p> <ol> <li>Token \u8fc7\u671f\uff1a\u9ed8\u8ba4\u6709\u6548\u671f 7 \u5929\uff0c\u91cd\u65b0\u767b\u5f55\u5373\u53ef</li> <li>\u7528\u6237\u88ab\u7981\u7528\uff1a\u7ba1\u7406\u5458\u901a\u8fc7 <code>PUT /auth/users/{id}</code> \u7981\u7528\u4e86\u8d26\u53f7\uff08<code>is_active=false</code>\uff09\uff0c\u8054\u7cfb\u7ba1\u7406\u5458</li> <li>JWT \u5bc6\u94a5\u53d8\u66f4\uff1a\u670d\u52a1\u7aef\u91cd\u542f\u540e\u4f7f\u7528\u4e86\u4e0d\u540c\u7684 <code>ARTIFACTFLOW_JWT_SECRET</code>\uff0c\u6240\u6709\u65e7 token \u5931\u6548</li> </ol>"},{"location":"faq/#sse-\u8fde\u63a5\u8fd4\u56de-401","title":"SSE \u8fde\u63a5\u8fd4\u56de 401","text":"<p>SSE \u7aef\u70b9\u540c\u6837\u9700\u8981\u8ba4\u8bc1\u3002\u786e\u4fdd\u524d\u7aef\u4f7f\u7528 <code>fetch</code>\uff08\u800c\u975e <code>EventSource</code>\uff09\u8fde\u63a5 SSE\uff0c\u4ee5\u4fbf\u643a\u5e26 <code>Authorization</code> header\u3002ArtifactFlow \u524d\u7aef\u5df2\u6b63\u786e\u5904\u7406\uff08<code>frontend/src/lib/sse.ts</code>\uff09\u3002</p>"},{"location":"faq/#\u8fd0\u884c\u95ee\u9898","title":"\u8fd0\u884c\u95ee\u9898","text":""},{"location":"faq/#api-\u670d\u52a1\u542f\u52a8\u5931\u8d25","title":"API \u670d\u52a1\u542f\u52a8\u5931\u8d25","text":"<p>\u68c0\u67e5\u7aef\u53e3\u5360\u7528\uff1a</p> <pre><code>lsof -i :8000\n# \u5982\u679c\u6709\u8fdb\u7a0b\u5360\u7528\uff0ckill \u6216\u6362\u7aef\u53e3\npython run_server.py --port 8001\n</code></pre> <p>\u68c0\u67e5\u6570\u636e\u5e93\u76ee\u5f55\uff1a</p> <pre><code># \u786e\u4fdd data \u76ee\u5f55\u5b58\u5728\u4e14\u53ef\u5199\nmkdir -p data\nchmod 755 data\n</code></pre>"},{"location":"faq/#sse-\u8fde\u63a5\u7acb\u5373\u65ad\u5f00","title":"SSE \u8fde\u63a5\u7acb\u5373\u65ad\u5f00","text":"<p>\u53ef\u80fd\u539f\u56e0\uff1a</p> <ol> <li>thread_id \u4e0d\u5b58\u5728\uff1a\u68c0\u67e5 POST /chat \u8fd4\u56de\u7684 thread_id</li> <li>TTL \u8d85\u65f6\uff1aPOST \u540e\u8d85\u8fc7 30 \u79d2\u672a\u8fde\u63a5 SSE</li> <li>\u53cd\u5411\u4ee3\u7406\u7f13\u51b2\uff1aNginx \u7b49\u4ee3\u7406\u53ef\u80fd\u7f13\u51b2 SSE</li> </ol> <p>Nginx \u914d\u7f6e\uff1a</p> <pre><code>location /api/v1/stream/ {\n    proxy_pass http://backend;\n    proxy_buffering off;\n    proxy_cache off;\n    proxy_set_header Connection '';\n    proxy_http_version 1.1;\n    chunked_transfer_encoding off;\n}\n</code></pre>"},{"location":"faq/#agent-\u6267\u884c\u5361\u4f4f","title":"Agent \u6267\u884c\u5361\u4f4f","text":"<p>\u542f\u7528\u8c03\u8bd5\u65e5\u5fd7\uff1a</p> <pre><code>from utils.logger import set_global_debug\nset_global_debug(True)\n</code></pre> <p>\u68c0\u67e5 LLM API\uff1a</p> <pre><code># \u6d4b\u8bd5 API \u8fde\u63a5\ncurl -X POST https://your-llm-api/v1/chat/completions \\\n  -H \"Authorization: Bearer $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"model\": \"your-model\", \"messages\": [{\"role\": \"user\", \"content\": \"test\"}]}'\n</code></pre> <p>\u68c0\u67e5\u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code># \u786e\u4fdd API Key \u5df2\u8bbe\u7f6e\necho $OPENAI_API_KEY\necho $DASHSCOPE_API_KEY\n</code></pre>"},{"location":"faq/#\u6743\u9650\u4e2d\u65ad\u540e\u65e0\u6cd5\u6062\u590d","title":"\u6743\u9650\u4e2d\u65ad\u540e\u65e0\u6cd5\u6062\u590d","text":"<p>\u68c0\u67e5 Checkpointer \u72b6\u6001\uff1a</p> <pre><code># \u67e5\u770b LangGraph \u6570\u636e\u5e93\nsqlite3 data/langgraph.db \".tables\"\nsqlite3 data/langgraph.db \"SELECT thread_id FROM checkpoints LIMIT 5\"\n</code></pre> <p>\u786e\u4fdd thread_id \u4e00\u81f4\uff1a</p> <pre><code># \u901a\u8fc7 API \u6062\u590d\u6267\u884c\n# POST /api/v1/chat/{conversation_id}/resume\n{\n    \"thread_id\": \"thd-original-thread-id\",  # \u4f7f\u7528\u539f\u59cb thread_id\n    \"message_id\": \"msg-original-message-id\",\n    \"approved\": True\n}\n</code></pre> <p>\u6216\u901a\u8fc7 Controller\uff1a</p> <pre><code>async for event in controller.stream_execute(\n    thread_id=original_thread_id,\n    conversation_id=conversation_id,\n    message_id=message_id,\n    resume_data={\"type\": \"permission\", \"approved\": True}\n):\n    # \u5904\u7406\u4e8b\u4ef6\n    pass\n</code></pre>"},{"location":"faq/#\u5de5\u5177\u95ee\u9898","title":"\u5de5\u5177\u95ee\u9898","text":""},{"location":"faq/#web_search-\u8fd4\u56de\u7a7a\u7ed3\u679c","title":"web_search \u8fd4\u56de\u7a7a\u7ed3\u679c","text":"<p>\u68c0\u67e5\u641c\u7d22 API \u914d\u7f6e\uff1a</p> <p>\u641c\u7d22\u540e\u7aef\u4f7f\u7528\u535a\u67e5 AI\uff08Bocha API\uff09\uff0c\u786e\u4fdd <code>.env</code> \u4e2d\u914d\u7f6e\u4e86 <code>BOCHA_API_KEY</code>\uff1a</p> <pre><code># \u68c0\u67e5\u73af\u5883\u53d8\u91cf\necho $BOCHA_API_KEY\n\n# \u68c0\u67e5\u65e5\u5fd7\ntail -f logs/artifactflow.log | grep \"web_search\"\n</code></pre>"},{"location":"faq/#web_fetch-\u6293\u53d6\u5931\u8d25","title":"web_fetch \u6293\u53d6\u5931\u8d25","text":"<p>\u8c03\u6574\u6293\u53d6\u53c2\u6570\uff1a</p> <pre><code># web_fetch \u5de5\u5177\u652f\u6301\u7684\u53c2\u6570\nresult = await tool.execute(\n    url_list=[\"https://example.com\"],      # URL \u5217\u8868\uff08\u5fc5\u586b\uff09\n    max_content_length=10000,              # \u5355\u9875\u6700\u5927\u5b57\u7b26\u6570\uff08\u9ed8\u8ba4 10000\uff09\n    max_concurrent=3                       # \u6700\u5927\u5e76\u53d1\u6d4f\u89c8\u5668\u6570\uff08\u9ed8\u8ba4 3\uff0c\u4e0a\u9650 5\uff09\n)\n</code></pre> <p>\u68c0\u67e5\u76ee\u6807\u7f51\u7ad9\uff1a</p> <ul> <li>\u662f\u5426\u9700\u8981 JavaScript \u6e32\u67d3</li> <li>\u662f\u5426\u6709\u53cd\u722c\u866b\u673a\u5236</li> <li>\u662f\u5426\u9700\u8981\u4ee3\u7406</li> </ul>"},{"location":"faq/#artifact-\u66f4\u65b0\u7248\u672c\u51b2\u7a81","title":"Artifact \u66f4\u65b0\u7248\u672c\u51b2\u7a81","text":"<p>\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>VersionConflictError: Version mismatch for artifact 'xxx': expected lock_version 2, current is 3\n</code></pre> <p>\u539f\u56e0\uff1a \u591a\u4e2a Agent \u540c\u65f6\u66f4\u65b0\u540c\u4e00\u4e2a Artifact\u3002</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a Agent \u5e94\u8be5\uff1a</p> <ol> <li>\u91cd\u65b0\u8bfb\u53d6\u6700\u65b0\u7248\u672c</li> <li>\u5408\u5e76\u53d8\u66f4</li> <li>\u91cd\u8bd5\u66f4\u65b0</li> </ol> <p>\u8fd9\u662f\u6b63\u5e38\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u4e0d\u662f bug\u3002</p>"},{"location":"faq/#\u6027\u80fd\u95ee\u9898","title":"\u6027\u80fd\u95ee\u9898","text":""},{"location":"faq/#llm-\u54cd\u5e94\u6162","title":"LLM \u54cd\u5e94\u6162","text":"<p>\u4f7f\u7528\u6d41\u5f0f\u8f93\u51fa\uff1a \u786e\u4fdd\u524d\u7aef\u4f7f\u7528 SSE \u63a5\u6536 <code>llm_chunk</code> \u4e8b\u4ef6\uff0c\u800c\u4e0d\u662f\u7b49\u5f85\u5b8c\u6574\u54cd\u5e94\u3002</p> <p>\u8c03\u6574\u6a21\u578b\uff1a</p> <pre><code># \u5bf9\u4e8e\u7b80\u5355\u4efb\u52a1\uff0c\u4f7f\u7528\u66f4\u5feb\u7684\u6a21\u578b\nAgentConfig(\n    model=\"qwen-turbo\",  # \u6bd4 thinking \u6a21\u578b\u5feb\n    # ...\n)\n</code></pre>"},{"location":"faq/#\u5185\u5b58\u4f7f\u7528\u8fc7\u9ad8","title":"\u5185\u5b58\u4f7f\u7528\u8fc7\u9ad8","text":"<p>\u68c0\u67e5 StreamManager \u961f\u5217\uff1a</p> <pre><code># \u83b7\u53d6\u6d3b\u8dc3\u6d41\u6570\u91cf\nprint(f\"Active streams: {stream_manager.active_stream_count}\")\n\n# \u68c0\u67e5\u7279\u5b9a\u6d41\u72b6\u6001\nstatus = stream_manager.get_stream_status(thread_id)\nprint(f\"Stream status: {status}\")  # pending | streaming | closed | None\n</code></pre> <p>\u8c03\u6574 TTL\uff1a</p> <pre><code># \u51cf\u5c11\u672a\u6d88\u8d39\u961f\u5217\u7684\u5b58\u6d3b\u65f6\u95f4\nstream_manager = StreamManager(ttl_seconds=15)\n</code></pre>"},{"location":"faq/#\u6570\u636e\u5e93\u53d8\u6162","title":"\u6570\u636e\u5e93\u53d8\u6162","text":"<p>\u6e05\u7406\u5386\u53f2\u6570\u636e\uff1a</p> <pre><code>-- \u5220\u9664 30 \u5929\u524d\u7684\u5bf9\u8bdd\nDELETE FROM messages WHERE created_at &lt; datetime('now', '-30 days');\nDELETE FROM conversations WHERE updated_at &lt; datetime('now', '-30 days');\n\n-- \u6e05\u7406 Artifact \u5386\u53f2\u7248\u672c\uff08\u4fdd\u7559\u6bcf\u4e2a artifact \u6700\u8fd1 10 \u4e2a\u7248\u672c\uff09\nDELETE FROM artifact_versions\nWHERE id NOT IN (\n    SELECT id FROM (\n        SELECT id, ROW_NUMBER() OVER (\n            PARTITION BY artifact_id, session_id\n            ORDER BY version DESC\n        ) as rn\n        FROM artifact_versions\n    ) WHERE rn &lt;= 10\n);\n\n-- \u91cd\u5efa\u7d22\u5f15\nVACUUM;\n</code></pre>"},{"location":"faq/#\u5f00\u53d1\u95ee\u9898","title":"\u5f00\u53d1\u95ee\u9898","text":""},{"location":"faq/#\u5982\u4f55\u67e5\u770b\u5b8c\u6574\u7684-agent-\u63d0\u793a\u8bcd","title":"\u5982\u4f55\u67e5\u770b\u5b8c\u6574\u7684 Agent \u63d0\u793a\u8bcd\uff1f","text":"<pre><code>from agents.lead_agent import LeadAgent\n\nagent = LeadAgent()\n\n# build_system_prompt \u53ea\u8fd4\u56de\u89d2\u8272\u5b9a\u4e49\u90e8\u5206\nbase_prompt = agent.build_system_prompt(context=None)\nprint(\"=== Base Prompt ===\")\nprint(base_prompt)\n\n# build_complete_system_prompt \u8fd4\u56de\u5305\u542b\u5de5\u5177\u8bf4\u660e\u7684\u5b8c\u6574\u63d0\u793a\u8bcd\n# \u9700\u8981\u5148\u7ed1\u5b9a toolkit\nif agent.toolkit:\n    complete_prompt = agent.build_complete_system_prompt(context=None)\n    print(\"=== Complete Prompt ===\")\n    print(complete_prompt)\n</code></pre>"},{"location":"faq/#\u5982\u4f55\u8c03\u8bd5\u5de5\u5177\u6267\u884c","title":"\u5982\u4f55\u8c03\u8bd5\u5de5\u5177\u6267\u884c\uff1f","text":"<pre><code># \u76f4\u63a5\u6d4b\u8bd5\u5de5\u5177\nfrom tools.implementations.web_search import WebSearchTool\n\ntool = WebSearchTool()\nresult = await tool(query=\"test query\")  # \u4f7f\u7528 __call__\uff0c\u4f1a\u81ea\u52a8\u586b\u5145\u9ed8\u8ba4\u53c2\u6570\nprint(result)\n</code></pre>"},{"location":"faq/#\u5982\u4f55\u67e5\u770b-graph-\u72b6\u6001","title":"\u5982\u4f55\u67e5\u770b Graph \u72b6\u6001\uff1f","text":"<pre><code># \u83b7\u53d6\u5f53\u524d\u72b6\u6001\u5feb\u7167\nfrom langgraph.checkpoint.sqlite.aio import AsyncSqliteSaver\n\ncheckpointer = AsyncSqliteSaver.from_conn_string(\"data/langgraph.db\")\nstate = await checkpointer.aget({\"configurable\": {\"thread_id\": \"your-thread-id\"}})\nprint(state)\n</code></pre>"},{"location":"faq/#\u83b7\u53d6\u5e2e\u52a9","title":"\u83b7\u53d6\u5e2e\u52a9","text":"<p>\u5982\u679c\u4ee5\u4e0a\u90fd\u65e0\u6cd5\u89e3\u51b3\u95ee\u9898\uff1a</p> <ol> <li>\u68c0\u67e5\u65e5\u5fd7\uff1a<code>tail -f logs/artifactflow.log</code></li> <li>\u542f\u7528\u8c03\u8bd5\u6a21\u5f0f\uff1a<code>set_global_debug(True)</code></li> <li>\u63d0\u4ea4 Issue\uff1a\u9644\u4e0a\u9519\u8bef\u65e5\u5fd7\u548c\u590d\u73b0\u6b65\u9aa4</li> </ol>"},{"location":"frontend/","title":"\u524d\u7aef\u67b6\u6784\u6307\u5357","text":"<p>\u672c\u6587\u6863\u5e2e\u52a9\u4f60\u7406\u89e3 ArtifactFlow \u524d\u7aef\u7684\u5b8c\u6574\u67b6\u6784\uff0c\u9002\u5408\u521a\u63a5\u89e6\u8fd9\u4e2a\u9879\u76ee\u7684\u5f00\u53d1\u8005\u9605\u8bfb\u3002</p>"},{"location":"frontend/#\u6280\u672f\u6808","title":"\u6280\u672f\u6808","text":"\u6280\u672f \u7248\u672c \u7528\u9014 Next.js 15 React \u6846\u67b6\uff08App Router \u6a21\u5f0f\uff09 React 19 UI \u5e93 TypeScript strict mode \u7c7b\u578b\u5b89\u5168 Tailwind CSS 3 \u539f\u5b50\u5316 CSS Zustand 5 \u72b6\u6001\u7ba1\u7406"},{"location":"frontend/#\u76ee\u5f55\u7ed3\u6784\u603b\u89c8","title":"\u76ee\u5f55\u7ed3\u6784\u603b\u89c8","text":"<pre><code>frontend/src/\n\u251c\u2500\u2500 app/                  # Next.js \u5165\u53e3\uff08\u8def\u7531 + \u5168\u5c40\u6837\u5f0f\uff09\n\u2502   \u2514\u2500\u2500 login/           # \u767b\u5f55\u9875\n\u251c\u2500\u2500 components/           # React \u7ec4\u4ef6\n\u2502   \u251c\u2500\u2500 layout/          # \u9875\u9762\u5e03\u5c40\n\u2502   \u251c\u2500\u2500 sidebar/         # \u5de6\u4fa7\u680f\uff08\u5bf9\u8bdd\u5217\u8868\uff09\n\u2502   \u251c\u2500\u2500 chat/            # \u4e2d\u95f4\u680f\uff08\u804a\u5929\u9762\u677f\uff09\n\u2502   \u2514\u2500\u2500 artifact/        # \u53f3\u4fa7\u680f\uff08\u6587\u7a3f\u9762\u677f\uff09\n\u251c\u2500\u2500 hooks/                # \u81ea\u5b9a\u4e49 Hook\n\u251c\u2500\u2500 lib/                  # \u5de5\u5177\u51fd\u6570\uff08API \u5ba2\u6237\u7aef\u3001SSE\u3001\u6d88\u606f\u6811\uff09\n\u251c\u2500\u2500 stores/               # Zustand \u72b6\u6001\u4ed3\u5e93\uff08\u542b authStore\uff09\n\u2514\u2500\u2500 types/                # TypeScript \u7c7b\u578b\u5b9a\u4e49\n</code></pre>"},{"location":"frontend/#\u6838\u5fc3\u6982\u5ff5","title":"\u6838\u5fc3\u6982\u5ff5","text":""},{"location":"frontend/#\u4ec0\u4e48\u662f-hook","title":"\u4ec0\u4e48\u662f Hook\uff1f","text":"<p>Hook \u662f React \u7684\u4e00\u79cd\u6a21\u5f0f\uff0c\u7528\u6765\u628a\u53ef\u590d\u7528\u7684\u903b\u8f91\u4ece\u7ec4\u4ef6\u4e2d\u62bd\u79bb\u51fa\u6765\u3002\u51fd\u6570\u540d\u4ee5 <code>use</code> \u5f00\u5934\u3002</p> <p>\u6bd4\u5982 <code>useChat</code> \u5c01\u88c5\u4e86\u300c\u53d1\u9001\u6d88\u606f\u3001\u5237\u65b0\u5bf9\u8bdd\u300d\u7b49\u64cd\u4f5c\uff0c\u4efb\u4f55\u9700\u8981\u804a\u5929\u529f\u80fd\u7684\u7ec4\u4ef6\u53ea\u9700\u8c03\u7528 <code>useChat()</code> \u5c31\u80fd\u62ff\u5230\u8fd9\u4e9b\u51fd\u6570\uff0c\u800c\u4e0d\u7528\u91cd\u590d\u5199\u903b\u8f91\u3002</p> <pre><code>// \u4f7f\u7528\u793a\u4f8b\nfunction MyComponent() {\n  const { sendMessage, isNewConversation } = useChat();\n  // \u73b0\u5728\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528 sendMessage(\"hello\")\n}\n</code></pre>"},{"location":"frontend/#\u4ec0\u4e48\u662f-store","title":"\u4ec0\u4e48\u662f Store\uff1f","text":"<p>Store\uff08\u72b6\u6001\u4ed3\u5e93\uff09\u662f\u7528 Zustand \u521b\u5efa\u7684\u5168\u5c40\u72b6\u6001\u5bb9\u5668\u3002\u5b83\u89e3\u51b3\u7684\u95ee\u9898\u662f\uff1a\u591a\u4e2a\u4e0d\u76f8\u5173\u7684\u7ec4\u4ef6\u9700\u8981\u5171\u4eab\u540c\u4e00\u4efd\u6570\u636e\u3002</p> <p>\u6bd4\u5982 <code>streamStore</code> \u4fdd\u5b58\u4e86\u5f53\u524d SSE \u6d41\u7684\u72b6\u6001\uff08\u662f\u5426\u5728\u6d41\u5f0f\u4f20\u8f93\u3001\u5f53\u524d\u5185\u5bb9\u3001\u5de5\u5177\u8c03\u7528\u7b49\uff09\uff0c\u804a\u5929\u9762\u677f\u548c\u6d88\u606f\u5217\u8868\u90fd\u9700\u8981\u8bfb\u53d6\u8fd9\u4e9b\u6570\u636e\u3002</p> <pre><code>// \u901a\u8fc7 selector \u8bfb\u53d6\u5355\u4e2a\u5b57\u6bb5\uff08\u63a8\u8350\uff0c\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u91cd\u6e32\u67d3\uff09\nconst isStreaming = useStreamStore((s) =&gt; s.isStreaming);\n\n// \u8c03\u7528 action \u4fee\u6539\u72b6\u6001\nconst startStream = useStreamStore((s) =&gt; s.startStream);\nstartStream(url, threadId, messageId);\n</code></pre> <p>Selector \u6a21\u5f0f\uff1a<code>useStreamStore((s) =&gt; s.isStreaming)</code> \u53ea\u5728 <code>isStreaming</code> \u53d8\u5316\u65f6\u89e6\u53d1\u91cd\u6e32\u67d3\u3002\u5982\u679c\u5199\u6210 <code>useStreamStore()</code> \u83b7\u53d6\u6574\u4e2a store\uff0c\u90a3\u4e48 store \u91cc\u4efb\u4f55\u5b57\u6bb5\u53d8\u5316\u90fd\u4f1a\u5bfc\u81f4\u91cd\u6e32\u67d3\uff0c\u5728\u9ad8\u9891\u7387\u6d41\u5f0f\u66f4\u65b0\u65f6\u4f1a\u9020\u6210\u6027\u80fd\u95ee\u9898\u3002</p>"},{"location":"frontend/#\u9875\u9762\u7ed3\u6784","title":"\u9875\u9762\u7ed3\u6784","text":"<p>\u6574\u4e2a\u5e94\u7528\u53ea\u6709\u4e00\u4e2a\u9875\u9762 <code>app/page.tsx</code>\uff0c\u91c7\u7528\u4e09\u680f\u5e03\u5c40\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502          \u2502                      \u2502              \u2502\n\u2502 Sidebar  \u2502     Chat Panel       \u2502  Artifact    \u2502\n\u2502 \u5bf9\u8bdd\u5217\u8868  \u2502     \u804a\u5929\u9762\u677f          \u2502  \u6587\u7a3f\u9762\u677f     \u2502\n\u2502          \u2502                      \u2502              \u2502\n\u2502          \u2502                      \u2502              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>Sidebar\uff1a\u5bf9\u8bdd\u5217\u8868\u3001\u65b0\u5efa\u5bf9\u8bdd\u3001\u5e95\u90e8\u7528\u6237\u83dc\u5355\uff08\u4e3b\u9898\u5207\u6362\u3001\u9000\u51fa\u767b\u5f55\u3001Admin \u7528\u6237\u7ba1\u7406\uff09</li> <li>Chat Panel\uff1a\u6d88\u606f\u5386\u53f2 + \u6d41\u5f0f\u54cd\u5e94 + \u8f93\u5165\u6846</li> <li>Artifact Panel\uff1a\u6587\u7a3f\u9884\u89c8\uff08Markdown\uff09/ \u6e90\u7801 / Diff \u5bf9\u6bd4</li> </ul> <p>Artifact Panel \u9ed8\u8ba4\u9690\u85cf\uff0c\u5f53 Agent \u521b\u5efa/\u66f4\u65b0\u6587\u7a3f\u65f6\u81ea\u52a8\u5f39\u51fa\u3002</p>"},{"location":"frontend/#\u6587\u4ef6\u8be6\u89e3","title":"\u6587\u4ef6\u8be6\u89e3","text":""},{"location":"frontend/#app--nextjs-\u5165\u53e3","title":"<code>app/</code> \u2014 Next.js \u5165\u53e3","text":"\u6587\u4ef6 \u4f5c\u7528 <code>layout.tsx</code> \u6839\u5e03\u5c40\uff0c\u8bbe\u7f6e HTML metadata\u3001\u5b57\u4f53\u3001\u5168\u5c40\u6837\u5f0f <code>page.tsx</code> \u9996\u9875\uff0c\u7ec4\u88c5\u4e09\u680f\u5e03\u5c40 + \u6743\u9650\u786e\u8ba4\u5f39\u7a97\uff08\u88ab <code>AuthGuard</code> \u5305\u88f9\uff09 <code>login/page.tsx</code> \u767b\u5f55\u9875\uff0cusername/password \u8868\u5355 <code>globals.css</code> \u5168\u5c40 CSS\uff08Tailwind \u6307\u4ee4 + \u81ea\u5b9a\u4e49\u6837\u5f0f\uff09"},{"location":"frontend/#types--\u7c7b\u578b\u5b9a\u4e49","title":"<code>types/</code> \u2014 \u7c7b\u578b\u5b9a\u4e49","text":"\u6587\u4ef6 \u4f5c\u7528 <code>index.ts</code> \u624b\u5199\u7684\u4e1a\u52a1\u7c7b\u578b\uff1a<code>ChatRequest</code>\u3001<code>ConversationDetail</code>\u3001<code>ArtifactDetail</code>\u3001<code>LoginRequest</code>\u3001<code>UserInfo</code> \u7b49 <code>events.ts</code> SSE \u4e8b\u4ef6\u7c7b\u578b\uff1a<code>StreamEventType</code> \u679a\u4e3e + \u6bcf\u79cd\u4e8b\u4ef6\u7684\u6570\u636e\u7ed3\u6784 <code>api.d.ts</code> \u4ece\u540e\u7aef OpenAPI schema \u81ea\u52a8\u751f\u6210\u7684\u7c7b\u578b\uff08<code>npm run generate-types</code>\uff09 <p><code>index.ts</code> \u91cc\u7684\u7c7b\u578b\u662f\u524d\u7aef\u81ea\u5df1\u5b9a\u4e49\u7684\u522b\u540d\uff0c\u6bd4 <code>api.d.ts</code> \u66f4\u6613\u7528\u3002\u5f53\u540e\u7aef API \u6539\u4e86\u5b57\u6bb5\u65f6\uff0c\u9700\u8981\u91cd\u65b0\u8dd1 <code>generate-types</code> \u518d\u624b\u52a8\u66f4\u65b0 <code>index.ts</code>\u3002</p>"},{"location":"frontend/#lib--\u5de5\u5177\u51fd\u6570","title":"<code>lib/</code> \u2014 \u5de5\u5177\u51fd\u6570","text":""},{"location":"frontend/#apits--api-\u5ba2\u6237\u7aef","title":"<code>api.ts</code> \u2014 API \u5ba2\u6237\u7aef","text":"<p>\u5c01\u88c5\u4e86\u6240\u6709\u540e\u7aef HTTP \u8bf7\u6c42\uff0c\u63d0\u4f9b\u7c7b\u578b\u5b89\u5168\u7684\u51fd\u6570\uff1a</p> <pre><code>// \u5bf9\u8bdd\u76f8\u5173\nlistConversations(limit, offset)    // GET  /api/v1/chat\ngetConversation(convId)             // GET  /api/v1/chat/:id\nsendMessage(body)                   // POST /api/v1/chat\ndeleteConversation(convId)          // DELETE /api/v1/chat/:id\nresumeExecution(convId, body)       // POST /api/v1/chat/:id/resume\n\n// \u6587\u7a3f\u76f8\u5173\nlistArtifacts(sessionId)            // GET  /api/v1/artifacts/:sessionId\ngetArtifact(sessionId, artifactId)  // GET  /api/v1/artifacts/:sessionId/:id\nlistVersions(sessionId, artifactId) // GET  /api/v1/artifacts/:sessionId/:id/versions\ngetVersion(sessionId, id, version)  // GET  /api/v1/artifacts/:sessionId/:id/versions/:v\n</code></pre> <p>\u5185\u90e8\u7528\u4e00\u4e2a\u901a\u7528\u7684 <code>request&lt;T&gt;()</code> \u51fd\u6570\u5904\u7406 fetch + \u9519\u8bef\u5904\u7406 + JSON \u89e3\u6790\u3002\u6240\u6709\u8bf7\u6c42\u81ea\u52a8\u4ece <code>authStore</code> \u8bfb\u53d6 token \u6ce8\u5165 <code>Authorization: Bearer &lt;token&gt;</code> header\uff0c401 \u54cd\u5e94\u81ea\u52a8\u89e6\u53d1\u767b\u51fa\u3002</p> <p>\u65b0\u589e\u8ba4\u8bc1\u4e0e\u7528\u6237\u7ba1\u7406\u51fd\u6570\uff1a <pre><code>login(body: LoginRequest)              // POST /api/v1/auth/login\uff08\u65e0\u9700 token\uff09\n\n// \u7528\u6237\u7ba1\u7406\uff08Admin\uff09\nlistUsers(limit, offset)               // GET  /api/v1/auth/users\ncreateUser(body: CreateUserRequest)     // POST /api/v1/auth/users\nupdateUser(userId, body: UpdateUserRequest) // PUT  /api/v1/auth/users/:userId\n</code></pre></p>"},{"location":"frontend/#ssets--sse-\u8fde\u63a5","title":"<code>sse.ts</code> \u2014 SSE \u8fde\u63a5","text":"<p>\u4e3a\u4ec0\u4e48\u4e0d\u7528\u6d4f\u89c8\u5668\u539f\u751f\u7684 <code>EventSource</code>\uff1f \u56e0\u4e3a <code>EventSource</code> \u4e0d\u652f\u6301\u81ea\u5b9a\u4e49 Header\uff08\u65e0\u6cd5\u4f20 <code>Authorization</code>\uff09\uff0c\u4e5f\u65e0\u6cd5\u7528 <code>AbortController</code> \u7cbe\u786e\u53d6\u6d88\u8fde\u63a5\u3002SSE \u8fde\u63a5\u540c\u6837\u4ece <code>authStore</code> \u8bfb\u53d6 token \u6ce8\u5165 auth header\uff0c401 \u54cd\u5e94\u89e6\u53d1\u767b\u51fa\u3002</p> <p>\u5b9e\u73b0\u65b9\u5f0f\u662f <code>fetch()</code> + <code>ReadableStream</code> \u624b\u52a8\u89e3\u6790 SSE \u534f\u8bae\uff1a</p> <pre><code>event: agent_start        \u2190 \u4e8b\u4ef6\u7c7b\u578b\ndata: {\"agent\":\"Lead\"}    \u2190 JSON \u6570\u636e\n                          \u2190 \u7a7a\u884c\u5206\u9694\nevent: llm_chunk\ndata: {\"content\":\"\u4f60\u597d\"}\n</code></pre> <p>\u89e3\u6790\u6d41\u7a0b\uff1a\u9010\u884c\u8bfb\u53d6 \u2192 \u9047\u5230 <code>event:</code> \u8bb0\u5f55\u7c7b\u578b \u2192 \u9047\u5230 <code>data:</code> \u89e3\u6790 JSON \u2192 \u56de\u8c03 <code>onEvent</code>\u3002</p>"},{"location":"frontend/#messagetreets--\u6d88\u606f\u6811","title":"<code>messageTree.ts</code> \u2014 \u6d88\u606f\u6811","text":"<p>\u540e\u7aef\u8fd4\u56de\u7684\u6d88\u606f\u662f\u6241\u5e73\u6570\u7ec4\uff0c\u6bcf\u6761\u6d88\u606f\u5e26\u4e00\u4e2a <code>parent_id</code> \u6307\u5411\u5b83\u7684\u7236\u6d88\u606f\u3002\u8fd9\u4e2a\u6587\u4ef6\u8d1f\u8d23\u628a\u6241\u5e73\u6570\u7ec4\u8f6c\u6362\u6210\u6811\u7ed3\u6784\uff0c\u7528\u4e8e\u652f\u6301\u5bf9\u8bdd\u5206\u652f\u3002</p> <pre><code>\u6d88\u606fA (root)\n\u251c\u2500\u2500 \u6d88\u606fB (parent_id = A)\n\u2502   \u251c\u2500\u2500 \u6d88\u606fC (parent_id = B)  \u2190 \u5206\u652f1\n\u2502   \u2514\u2500\u2500 \u6d88\u606fD (parent_id = B)  \u2190 \u5206\u652f2\n\u2514\u2500\u2500 \u6d88\u606fE (parent_id = A)\n</code></pre> <p>\u4e09\u4e2a\u6838\u5fc3\u51fd\u6570\uff1a</p> <ul> <li><code>buildMessageTree(messages)</code>\uff1a\u6241\u5e73\u6570\u7ec4 \u2192 <code>Map&lt;id, MessageNode&gt;</code>\uff0c\u6bcf\u4e2a node \u5e26 <code>childNodes</code>\u3001<code>siblingIndex</code>\u3001<code>siblingCount</code></li> <li><code>extractBranchPath(nodeMap, activeBranch)</code>\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u76ee\u6807\u6d88\u606f ID\uff0c\u4ece root \u5230\u76ee\u6807\u6d88\u606f\u7684\u5b8c\u6574\u8def\u5f84\uff08\u8fd9\u5c31\u662f\u5f53\u524d\u5c55\u793a\u7684\u5bf9\u8bdd\u7ebf\uff09</li> <li><code>getBranchChoicesAtMessage(nodeMap, messageId)</code>\uff1a\u83b7\u53d6\u67d0\u6761\u6d88\u606f\u7684\u6240\u6709\u5144\u5f1f\u8282\u70b9\uff08\u7528\u4e8e\u5206\u652f\u5bfc\u822a\u5668 <code>&lt; 1/3 &gt;</code>\uff09</li> </ul>"},{"location":"frontend/#stores--\u72b6\u6001\u4ed3\u5e93","title":"<code>stores/</code> \u2014 \u72b6\u6001\u4ed3\u5e93","text":""},{"location":"frontend/#conversationstorets--\u5bf9\u8bdd\u72b6\u6001","title":"<code>conversationStore.ts</code> \u2014 \u5bf9\u8bdd\u72b6\u6001","text":"<p>\u7ba1\u7406\u5bf9\u8bdd\u5217\u8868\u548c\u5f53\u524d\u5bf9\u8bdd\u7684\u6240\u6709\u6570\u636e\uff1a</p> \u72b6\u6001 \u8bf4\u660e <code>conversations</code> \u5bf9\u8bdd\u5217\u8868 <code>current</code> \u5f53\u524d\u9009\u4e2d\u7684\u5bf9\u8bdd\u8be6\u60c5\uff08\u542b\u5b8c\u6574\u6d88\u606f\uff09 <code>nodeMap</code> \u6d88\u606f\u6811\uff08<code>Map&lt;id, MessageNode&gt;</code>\uff09 <code>branchPath</code> \u5f53\u524d\u5c55\u793a\u7684\u5206\u652f\u8def\u5f84\uff08\u6d88\u606f\u6570\u7ec4\uff09 <code>activeBranch</code> \u5f53\u524d\u5206\u652f\u672b\u7aef\u7684\u6d88\u606f ID <p>\u5173\u952e\u52a8\u4f5c\uff1a - <code>setCurrent(conv)</code> \u2014 \u8bbe\u7f6e\u5f53\u524d\u5bf9\u8bdd\u65f6\uff0c\u81ea\u52a8\u6784\u5efa\u6d88\u606f\u6811 + \u63d0\u53d6\u5206\u652f\u8def\u5f84 - <code>setActiveBranch(messageId)</code> \u2014 \u5207\u6362\u5206\u652f\u65f6\uff0c\u91cd\u65b0\u8ba1\u7b97\u8def\u5f84</p>"},{"location":"frontend/#streamstorets--\u6d41\u5f0f\u72b6\u6001","title":"<code>streamStore.ts</code> \u2014 \u6d41\u5f0f\u72b6\u6001","text":"<p>\u7ba1\u7406 SSE \u6d41\u5f0f\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u7684\u5b9e\u65f6\u6570\u636e\uff1a</p> \u72b6\u6001 \u8bf4\u660e <code>isStreaming</code> \u662f\u5426\u6b63\u5728\u6d41\u5f0f\u4f20\u8f93 <code>segments</code> \u6267\u884c\u6bb5\u5217\u8868\uff08\u6bcf\u4e2a Agent \u4e00\u6bb5\uff09 <code>pendingUserMessage</code> \u7528\u6237\u6d88\u606f\uff08\u5728\u5bf9\u8bdd\u52a0\u8f7d\u524d\u5148\u663e\u793a\uff09 <code>completedSegments</code> \u5df2\u5b8c\u6210\u6d88\u606f\u7684\u6bb5\u7f13\u5b58\uff08\u6309 messageId \u7d22\u5f15\uff09 <code>permissionRequest</code> \u5f85\u786e\u8ba4\u7684\u6743\u9650\u8bf7\u6c42 <code>error</code> \u9519\u8bef\u4fe1\u606f <p>ExecutionSegment\uff08\u6267\u884c\u6bb5\uff09 \u662f\u6d41\u5f0f\u6e32\u67d3\u7684\u6838\u5fc3\u6982\u5ff5\uff1a</p> <pre><code>interface ExecutionSegment {\n  agent: string;           // Agent \u540d\u79f0\n  status: 'running' | 'complete';\n  reasoningContent: string; // \u601d\u8003\u8fc7\u7a0b\n  isThinking: boolean;     // \u662f\u5426\u6b63\u5728\u601d\u8003\n  toolCalls: ToolCallInfo[];  // \u5de5\u5177\u8c03\u7528\u5217\u8868\n  content: string;         // LLM \u8f93\u51fa\u5185\u5bb9\n}\n</code></pre> <p>\u4e00\u6b21\u5b8c\u6574\u7684\u6267\u884c\u53ef\u80fd\u4ea7\u751f\u591a\u4e2a Segment\uff08Lead Agent \u2192 Search Agent \u2192 Lead Agent\uff09\uff0cUI \u6309 Segment \u5206\u6bb5\u5c55\u793a\u3002</p> <p>\u6027\u80fd\u4f18\u5316\uff1a<code>scheduleContentUpdate()</code> \u4f7f\u7528 <code>requestAnimationFrame</code> \u8282\u6d41\uff0c\u907f\u514d\u6bcf\u4e2a <code>llm_chunk</code> \u4e8b\u4ef6\u90fd\u89e6\u53d1\u4e00\u6b21 Zustand \u72b6\u6001\u66f4\u65b0\u548c React \u91cd\u6e32\u67d3\u3002</p>"},{"location":"frontend/#artifactstorets--\u6587\u7a3f\u72b6\u6001","title":"<code>artifactStore.ts</code> \u2014 \u6587\u7a3f\u72b6\u6001","text":"<p>\u7ba1\u7406\u6587\u7a3f\u9762\u677f\u7684\u6570\u636e\uff1a</p> \u72b6\u6001 \u8bf4\u660e <code>artifacts</code> \u6587\u7a3f\u5217\u8868 <code>current</code> \u5f53\u524d\u9009\u4e2d\u7684\u6587\u7a3f\u8be6\u60c5 <code>versions</code> \u7248\u672c\u5217\u8868 <code>viewMode</code> \u67e5\u770b\u6a21\u5f0f\uff1a<code>preview</code> / <code>source</code> / <code>diff</code> <code>pendingUpdates</code> \u6d41\u5f0f\u8fc7\u7a0b\u4e2d\u6b63\u5728\u66f4\u65b0\u7684\u6587\u7a3f ID"},{"location":"frontend/#authstorets--\u8ba4\u8bc1\u72b6\u6001","title":"<code>authStore.ts</code> \u2014 \u8ba4\u8bc1\u72b6\u6001","text":"<p>\u7ba1\u7406\u7528\u6237\u767b\u5f55\u6001\uff1a</p> \u72b6\u6001 \u8bf4\u660e <code>token</code> JWT access token <code>user</code> \u5f53\u524d\u7528\u6237\u4fe1\u606f\uff08UserInfo\uff09 <code>isAuthenticated</code> \u662f\u5426\u5df2\u767b\u5f55 <code>isHydrated</code> \u662f\u5426\u5df2\u4ece localStorage \u6062\u590d\u72b6\u6001 <p>\u5173\u952e\u52a8\u4f5c\uff1a - <code>login(token, user)</code> \u2014 \u767b\u5f55\u6210\u529f\u540e\u5b58\u50a8 token \u548c\u7528\u6237\u4fe1\u606f\u5230 state + localStorage - <code>logout()</code> \u2014 \u6e05\u9664\u6240\u6709\u8ba4\u8bc1\u72b6\u6001\u548c localStorage - <code>hydrate()</code> \u2014 \u4ece localStorage \u540c\u6b65\u6062\u590d\u8ba4\u8bc1\u72b6\u6001\uff08\u5e94\u7528\u542f\u52a8\u65f6\u8c03\u7528\uff09</p> <p>\u6301\u4e45\u5316 key\uff1a<code>af_token</code>\u3001<code>af_user</code>\uff08localStorage\uff09\u3002</p>"},{"location":"frontend/#uistorets--ui-\u72b6\u6001","title":"<code>uiStore.ts</code> \u2014 UI \u72b6\u6001","text":"<p>\u6700\u7b80\u5355\u7684 store\uff0c\u7ba1\u7406\u4e09\u4e2a UI \u5f00\u5173\uff1a</p> <ul> <li><code>sidebarCollapsed</code> \u2014 \u4fa7\u8fb9\u680f\u6298\u53e0</li> <li><code>artifactPanelVisible</code> \u2014 \u6587\u7a3f\u9762\u677f\u663e\u793a</li> <li><code>theme</code> \u2014 \u4eae\u8272 / \u6697\u8272\u4e3b\u9898\uff08\u901a\u8fc7 <code>document.documentElement.classList.toggle('dark')</code> \u5207\u6362\uff09</li> </ul>"},{"location":"frontend/#hooks--\u81ea\u5b9a\u4e49-hook","title":"<code>hooks/</code> \u2014 \u81ea\u5b9a\u4e49 Hook","text":""},{"location":"frontend/#usessets--sse-\u4e8b\u4ef6\u5904\u7406","title":"<code>useSSE.ts</code> \u2014 SSE \u4e8b\u4ef6\u5904\u7406","text":"<p>\u6700\u590d\u6742\u7684 Hook\uff0c\u8d1f\u8d23\u628a\u540e\u7aef\u63a8\u9001\u7684 SSE \u4e8b\u4ef6\u7ffb\u8bd1\u6210 store \u72b6\u6001\u66f4\u65b0\u3002</p> <p>\u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b\uff1a</p> <pre><code>\u540e\u7aef\u63a8\u9001\u4e8b\u4ef6 \u2192 connectSSE() \u89e3\u6790 \u2192 handleEvent() \u5206\u53d1 \u2192 \u66f4\u65b0\u5404 store\n</code></pre> <p>\u5404\u4e8b\u4ef6\u7684\u5904\u7406\uff1a</p> \u4e8b\u4ef6 \u5904\u7406 <code>AGENT_START</code> \u521b\u5efa\u65b0 Segment <code>LLM_CHUNK</code> \u8ffd\u52a0\u601d\u8003\u5185\u5bb9 / \u8f93\u51fa\u5185\u5bb9\uff08RAF \u8282\u6d41\uff09 <code>LLM_COMPLETE</code> \u8bbe\u7f6e\u6700\u7ec8\u5185\u5bb9 <code>TOOL_START</code> \u6dfb\u52a0\u5de5\u5177\u8c03\u7528\u5361\u7247 <code>TOOL_COMPLETE</code> \u66f4\u65b0\u5de5\u5177\u8c03\u7528\u72b6\u6001 + \u5982\u679c\u662f\u6587\u7a3f\u5de5\u5177\u5219\u62c9\u53d6\u6587\u7a3f <code>AGENT_COMPLETE</code> \u6807\u8bb0 Segment \u5b8c\u6210 <code>PERMISSION_REQUEST</code> \u5f39\u51fa\u6743\u9650\u786e\u8ba4\u5f39\u7a97 <code>COMPLETE</code> \u5feb\u7167 Segments \u2192 \u5237\u65b0\u5bf9\u8bdd\u548c\u6587\u7a3f <code>ERROR</code> \u663e\u793a\u9519\u8bef\u4fe1\u606f <p>\u6587\u7a3f\u76f8\u5173\u7684\u7279\u6b8a\u903b\u8f91\uff1a\u5f53 <code>create_artifact</code> / <code>update_artifact</code> / <code>rewrite_artifact</code> \u5de5\u5177\u5b8c\u6210\u65f6\uff0c\u81ea\u52a8\u6253\u5f00\u6587\u7a3f\u9762\u677f\u5e76\u62c9\u53d6\u6700\u65b0\u5185\u5bb9\u3002</p>"},{"location":"frontend/#usechatts--\u804a\u5929\u64cd\u4f5c","title":"<code>useChat.ts</code> \u2014 \u804a\u5929\u64cd\u4f5c","text":"<p>\u5c01\u88c5\u4e86\u53d1\u6d88\u606f\u7684\u6838\u5fc3\u6d41\u7a0b\uff1a</p> <pre><code>\u7528\u6237\u8f93\u5165 \u2192 sendMessage() \u2192 POST /api/v1/chat \u2192 \u62ff\u5230 stream_url \u2192 connectSSE()\n</code></pre> <p>\u5904\u7406\u4e09\u79cd\u53d1\u6d88\u606f\u573a\u666f\uff1a - \u6b63\u5e38\u53d1\u9001\uff1a<code>parentMessageId</code> \u4e3a undefined\uff0c\u81ea\u52a8\u7528\u5f53\u524d\u5206\u652f\u6700\u540e\u4e00\u6761\u6d88\u606f\u4f5c\u4e3a parent - \u91cd\u8dd1\uff08rerun\uff09\uff1a<code>parentMessageId</code> \u4e3a\u6307\u5b9a\u7684\u6d88\u606f ID - \u65b0\u5bf9\u8bdd\uff1a<code>conversation_id</code> \u4e3a\u7a7a</p>"},{"location":"frontend/#useartifactsts--\u6587\u7a3f\u64cd\u4f5c","title":"<code>useArtifacts.ts</code> \u2014 \u6587\u7a3f\u64cd\u4f5c","text":"<p>\u52a0\u8f7d\u548c\u7ba1\u7406\u6587\u7a3f\u76f8\u5173\u6570\u636e\u3002</p>"},{"location":"frontend/#usemediaqueryts--\u54cd\u5e94\u5f0f\u65ad\u70b9","title":"<code>useMediaQuery.ts</code> \u2014 \u54cd\u5e94\u5f0f\u65ad\u70b9","text":"<p>\u68c0\u6d4b\u5c4f\u5e55\u5bbd\u5ea6\uff0c\u7528\u4e8e\u54cd\u5e94\u5f0f\u5e03\u5c40\uff08\u6bd4\u5982\u5c0f\u5c4f\u81ea\u52a8\u6298\u53e0\u4fa7\u8fb9\u680f\uff09\u3002</p>"},{"location":"frontend/#components--ui-\u7ec4\u4ef6","title":"<code>components/</code> \u2014 UI \u7ec4\u4ef6","text":""},{"location":"frontend/#\u8ba4\u8bc1\u7ec4\u4ef6","title":"\u8ba4\u8bc1\u7ec4\u4ef6","text":"\u7ec4\u4ef6 \u4f5c\u7528 <code>AuthGuard</code> \u8def\u7531\u4fdd\u62a4\u7ec4\u4ef6\uff0c\u5305\u88f9\u9700\u8ba4\u8bc1\u7684\u9875\u9762\u3002\u7b49\u5f85 <code>hydrate()</code> \u5b8c\u6210\u540e\u68c0\u67e5\u767b\u5f55\u6001\uff0c\u672a\u767b\u5f55\u5219\u91cd\u5b9a\u5411\u5230 <code>/login</code>"},{"location":"frontend/#\u5e03\u5c40\u7ec4\u4ef6-layout","title":"\u5e03\u5c40\u7ec4\u4ef6 (<code>layout/</code>)","text":"\u7ec4\u4ef6 \u4f5c\u7528 <code>ThreeColumnLayout</code> \u4e09\u680f\u5e03\u5c40\u5bb9\u5668\uff0c\u652f\u6301\u62d6\u62fd\u8c03\u6574\u6587\u7a3f\u9762\u677f\u5bbd\u5ea6\uff0c\u5904\u7406\u54cd\u5e94\u5f0f\u65ad\u70b9 <code>PermissionModal</code> \u6743\u9650\u786e\u8ba4\u5f39\u7a97\uff08Agent \u8bf7\u6c42\u6267\u884c\u53d7\u9650\u5de5\u5177\u65f6\u5f39\u51fa\uff09"},{"location":"frontend/#\u4fa7\u8fb9\u680f\u7ec4\u4ef6-sidebar","title":"\u4fa7\u8fb9\u680f\u7ec4\u4ef6 (<code>sidebar/</code>)","text":"\u7ec4\u4ef6 \u4f5c\u7528 <code>Sidebar</code> \u4fa7\u8fb9\u680f\u5bb9\u5668\uff1a\u65b0\u5efa\u5bf9\u8bdd\u6309\u94ae\u3001\u5bf9\u8bdd\u5217\u8868\u3001\u6587\u7a3f\u5207\u6362\u3001\u5e95\u90e8\u7528\u6237\u83dc\u5355 <code>ConversationList</code> \u5bf9\u8bdd\u5217\u8868\uff0c\u652f\u6301\u5206\u9875 <code>ConversationItem</code> \u5355\u6761\u5bf9\u8bdd\u9879\uff08\u6807\u9898\u3001\u65f6\u95f4\u3001\u5220\u9664\u6309\u94ae\uff09 <code>UserMenu</code> \u5e95\u90e8\u7528\u6237\u7ec4\u4ef6\uff1a\u5934\u50cf + \u7528\u6237\u540d\uff0c\u70b9\u51fb\u5f39\u51fa Popover\uff08\u4e3b\u9898\u5207\u6362\u3001\u9000\u51fa\u767b\u5f55\u3001Admin \u7ba1\u7406\u5165\u53e3\uff09 <code>UserManagementModal</code> Admin \u7528\u6237\u7ba1\u7406\u5f39\u7a97\uff1a\u7528\u6237\u5217\u8868\u3001\u65b0\u5efa\u7528\u6237\u3001\u7f16\u8f91\u663e\u793a\u540d\u79f0\u3001\u542f\u7528/\u7981\u7528"},{"location":"frontend/#\u804a\u5929\u7ec4\u4ef6-chat","title":"\u804a\u5929\u7ec4\u4ef6 (<code>chat/</code>)","text":"\u7ec4\u4ef6 \u4f5c\u7528 <code>ChatPanel</code> \u804a\u5929\u9762\u677f\u4e3b\u5bb9\u5668\uff0c\u4e09\u79cd\u72b6\u6001\u5207\u6362\uff1a\u6b22\u8fce\u9875 / \u6d88\u606f\u5217\u8868 / \u6d41\u5f0f\u65b0\u5bf9\u8bdd <code>MessageList</code> \u6e32\u67d3\u5f53\u524d\u5206\u652f\u8def\u5f84\u4e0a\u7684\u6240\u6709\u6d88\u606f <code>MessageInput</code> \u8f93\u5165\u6846 + \u53d1\u9001 / \u4e0a\u4f20\u6309\u94ae <code>UserMessage</code> \u7528\u6237\u6d88\u606f\u6c14\u6ce1\uff08\u652f\u6301\u7f16\u8f91\u3001\u91cd\u8dd1\u3001\u5206\u652f\u5bfc\u822a\uff09 <code>AssistantMessage</code> \u52a9\u624b\u6d88\u606f\uff08\u5c55\u793a Agent \u6267\u884c\u6bb5 + \u5206\u652f\u5bfc\u822a\uff09 <code>StreamingMessage</code> \u6d41\u5f0f\u54cd\u5e94\uff08\u6b63\u5728\u751f\u6210\u4e2d\u7684\u6d88\u606f\uff09 <code>AgentSegmentBlock</code> \u5355\u4e2a Agent \u6267\u884c\u6bb5\uff08\u601d\u8003 + \u5de5\u5177\u8c03\u7528 + \u8f93\u51fa\uff09 <code>BranchNavigator</code> \u5206\u652f\u5bfc\u822a\u5668 <code>&lt; 1/3 &gt;</code>\uff0c\u5207\u6362\u540c\u4e00\u4f4d\u7f6e\u7684\u4e0d\u540c\u56de\u590d <code>ToolCallCard</code> \u5de5\u5177\u8c03\u7528\u5361\u7247\uff08\u540d\u79f0\u3001\u53c2\u6570\u3001\u7ed3\u679c\u3001\u8017\u65f6\uff09 <code>ThinkingBlock</code> \u53ef\u6298\u53e0\u7684\u601d\u8003\u8fc7\u7a0b\u5757 <code>AgentBadge</code> Agent \u540d\u79f0\u6807\u7b7e"},{"location":"frontend/#\u6587\u7a3f\u7ec4\u4ef6-artifact","title":"\u6587\u7a3f\u7ec4\u4ef6 (<code>artifact/</code>)","text":"\u7ec4\u4ef6 \u4f5c\u7528 <code>ArtifactPanel</code> \u6587\u7a3f\u9762\u677f\u5bb9\u5668\uff0c\u8def\u7531\u5230\u5217\u8868/\u8be6\u60c5\u89c6\u56fe <code>ArtifactList</code> \u6587\u7a3f\u5217\u8868 <code>ArtifactToolbar</code> \u9876\u90e8\u5de5\u5177\u680f\uff08\u8fd4\u56de\u3001\u6587\u7a3f\u4fe1\u606f\u3001\u4e0b\u8f7d\u3001\u7248\u672c\u9009\u62e9\uff09 <code>ArtifactTabs</code> \u89c6\u56fe\u5207\u6362\u6807\u7b7e\uff08Preview / Source / Diff\uff09 <code>MarkdownPreview</code> Markdown \u6e32\u67d3\u9884\u89c8 <code>SourceView</code> \u6e90\u7801\u67e5\u770b <code>DiffView</code> \u7248\u672c\u5dee\u5f02\u5bf9\u6bd4"},{"location":"frontend/#\u6570\u636e\u6d41\u5168\u666f","title":"\u6570\u636e\u6d41\u5168\u666f","text":""},{"location":"frontend/#\u53d1\u9001\u6d88\u606f","title":"\u53d1\u9001\u6d88\u606f","text":"<pre><code>\u7528\u6237\u8f93\u5165\u6587\u672c\n    \u2502\n    \u25bc\nuseChat.sendMessage(content)\n    \u2502\n    \u251c\u2500 POST /api/v1/chat \u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u540e\u7aef\u5f00\u59cb\u6267\u884c\n    \u2502   \u8fd4\u56de { stream_url, conversation_id, message_id }\n    \u2502\n    \u251c\u2500 streamStore.startStream()  \u2190 \u8bbe\u7f6e\u6d41\u5f0f\u72b6\u6001\n    \u251c\u2500 streamStore.setPendingUserMessage()  \u2190 \u7acb\u5373\u663e\u793a\u7528\u6237\u6d88\u606f\n    \u2502\n    \u2514\u2500 useSSE.connect(stream_url)\n        \u2502\n        \u25bc\n    GET /api/v1/stream/:thread_id \uff08SSE \u957f\u8fde\u63a5\uff09\n        \u2502\n        \u251c\u2500 event: agent_start    \u2192 pushSegment(\"Lead\")\n        \u251c\u2500 event: llm_chunk      \u2192 scheduleContentUpdate(content)  [RAF \u8282\u6d41]\n        \u251c\u2500 event: tool_start     \u2192 addToolCallToSegment(...)\n        \u251c\u2500 event: tool_complete  \u2192 updateToolCallInSegment(...)\n        \u251c\u2500 event: agent_complete \u2192 updateCurrentSegment({ status: 'complete' })\n        \u251c\u2500 ...\uff08\u53ef\u80fd\u5faa\u73af\u591a\u4e2a Agent\uff09\n        \u2502\n        \u2514\u2500 event: complete\n            \u251c\u2500 snapshotSegments()     \u2190 \u7f13\u5b58\u6267\u884c\u6bb5\n            \u251c\u2500 endStream()            \u2190 \u7ed3\u675f\u6d41\u5f0f\u72b6\u6001\n            \u2514\u2500 refreshAfterComplete() \u2190 \u91cd\u65b0\u62c9\u53d6\u5bf9\u8bdd + \u6587\u7a3f\u6570\u636e\n</code></pre>"},{"location":"frontend/#\u5bf9\u8bdd\u5206\u652f","title":"\u5bf9\u8bdd\u5206\u652f","text":"<pre><code>\u6d88\u606fA (user: \"\u641c\u7d22 AI \u65b0\u95fb\")\n\u251c\u2500\u2500 \u6d88\u606fB (assistant: \u56de\u590d1)          \u2190 \u5206\u652f 1/2\n\u2502   \u2514\u2500\u2500 \u6d88\u606fC (user: \"\u8be6\u7ec6\u8bf4\u8bf4\")\n\u2502       \u2514\u2500\u2500 \u6d88\u606fD (assistant: ...)\n\u2514\u2500\u2500 \u6d88\u606fE (assistant: \u56de\u590d2)          \u2190 \u5206\u652f 2/2  [\u7528\u6237\u70b9\u4e86\u91cd\u8dd1]\n    \u2514\u2500\u2500 \u6d88\u606fF (user: \"\u6362\u4e2a\u89d2\u5ea6\")\n\n\u5f53\u524d\u5206\u652f\u8def\u5f84 branchPath = [A, E, F]\nBranchNavigator \u5728\u6d88\u606f E \u5904\u663e\u793a &lt; 2/2 &gt;\uff0c\u70b9\u51fb\u53ef\u5207\u56de [A, B, C, D]\n</code></pre>"},{"location":"frontend/#\u6587\u7a3f\u66f4\u65b0","title":"\u6587\u7a3f\u66f4\u65b0","text":"<pre><code>Agent \u8c03\u7528 create_artifact / update_artifact\n    \u2502\n    \u25bc\nSSE: tool_complete (tool_name = \"create_artifact\")\n    \u2502\n    \u251c\u2500 setArtifactPanelVisible(true)   \u2190 \u81ea\u52a8\u6253\u5f00\u6587\u7a3f\u9762\u677f\n    \u251c\u2500 addPendingUpdate(artifactId)     \u2190 \u6807\u8bb0\u6b63\u5728\u66f4\u65b0\n    \u2514\u2500 \u5e76\u884c\u62c9\u53d6\u6587\u7a3f\u8be6\u60c5 + \u5217\u8868 + \u7248\u672c\n        \u2502\n        \u25bc\n    \u6587\u7a3f\u9762\u677f\u5b9e\u65f6\u66f4\u65b0\u5185\u5bb9\n\nSSE: complete\n    \u2514\u2500 clearPendingUpdates()           \u2190 \u6e05\u9664\u5f85\u66f4\u65b0\u6807\u8bb0\n</code></pre>"},{"location":"frontend/#\u6837\u5f0f\u7cfb\u7edf","title":"\u6837\u5f0f\u7cfb\u7edf","text":"<p>\u4f7f\u7528 Tailwind CSS + \u81ea\u5b9a\u4e49\u8bbe\u8ba1\u7cfb\u7edf\uff08RAMS\uff09\uff0c\u5728 <code>tailwind.config.ts</code> \u4e2d\u5b9a\u4e49\uff1a</p> <ul> <li>\u8bed\u4e49\u5316\u989c\u8272\uff1a<code>text-primary</code>\u3001<code>bg-surface</code>\u3001<code>border-border</code> \u7b49\uff0c\u6bcf\u4e2a\u989c\u8272\u90fd\u6709 dark \u53d8\u4f53</li> <li>\u6697\u8272\u6a21\u5f0f\uff1a\u901a\u8fc7 <code>class</code> \u7b56\u7565\uff0c<code>&lt;html class=\"dark\"&gt;</code> \u5207\u6362</li> <li>\u7ec4\u4ef6\u6837\u5f0f\uff1a<code>rounded-bubble</code>\uff08\u6d88\u606f\u6c14\u6ce1\u5706\u89d2\uff09\u3001<code>shadow-card</code>\uff08\u5361\u7247\u9634\u5f71\uff09\u7b49</li> </ul> <pre><code>// \u5178\u578b\u7528\u6cd5\uff1a\u540c\u65f6\u5199\u4eae\u8272\u548c\u6697\u8272\n&lt;div className=\"bg-surface dark:bg-surface-dark text-text-primary dark:text-text-primary-dark\"&gt;\n</code></pre>"},{"location":"request-lifecycle/","title":"Request Lifecycle","text":"<p>\u672c\u6587\u6863\u8be6\u7ec6\u63cf\u8ff0\u4e00\u4e2a\u8bf7\u6c42\u4ece\u8fdb\u5165 API \u5230\u8fd4\u56de\u7ed3\u679c\u7684\u5b8c\u6574\u751f\u547d\u5468\u671f\u3002</p>"},{"location":"request-lifecycle/#\u6574\u4f53\u6d41\u7a0b","title":"\u6574\u4f53\u6d41\u7a0b","text":"<pre><code>sequenceDiagram\n    participant Client\n    participant FastAPI\n    participant StreamManager\n    participant Controller\n    participant Graph\n    participant Agent\n    participant Tool\n    participant DB\n\n    Client-&gt;&gt;FastAPI: POST /api/v1/chat (+ Bearer Token)\n    FastAPI-&gt;&gt;FastAPI: JWT \u9a8c\u8bc1 + DB \u6821\u9a8c\u7528\u6237\u72b6\u6001\n    FastAPI-&gt;&gt;DB: \u786e\u4fdd Conversation \u5b58\u5728\uff08\u6821\u9a8c ownership\uff09\n    FastAPI-&gt;&gt;StreamManager: create_stream(thread_id, owner_user_id)\n    FastAPI-&gt;&gt;Client: \u8fd4\u56de {thread_id, stream_url}\n\n    FastAPI-&gt;&gt;Controller: \u540e\u53f0\u542f\u52a8 stream_execute()\n    Controller-&gt;&gt;Graph: astream(initial_state)\n\n    loop Agent Execution\n        Graph-&gt;&gt;Agent: agent.stream(messages)\n        Agent-&gt;&gt;Agent: LLM \u8c03\u7528\n        Agent-&gt;&gt;Graph: yield StreamEvent\n        Graph-&gt;&gt;StreamManager: push(llm_chunk)\n\n        opt Tool Call\n            Graph-&gt;&gt;Tool: execute_tool()\n            Tool-&gt;&gt;Graph: ToolResult\n            Graph-&gt;&gt;StreamManager: push(tool_complete)\n        end\n    end\n\n    Graph-&gt;&gt;Controller: \u6700\u7ec8\u72b6\u6001\n    Controller-&gt;&gt;DB: \u4fdd\u5b58\u54cd\u5e94\n    Controller-&gt;&gt;StreamManager: push(complete)\n\n    Client-&gt;&gt;FastAPI: GET /stream/{thread_id} (+ Bearer Token)\n    FastAPI-&gt;&gt;FastAPI: JWT \u9a8c\u8bc1\n    FastAPI-&gt;&gt;StreamManager: consume_events(thread_id, user_id)\n    StreamManager--&gt;&gt;Client: SSE \u4e8b\u4ef6\u6d41</code></pre>"},{"location":"request-lifecycle/#phase-1-\u8bf7\u6c42\u63a5\u6536\u4e0e\u521d\u59cb\u5316","title":"Phase 1: \u8bf7\u6c42\u63a5\u6536\u4e0e\u521d\u59cb\u5316","text":""},{"location":"request-lifecycle/#api-\u5c42\u5904\u7406","title":"API \u5c42\u5904\u7406","text":"<pre><code># POST /api/v1/chat\n{\n    \"content\": \"\u5e2e\u6211\u5206\u6790\u4e00\u4e0b Python \u5f02\u6b65\u7f16\u7a0b\u7684\u6700\u4f73\u5b9e\u8df5\",\n    \"conversation_id\": null,  # null \u8868\u793a\u65b0\u5bf9\u8bdd\n    \"parent_message_id\": null\n}\n</code></pre> <p>\u4f9d\u8d56\u6ce8\u5165\u94fe\uff08<code>src/api/dependencies.py</code>\uff09\uff1a</p> <pre><code>flowchart LR\n    subgraph Auth[\"\u8ba4\u8bc1\"]\n        Bearer[\"HTTPBearer\"]\n        CU[\"get_current_user()&lt;br/&gt;JWT \u89e3\u7801 + DB \u6821\u9a8c\"]\n    end\n\n    subgraph Request[\"\u8bf7\u6c42\u7ea7\u522b\"]\n        Session[\"get_db_session()&lt;br/&gt;AsyncSession\"]\n        AM[\"get_artifact_manager()\"]\n        CM[\"get_conversation_manager()\"]\n        Ctrl[\"get_controller()\"]\n    end\n\n    subgraph Global[\"\u5168\u5c40\u5355\u4f8b\"]\n        CP[\"get_checkpointer()&lt;br/&gt;AsyncSqliteSaver\"]\n        SM[\"get_stream_manager()&lt;br/&gt;StreamManager\"]\n    end\n\n    HTTP[\"HTTP Request\"] --&gt; Bearer --&gt; CU\n    HTTP --&gt; Session\n    CU --&gt; Session\n    Session --&gt; AM\n    Session --&gt; CM\n    Session --&gt; Ctrl\n    HTTP --&gt; CP\n    HTTP --&gt; SM</code></pre> <p><code>get_current_user()</code> \u5728\u6bcf\u4e2a\u53d7\u4fdd\u62a4\u7aef\u70b9\u7684\u5165\u53e3\u6267\u884c\uff1a\u89e3\u7801 JWT \u2192 \u67e5 DB \u6821\u9a8c <code>is_active</code> \u548c\u6700\u65b0 <code>role</code>\uff08\u786e\u4fdd\u7981\u7528/\u964d\u6743\u5373\u65f6\u751f\u6548\uff09\u3002<code>/health</code> \u548c <code>/auth/login</code> \u4e0d\u9700\u8981\u8ba4\u8bc1\u3002</p>"},{"location":"request-lifecycle/#conversation-\u521b\u5efa","title":"Conversation \u521b\u5efa","text":"<p>\u5982\u679c <code>conversation_id</code> \u4e3a\u7a7a\uff0cController \u4f1a\u5728 <code>_stream_new_message()</code> \u4e2d\uff1a</p> <ol> <li>\u8c03\u7528 <code>conversation_manager.start_conversation_async()</code> \u751f\u6210\u65b0 ID</li> <li>\u5728\u6570\u636e\u5e93\u521b\u5efa <code>Conversation</code> \u8bb0\u5f55</li> <li>Artifact session ID \u4e0e conversation ID \u76f8\u540c</li> </ol> <pre><code># src/core/controller.py - _stream_new_message() \u4e2d\u7684\u903b\u8f91\nif not conversation_id:\n    conversation_id = await self.conversation_manager.start_conversation_async()\nelse:\n    await self.conversation_manager.ensure_conversation_exists(conversation_id)\n</code></pre> <p>\u6ce8\u610f\uff1a\u7528\u6237\u5f52\u5c5e\u7531 API \u5c42\uff08<code>chat.py</code>\uff09\u8d1f\u8d23\uff0c\u4e0d\u5728 Controller \u4e2d\u5904\u7406\u3002Router \u5c42\u5728\u8fdb\u5165 Controller \u4e4b\u524d\u5b8c\u6210\uff1a - \u65b0\u5efa\u4f1a\u8bdd\u65f6\uff0c<code>ensure_conversation_exists(conversation_id, user_id=user_id)</code> \u7ed1\u5b9a owner - \u5df2\u6709\u4f1a\u8bdd\u65f6\uff0c<code>_verify_ownership()</code> \u6821\u9a8c <code>conv.user_id == current_user.user_id</code>\uff0c\u4e0d\u5339\u914d\u8fd4\u56de 404</p>"},{"location":"request-lifecycle/#phase-2-\u72b6\u6001\u51c6\u5907","title":"Phase 2: \u72b6\u6001\u51c6\u5907","text":""},{"location":"request-lifecycle/#\u5bf9\u8bdd\u5386\u53f2\u683c\u5f0f\u5316","title":"\u5bf9\u8bdd\u5386\u53f2\u683c\u5f0f\u5316","text":"<p><code>ConversationManager</code> \u4ece\u6d88\u606f\u6811\u4e2d\u63d0\u53d6\u5f53\u524d\u5206\u652f\u7684\u5386\u53f2\uff1a</p> <pre><code># \u6811\u72b6\u7ed3\u6784\u793a\u4f8b\n#       msg_1 (root)\n#      /      \\\n#   msg_2    msg_3\n#     |\n#   msg_4 (current)\n\n# \u683c\u5f0f\u5316\u7ed3\u679c\uff08\u4ece root \u5230 current \u7684\u8def\u5f84\uff09\n# \u8fd4\u56de List[Dict]\uff0c\u7528\u4e8e\u540e\u7eed\u6784\u5efa LLM messages\nconversation_history = [\n    {\"role\": \"user\", \"content\": \"\u7b2c\u4e00\u6761\u6d88\u606f\"},\n    {\"role\": \"assistant\", \"content\": \"\u7b2c\u4e00\u6761\u56de\u590d\"},\n    {\"role\": \"user\", \"content\": \"\u7b2c\u4e8c\u6761\u6d88\u606f\"},\n    {\"role\": \"assistant\", \"content\": \"\u7b2c\u4e8c\u6761\u56de\u590d\"}\n]\n</code></pre>"},{"location":"request-lifecycle/#\u521d\u59cb\u72b6\u6001\u6784\u5efa","title":"\u521d\u59cb\u72b6\u6001\u6784\u5efa","text":"<pre><code># src/core/state.py - create_initial_state()\ninitial_state = {\n    \"current_task\": \"\u5e2e\u6211\u5206\u6790\u4e00\u4e0b Python \u5f02\u6b65\u7f16\u7a0b\u7684\u6700\u4f73\u5b9e\u8df5\",\n    \"session_id\": conversation_id, # session_id \u4e0e conversation_id \u76f8\u540c\uff0c\u7528\u4e8e\u5bf9\u8bdd\u4e0eArtifact\u6620\u5c04\n    \"thread_id\": f\"thd-{uuid4().hex}\",\n    \"conversation_history\": [...],  # List[Dict]\uff0c\u683c\u5f0f\u5316\u7684\u5bf9\u8bdd\u5386\u53f2\n    \"phase\": ExecutionPhase.LEAD_EXECUTING,\n    \"current_agent\": \"lead_agent\",\n    \"subagent_pending\": None,\n    \"pending_tool_call\": None,\n    \"agent_memories\": {},\n    \"compression_level\": \"normal\",\n    \"user_message_id\": f\"msg-{uuid4().hex}\",\n    \"graph_response\": None,\n    \"execution_metrics\": create_initial_metrics()\n}\n</code></pre>"},{"location":"request-lifecycle/#phase-3-graph-\u6267\u884c","title":"Phase 3: Graph \u6267\u884c","text":""},{"location":"request-lifecycle/#\u6267\u884c\u6a21\u5f0f","title":"\u6267\u884c\u6a21\u5f0f","text":"<p>ArtifactFlow \u4f7f\u7528 LangGraph \u7684 <code>stream_mode=\"custom\"</code> \u5b9e\u73b0\u6d41\u5f0f\u8f93\u51fa\uff1a</p> <pre><code># src/core/controller.py\nasync for event in self.graph.astream(\n    initial_state,\n    config={\"configurable\": {\"thread_id\": thread_id}},\n    stream_mode=\"custom\"\n):\n    yield event  # StreamEvent\n</code></pre>"},{"location":"request-lifecycle/#agent-\u8282\u70b9\u6267\u884c","title":"Agent \u8282\u70b9\u6267\u884c","text":"<p>\u6bcf\u4e2a Agent \u8282\u70b9\u6267\u884c\u5355\u8f6e LLM \u8c03\u7528\uff1a</p> <pre><code>flowchart TD\n    A[\u51c6\u5907 Messages] --&gt; B[LLM \u8c03\u7528]\n    B --&gt; C{\u89e3\u6790\u54cd\u5e94}\n    C --&gt;|tool_call| D[\u8bbe\u7f6e TOOL_EXECUTING]\n    C --&gt;|call_subagent| E[\u8bbe\u7f6e SUBAGENT_EXECUTING]\n    C --&gt;|\u5b8c\u6210| F[\u8bbe\u7f6e COMPLETED]\n    D --&gt; G[\u66f4\u65b0\u72b6\u6001]\n    E --&gt; G\n    F --&gt; G</code></pre> <p>\u6d88\u606f\u6784\u5efa\uff08<code>src/core/context_manager.py</code>\uff09\uff1a</p> <p><code>ContextManager.build_agent_messages()</code> \u6309\u987a\u5e8f\u62fc\u88c5 messages \u5217\u8868\uff1a</p> <pre><code># Part 1: System prompt\nmessages = [{\"role\": \"system\", \"content\": system_prompt}]\n\n# Part 2: Conversation history\uff08\u4ec5 Lead Agent\uff09\n# \u81ea\u52a8\u538b\u7f29\uff0c\u81f3\u5c11\u4fdd\u7559\u6700\u8fd1 4 \u6761\uff082 \u8f6e\u5bf9\u8bdd\uff09\nif agent.config.name == \"lead_agent\" and conversation_history:\n    messages.extend(compressed_history)\n\n# Part 3: Current instruction\nmessages.append({\"role\": \"user\", \"content\": instruction})\n\n# Part 4: Tool interactions\uff08\u5982\u679c\u6709\uff09\n# assistant/user \u4ea4\u66ff\u7684\u5de5\u5177\u8c03\u7528\u5386\u53f2\nif tool_interactions:\n    messages.extend(compressed_tool_interactions)\n\n# Part 5: Pending tool result\uff08\u5982\u679c\u6709\uff09\nif pending_tool_result:\n    messages.append({\"role\": \"user\", \"content\": formatted_result})\n</code></pre>"},{"location":"request-lifecycle/#\u72b6\u6001\u8def\u7531","title":"\u72b6\u6001\u8def\u7531","text":"<p>\u8def\u7531\u57fa\u4e8e <code>ExecutionPhase</code> \u51b3\u5b9a\u4e0b\u4e00\u4e2a\u8282\u70b9\uff08\u5b9a\u4e49\u5728 <code>_add_routing_rules()</code> \u4e2d\uff09\uff1a</p> <pre><code># src/core/graph.py - route_func \u5185\u90e8\u51fd\u6570\ndef route_func(state: AgentState) -&gt; str:\n    phase = state[\"phase\"]\n\n    if phase == ExecutionPhase.TOOL_EXECUTING:\n        return \"tool_execution\"\n    elif phase == ExecutionPhase.SUBAGENT_EXECUTING:\n        return state[\"subagent_pending\"][\"target\"]\n    elif phase == ExecutionPhase.LEAD_EXECUTING:\n        return \"lead_agent\"\n    elif phase == ExecutionPhase.COMPLETED:\n        return END\n    else:\n        return END\n</code></pre>"},{"location":"request-lifecycle/#\u5de5\u5177\u6267\u884c\u8282\u70b9","title":"\u5de5\u5177\u6267\u884c\u8282\u70b9","text":"<p>\u7edf\u4e00\u5904\u7406\u6240\u6709\u5de5\u5177\u8c03\u7528\uff0c\u5305\u62ec\u6743\u9650\u68c0\u67e5\uff1a</p> <pre><code>flowchart TD\n    A[\u83b7\u53d6 pending_tool_call] --&gt; B[\u67e5\u627e\u5de5\u5177]\n    B --&gt; C{\u68c0\u67e5\u6743\u9650}\n    C --&gt;|AUTO| D[\u76f4\u63a5\u6267\u884c]\n    C --&gt;|CONFIRM| E[interrupt \u8bf7\u6c42\u786e\u8ba4]\n    E --&gt; F{\u7528\u6237\u54cd\u5e94}\n    F --&gt;|approved| D\n    F --&gt;|denied| G[\u8fd4\u56de\u62d2\u7edd\u7ed3\u679c]\n    D --&gt; H[\u8bb0\u5f55 metrics]\n    H --&gt; I[\u8fd4\u56de\u539f Agent]</code></pre>"},{"location":"request-lifecycle/#phase-4-\u4e8b\u4ef6\u6d41\u4e0e-sse","title":"Phase 4: \u4e8b\u4ef6\u6d41\u4e0e SSE","text":""},{"location":"request-lifecycle/#\u4e8b\u4ef6\u7c7b\u578b","title":"\u4e8b\u4ef6\u7c7b\u578b","text":"<pre><code># src/core/events.py\nclass StreamEventType(Enum):\n    # Controller \u5c42\n    METADATA = \"metadata\"\n    COMPLETE = \"complete\"\n    ERROR = \"error\"\n\n    # Agent \u5c42\n    AGENT_START = \"agent_start\"\n    LLM_CHUNK = \"llm_chunk\"\n    LLM_COMPLETE = \"llm_complete\"\n    AGENT_COMPLETE = \"agent_complete\"\n\n    # Graph \u5c42\n    TOOL_START = \"tool_start\"\n    TOOL_COMPLETE = \"tool_complete\"\n    PERMISSION_REQUEST = \"permission_request\"\n    PERMISSION_RESULT = \"permission_result\"\n</code></pre>"},{"location":"request-lifecycle/#\u4e8b\u4ef6\u7f13\u51b2","title":"\u4e8b\u4ef6\u7f13\u51b2","text":"<p>\u7531\u4e8e POST \u8bf7\u6c42\u7acb\u5373\u8fd4\u56de\uff0cSSE \u8fde\u63a5\u7a0d\u540e\u5efa\u7acb\uff0c\u9700\u8981\u7f13\u51b2\u4e2d\u95f4\u4e8b\u4ef6\uff1a</p> <pre><code>sequenceDiagram\n    participant Client\n    participant POST as POST /chat\n    participant Queue as StreamManager\n    participant Graph\n    participant GET as GET /stream\n\n    Client-&gt;&gt;POST: \u53d1\u9001\u6d88\u606f\n    POST-&gt;&gt;Queue: create_stream(thread_id)\n    Note over Queue: TTL \u8ba1\u65f6\u5668\u542f\u52a8 (30s)\n    POST-&gt;&gt;Client: \u8fd4\u56de thread_id\n\n    POST-&gt;&gt;Graph: \u540e\u53f0\u6267\u884c\n    Graph-&gt;&gt;Queue: push(agent_start)\n    Graph-&gt;&gt;Queue: push(llm_chunk)\n\n    Client-&gt;&gt;GET: \u8fde\u63a5 SSE\n    GET-&gt;&gt;Queue: consume_events(thread_id)\n    Note over Queue: \u53d6\u6d88 TTL \u8ba1\u65f6\u5668\n    Queue-&gt;&gt;GET: yield events\n    GET-&gt;&gt;Client: SSE \u63a8\u9001\n\n    Graph-&gt;&gt;Queue: push(complete)\n    Queue-&gt;&gt;GET: yield complete\n    GET-&gt;&gt;Client: SSE: complete\n    Note over Queue: \u6e05\u7406\u961f\u5217</code></pre>"},{"location":"request-lifecycle/#sse-\u683c\u5f0f","title":"SSE \u683c\u5f0f","text":"<p>\u4f7f\u7528\u6807\u51c6 SSE <code>event:</code> \u5b57\u6bb5\u533a\u5206\u4e8b\u4ef6\u7c7b\u578b\uff0c<code>data:</code> JSON \u5185\u540c\u65f6\u4fdd\u7559 <code>type</code> \u5b57\u6bb5\u4ee5\u4fbf\u7edf\u4e00\u89e3\u6790\uff1a</p> <pre><code>event: metadata\ndata: {\"type\":\"metadata\",\"timestamp\":\"...\",\"data\":{\"conversation_id\":\"xxx\",\"thread_id\":\"yyy\",\"message_id\":\"zzz\"}}\n\nevent: agent_start\ndata: {\"type\":\"agent_start\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"\",\"metadata\":{...}}}\n\nevent: llm_chunk\ndata: {\"type\":\"llm_chunk\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"\u8ba9\u6211\",\"metadata\":{...}}}\n\nevent: llm_chunk\ndata: {\"type\":\"llm_chunk\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"\u8ba9\u6211\u6765\u5206\u6790\",\"metadata\":{...}}}\n\nevent: llm_complete\ndata: {\"type\":\"llm_complete\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"...\",\"token_usage\":{...}}}\n\nevent: agent_complete\ndata: {\"type\":\"agent_complete\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"...\",\"routing\":{\"type\":\"tool_call\",...}}}\n\nevent: tool_start\ndata: {\"type\":\"tool_start\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"tool\":\"web_search\",\"data\":{\"params\":{\"query\":\"Python async best practices\"}}}\n\nevent: tool_complete\ndata: {\"type\":\"tool_complete\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"tool\":\"web_search\",\"data\":{\"success\":true,\"duration_ms\":1234,\"error\":null,\"params\":{\"query\":\"Python async best practices\"},\"result_data\":{...}}}\n\nevent: complete\ndata: {\"type\":\"complete\",\"timestamp\":\"...\",\"data\":{\"success\":true,\"interrupted\":false,\"response\":\"...\",\"execution_metrics\":{...}}}\n</code></pre> <p>\u5173\u952e\u70b9\uff1a - <code>llm_chunk.data.content</code> \u662f\u7d2f\u79ef\u5185\u5bb9\uff0c\u6bcf\u6b21\u4e8b\u4ef6\u5305\u542b\u4ece\u5934\u5f00\u59cb\u7684\u5b8c\u6574\u6587\u672c - <code>tool_complete</code> \u5305\u542b <code>params</code>\uff08\u5de5\u5177\u8c03\u7528\u53c2\u6570\uff09\u548c <code>result_data</code>\uff08\u5de5\u5177\u8fd4\u56de\u7684\u4e1a\u52a1\u6570\u636e\uff09\uff0c\u524d\u7aef\u53ef\u7528\u4e8e\u8ffd\u8e2a\u5de5\u5177\u6267\u884c\u8be6\u60c5 - <code>complete</code> \u4e8b\u4ef6\u7684 <code>interrupted</code> \u5b57\u6bb5\u6307\u793a\u662f\u5426\u9700\u8981\u7528\u6237\u786e\u8ba4\u6743\u9650</p> <p>\u8be6\u7ec6\u5b57\u6bb5\u8bf4\u660e\u89c1 API Reference\u3002</p>"},{"location":"request-lifecycle/#phase-5-\u6743\u9650\u4e2d\u65ad\u4e0e\u6062\u590d","title":"Phase 5: \u6743\u9650\u4e2d\u65ad\u4e0e\u6062\u590d","text":"<p>\u5f53\u5de5\u5177\u9700\u8981\u7528\u6237\u786e\u8ba4\u65f6\uff1a</p>"},{"location":"request-lifecycle/#\u4e2d\u65ad\u6d41\u7a0b","title":"\u4e2d\u65ad\u6d41\u7a0b","text":"<pre><code># src/core/graph.py - tool_execution_node\nif tool.permission == ToolPermission.CONFIRM:\n    # \u53d1\u9001\u6743\u9650\u8bf7\u6c42\u4e8b\u4ef6\n    writer({\n        \"type\": StreamEventType.PERMISSION_REQUEST.value,\n        \"agent\": from_agent,\n        \"tool\": tool_name,\n        \"timestamp\": datetime.now().isoformat(),\n        \"data\": {\n            \"permission_level\": tool.permission.value,\n            \"params\": params\n        }\n    })\n\n    # \u6682\u505c\u6267\u884c\uff0c\u7b49\u5f85\u7528\u6237\u786e\u8ba4\n    is_approved = interrupt({\n        \"type\": \"tool_permission\",\n        \"agent\": from_agent,\n        \"tool_name\": tool_name,\n        \"params\": params,\n        \"permission_level\": tool.permission.value,\n        \"message\": f\"Tool '{tool_name}' requires {tool.permission.value} permission\"\n    })\n</code></pre>"},{"location":"request-lifecycle/#\u6062\u590d\u6d41\u7a0b","title":"\u6062\u590d\u6d41\u7a0b","text":"<pre><code># POST /api/v1/chat/{conversation_id}/resume\n{\n    \"thread_id\": \"thd-xxx\",\n    \"message_id\": \"msg-yyy\",  # \u8981\u66f4\u65b0\u7684\u6d88\u606f ID\n    \"approved\": true\n}\n\n# Controller \u6062\u590d\u6267\u884c\nawait graph.astream(\n    Command(resume=approved),\n    config={\"configurable\": {\"thread_id\": thread_id}},\n    stream_mode=\"custom\"\n)\n</code></pre>"},{"location":"request-lifecycle/#phase-6-\u7ed3\u679c\u6301\u4e45\u5316","title":"Phase 6: \u7ed3\u679c\u6301\u4e45\u5316","text":"<p>\u6570\u636e\u6301\u4e45\u5316\u91c7\u7528\u77ed\u4e8b\u52a1\u6a21\u5f0f\uff1a\u6bcf\u6b21\u5199\u64cd\u4f5c\u5728 Repository \u5c42\u7acb\u5373 <code>flush() + commit()</code>\uff0c\u800c\u975e\u5728 session \u9000\u51fa\u65f6\u7edf\u4e00\u63d0\u4ea4\u3002\u8fd9\u907f\u514d\u4e86\u957f\u4e8b\u52a1\u6301\u6709 SQLite \u5199\u9501\u5bfc\u81f4\u7684 <code>database is locked</code> \u9519\u8bef\u3002</p> <pre><code># \u66f4\u65b0\u6d88\u606f\u7684 graph_response\uff08Repository \u5185\u90e8\u7acb\u5373 commit\uff09\nawait self.conversation_manager.update_response_async(\n    conv_id=conversation_id,\n    message_id=message_id,\n    response=final_response\n)\n\n# Artifact \u53d8\u66f4\u5df2\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u901a\u8fc7\u5de5\u5177\u4fdd\u5b58\uff08\u6bcf\u6b21\u5de5\u5177\u8c03\u7528\u72ec\u7acb commit\uff09\n# \u7248\u672c\u5386\u53f2\u81ea\u52a8\u8bb0\u5f55\n</code></pre>"},{"location":"request-lifecycle/#\u6570\u636e\u6d41\u603b\u7ed3","title":"\u6570\u636e\u6d41\u603b\u7ed3","text":"<pre><code>flowchart TB\n    Client[\"Client\"]\n\n    subgraph API[\"API Layer\"]\n        FastAPI[\"FastAPI\"]\n        SSE[\"SSE Stream\"]\n    end\n\n    subgraph Core[\"Core Layer\"]\n        Controller[\"Controller\"]\n        Graph[\"Graph\"]\n        SM[\"StreamManager\"]\n    end\n\n    subgraph Agents[\"Agents\"]\n        Lead[\"Lead\"]\n        Search[\"Search\"]\n        Crawl[\"Crawl\"]\n    end\n\n    Tools[\"Tools\"]\n\n    subgraph DB[\"Database\"]\n        Convos[\"Conversations\"]\n        Artifacts[\"Artifacts\"]\n    end\n\n    Client --&gt;|HTTP Request| FastAPI\n    FastAPI --&gt; Controller\n    Controller --&gt; Graph\n    Graph --&gt; Agents\n    Agents --&gt; Tools\n    Tools --&gt; DB\n    Controller --&gt; DB\n\n    Graph --&gt;|Events| SM\n    SM --&gt; SSE\n    SSE --&gt;|SSE| Client</code></pre>"},{"location":"streaming/","title":"\u6d41\u5f0f\u4e8b\u4ef6\u7cfb\u7edf","text":"<p>ArtifactFlow \u4f7f\u7528 Server-Sent Events (SSE) \u5b9e\u73b0\u5b9e\u65f6\u4e8b\u4ef6\u63a8\u9001\uff0c\u8ba9\u524d\u7aef\u80fd\u591f\u5373\u65f6\u5c55\u793a\u6267\u884c\u8fdb\u5ea6\u3002</p>"},{"location":"streaming/#\u67b6\u6784\u6982\u89c8","title":"\u67b6\u6784\u6982\u89c8","text":"<pre><code>flowchart TB\n    subgraph Graph[\"Graph \u6267\u884c\"]\n        Agent[\"Agent Node\"]\n        Tool[\"Tool Node\"]\n    end\n\n    subgraph Events[\"\u4e8b\u4ef6\u4ea7\u751f\"]\n        E1[\"LLM_CHUNK\"]\n        E2[\"AGENT_COMPLETE\"]\n        E3[\"TOOL_START\"]\n        E4[\"TOOL_COMPLETE\"]\n    end\n\n    subgraph Pipeline[\"\u4e8b\u4ef6\u7ba1\u9053\"]\n        Controller[\"Controller\"]\n        SM[\"StreamManager&lt;br/&gt;(Event Queue)\"]\n        SSE[\"SSE \u7aef\u70b9\"]\n    end\n\n    Agent --&gt; E1\n    Agent --&gt; E2\n    Tool --&gt; E3\n    Tool --&gt; E4\n\n    E1 &amp; E2 &amp; E3 &amp; E4 --&gt; Controller\n    Controller --&gt; SM\n    SM --&gt; SSE\n    SSE --&gt; Client[\"Client\"]</code></pre>"},{"location":"streaming/#\u4e8b\u4ef6\u7c7b\u578b","title":"\u4e8b\u4ef6\u7c7b\u578b","text":""},{"location":"streaming/#\u5b8c\u6574\u4e8b\u4ef6\u5217\u8868","title":"\u5b8c\u6574\u4e8b\u4ef6\u5217\u8868","text":"\u4e8b\u4ef6\u7c7b\u578b \u6765\u6e90 \u8bf4\u660e data \u4e3b\u8981\u5b57\u6bb5 <code>metadata</code> Controller \u521d\u59cb\u5143\u6570\u636e <code>{conversation_id, thread_id, message_id}</code> <code>agent_start</code> Agent Agent \u5f00\u59cb\u6267\u884c <code>{success, content, metadata}</code> <code>llm_chunk</code> Agent LLM \u6d41\u5f0f\u8f93\u51fa\u7247\u6bb5 <code>{success, content*, reasoning_content, metadata, token_usage}</code> <code>llm_complete</code> Agent LLM \u5355\u6b21\u8c03\u7528\u5b8c\u6210 <code>{success, content, reasoning_content, metadata, token_usage}</code> <code>agent_complete</code> Agent Agent \u5355\u8f6e\u5b8c\u6210 <code>{success, content, routing, metadata, token_usage}</code> <code>tool_start</code> Graph \u5de5\u5177\u5f00\u59cb\u6267\u884c <code>{params}</code> <code>tool_complete</code> Graph \u5de5\u5177\u6267\u884c\u5b8c\u6210 <code>{success, duration_ms, error, params, result_data}</code> <code>permission_request</code> Graph \u8bf7\u6c42\u6743\u9650\u786e\u8ba4 <code>{permission_level, params}</code> <code>permission_result</code> Graph \u6743\u9650\u786e\u8ba4\u7ed3\u679c <code>{approved}</code> <code>complete</code> Controller \u6267\u884c\u5b8c\u6210 <code>{success, interrupted, response, execution_metrics, ...}</code> <code>error</code> Controller \u6267\u884c\u9519\u8bef <code>{success, error, conversation_id, ...}</code> <p>\u6ce8\u610f\uff1a <code>llm_chunk.content</code> \u662f\u7d2f\u79ef\u5185\u5bb9\uff0c\u975e\u589e\u91cf delta\u3002\u8be6\u7ec6\u5b57\u6bb5\u8bf4\u660e\u89c1 API Reference\u3002</p>"},{"location":"streaming/#\u4e8b\u4ef6\u65f6\u5e8f\u793a\u4f8b","title":"\u4e8b\u4ef6\u65f6\u5e8f\u793a\u4f8b","text":"<pre><code>sequenceDiagram\n    participant S as Server\n    participant C as Client\n\n    S-&gt;&gt;C: metadata\n    S-&gt;&gt;C: agent_start (lead_agent)\n    Note right of C: content \u662f\u7d2f\u79ef\u7684\n    S-&gt;&gt;C: llm_chunk {content: \"\u8ba9\u6211\"}\n    S-&gt;&gt;C: llm_chunk {content: \"\u8ba9\u6211\u6765\u5206\u6790\"}\n    S-&gt;&gt;C: llm_chunk {content: \"\u8ba9\u6211\u6765\u5206\u6790\u8fd9\u4e2a\u95ee\u9898\"}\n    S-&gt;&gt;C: llm_complete\n    S-&gt;&gt;C: agent_complete {routing: tool_call}\n\n    S-&gt;&gt;C: tool_start (web_search)\n    Note over S: \u6267\u884c\u5de5\u5177\n    S-&gt;&gt;C: tool_complete {success, duration_ms, params, result_data}\n\n    S-&gt;&gt;C: agent_start (lead_agent)\n    Note right of C: \u65b0\u4e00\u8f6e\uff0ccontent \u91cd\u65b0\u5f00\u59cb\n    S-&gt;&gt;C: llm_chunk {content: \"\u6839\u636e\u641c\u7d22\u7ed3\u679c...\"}\n    S-&gt;&gt;C: llm_complete\n    S-&gt;&gt;C: agent_complete {routing: null}\n\n    S-&gt;&gt;C: complete {response, execution_metrics}</code></pre>"},{"location":"streaming/#streammanager","title":"StreamManager","text":""},{"location":"streaming/#\u6838\u5fc3\u804c\u8d23","title":"\u6838\u5fc3\u804c\u8d23","text":"<ol> <li>\u4e8b\u4ef6\u7f13\u51b2\uff1aPOST \u8bf7\u6c42\u8fd4\u56de\u540e\uff0cGraph \u7ee7\u7eed\u6267\u884c\u4ea7\u751f\u7684\u4e8b\u4ef6\u9700\u8981\u7f13\u51b2</li> <li>\u961f\u5217\u7ba1\u7406\uff1a\u6bcf\u4e2a <code>thread_id</code> \u5bf9\u5e94\u72ec\u7acb\u7684\u4e8b\u4ef6\u961f\u5217</li> <li>TTL \u6e05\u7406\uff1a\u9632\u6b62\u524d\u7aef\u672a\u8fde\u63a5\u5bfc\u81f4\u7684\u5185\u5b58\u6cc4\u6f0f</li> </ol>"},{"location":"streaming/#\u5b9e\u73b0","title":"\u5b9e\u73b0","text":"<pre><code># src/api/services/stream_manager.py\n\n@dataclass\nclass StreamContext:\n    queue: asyncio.Queue = field(default_factory=asyncio.Queue)\n    created_at: datetime = field(default_factory=datetime.now)\n    status: Literal[\"pending\", \"streaming\", \"closed\"] = \"pending\"\n    ttl_task: Optional[asyncio.Task] = None\n    owner_user_id: Optional[str] = None  # \u7ed1\u5b9a\u521b\u5efa\u8005\uff0c\u6d88\u8d39\u65f6\u6821\u9a8c\n\nclass StreamManager:\n    def __init__(self, ttl_seconds: int = 30):\n        self.streams: Dict[str, StreamContext] = {}\n        self.ttl_seconds = ttl_seconds\n\n    async def create_stream(self, thread_id: str, owner_user_id: str = None) -&gt; StreamContext:\n        \"\"\"\u521b\u5efa\u65b0\u7684\u4e8b\u4ef6\u6d41\"\"\"\n        context = StreamContext(owner_user_id=owner_user_id)\n        self.streams[thread_id] = context\n\n        # \u542f\u52a8 TTL \u8ba1\u65f6\u5668\n        context.ttl_task = asyncio.create_task(\n            self._ttl_cleanup(thread_id)\n        )\n\n        return context\n\n    async def push_event(self, thread_id: str, event: Dict[str, Any]) -&gt; bool:\n        \"\"\"\u63a8\u9001\u4e8b\u4ef6\u5230\u961f\u5217\"\"\"\n        context = self.streams.get(thread_id)\n        if not context or context.status == \"closed\":\n            return False\n        await context.queue.put(event)\n        return True\n\n    async def consume_events(\n        self,\n        thread_id: str,\n        user_id: str = None\n    ) -&gt; AsyncGenerator[Dict[str, Any], None]:\n        \"\"\"\u6d88\u8d39\u4e8b\u4ef6\u6d41\uff08\u6821\u9a8c owner\uff09\"\"\"\n        context = self.streams.get(thread_id)\n        if not context:\n            raise StreamNotFoundError(thread_id)\n\n        # \u6821\u9a8c ownership\uff1a\u975e\u521b\u5efa\u8005\u4e0d\u80fd\u6d88\u8d39\n        if context.owner_user_id and user_id != context.owner_user_id:\n            raise StreamNotFoundError(thread_id)\n\n        # \u53d6\u6d88 TTL \u8ba1\u65f6\u5668\n        if context.ttl_task:\n            context.ttl_task.cancel()\n            context.ttl_task = None\n\n        context.status = \"streaming\"\n\n        try:\n            while True:\n                event = await context.queue.get()\n                yield event\n\n                # \u68c0\u67e5\u662f\u5426\u7ed3\u675f\n                if event.get(\"type\") in (\"complete\", \"error\"):\n                    break\n        finally:\n            await self.close_stream(thread_id)\n\n    async def _ttl_cleanup(self, thread_id: str):\n        \"\"\"TTL \u8d85\u65f6\u6e05\u7406\"\"\"\n        await asyncio.sleep(self.ttl_seconds)\n\n        context = self.streams.get(thread_id)\n        if context and context.status == \"pending\":\n            # \u524d\u7aef\u672a\u8fde\u63a5\uff0c\u6e05\u7406\u961f\u5217\n            await self._close_stream_internal(thread_id)\n</code></pre>"},{"location":"streaming/#\u65f6\u5e8f\u56fe","title":"\u65f6\u5e8f\u56fe","text":"<p>\u5b8c\u6574\u7684\u4e8b\u4ef6\u7f13\u51b2\u65f6\u5e8f\u56fe\u89c1 Request Lifecycle \u2014 \u4e8b\u4ef6\u7f13\u51b2\u3002</p>"},{"location":"streaming/#sse-\u7aef\u70b9","title":"SSE \u7aef\u70b9","text":""},{"location":"streaming/#\u5b9e\u73b0_1","title":"\u5b9e\u73b0","text":"<pre><code># src/api/routers/stream.py\n\n@router.get(\"/{thread_id}\")\nasync def stream_events(\n    thread_id: str,\n    current_user: TokenPayload = Depends(get_current_user),\n    stream_manager: StreamManager = Depends(get_stream_manager),\n) -&gt; StreamingResponse:\n    async def event_generator() -&gt; AsyncGenerator[str, None]:\n        try:\n            async for event in stream_manager.consume_events(thread_id, user_id=current_user.user_id):\n                yield format_sse_event(event, event=event.get(\"type\"))\n\n                # \u68c0\u67e5\u662f\u5426\u662f\u7ec8\u7ed3\u4e8b\u4ef6\n                if event.get(\"type\") in (\"complete\", \"error\"):\n                    break\n\n        except StreamNotFoundError:\n            error_event = {\"type\": \"error\", \"data\": {\"error\": f\"Stream not found\"}}\n            yield format_sse_event(error_event, event=\"error\")\n\n    return StreamingResponse(\n        event_generator(),\n        media_type=\"text/event-stream\",\n        headers={\n            \"Cache-Control\": \"no-cache\",\n            \"Connection\": \"keep-alive\",\n            \"X-Accel-Buffering\": \"no\",  # \u7981\u7528 nginx \u7f13\u51b2\n        }\n    )\n\n# src/api/utils/sse.py\ndef format_sse_event(data: Dict[str, Any], event: str = None) -&gt; str:\n    \"\"\"\n    \u683c\u5f0f\u5316\u4e3a SSE \u534f\u8bae\n\n    Args:\n        data: \u4e8b\u4ef6\u6570\u636e\uff08\u6574\u4e2a\u4e8b\u4ef6\u5b57\u5178\uff0c\u5305\u542b type \u5b57\u6bb5\uff09\n        event: SSE event \u540d\u79f0\uff08\u4ece\u4e8b\u4ef6 type \u5b57\u6bb5\u63d0\u53d6\uff09\n\n    Returns:\n        \u683c\u5f0f\u5316\u7684 SSE \u5b57\u7b26\u4e32\n    \"\"\"\n    lines = []\n    if event:\n        lines.append(f\"event: {event}\")\n    json_data = json.dumps(data, ensure_ascii=False)\n    lines.append(f\"data: {json_data}\")\n    return \"\\n\".join(lines) + \"\\n\\n\"\n</code></pre>"},{"location":"streaming/#sse-\u534f\u8bae\u683c\u5f0f","title":"SSE \u534f\u8bae\u683c\u5f0f","text":"<p>\u4f7f\u7528\u6807\u51c6 SSE <code>event:</code> \u5b57\u6bb5\u533a\u5206\u4e8b\u4ef6\u7c7b\u578b\uff0c<code>data:</code> JSON \u5185\u540c\u65f6\u4fdd\u7559 <code>type</code> \u5b57\u6bb5\u4ee5\u4fbf\u7edf\u4e00\u89e3\u6790\uff1a</p> <pre><code>event: metadata\ndata: {\"type\":\"metadata\",\"timestamp\":\"...\",\"data\":{\"conversation_id\":\"abc\",\"thread_id\":\"xyz\",\"message_id\":\"123\"}}\n\nevent: agent_start\ndata: {\"type\":\"agent_start\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"\",\"metadata\":{...}}}\n\nevent: llm_chunk\ndata: {\"type\":\"llm_chunk\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"\u8ba9\u6211\",\"metadata\":{...}}}\n\nevent: llm_chunk\ndata: {\"type\":\"llm_chunk\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"\u8ba9\u6211\u6765\u5206\u6790\",\"metadata\":{...}}}\n\nevent: llm_complete\ndata: {\"type\":\"llm_complete\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"\u8ba9\u6211\u6765\u5206\u6790...\",\"token_usage\":{...}}}\n\nevent: agent_complete\ndata: {\"type\":\"agent_complete\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"data\":{\"success\":true,\"content\":\"...\",\"routing\":{\"type\":\"tool_call\",\"tool_name\":\"web_search\",\"params\":{...}}}}\n\nevent: tool_start\ndata: {\"type\":\"tool_start\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"tool\":\"web_search\",\"data\":{\"params\":{\"query\":\"Python async\"}}}\n\nevent: tool_complete\ndata: {\"type\":\"tool_complete\",\"timestamp\":\"...\",\"agent\":\"lead_agent\",\"tool\":\"web_search\",\"data\":{\"success\":true,\"duration_ms\":1234,\"error\":null,\"params\":{\"query\":\"Python async\"},\"result_data\":\"&lt;search_results&gt;...&lt;/search_results&gt;\"}}\n\nevent: complete\ndata: {\"type\":\"complete\",\"timestamp\":\"...\",\"data\":{\"success\":true,\"interrupted\":false,\"response\":\"...\",\"execution_metrics\":{...}}}\n</code></pre> <p>\u5173\u952e\u70b9\uff1a - <code>llm_chunk.data.content</code> \u662f\u7d2f\u79ef\u5185\u5bb9\uff0c\u6bcf\u6b21\u4e8b\u4ef6\u5305\u542b\u4ece\u5934\u5f00\u59cb\u7684\u5b8c\u6574\u6587\u672c - <code>tool_complete</code> \u5305\u542b <code>params</code>\uff08\u5de5\u5177\u8c03\u7528\u53c2\u6570\uff09\u548c <code>result_data</code>\uff08\u5de5\u5177\u8fd4\u56de\u7684\u4e1a\u52a1\u6570\u636e\uff09 - <code>complete</code> \u4e8b\u4ef6\u7684 <code>interrupted</code> \u5b57\u6bb5\u6307\u793a\u662f\u5426\u9700\u8981\u7528\u6237\u786e\u8ba4\u6743\u9650</p>"},{"location":"streaming/#\u524d\u7aef\u96c6\u6210","title":"\u524d\u7aef\u96c6\u6210","text":""},{"location":"streaming/#javascript-\u793a\u4f8b","title":"JavaScript \u793a\u4f8b","text":"<p>\u524d\u7aef\u4f7f\u7528 <code>fetch</code> + <code>ReadableStream</code>\uff08\u800c\u975e <code>EventSource</code>\uff09\u8fde\u63a5 SSE\uff0c\u4ee5\u4fbf\u643a\u5e26 <code>Authorization</code> header\uff1a</p> <pre><code>async function chat(content) {\n  const token = localStorage.getItem('af_token');\n  const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};\n\n  // 1. \u53d1\u9001\u6d88\u606f\n  const response = await fetch('/api/v1/chat', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json', ...authHeaders },\n    body: JSON.stringify({ content })\n  });\n  const { thread_id, conversation_id, message_id, stream_url } = await response.json();\n\n  // 2. \u8fde\u63a5 SSE\uff08\u4f7f\u7528 fetch \u4ee5\u652f\u6301 Authorization header\uff09\n  const sseRes = await fetch(stream_url, {\n    headers: { Accept: 'text/event-stream', ...authHeaders },\n  });\n\n  // \u89e3\u6790 SSE \u6d41...\n  // \u5b9e\u9645\u5b9e\u73b0\u53c2\u8003 frontend/src/lib/sse.ts\n\n  // \u5177\u4f53\u7684 SSE \u6d41\u89e3\u6790\u548c\u4e8b\u4ef6\u5206\u53d1\u903b\u8f91\u8be6\u89c1 API Reference \u7684\u524d\u7aef\u96c6\u6210\u793a\u4f8b\n}\n</code></pre> <p>\u6ce8\u610f\uff1a\u6d4f\u89c8\u5668\u539f\u751f\u7684 <code>EventSource</code> \u4e0d\u652f\u6301\u81ea\u5b9a\u4e49 Header\uff0c\u65e0\u6cd5\u4f20\u9012 <code>Authorization</code>\u3002ArtifactFlow \u524d\u7aef\u4f7f\u7528 <code>fetch()</code> + <code>ReadableStream</code> \u624b\u52a8\u89e3\u6790 SSE \u534f\u8bae\uff0c\u8be6\u89c1 \u524d\u7aef\u67b6\u6784 \u2014 sse.ts\u3002</p>"},{"location":"streaming/#react-hook-\u793a\u4f8b","title":"React Hook \u793a\u4f8b","text":"<p>ArtifactFlow \u524d\u7aef\u7684\u5b9e\u9645\u5b9e\u73b0\u4f7f\u7528 Zustand store \u7ba1\u7406\u8ba4\u8bc1\u548c\u6d41\u5f0f\u72b6\u6001\uff0c\u8be6\u89c1\uff1a - <code>frontend/src/stores/authStore.ts</code> \u2014 \u8ba4\u8bc1\u72b6\u6001\u7ba1\u7406 - <code>frontend/src/hooks/useSSE.ts</code> \u2014 SSE \u4e8b\u4ef6\u5904\u7406 - <code>frontend/src/hooks/useChat.ts</code> \u2014 \u804a\u5929\u64cd\u4f5c\u5c01\u88c5 - <code>frontend/src/lib/sse.ts</code> \u2014 SSE \u8fde\u63a5\uff08fetch + auth header\uff09</p>"},{"location":"streaming/#\u6743\u9650\u4e2d\u65ad\u5904\u7406","title":"\u6743\u9650\u4e2d\u65ad\u5904\u7406","text":"<p>\u5f53\u9047\u5230\u9700\u8981\u786e\u8ba4\u7684\u5de5\u5177\u65f6\uff1a</p>"},{"location":"streaming/#\u540e\u7aef\u6d41\u7a0b","title":"\u540e\u7aef\u6d41\u7a0b","text":"<pre><code># tool_execution_node \u4e2d\nif tool.permission == ToolPermission.CONFIRM:\n    # \u53d1\u9001 PERMISSION_REQUEST \u4e8b\u4ef6\n    writer({\n        \"type\": StreamEventType.PERMISSION_REQUEST.value,\n        \"agent\": from_agent,\n        \"tool\": tool_name,\n        \"timestamp\": datetime.now().isoformat(),\n        \"data\": {\n            \"permission_level\": tool.permission.value,\n            \"params\": params\n        }\n    })\n\n    # \u4e2d\u65ad\u6267\u884c\uff0c\u7b49\u5f85\u7528\u6237\u786e\u8ba4\n    is_approved = interrupt({\n        \"type\": \"tool_permission\",\n        \"agent\": from_agent,\n        \"tool_name\": tool_name,\n        \"params\": params,\n        \"permission_level\": tool.permission.value,\n        \"message\": f\"Tool '{tool_name}' requires {tool.permission.value} permission\"\n    })\n\n    # \u53d1\u9001 PERMISSION_RESULT \u4e8b\u4ef6\n    writer({\n        \"type\": StreamEventType.PERMISSION_RESULT.value,\n        \"agent\": from_agent,\n        \"tool\": tool_name,\n        \"timestamp\": datetime.now().isoformat(),\n        \"data\": {\"approved\": is_approved}\n    })\n\n    if not is_approved:\n        # \u7528\u6237\u62d2\u7edd\uff0c\u8fd4\u56de\u9519\u8bef\u7ed3\u679c\n        ...\n</code></pre>"},{"location":"streaming/#\u524d\u7aef\u5904\u7406","title":"\u524d\u7aef\u5904\u7406","text":"<p>\u6743\u9650\u4e2d\u65ad\u662f\u4e00\u4e2a\u4e24\u6b65\u6d41\u7a0b\uff0c\u524d\u7aef\u4f1a\u4f9d\u6b21\u6536\u5230\u4e24\u4e2a\u4e8b\u4ef6\uff1a 1. <code>permission_request</code> \u4e8b\u4ef6 - \u5728 <code>interrupt()</code> \u524d\u53d1\u9001\uff0c\u63d0\u524d\u901a\u77e5\u524d\u7aef\u5373\u5c06\u4e2d\u65ad\uff08\u53ef\u7528\u4e8e\u663e\u793a\u7b49\u5f85\u72b6\u6001\uff09 2. <code>complete</code> \u4e8b\u4ef6 (<code>interrupted=true</code>) - \u6267\u884c\u5df2\u6682\u505c\uff0c\u5305\u542b\u5b8c\u6574\u4e2d\u65ad\u6570\u636e\uff0c\u524d\u7aef\u636e\u6b64\u5f39\u51fa\u786e\u8ba4\u5bf9\u8bdd\u6846\u5e76\u53d1\u8d77 resume \u8bf7\u6c42</p> <pre><code>// SSE \u4e8b\u4ef6\u89e3\u6790\u56de\u8c03\u4e2d\uff0c\u6309 event \u5b57\u6bb5\u5206\u53d1\u5904\u7406\uff1a\n\nasync function handleSSEEvent(eventType, parsed) {\n  if (eventType === 'permission_request') {\n    // \u6b65\u9aa41\uff1a\u63d0\u524d\u663e\u793a\u7b49\u5f85\u72b6\u6001\n    const { tool, data } = parsed;\n    showPendingPermission(tool, data.permission_level, data.params);\n  }\n\n  if (eventType === 'complete') {\n    // \u6b65\u9aa42\uff1a\u68c0\u67e5\u662f\u5426\u6743\u9650\u4e2d\u65ad\n    const { data } = parsed;\n    if (!data.interrupted) return;\n\n  const { interrupt_data, thread_id, message_id, conversation_id } = data;\n\n  // \u663e\u793a\u786e\u8ba4\u5bf9\u8bdd\u6846\n  const approved = await showConfirmDialog({\n    title: `\u786e\u8ba4\u6267\u884c ${interrupt_data.tool_name}`,\n    message: interrupt_data.message,\n    details: interrupt_data.params\n  });\n\n  const token = localStorage.getItem('af_token');\n  const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};\n\n  // \u53d1\u9001\u6062\u590d\u8bf7\u6c42\n  const res = await fetch(`/api/v1/chat/${conversation_id}/resume`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json', ...authHeaders },\n    body: JSON.stringify({\n      thread_id,\n      message_id,\n      approved\n    })\n  });\n\n  // \u91cd\u65b0\u8fde\u63a5 SSE \u7ee7\u7eed\u63a5\u6536\u4e8b\u4ef6\uff08\u540c\u6837\u4f7f\u7528 fetch + auth header\uff09\n  const { stream_url } = await res.json();\n  const sseRes = await fetch(stream_url, {\n    headers: { Accept: 'text/event-stream', ...authHeaders },\n  });\n  // ... \u7528 ReadableStream \u5904\u7406\u540e\u7eed\u4e8b\u4ef6\n  }\n}\n</code></pre>"},{"location":"streaming/#\u914d\u7f6e\u9009\u9879","title":"\u914d\u7f6e\u9009\u9879","text":"<pre><code># src/api/config.py\n\nclass APIConfig(BaseSettings):\n    # SSE \u914d\u7f6e\n    SSE_PING_INTERVAL: int = 15      # \u5fc3\u8df3\u95f4\u9694\uff08\u79d2\uff09\n    STREAM_TIMEOUT: int = 300        # \u6d41\u8d85\u65f6\uff08\u79d2\uff09\n    STREAM_TTL: int = 30             # \u961f\u5217 TTL\uff08\u79d2\uff09\n\n    class Config:\n        env_prefix = \"ARTIFACTFLOW_\"\n</code></pre>"},{"location":"streaming/#\u9519\u8bef\u5904\u7406","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"streaming/#\u8fde\u63a5\u65ad\u5f00","title":"\u8fde\u63a5\u65ad\u5f00","text":"<p>\u5f53\u524d\u4f7f\u7528 <code>fetch + ReadableStream</code>\uff0c\u6ca1\u6709 <code>EventSource</code> \u7684\u81ea\u52a8\u91cd\u8fde\u8bed\u4e49\u3002\u524d\u7aef\u9700\u663e\u5f0f\u5904\u7406\u8fde\u63a5\u5f02\u5e38\uff1a</p> <pre><code>// connectSSE() \u7684 onError \u56de\u8c03\u4e2d\u5904\u7406\nfunction onError(error) {\n  if (error.message === 'Session expired') {\n    // 401\uff1atoken \u8fc7\u671f\uff0c\u89e6\u53d1\u767b\u51fa\n    authStore.logout();\n  } else {\n    // \u7f51\u7edc\u9519\u8bef\u6216\u670d\u52a1\u7aef\u5f02\u5e38\uff0c\u63d0\u793a\u7528\u6237\n    showError('\u8fde\u63a5\u65ad\u5f00\uff0c\u8bf7\u5237\u65b0\u9875\u9762\u91cd\u8bd5');\n  }\n}\n</code></pre> <p>\u6ce8\u610f\uff1aArtifactFlow \u7684 SSE \u8fde\u63a5\u662f\u4e00\u6b21\u6027\u7684\uff08\u4e00\u6b21\u8bf7\u6c42\u5bf9\u5e94\u4e00\u4e2a stream\uff09\uff0c\u4e0d\u9700\u8981\u81ea\u52a8\u91cd\u8fde\u3002\u5982\u679c\u8fde\u63a5\u4e2d\u65ad\uff0cgraph \u6267\u884c\u4ecd\u4f1a\u7ee7\u7eed\u5b8c\u6210\u5e76\u5c06\u7ed3\u679c\u6301\u4e45\u5316\u5230\u6570\u636e\u5e93\uff0c\u7528\u6237\u5237\u65b0\u9875\u9762\u5373\u53ef\u67e5\u770b\u3002</p>"},{"location":"streaming/#\u8d85\u65f6\u5904\u7406","title":"\u8d85\u65f6\u5904\u7406","text":"<pre><code>// \u670d\u52a1\u7aef\u5df2\u6709 STREAM_TIMEOUT\uff08\u9ed8\u8ba4 300 \u79d2\uff09\u4fdd\u62a4\uff0c\u8d85\u65f6\u540e\u4f1a\u63a8\u9001 error \u4e8b\u4ef6\u3002\n// \u524d\u7aef\u53ef\u989d\u5916\u8bbe\u7f6e\u5ba2\u6237\u7aef\u8d85\u65f6\u4f5c\u4e3a\u515c\u5e95\uff1a\nconst controller = new AbortController();\nconst timeout = setTimeout(() =&gt; {\n  controller.abort();\n  showTimeout();\n}, 5 * 60 * 1000);  // 5 \u5206\u949f\u8d85\u65f6\n\n// fetch \u65f6\u4f20\u5165 signal\nfetch(streamUrl, { signal: controller.signal, headers: authHeaders });\n\n// \u6536\u5230 complete \u65f6\u6e05\u9664\u8d85\u65f6\n// \uff08\u5728 handleSSEEvent \u7684 complete \u5206\u652f\u4e2d\uff09\nclearTimeout(timeout);\n</code></pre>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/","title":"Redis\u8fc1\u79fb\u6e05\u5355","text":""},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#phase-1---\u6838\u5fc3\u591aworker\u90e8\u7f72\u524d\u5fc5\u987b\u5b8c\u6210","title":"Phase 1 - \u6838\u5fc3\uff08\u591aWorker\u90e8\u7f72\u524d\u5fc5\u987b\u5b8c\u6210\uff09","text":"<ul> <li>[ ] ConversationManager._cache \u2192 Redis Hash</li> <li>[ ] Streaming Events \u2192 Redis Pub/Sub</li> </ul>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#phase-2---\u6269\u5c55\u5e76\u53d1\u91cf\u4e0a\u5347\u540e","title":"Phase 2 - \u6269\u5c55\uff08\u5e76\u53d1\u91cf\u4e0a\u5347\u540e\uff09","text":"<ul> <li>[ ] AsyncSqliteSaver \u2192 langgraph-checkpoint-redis</li> <li>[ ] Redis Key TTL \u81ea\u52a8\u6e05\u7406</li> </ul>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#phase-3---\u53ef\u9009\u4f18\u5316","title":"Phase 3 - \u53ef\u9009\u4f18\u5316","text":"<ul> <li>[ ] ArtifactManager \u7f13\u5b58\u52a0 TTL\uff08\u6216\u76f4\u63a5\u79fb\u9664\uff09  \u2190 \u4f18\u5148\u7ea7\u4f4e</li> <li>[ ] API Rate Limit / Session / \u5206\u5e03\u5f0f\u9501</li> </ul>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u6a21\u578b\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","title":"\u6a21\u578b\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","text":""},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u6b21\u8981\u95ee\u9898","title":"\u6b21\u8981\u95ee\u9898","text":"<ul> <li>[x] \u5c06langchain\u6a21\u578b\u63a5\u5165\u6539\u4e3a\u4e13\u95e8\u7684\u4e07\u80fd\u63a5\u53e3\u53bb\u9002\u5e94\u4e0d\u540cprovider\uff0c\u4f8b\u5982LiteLLM\u3002\u5c24\u5176\u8981\u6ce8\u610freasoning\u548ctoken usage\u7b49\u5b57\u6bb5\u5982\u4f55\u83b7\u53d6</li> </ul>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u5de5\u5177\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","title":"\u5de5\u5177\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","text":""},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u6b21\u8981\u95ee\u9898_1","title":"\u6b21\u8981\u95ee\u9898","text":"<ul> <li>[x] \u4f7f\u7528\u6807\u51c6xml\u89e3\u6790\u65b9\u5f0f\uff08xml.etree.ElementTree\uff09\uff0cstring\u5b57\u6bb5\u7edf\u4e00\u7528cdata\u5b57\u6bb5\uff0c\u6240\u6709\u53c2\u6570Tag\u5e73\u94fa\uff0c\u5982\u6709\u4e0b\u7ea7\u6807\u7b7e\u5219\u4e3alist</li> </ul>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#core\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","title":"Core\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","text":""},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u4e3b\u8981\u95ee\u9898","title":"\u4e3b\u8981\u95ee\u9898","text":"<ul> <li>[x] <code>ExtendableGraph</code>\u548c<code>ExecutionController</code>\u6d41\u5f0f\u8f93\u51fa\u652f\u6301</li> <li>[x] \u786e\u8ba4user_confirmation_node\u5728<code>ExecutionController</code>\u5c42\u9762\u6b63\u786e\u5de5\u4f5c\uff0c\u73b0\u6709\u4ee3\u7801\u5904\u7406\u5f88\u5947\u602a\uff1a \u4e00\u4e2a\u662f<code>handle_permission_confirmation</code>\u6ca1\u6709\u5b9e\u73b0\u5bf9\u5b9e\u9645\u5de5\u5177\u7684\u8c03\u7528\uff0c\u540c\u65f6\u6ca1\u6709\u5730\u65b9\u8c03\u7528\u4e86\u8fd9\u4e2a<code>handle_permission_confirmation</code>\u3002\u53e6\u5916\u89c2\u5bdf<code>ExtendableGraph</code>\u7684\u8def\u7531\u4e5f\u4e0d\u5bf9\uff0c<code>_add_routing_rules</code>\u600e\u4e48\u628a<code>user_confirmation</code>\u8def\u7531\u5230END\u53bb\u4e86\u3002</li> <li>[x] <code>ContextManager</code>\u91cd\u590d\u8bbe\u8ba1\u4e86<code>prepare_context_for_agent</code>\u65b9\u6cd5\u3002\u5e94\u8be5\u4e0e<code>BaseAgent</code>\u4e2d\u5c31\u6709<code>_prepare_context_with_task_plan</code>\u505a\u51fa\u533a\u5206\u3002</li> <li>[x] sub agent\u7684response\u597d\u50cf\u4e0d\u4f1a\u88ablead agent\u89e3\u6790\u3002</li> <li>[x] <code>BaseAgent</code>\u7684messages\u7684\u62fc\u63a5\u65b9\u5f0f\u4fee\u6539\u4e3a\uff1a system prompt + instruction + history(\u5982\u679c\u6709) + tool result</li> <li>[x] \u7531\u4e8e\u6d88\u606f\u62fc\u63a5\u88ab\u79fb\u52a8\u5230\u4e86baseagent\u5916\uff0c\u5bfc\u81f4\u5916\u90e8\u8c03\u7528\u7684\u5de5\u5177\u7ed3\u679c\u6ca1\u6709\u88abgraph\u8bb0\u5f55\u4e0b\u6765</li> <li>[x] conversation history\u53ea\u80fdformat\u4e24\u6761\uff1f\u5df2\u5b9a\u4f4d\u95ee\u9898\uff1a_execute_new_message\u6ca1\u6709\u8f93\u5165parent_message_id\u5e94\u8be5\u81ea\u52a8\u8bbe\u7f6eparent_message_id\u5173\u8054</li> <li>[x] <code>interrupt()</code> \u51fd\u6570\u9700\u8981\u5728\u4e00\u4e2a\u6b63\u786e\u7684 runnable context \u4e2d\u8c03\u7528\uff0c\u4f46\u73b0\u5728\u770b\u8d77\u6765\u4e0a\u4e0b\u6587\u4e0d\u6b63\u786e\u3002\u5df2\u5b9a\u4f4d\u95ee\u9898\uff1a\u5f02\u6b65 interrupt \u529f\u80fd\u9700\u8981 Python 3.11+ \u624d\u80fd\u6b63\u5e38\u5de5\u4f5c,\u56e0\u4e3a Python 3.11 \u4e4b\u524d\u7684\u7248\u672c\u4e2d\u5f02\u6b65\u4efb\u52a1\u65e0\u6cd5\u6b63\u786e\u4f20\u64ad\u4e0a\u4e0b\u6587 Asynchronous Graph with interrupts in Python 3.10 seems to be broken \u00b7 langchain-ai/langgraph \u00b7 Discussion #3200</li> <li>[ ] <code>langgraph</code>\u4f7f\u7528\u7684<code>AsyncSqliteSaver</code>\u9700\u8981\u4e00\u4e2a\u5b9a\u65f6\u6e05\u7406\u811a\u672c\u907f\u514d\u7f13\u5b58\u7ebf\u7a0b\u65e0\u9650\u5806\u79ef/\u6216\u8005\u5207\u6362\u4e3a\u62e5\u6709ttl\u7ba1\u7406\u7684redis\u7ba1\u7406</li> <li>[x] Agent\u57fa\u7c7b\u53bb\u6389\u81ea\u5df1\u7684\u5de5\u5177\u8c03\u7528\u5904\u7406\uff0c\u5c06\u5de5\u5177\u8c03\u7528\u5904\u7406\u5168\u6743\u4ea4\u7ed9graph\u7684\u5de5\u5177\u8282\u70b9<code>user_confirmation_node</code>(\u8fd9\u4e2anode\u53ef\u4ee5\u6539\u4e2a\u540d\u5b57)\u3002\u4f8b\u5982tool permission\u4e3aNOTIFY/PUBLIC\u7684\u65f6\u5019\u4e5f\u4ea4\u7ed9confirmation node\u6267\u884c\uff0c\u4f46\u662f\u81ea\u52a8\u5141\u8bb8\u3002</li> <li>[x] \u53ef\u89c2\u6d4b\u6027\u8bbe\u8ba1\uff1a\u4ed4\u7ec6\u8bbe\u8ba1graph state\u5305\u542b\u53ef\u89c2\u6d4b\u6027\u5b57\u6bb5\uff0c\u8bb0\u5f55token\u4f7f\u7528\u4ee5\u53ca\u5de5\u5177\u8c03\u7528\u7b49\u4fe1\u606f</li> </ul>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u6b21\u8981\u95ee\u9898_2","title":"\u6b21\u8981\u95ee\u9898","text":"<ul> <li>[x] \u5404\u7c7bid\u52a0\u4e0a\u7c7b\u578b\u540d</li> <li>[x] controller\u5c42\u7684\u5386\u53f2\u8bb0\u5f55\uff08User \u2194 Graph\uff09\u548cgraph\u5c42\u7684\u5386\u53f2\u8bb0\u5f55\u662f\u4e0d\u662f\u4e5f\u5e94\u8be5\u5206\u5f00\u7ba1\u7406\uff0c\u56e0\u4e3a\u5982\u679c\u90fd\u585e\u5230NodeMemory\u91cc\u9762\u7684\u8bdd\u611f\u89c9\u4e0d\u592a\u5408\u7406\uff0c\u5e94\u8be5\u662f\u4e00\u4e2acontext manager\u7ba1\u7406controller\u5c42\u4e00\u4e2a\u7ba1\u7406graph\u5c42\uff0c\u8fd9\u4e2acontext manager\u53ef\u4ee5\u548c\u524d\u9762\u8bf4\u7684\u662f\u4e00\u4e2a\uff0c\u7136\u540econtroller\u5c42\u7684\u5386\u53f2\u8bb0\u5f55\u4ee5context\u7684\u5f62\u5f0f\u7ed9graph\uff1f</li> <li>[x] \u5f15\u5165python-diff-match-patch\u5347\u7ea7\u4e00\u4e0b\u73b0\u6709\u7684artifact_ops.py\uff0c\u5e76\u589e\u52a0\u7248\u672c\u7ba1\u7406\u529f\u80fd\u4e0econtroller\u4e2d\u7684conversation\u7ba1\u7406\u5bf9\u5e94\u8d77\u6765\uff08\u7b97\u7403\u4e86\uff0c\u592a\u8026\u5408\u4e86\uff09\uff0c\u63d0\u4f9b\u66f4\u5b8c\u5584\u7684\u529f\u80fd\u7ed9\u672a\u6765\u5f00\u53d1\u7684\u524d\u7aef\uff0c\u4f8b\u5982\u80fd\u751f\u6210\u4f8b\u5982git diff\u7684\u5185\u5bb9\u5c55\u793a\u6a21\u578b\u5bf9\u6587\u6863\u7684\u4fee\u6539\u3002</li> <li>[x] lead agent\u63d0\u793a\u8bcd\u63d0\u793aresult artifact \u6e10\u8fdb\u5f0f\u5b8c\u6210</li> <li>[ ] graph level\u8f6e\u6b21\u592a\u591a\u63d0\u793alead agent</li> <li>[x] agent\u5f00\u542f\u5173\u95eddebug\u6a21\u5f0f\u5f88\u8d39\u52b2\uff1a\u5220\u9664agentconfig\u4e2ddebug\u53c2\u6570</li> <li>[x] Typer + Rich\u5b9e\u73b0\u7b80\u6613terminal\u524d\u7aef</li> <li>[ ] agent\u63d0\u793a\u8bcd\u7cbe\u7b80\u4e00\u4e0b</li> <li>[ ] subagent\u5e94\u8be5\u4e5f\u5229\u7528\u597dartifact</li> <li>[x] ToolPromptGenerator\u4e2dgenerate_tool_instruction\u6700\u540ereturn\u7684instruction\u52a0\u4e0a\u7684tag <li>[x] \u535a\u67e5\u641c\u7d22\u8bed\u6cd5\u786e\u8ba4</li> <li>[x] _execute_new_message\u5728\u8c03\u7528graph\u4e4b\u524d\uff0c\u83b7\u53d6\u4e86session_id\u4e4b\u540e\u6e05\u9664\u5df2\u6709\u7684task_plan</li> <li>[x] fetch tool \u652f\u6301pdf</li> <li>[ ] agent logging \u52a0\u4e0athread id</li> <li>[ ] \u533a\u5206conversation history\u548ctool interactions\u7684compression level</li>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#agent\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","title":"Agent\u6a21\u5757\u5df2\u77e5\u95ee\u9898\u6e05\u5355","text":""},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u91cd\u8981\u95ee\u9898","title":"\u91cd\u8981\u95ee\u9898","text":"<ul> <li>[x] revisit xml\u5de5\u5177\u89e3\u6790\u7cfb\u7edf\uff1a\u53c2\u6570\u7c7b\u578b\u8f6c\u6362\uff08str \u2192 int/List[str]\uff09\u5e94\u7531\u5de5\u5177\u81ea\u884c\u5904\u7406</li> <li>[x] artifact rewrite\u51c6\u786e\u5ea6\uff1aupdate_artifact\u7684old_str\u5339\u914d\u5931\u8d25\uff0c\u9700\u68c0\u67e5read\u540e\u7684\u683c\u5f0f\u6216\u6b63\u5219\u89e3\u6790\uff1aartifact\u63d0\u4f9b\u6a21\u7cca\u5339\u914d\u529f\u80fd</li> <li>[x] \u4f18\u5316agent\u63d0\u793a\u8bcd\u683c\u5f0f\uff1a\u7528xml\u6807\u7b7e\u89c4\u6574\uff08\u5982<code>&lt;task_plan&gt;</code>\uff09\uff0c\u5404agent\u7edf\u4e00</li> <li>[x] crawl agent\u65e0\u6cd5\u6b63\u786e\u8c03\u7528web_fetch\uff1alist\u683c\u5f0f\u89e3\u6790\u95ee\u9898\uff08JSON\u6570\u7ec4 vs \u591a\u884c\u683c\u5f0f\uff09</li> </ul>"},{"location":"_archive/ArtifactFlow%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98%E6%B8%85%E5%8D%95/#\u6b21\u8981\u95ee\u9898_3","title":"\u6b21\u8981\u95ee\u9898","text":"<ul> <li>[x] agent\u63d0\u793a\u8bcd\u589e\u52a0\u7cfb\u7edf\u65f6\u95f4\u611f\u77e5</li> <li>[x] artifact\u901a\u7528\u5316\u63cf\u8ff0\uff1aresult artifact\u7684id\u5e94\u6839\u636e\u7528\u6237\u9700\u6c42\u52a8\u6001\u786e\u5b9a\uff0ctask_plan\u652f\u6301\u7b14\u8bb0\u529f\u80fd</li> <li>[x] agent node\u5bf9\u8bdd\u5386\u53f2\u5904\u7406\uff1a\u5de5\u5177\u5faa\u73af\u5386\u53f2\u8bb0\u5f55\u9700\u4fdd\u7559\u5e76\u53ef\u9009\u62e9\u6027\u4f20\u9012</li> <li>[x] task_plan artifact\u6ca1\u6709\u53ca\u65f6\u52a0\u8f7d\uff1a\u5de5\u5177\u5faa\u73af\u4e2d\u7684\u64cd\u4f5c\u672a\u53ca\u65f6\u66f4\u65b0\u5230\u7cfb\u7edf\u63d0\u793a\u8bcd</li> <li>[x] search agent\u7ed3\u679c\u8fd4\u56de\u65b9\u5f0f\uff1a\u8003\u8651\u76f4\u63a5\u8fd4\u56de\u5de5\u5177\u7ed3\u679c\u800c\u975e\u590d\u8ff0</li> <li>[x] \u7cbe\u7b80\u63d0\u793a\u8bcd\uff1a\u7b80\u5316\u5408\u5e76\u63d0\u793a\u8bcd\u5185\u5bb9</li> <li>[x] Agent\u6587\u4ef6\uff0c\u4f8b\u5982lead_agent.py\u662f\u4e0d\u662f\u5e94\u8be5\u4ee5@property\u6216\u8005\u522b\u7684\u5f62\u5f0f\u5b9a\u4e49\u5de5\u5177\u5217\u8868\uff0c<code>create_multi_agent_graph</code>\u5728<code>registry.create_agent_toolkit</code>\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u4f20\u5165\u8fd9\u4e2a<code>tool_names</code>\u3002\u7c7b\u4f3c\u7684\u611f\u89c9lead.register_subagent\u4f7f\u7528\u7684\u4fe1\u606f\u5e94\u8be5\u4e5f\u901a\u8fc7search\u548ccrawl\u7684property\u83b7\u53d6\uff0c\u800c\u4e0d\u662f\u7f16\u7801\u5728<code>create_multi_agent_graph</code>\u4e2d</li> </ul>"},{"location":"_archive/optimization-plan/","title":"ArtifactFlow \u5206\u9636\u6bb5\u4f18\u5316\u8ba1\u5212","text":"<p>\u57fa\u4e8e code review \u53cd\u9988\u548c <code>docs/architecture/concurrency.md</code> \u6f14\u8fdb\u8def\u7ebf\u6574\u5408\u3002</p>"},{"location":"_archive/optimization-plan/#phase-1-\u6838\u5fc3\u6d41\u7a0b-bug-\u4fee\u590did-\u4e00\u81f4\u6027--permission-resume--done","title":"Phase 1: \u6838\u5fc3\u6d41\u7a0b Bug \u4fee\u590d\uff08ID \u4e00\u81f4\u6027 + Permission Resume\uff09 \u2705 DONE","text":"<p>\u76ee\u6807: \u4fee\u590d permission resume \u7aef\u5230\u7aef\u94fe\u8def\u65ad\u88c2\u95ee\u9898\u3002\u5f53\u524d permission \u786e\u8ba4\u6d41\u7a0b\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\u3002</p> <p>\u5b8c\u6210\u4e8e: commit <code>c24fdb8</code> \u2014 1.1~1.4 \u5168\u90e8\u5b8c\u6210\u3002Controller \u63a5\u53d7\u5916\u90e8\u4f20\u5165 ID \u5e76 fallback \u81ea\u52a8\u751f\u6210\uff0c\u6d4b\u8bd5\u65e0\u9700\u5f3a\u5236\u9002\u914d\uff08\u5411\u540e\u517c\u5bb9\uff09\u3002</p>"},{"location":"_archive/optimization-plan/#11-\u7edf\u4e00-id-\u751f\u6210\u6e90","title":"1.1 \u7edf\u4e00 ID \u751f\u6210\u6e90","text":"<p>\u95ee\u9898: Router \u5c42\u751f\u6210 <code>message_id</code>/<code>thread_id</code>\uff0cController \u5c42\u53c8\u91cd\u65b0\u751f\u6210\uff0c\u5bfc\u81f4\u524d\u7aef\u6301\u6709\u7684 ID \u4e0e\u5b9e\u9645\u6267\u884c ID \u4e0d\u4e00\u81f4\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/routers/chat.py</code> \u2014 ID \u751f\u6210\u70b9\uff08~L65-72\uff09 - <code>src/core/controller.py</code> \u2014 <code>_execute_new_message()</code>\uff08~L214\uff09\u548c <code>_stream_new_message()</code>\uff08~L353\uff09\u4e2d\u7684\u91cd\u590d ID \u751f\u6210 - <code>src/core/controller.py</code> \u2014 <code>ExecutionController.stream_execute()</code> / <code>execute()</code> \u65b9\u6cd5\u7b7e\u540d</p> <p>\u6539\u52a8: - Router \u5c42\u751f\u6210 <code>message_id</code> + <code>thread_id</code> \u4f5c\u4e3a\u552f\u4e00\u6743\u5a01\u6e90 - Controller \u7684 <code>stream_execute()</code> / <code>execute()</code> \u63a5\u53d7\u5916\u90e8\u4f20\u5165\u7684 <code>message_id</code> + <code>thread_id</code> \u53c2\u6570 - \u5220\u9664 Controller \u5185\u90e8 <code>_execute_new_message()</code> / <code>_stream_new_message()</code> \u4e2d\u7684 ID \u751f\u6210\u903b\u8f91 - \u6d4b\u8bd5\u9002\u914d\uff1a<code>tests/test_core_graph.py</code> \u548c <code>tests/test_core_graph_stream.py</code> \u4e2d\u6240\u6709\u76f4\u63a5\u8c03\u7528 <code>controller.execute(content=...)</code> / <code>controller.stream_execute(content=...)</code> \u7684\u5730\u65b9\u9700\u8865\u4f20 <code>thread_id</code> + <code>message_id</code>\uff1b\u5728 <code>TestEnvironment</code> \u4e0a\u65b0\u589e <code>generate_ids()</code> helper \u5c01\u88c5 ID \u751f\u6210\uff0c\u6a21\u62df Router \u5c42\u804c\u8d23</p>"},{"location":"_archive/optimization-plan/#12-\u524d\u7aef-permissionmodal-\u4ece-streamstore-\u8bfb\u53d6-id","title":"1.2 \u524d\u7aef PermissionModal \u4ece streamStore \u8bfb\u53d6 ID","text":"<p>\u95ee\u9898: <code>useSSE.ts</code> \u7684 <code>permission_request</code> handler \u5c1d\u8bd5\u4ece SSE \u4e8b\u4ef6 payload \u8bfb\u53d6 <code>thread_id</code>/<code>message_id</code>\uff0c\u4f46\u540e\u7aef <code>graph.py</code> \u7684 <code>permission_request</code> \u4e8b\u4ef6\u6839\u672c\u4e0d\u5305\u542b\u8fd9\u4e24\u4e2a\u5b57\u6bb5\uff0c\u5bfc\u81f4\u524d\u7aef\u62ff\u5230\u7a7a\u5b57\u7b26\u4e32\u3002\u5b9e\u9645\u4e0a\uff0cpermission request \u5fc5\u7136\u53d1\u751f\u5728\u5f53\u524d\u6d3b\u8dc3 stream \u5185\uff0c<code>streamStore</code> \u4e2d\u5df2\u901a\u8fc7 <code>startStream()</code> \u6301\u6709\u6b63\u786e\u7684 <code>threadId</code>/<code>messageId</code>\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>frontend/src/hooks/useSSE.ts</code> \u2014 <code>PERMISSION_REQUEST</code> case\uff08~L213-219\uff09 - <code>frontend/src/components/layout/PermissionModal.tsx</code> \u2014 \u5df2\u4ece <code>permissionRequest</code> \u5bf9\u8c61\u8bfb\u53d6 ID\uff08~L23-24\uff09</p> <p>\u6539\u52a8: - <code>useSSE.ts</code> \u7684 <code>permission_request</code> handler \u4e0d\u518d\u4ece <code>data</code> \u4e2d\u8bfb\u53d6 <code>thread_id</code>/<code>message_id</code>\uff0c\u6539\u4e3a\u5b58\u50a8 <code>toolName</code> + <code>params</code> \u5373\u53ef - <code>PermissionModal</code> \u7684 <code>handleResponse()</code> \u76f4\u63a5\u4ece <code>streamStore</code> \u8bfb\u53d6 <code>threadId</code>/<code>messageId</code>\uff08\u4e0e\u8bfb\u53d6 <code>streamUrl</code> \u540c\u6e90\uff09 - <code>PermissionRequest</code> \u7c7b\u578b\u5b9a\u4e49\u4e2d\u79fb\u9664 <code>messageId</code>/<code>threadId</code> \u5b57\u6bb5 - \u540e\u7aef <code>permission_request</code> \u4e8b\u4ef6\u65e0\u9700\u6539\u52a8</p>"},{"location":"_archive/optimization-plan/#13-\u524d\u7aef\u5904\u7406-metadata-\u4e8b\u4ef6","title":"1.3 \u524d\u7aef\u5904\u7406 metadata \u4e8b\u4ef6","text":"<p>\u95ee\u9898: <code>useSSE.ts</code> \u5bf9 METADATA \u4e8b\u4ef6\u76f4\u63a5 <code>break</code>\uff0c\u672a\u63d0\u53d6\u771f\u5b9e\u6267\u884c ID\u3002\u914d\u5408 1.1 \u7684 ID \u7edf\u4e00\u540e\uff0cmetadata \u4e8b\u4ef6\u4e2d\u7684 ID \u53ef\u4f5c\u4e3a\u9632\u5fa1\u6027\u6821\u9a8c\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>frontend/src/hooks/useSSE.ts</code> \u2014 METADATA case\uff08~L78\uff09</p> <p>\u6539\u52a8: - METADATA \u4e8b\u4ef6\u4e2d\u63d0\u53d6 <code>conversation_id</code>\u3001<code>message_id</code>\u3001<code>thread_id</code>\uff0c\u4e0e <code>streamStore</code> \u4e2d\u5df2\u6709\u503c\u505a\u4e00\u81f4\u6027\u6821\u9a8c\uff08dev \u73af\u5883 console.warn \u4e0d\u4e00\u81f4\u60c5\u51b5\uff09</p>"},{"location":"_archive/optimization-plan/#14-resume-\u5f52\u5c5e\u6821\u9a8c","title":"1.4 resume \u5f52\u5c5e\u6821\u9a8c","text":"<p>\u95ee\u9898: resume \u7aef\u70b9\u5b8c\u5168\u4fe1\u4efb\u5ba2\u6237\u7aef\u4f20\u5165\u7684 <code>thread_id</code>\uff0c\u672a\u6821\u9a8c\u5176\u4e0e <code>conversation_id</code> \u7684\u7ed1\u5b9a\u5173\u7cfb\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/routers/chat.py</code> \u2014 <code>resume_execution()</code>\uff08~L284-299\uff09 - <code>src/db/models.py</code> \u2014 <code>Message</code> \u6a21\u578b\u5df2\u6709 <code>thread_id</code> \u548c <code>conversation_id</code> \u5b57\u6bb5 - <code>src/repositories/</code> \u2014 \u53ef\u80fd\u9700\u8981\u65b0\u589e\u67e5\u8be2\u65b9\u6cd5</p> <p>\u6539\u52a8: - resume \u524d\u67e5\u8be2 DB \u6821\u9a8c <code>message.thread_id == request.thread_id AND message.conversation_id == conv_id</code> - \u6821\u9a8c\u5931\u8d25\u8fd4\u56de 403/404</p>"},{"location":"_archive/optimization-plan/#phase-2-\u5b89\u5168\u52a0\u56fa--done","title":"Phase 2: \u5b89\u5168\u52a0\u56fa \u2705 DONE","text":"<p>\u76ee\u6807: \u4fee\u590d SSRF \u98ce\u9669\u3001\u6301\u4e45\u5316\u9759\u9ed8\u5931\u8d25\u3001\u751f\u4ea7\u73af\u5883\u914d\u7f6e\u95ee\u9898\u3002</p> <p>\u5b8c\u6210\u4e8e: 2.1 web_fetch SSRF \u9632\u62a4\uff08\u534f\u8bae\u6821\u9a8c + permission AUTO\u2192CONFIRM\uff09\u30012.2 \u6301\u4e45\u5316 fail fast\uff08\u79fb\u9664\u9759\u9ed8\u541e\u5f02\u5e38\uff09\u30012.3 Docker healthcheck\uff08/docs\u2192/health\uff09\u30012.4 \u9519\u8bef\u4fe1\u606f\u8131\u654f\uff08<code>_sanitize_error_event</code> \u7edf\u4e00\u62e6\u622a\u6240\u6709 push \u51fa\u53e3 + controller \u4e0d\u518d\u5411 graph_response \u5199\u5165\u5185\u90e8\u5f02\u5e38\uff09\u3002\u9644\u5e26\u4fee\u590d permission \u524d\u7aef\u786e\u8ba4\u6d41\u7a0b\uff08interrupted COMPLETE \u4fdd\u7559 stream \u72b6\u6001\u3001streamStore \u65b0\u589e conversationId/resumeStream\u3001StreamManager \u5141\u8bb8\u91cd\u5efa\u5df2\u5173\u95ed stream\uff09\u3002</p>"},{"location":"_archive/optimization-plan/#21-web_fetch-ssrf-\u9632\u62a4","title":"2.1 web_fetch SSRF \u9632\u62a4","text":"<p>\u95ee\u9898: <code>web_fetch</code> \u5de5\u5177 permission \u4e3a AUTO\uff0c\u4e14\u65e0 URL \u6821\u9a8c\uff0c\u53ef\u8bbf\u95ee\u5185\u7f51/\u5143\u6570\u636e\u5730\u5740\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/tools/implementations/web_fetch.py</code> \u2014 permission \u5b9a\u4e49\uff08~L54\uff09\u548c fetch \u903b\u8f91\uff08~L246\uff09</p> <p>\u6539\u52a8: - \u65b0\u589e URL \u6821\u9a8c\u51fd\u6570\uff1a\u62d2\u7edd\u79c1\u7f51 IP\uff0810.x, 172.16-31.x, 192.168.x, 127.x, 169.254.x\uff09\u3001\u62d2\u7edd <code>file://</code> \u7b49\u975e HTTP \u534f\u8bae - \u5bf9\u89e3\u6790\u540e\u7684 IP \u505a\u4e8c\u6b21\u6821\u9a8c\uff08\u9632 DNS rebinding\uff1aresolve \u540e\u68c0\u67e5 IP\uff09 - Permission \u4ece <code>AUTO</code> \u6539\u4e3a <code>CONFIRM</code>\uff08\u9700\u7528\u6237\u786e\u8ba4\uff09\u6216\u81f3\u5c11\u5bf9\u975e\u767d\u540d\u5355\u57df\u540d CONFIRM</p>"},{"location":"_archive/optimization-plan/#22-\u6301\u4e45\u5316\u5f02\u5e38-fail-fast","title":"2.2 \u6301\u4e45\u5316\u5f02\u5e38 fail fast","text":"<p>\u95ee\u9898: <code>conversation_manager.py</code> \u4e09\u5904 DB \u5199\u5165\u5931\u8d25\u88ab <code>except Exception: logger.warning()</code> \u541e\u6389\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/core/conversation_manager.py</code> \u2014 <code>_persist_conversation()</code>\uff08~L170\uff09\u3001<code>_persist_message()</code>\uff08~L300\uff09\u3001<code>_persist_response()</code>\uff08~L337\uff09</p> <p>\u6539\u52a8: - \u6838\u5fc3\u8def\u5f84\uff08persist_message\u3001persist_response\uff09\u7684\u5f02\u5e38\u5411\u4e0a\u629b\u51fa\uff0c\u8ba9 API \u5c42\u8fd4\u56de\u9519\u8bef - \u53ef\u964d\u7ea7\u8def\u5f84\uff08\u5982 persist_conversation \u7684 DuplicateError\uff09\u4fdd\u7559\u5f53\u524d\u884c\u4e3a - \u5728 <code>chat.py</code> \u7684 <code>execute_and_push()</code> \u4e2d\u6355\u83b7\u6301\u4e45\u5316\u5f02\u5e38\uff0c\u63a8\u9001 error \u4e8b\u4ef6\u5230 stream</p>"},{"location":"_archive/optimization-plan/#23-docker-\u5065\u5eb7\u68c0\u67e5\u4fee\u590d","title":"2.3 Docker \u5065\u5eb7\u68c0\u67e5\u4fee\u590d","text":"<p>\u95ee\u9898: Healthcheck \u4f9d\u8d56 <code>/docs</code>\uff0c\u751f\u4ea7\u73af\u5883 <code>DEBUG=False</code> \u65f6 <code>/docs</code> \u88ab\u7981\u7528\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/main.py</code> \u2014 \u9700\u65b0\u589e <code>/health</code> \u7aef\u70b9 - <code>Dockerfile</code> \u2014 healthcheck \u547d\u4ee4\uff08~L71\uff09</p> <p>\u6539\u52a8: - <code>main.py</code> \u65b0\u589e <code>GET /health</code> \u7aef\u70b9\uff0c\u8fd4\u56de <code>{\"status\": \"ok\"}</code> - Dockerfile healthcheck \u6539\u4e3a <code>curl -f http://localhost:8000/health</code></p>"},{"location":"_archive/optimization-plan/#24-\u9519\u8bef\u4fe1\u606f\u8131\u654f","title":"2.4 \u9519\u8bef\u4fe1\u606f\u8131\u654f","text":"<p>\u95ee\u9898: Background task \u5f02\u5e38\u901a\u8fc7 <code>str(e)</code> \u76f4\u63a5\u63a8\u9001\u524d\u7aef\uff0c\u53ef\u80fd\u6cc4\u9732\u5185\u90e8\u8def\u5f84/DB \u4fe1\u606f\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/routers/chat.py</code> \u2014 error \u4e8b\u4ef6\u63a8\u9001\uff08~L189, ~L398\uff09</p> <p>\u6539\u52a8: - \u751f\u4ea7\u73af\u5883\uff08<code>DEBUG=False</code>\uff09\uff1a\u63a8\u9001\u901a\u7528\u9519\u8bef\u6d88\u606f \"Internal server error\"\uff0c\u8be6\u7ec6\u4fe1\u606f\u4ec5\u5199\u65e5\u5fd7 - \u5f00\u53d1\u73af\u5883\uff08<code>DEBUG=True</code>\uff09\uff1a\u4fdd\u6301\u5f53\u524d\u884c\u4e3a\uff0c\u63a8\u9001\u5b8c\u6574\u9519\u8bef\u4fe1\u606f</p>"},{"location":"_archive/optimization-plan/#phase-3-\u6570\u636e\u8d28\u91cf\u6539\u5584-31--32--33-","title":"Phase 3: \u6570\u636e\u8d28\u91cf\u6539\u5584 (3.1 \u2705, 3.2 \u2705, 3.3 \u23f8\ufe0f)","text":"<p>\u76ee\u6807: \u4fee\u590d\u6570\u636e\u51c6\u786e\u6027\u95ee\u9898\u3002</p> <p>3.1 &amp; 3.2 \u5b8c\u6210\u4e8e: commit <code>14f44e6</code> \u2014 Repository \u5c42\u65b0\u589e count \u67e5\u8be2\uff0cRouter \u5c42\u8fd4\u56de\u51c6\u786e total\uff1bArtifactMemory \u589e\u52a0 created_at \u5b57\u6bb5\uff0c\u4f7f\u7528 DB \u771f\u5b9e\u65f6\u95f4\u3002 \u8865\u4e01: commit <code>925ce9f</code> \u2014 code review \u4fee\u590d\uff1alist_conversations \u53bb\u6389 asyncio.gather \u907f\u514d\u5171\u4eab AsyncSession\uff1bcreate_artifact \u7f13\u5b58\u6784\u9020\u4f20\u5165 db_artifact.created_at\u3002</p>"},{"location":"_archive/optimization-plan/#31-\u5206\u9875-total-\u771f\u5b9e\u8ba1\u6570-","title":"3.1 \u5206\u9875 total \u771f\u5b9e\u8ba1\u6570 \u2705","text":"<p>\u95ee\u9898: <code>total</code> \u4f7f\u7528 <code>offset + len + (1 if has_more else 0)</code> \u4f30\u7b97\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/routers/chat.py</code> \u2014 list conversations\uff08~L202-207\uff09 - <code>src/repositories/</code> \u2014 \u53ef\u80fd\u9700\u8981\u65b0\u589e count \u67e5\u8be2</p> <p>\u6539\u52a8: - Repository \u5c42\u65b0\u589e <code>count_conversations()</code> \u65b9\u6cd5\uff08<code>SELECT COUNT(*) FROM conversations</code>\uff09 - Router \u5c42\u5e76\u884c\u6267\u884c count \u67e5\u8be2\u548c\u5206\u9875\u67e5\u8be2\uff0c\u8fd4\u56de\u51c6\u786e total</p>"},{"location":"_archive/optimization-plan/#32-artifact-created_at-\u8fd4\u56de\u771f\u5b9e\u65f6\u95f4-","title":"3.2 Artifact created_at \u8fd4\u56de\u771f\u5b9e\u65f6\u95f4 \u2705","text":"<p>\u95ee\u9898: <code>artifacts.py</code> \u7528 <code>datetime.now()</code> \u4ee3\u66ff\u771f\u5b9e\u521b\u5efa\u65f6\u95f4\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/routers/artifacts.py</code> \u2014 \u54cd\u5e94\u6784\u9020\uff08~L54, ~L93\uff09 - <code>src/tools/implementations/artifact_ops.py</code> \u2014 ArtifactMemory \u6570\u636e\u7ed3\u6784</p> <p>\u6539\u52a8: - \u68c0\u67e5 ArtifactMemory \u662f\u5426\u6301\u6709 <code>created_at</code>\uff0c\u5982\u679c\u6ca1\u6709\u5219\u4ece DB \u67e5\u8be2 - \u5982\u679c artifact \u5c1a\u672a\u6301\u4e45\u5316\u5230 DB\uff0c\u4f7f\u7528\u5185\u5b58\u4e2d\u7684\u521b\u5efa\u65f6\u95f4\uff08\u5728 ArtifactMemory \u4e2d\u589e\u52a0 <code>created_at</code> \u5b57\u6bb5\uff09 - Router \u5c42\u4f7f\u7528\u771f\u5b9e\u65f6\u95f4\u6784\u9020\u54cd\u5e94</p>"},{"location":"_archive/optimization-plan/#33-graph-\u7f16\u8bd1\u7f13\u5b58\u6765\u81ea-concurrencymd-phase-3--deferred","title":"3.3 Graph \u7f16\u8bd1\u7f13\u5b58\uff08\u6765\u81ea concurrency.md Phase 3\uff09 \u23f8\ufe0f Deferred","text":"<p>\u5f53\u524d\u72b6\u6001: \u6682\u4e0d\u5b9e\u65bd\uff0c\u5148\u4fdd\u6301\u201c\u6bcf\u8bf7\u6c42\u7f16\u8bd1 graph\u201d\u73b0\u72b6\uff0c\u540e\u7eed\u5728\u6709\u660e\u786e\u6027\u80fd\u74f6\u9888\u6570\u636e\u540e\u518d\u63a8\u8fdb\u3002</p> <p>\u80cc\u666f\u95ee\u9898: \u5f53\u524d\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u4f1a\u521b\u5efa Agent/Tool/Registry \u5e76\u7f16\u8bd1 StateGraph\uff0c\u5b58\u5728\u56fa\u5b9a CPU \u5f00\u9500\uff0c\u5f71\u54cd\u541e\u5410\u3002</p> <p>\u73b0\u6709\u5b9e\u73b0\u7279\u5f81\uff082026-02\uff09: - <code>src/api/dependencies.py</code> \u548c <code>src/api/routers/chat.py</code> \u7684\u540e\u53f0\u4efb\u52a1\u8def\u5f84\u4e2d\uff0c\u5747\u4f1a\u6309\u8bf7\u6c42\u8c03\u7528 <code>create_multi_agent_graph()</code> - <code>artifact_manager</code>\uff08\u8bf7\u6c42\u7ea7\u5bf9\u8c61\uff0c\u7ed1\u5b9a\u8bf7\u6c42\u7ea7 DB session\uff09\u5f53\u524d\u901a\u8fc7\u95ed\u5305/\u5b9e\u4f8b\u5b57\u6bb5\u53c2\u4e0e graph \u6784\u5efa - \u8be5\u8bbe\u8ba1\u5728\u201c\u6bcf\u8bf7\u6c42\u7f16\u8bd1\u201d\u524d\u63d0\u4e0b\u5e76\u53d1\u6b63\u786e\u6027\u53ef\u63a5\u53d7\uff08\u4e0d\u4f1a\u8de8\u8bf7\u6c42\u590d\u7528 session\uff09\uff0c\u4f46\u541e\u5410\u8f83\u5dee</p> <p>\u5019\u9009\u6539\u9020\u65b9\u6848\uff08\u5df2\u8c03\u7814\uff0c\u672a\u843d\u5730\uff09: - \u76ee\u6807\uff1a\u542f\u52a8\u65f6\u7f16\u8bd1\u4e00\u6b21 graph \u5e76\u7f13\u5b58\u4e3a\u5168\u5c40\u5355\u4f8b\uff1b\u8bf7\u6c42\u7ea7 <code>artifact_manager</code> \u901a\u8fc7 runtime context \u6ce8\u5165 - \u5bf9\u9f50 LangGraph \u63a8\u8350\u6a21\u5f0f\uff1a<code>context_schema</code> + <code>runtime.context</code>\uff08context \u4e0d\u8fdb\u5165 checkpoint\uff0cresume \u65f6\u9700\u91cd\u65b0\u4f20\u5165\uff09</p> <ol> <li>\u65b0\u589e <code>GraphContext</code></li> <li>\u65b0\u5efa <code>src/core/graph_context.py</code></li> <li>\u5b9a\u4e49 dataclass\uff1a<code>GraphContext(artifact_manager: Optional[ArtifactManager])</code></li> <li> <p>\u4f5c\u7528\uff1a\u627f\u8f7d\u8bf7\u6c42\u7ea7\u4f9d\u8d56\uff0c\u907f\u514d graph \u95ed\u5305\u6355\u83b7 request-scoped \u5bf9\u8c61</p> </li> <li> <p>\u6539\u9020 <code>core/graph.py</code></p> </li> <li><code>ExtendableGraph</code> \u79fb\u9664 <code>artifact_manager</code> \u6784\u9020\u53c2\u6570</li> <li><code>StateGraph</code> \u589e\u52a0 <code>context_schema=GraphContext</code></li> <li>\u8282\u70b9\u6267\u884c\u65f6\u901a\u8fc7 runtime \u8bfb\u53d6 <code>artifact_manager</code>\uff0c\u4f20\u5165 <code>ContextManager.build_agent_messages(...)</code></li> <li> <p><code>create_multi_agent_graph()</code> \u6539\u4e3a\u4e0d\u63a5\u6536 <code>artifact_manager</code></p> </li> <li> <p>\u6539\u9020 <code>tools/implementations/artifact_ops.py</code></p> </li> <li>Artifact \u5de5\u5177\u4e0d\u518d\u5728 <code>__init__</code> \u6301\u6709 manager</li> <li>\u6267\u884c\u65f6\u4ece runtime context \u83b7\u53d6 manager</li> <li> <p><code>create_artifact_tools()</code> \u6539\u4e3a\u65e0\u53c2\u5de5\u5382</p> </li> <li> <p>\u6539\u9020 <code>api/dependencies.py</code></p> </li> <li>\u589e\u52a0 <code>_compiled_graph</code> \u5168\u5c40\u53d8\u91cf</li> <li>\u5728 <code>init_globals()</code> \u4e2d\u7f16\u8bd1\u5e76\u7f13\u5b58 graph</li> <li>\u589e\u52a0 <code>get_compiled_graph()</code> \u8bbf\u95ee\u5668</li> <li> <p><code>get_controller()</code> \u6539\u4e3a\u590d\u7528\u7f13\u5b58 graph\uff0c\u4ec5\u6ce8\u5165\u8bf7\u6c42\u7ea7 manager</p> </li> <li> <p>\u6539\u9020 <code>core/controller.py</code></p> </li> <li> <p>\u6240\u6709 graph \u8c03\u7528\u70b9\uff08<code>ainvoke</code>/<code>astream</code>\u3001new/resume\uff09\u7edf\u4e00\u4f20\u5165 <code>context=GraphContext(...)</code></p> </li> <li> <p>\u6539\u9020 <code>api/routers/chat.py</code></p> </li> <li>\u4e24\u4e2a\u540e\u53f0\u4efb\u52a1\uff08<code>execute_and_push</code> / <code>execute_resume</code>\uff09\u6539\u4e3a\u590d\u7528 <code>get_compiled_graph()</code></li> <li> <p>\u5220\u9664\u4efb\u52a1\u5185\u91cd\u590d\u7f16\u8bd1 graph \u7684\u903b\u8f91</p> </li> <li> <p>\u6d4b\u8bd5\u9002\u914d</p> </li> <li><code>tests/test_core_graph.py</code> / <code>tests/test_core_graph_stream.py</code>\uff1a\u6d4b\u8bd5\u73af\u5883\u6539\u4e3a\u201cgraph \u7f16\u8bd1\u4e00\u6b21 + \u8bf7\u6c42\u7ea7 manager \u590d\u7528 graph\u201d</li> </ol> <p>\u5173\u952e\u6ce8\u610f\u4e8b\u9879\uff08\u5fc5\u987b\u6ee1\u8db3\uff09: - <code>compiled_graph</code> \u7edd\u4e0d\u80fd\u6301\u6709 request-scoped \u5bf9\u8c61\uff08\u5c24\u5176 <code>ArtifactManager</code> / <code>AsyncSession</code>\uff09 - \u5f00\u542f graph \u7f13\u5b58\u540e\uff0cgraph \u5185\u7ed1\u5b9a\u7684 tool/agent \u5b9e\u4f8b\u4f1a\u8de8\u8bf7\u6c42\u590d\u7528\uff1b\u6240\u6709\u5de5\u5177\u9700\u4fdd\u8bc1\u65e0\u72b6\u6001\u6216\u5e76\u53d1\u5b89\u5168 - <code>web_fetch</code> \u7b49\u5de5\u5177\u82e5\u6301\u6709\u53ef\u53d8\u5b9e\u4f8b\u72b6\u6001\uff08\u914d\u7f6e/\u8fd0\u884c\u5bf9\u8c61\uff09\uff0c\u5e94\u6539\u4e3a\u6267\u884c\u671f\u5c40\u90e8\u521b\u5efa\uff0c\u907f\u514d\u8de8\u8bf7\u6c42\u72b6\u6001\u6c61\u67d3 - \u9700\u9501\u5b9a\u652f\u6301 runtime context \u7684 LangGraph \u7248\u672c\uff0c\u907f\u514d\u73af\u5883\u89e3\u6790\u5230\u65e7\u7248\u672c\u5bfc\u81f4\u8fd0\u884c\u65f6\u9519\u8bef - context \u4e0d\u4f1a\u6301\u4e45\u5316\u5230 checkpoint\uff0cresume \u8def\u5f84\u5fc5\u987b\u6bcf\u6b21\u91cd\u65b0\u4f20\u5165 context</p> <p>\u4e3a\u4f55\u5148 defer: - \u5f53\u524d\u66f4\u5173\u6ce8\u5e76\u53d1\u6b63\u786e\u6027\u4e0e\u7a33\u5b9a\u6027\uff0c\u4f18\u5148\u907f\u514d\u4e00\u6b21\u6027\u5f15\u5165\u201c\u7f13\u5b58 + \u4f9d\u8d56\u6ce8\u5165\u6a21\u578b\u5207\u6362 + tool \u751f\u547d\u5468\u671f\u53d8\u5316\u201d\u7684\u590d\u5408\u6539\u52a8\u98ce\u9669 - Phase 5/6\uff08Redis + PostgreSQL \u8fc1\u79fb\uff09\u5b8c\u6210\u540e\u518d\u7ed3\u5408\u538b\u6d4b\u6570\u636e\u8bc4\u4f30\uff0c\u6536\u76ca/\u98ce\u9669\u6bd4\u66f4\u6e05\u6670</p> <p>\u540e\u7eed\u89e6\u53d1\u6761\u4ef6\uff08\u518d\u5f00\u542f\u672c\u9879\uff09: - \u6709\u660e\u786e\u6570\u636e\u8868\u660e graph \u7f16\u8bd1\u8017\u65f6\u663e\u8457\u5f71\u54cd p95/p99 \u6216\u541e\u5410 - \u5b8c\u6210\u5de5\u5177\u65e0\u72b6\u6001\u5316\u5ba1\u8ba1\uff08\u81f3\u5c11 <code>artifact_ops</code>\u3001<code>web_fetch</code>\uff09 - \u6709\u53ef\u81ea\u52a8\u5316\u56de\u5f52\u8986\u76d6 new/resume/streaming/\u5e76\u53d1\u53cc\u4f1a\u8bdd</p>"},{"location":"_archive/optimization-plan/#phase-4-\u8ba4\u8bc1\u6846\u67b6--done","title":"Phase 4: \u8ba4\u8bc1\u6846\u67b6 \u2705 DONE","text":"<p>\u76ee\u6807: \u5b9e\u73b0\u7528\u6237\u8ba4\u8bc1\u548c\u79df\u6237\u9694\u79bb\uff0c\u6240\u6709 API \u8def\u7531\u5f3a\u5236 <code>current_user</code>\u3002</p> <p>\u5b8c\u6210\u4e8e: commit <code>8d367ae</code> \u2014 JWT \u8ba4\u8bc1\u6846\u67b6\u5168\u9762\u5b9e\u73b0\u3002\u540e\u7aef\uff1aJWT \u7b7e\u53d1/\u9a8c\u8bc1\u3001User \u6a21\u578b\u3001get_current_user \u4f9d\u8d56\u6ce8\u5165\u3001\u6240\u6709\u8def\u7531 user_id \u8fc7\u6ee4\u3001SSE \u8fde\u63a5\u8ba4\u8bc1\u3001resume \u5f52\u5c5e\u6821\u9a8c\u3001admin \u7528\u6237\u7ba1\u7406 API\u3002\u524d\u7aef\uff1a\u767b\u5f55\u9875\u3001authStore\uff08Zustand + localStorage\uff09\u3001AuthGuard \u8def\u7531\u4fdd\u62a4\u3001API \u8bf7\u6c42\u81ea\u52a8\u9644\u52a0 token\u3001401 \u5168\u5c40\u62e6\u622a\u8df3\u8f6c\u767b\u5f55\u9875\u3001UserMenu + \u7ba1\u7406\u5458\u7528\u6237\u7ba1\u7406 UI\u3002CLI\uff1alogin/logout \u547d\u4ee4\u3001token \u6301\u4e45\u5316\u3002\u9644\u5e26 code review \u4fee\u590d\uff08<code>821f20a</code>\uff09\u3001\u7528\u6237\u7ba1\u7406 UI\uff08<code>b573be1</code>\uff09\u3001logout \u72b6\u6001\u6e05\u7406\uff08<code>0a06643</code>\uff09\u7b49\u3002</p>"},{"location":"_archive/optimization-plan/#41-\u540e\u7aef\u8ba4\u8bc1-","title":"4.1 \u540e\u7aef\u8ba4\u8bc1 \u2705","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/dependencies.py</code> \u2014 <code>get_current_user()</code> \u6539\u4e3a\u771f\u5b9e\u5b9e\u73b0 - <code>src/api/main.py</code> \u2014 \u53ef\u80fd\u9700\u8981\u8ba4\u8bc1\u4e2d\u95f4\u4ef6 - <code>src/api/routers/chat.py</code> \u2014 \u6240\u6709\u8def\u7531\u6ce8\u5165 <code>current_user</code> - <code>src/api/routers/artifacts.py</code> \u2014 \u6240\u6709\u8def\u7531\u6ce8\u5165 <code>current_user</code> - <code>src/api/routers/stream.py</code> \u2014 SSE \u8fde\u63a5\u8ba4\u8bc1 - <code>src/db/models.py</code> \u2014 <code>Conversation.user_id</code> \u5df2\u9884\u7559\uff0c\u9700\u8981\u65b0\u589e User \u6a21\u578b\u6216\u4f9d\u8d56\u5916\u90e8 IdP - <code>src/repositories/</code> \u2014 \u6240\u6709\u67e5\u8be2\u589e\u52a0 <code>user_id</code> \u8fc7\u6ee4\u6761\u4ef6</p> <p>\u6539\u52a8: - \u9009\u62e9\u8ba4\u8bc1\u65b9\u6848\uff1aJWT\uff08\u81ea\u7b7e\u53d1\uff09\u6216 OAuth2\uff08\u63a5\u5165\u5916\u90e8 IdP\uff09 - \u5b9e\u73b0 <code>get_current_user()</code> \u4ece <code>Authorization: Bearer &lt;token&gt;</code> \u89e3\u6790\u7528\u6237 - \u6240\u6709 conversation/artifact \u67e5\u8be2\u589e\u52a0 <code>WHERE user_id = :current_user</code> \u8fc7\u6ee4 - SSE \u7aef\u70b9\u652f\u6301 query param \u4f20 token\uff08\u56e0\u4e3a EventSource \u4e0d\u652f\u6301\u81ea\u5b9a\u4e49 header\uff0c\u4f46\u6211\u4eec\u7528 fetch \u6240\u4ee5\u53ef\u4ee5\u7528 header\uff09 - resume \u6d41\u7a0b\u589e\u52a0\u7528\u6237\u5f52\u5c5e\u6821\u9a8c</p>"},{"location":"_archive/optimization-plan/#42-\u524d\u7aef\u8ba4\u8bc1-","title":"4.2 \u524d\u7aef\u8ba4\u8bc1 \u2705","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>frontend/src/</code> \u2014 \u65b0\u589e\u767b\u5f55\u9875\u9762\u7ec4\u4ef6 - <code>frontend/src/lib/api.ts</code> \u2014 \u6240\u6709\u8bf7\u6c42\u9644\u52a0 Authorization header - <code>frontend/src/lib/sse.ts</code> \u2014 SSE \u8fde\u63a5\u9644\u52a0 token - <code>frontend/src/stores/</code> \u2014 \u65b0\u589e authStore\uff08token \u5b58\u50a8\u3001\u767b\u5f55\u72b6\u6001\uff09 - <code>frontend/src/app/</code> \u2014 \u8def\u7531\u4fdd\u62a4\uff08\u672a\u767b\u5f55\u8df3\u8f6c\u767b\u5f55\u9875\uff09</p> <p>\u6539\u52a8: - \u65b0\u589e\u767b\u5f55/\u6ce8\u518c\u9875\u9762 - api.ts \u5c01\u88c5\u8bf7\u6c42\u62e6\u622a\u5668\uff0c\u81ea\u52a8\u9644\u52a0 token - 401 \u54cd\u5e94\u5168\u5c40\u62e6\u622a\uff0c\u8df3\u8f6c\u767b\u5f55\u9875 - token \u6301\u4e45\u5316\u5230 localStorage\uff0c\u5237\u65b0\u9875\u9762\u4e0d\u4e22\u5931</p>"},{"location":"_archive/optimization-plan/#phase-5-redis-\u5f15\u5165--\u6570\u636e\u5e93\u53ef\u79fb\u690d\u6027\u57fa\u7ebf","title":"Phase 5: Redis \u5f15\u5165 + \u6570\u636e\u5e93\u53ef\u79fb\u690d\u6027\u57fa\u7ebf","text":"<p>\u76ee\u6807: \u89e3\u51b3\u6700\u7d27\u8feb\u7684\u5e76\u53d1\u74f6\u9888\uff08checkpointer \u5355\u8fde\u63a5\u4e32\u884c\uff09\uff0c\u5efa\u7acb\u6570\u636e\u5e93\u53ef\u79fb\u690d\u6027\u62bd\u8c61\u5c42\uff0c\u4e3a Phase 6 PostgreSQL \u8fc1\u79fb\u94fa\u8def\u3002</p> <p>\u6267\u884c\u987a\u5e8f\u8c03\u6574\u8bf4\u660e: \u539f\u8ba1\u5212 Phase 5 PostgreSQL \u2192 Phase 6 Redis\uff0c\u4f46\u5f53\u524d\u6700\u660e\u786e\u7684\u5e76\u53d1\u74f6\u9888\u662f checkpointer \u5355\u8fde\u63a5\u4e32\u884c\uff08<code>concurrency.md</code> L105-108\uff09\uff0c\u5e94\u4f18\u5148\u89e3\u51b3\u3002Redis \u524d\u7f6e\u53ef\u66f4\u5feb\u83b7\u5f97\u5e76\u53d1\u6536\u76ca\uff0cPostgreSQL \u8fc1\u79fb\u6539\u4e3a Phase 6\u3002</p>"},{"location":"_archive/optimization-plan/#51-\u6570\u636e\u5e93\u53ef\u79fb\u690d\u6027\u57fa\u7ebf","title":"5.1 \u6570\u636e\u5e93\u53ef\u79fb\u690d\u6027\u57fa\u7ebf","text":"<p>\u52a8\u673a: \u5728\u8fdb\u884c\u4efb\u4f55\u6570\u636e\u5e93\u8fc1\u79fb\u4e4b\u524d\uff0c\u786e\u4fdd Repository \u5c42\u4e0d\u7ed1\u5b9a\u7279\u5b9a SQL \u65b9\u8a00\u3002\u672a\u6765\u5207\u6362\u6570\u636e\u5e93\uff08PostgreSQL \u2192 MySQL/TDSQL\uff09\u53ea\u9700\u8c03\u6574\u8fde\u63a5\u914d\u7f6e\u548c\u8fc1\u79fb\u811a\u672c\uff0c\u4e0d\u6539\u4e1a\u52a1\u903b\u8f91\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/repositories/base.py</code> \u2014 \u65b0\u589e\u65b9\u8a00\u9002\u914d\u5de5\u5177\u65b9\u6cd5 - <code>src/repositories/artifact_repo.py</code> \u2014 RETURNING \u5b50\u53e5\u9002\u914d\uff08L309-325\uff0c\u5f53\u524d\u552f\u4e00\u7684 RETURNING \u7528\u6cd5\uff09 - <code>src/db/database.py</code> \u2014 \u63d0\u53d6\u65b9\u8a00\u68c0\u6d4b\u80fd\u529b\uff08L86-88 <code>_is_sqlite()</code>\uff09\uff0c\u66b4\u9732\u7ed9 Repository \u5c42 - <code>src/db/migrations/</code> \u2014 Alembic \u521d\u59cb\u5316</p> <p>\u6539\u52a8:</p> <p>5.1.1 RETURNING \u5b50\u53e5\u53ef\u79fb\u690d\u9002\u914d</p> <p><code>artifact_repo.py:324</code> \u7684\u4e50\u89c2\u9501\u66f4\u65b0\u4f7f\u7528\u4e86 <code>.returning()</code>\uff0cMySQL \u4e0d\u652f\u6301\u3002\u8bbe\u8ba1\u53ef\u79fb\u690d\u65b9\u6848\uff1a</p> <ul> <li><code>BaseRepository</code> \u65b0\u589e <code>_supports_returning() -&gt; bool</code> \u65b9\u6cd5\uff0c\u57fa\u4e8e\u5f15\u64ce\u65b9\u8a00\u5224\u65ad</li> <li><code>ArtifactRepository.update_artifact_content()</code> \u6539\u4e3a\uff1a</li> <li>\u652f\u6301 RETURNING\uff08PostgreSQL, SQLite 3.35+\uff09\u2192 \u539f\u5b50 <code>UPDATE...RETURNING</code>\uff08\u5f53\u524d\u884c\u4e3a\uff09</li> <li>\u4e0d\u652f\u6301 RETURNING\uff08MySQL\uff09\u2192 fallback \u4e3a <code>UPDATE</code> + <code>SELECT</code> \u4e24\u6b65\u64cd\u4f5c</li> <li>\u4e24\u6761\u8def\u5f84\u5728\u529f\u80fd\u4e0a\u7b49\u4ef7\uff0c\u4ec5\u6027\u80fd\u5dee\u5f02\uff08\u4e00\u6b21 vs \u4e24\u6b21 DB \u8c03\u7528\uff09</li> </ul> <p>5.1.2 Alembic \u8fc1\u79fb\u6846\u67b6</p> <p>\u66ff\u6362\u624b\u5199 SQL \u8fc1\u79fb\uff08<code>001_initial_schema.py</code> \u4f7f\u7528\u539f\u751f SQL \u542b <code>AUTOINCREMENT</code>\u3001<code>INSERT OR IGNORE</code> \u7b49 SQLite \u65b9\u8a00\uff09\uff1a</p> <ul> <li><code>alembic init</code> \u521d\u59cb\u5316\uff0c<code>env.py</code> \u914d\u7f6e async engine</li> <li>\u4ece\u5f53\u524d ORM models \u751f\u6210\u521d\u59cb\u8fc1\u79fb\uff08<code>alembic revision --autogenerate</code>\uff09</li> <li>\u8fc1\u79fb\u811a\u672c\u4e2d\u4f7f\u7528 SQLAlchemy DDL API\uff0c\u4e0d\u5199\u65b9\u8a00\u4e13\u5c5e SQL</li> <li>\u8fc1\u79fb\u6267\u884c\u7b56\u7565\uff1a\u90e8\u7f72\u524d\u5355\u6b21\u6267\u884c\uff08CLI \u547d\u4ee4\u6216 init container\uff09\uff0c\u4e0d\u5728\u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8 <code>upgrade head</code>\uff08\u591a worker \u540c\u65f6\u542f\u52a8\u4f1a\u5bfc\u81f4\u5e76\u53d1\u8fc1\u79fb\u7ade\u6001\uff09</li> <li><code>DatabaseManager.initialize()</code> \u6539\u4e3a schema version \u6821\u9a8c\uff1a\u542f\u52a8\u65f6\u68c0\u67e5\u5f53\u524d DB \u7248\u672c\u662f\u5426\u5339\u914d\u9884\u671f\uff0c\u4e0d\u5339\u914d\u5219 fail fast \u5e76\u63d0\u793a\u8fd0\u884c\u8fc1\u79fb\u547d\u4ee4</li> <li>\u65e7\u8fc1\u79fb\u811a\u672c <code>001_initial_schema.py</code> \u4fdd\u7559\uff0c\u6807\u8bb0\u4e3a archived</li> </ul> <p>5.1.3 Repository \u5c42\u65b9\u8a00\u5ba1\u8ba1</p> <p>\u786e\u8ba4\u6240\u6709 Repository \u4ec5\u4f7f\u7528 SQLAlchemy \u901a\u7528 ORM \u80fd\u529b\uff08\u5f53\u524d\u72b6\u6001\u626b\u63cf\u7ed3\u679c\uff09\uff1a - \u2705 \u65e0\u539f\u751f SQL\uff08\u9664 PRAGMA\uff0c\u5df2\u5728 <code>database.py</code> \u6761\u4ef6\u63a7\u5236\uff09 - \u2705 \u65e0 SQLite \u7279\u6709\u51fd\u6570\uff08ROWID\u3001typeof \u7b49\uff09 - \u2705 JSON \u7c7b\u578b\u4f7f\u7528 SQLAlchemy <code>JSON</code>\uff08PostgreSQL \u81ea\u52a8\u6620\u5c04 JSONB\uff09 - \u2705 \u6240\u6709\u67e5\u8be2\u901a\u8fc7 ORM \u6784\u9020\uff0c\u65e0\u5b57\u7b26\u4e32\u62fc\u63a5 SQL - \u26a0\ufe0f RETURNING \u5b50\u53e5\uff08artifact_repo.py L324\uff09\u2192 5.1.1 \u5df2\u5904\u7406</p> <p>\u9000\u51fa\u6807\u51c6: - RETURNING \u9002\u914d\u5c42\u6709\u5355\u5143\u6d4b\u8bd5\u8986\u76d6\u4e24\u6761\u8def\u5f84\uff08RETURNING / fallback\uff09   - \u6ce8\u610f\uff1aCI \u4ec5 SQLite + PostgreSQL\uff0c\u4e24\u8005\u90fd\u652f\u6301 RETURNING\uff0cfallback \u8def\u5f84\u4e0d\u4f1a\u88ab\u81ea\u7136\u89e6\u53d1\u3002\u9700\u589e\u52a0\u5f3a\u5236 fallback \u6a21\u5f0f\u7684\u5355\u6d4b\uff1amock <code>_supports_returning()</code> \u8fd4\u56de False\uff0c\u9a8c\u8bc1 UPDATE + SELECT \u8def\u5f84\u7684\u6b63\u786e\u6027 - Alembic \u8fc1\u79fb\u53ef\u5728 SQLite \u4e0a\u6b63\u5e38\u6267\u884c - \u73b0\u6709\u56de\u5f52\u6d4b\u8bd5\u5168\u90e8\u901a\u8fc7</p>"},{"location":"_archive/optimization-plan/#52-redis-\u57fa\u7840\u8bbe\u65bd--checkpointer-\u8fc1\u79fb","title":"5.2 Redis \u57fa\u7840\u8bbe\u65bd + Checkpointer \u8fc1\u79fb","text":"<p>\u52a8\u673a: <code>AsyncSqliteSaver</code> \u4f7f\u7528\u5355\u4e2a <code>aiosqlite.connect()</code> \u8fde\u63a5\uff0c\u5185\u90e8\u53ea\u6709\u4e00\u4e2a\u540e\u53f0\u7ebf\u7a0b + \u961f\u5217\uff0c\u6240\u6709 checkpoint \u64cd\u4f5c\u4e32\u884c\u6267\u884c\u3002N \u4e2a\u5e76\u53d1\u7528\u6237\u7684\u6240\u6709 checkpoint \u8bfb\u5199\u6392\u961f\uff0c\u662f\u5f53\u524d\u6700\u5927\u7684\u5168\u5c40\u5ef6\u8fdf\u74f6\u9888\u3002\u8fc1\u79fb\u5230 Redis \u53ef\u7acb\u5373\u83b7\u5f97\u5e76\u53d1\u8bfb\u5199\u80fd\u529b\u3002</p> <p>\u57fa\u7840\u8bbe\u65bd\u524d\u7f6e\u6761\u4ef6: - Redis \u5fc5\u987b\u4f7f\u7528 Redis Stack\uff08<code>redis/redis-stack</code> Docker \u955c\u50cf\uff09\uff0c\u56e0\u4e3a <code>langgraph-checkpoint-redis</code> \u4f9d\u8d56 RedisJSON + RediSearch \u6a21\u5757 - \u9a8c\u8bc1\uff1a<code>redis-cli MODULE LIST</code> \u8f93\u51fa\u4e2d\u9700\u5305\u542b <code>ReJSON</code> \u548c <code>search</code></p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>docker-compose.yml</code> \u2014 \u65b0\u589e Redis Stack \u670d\u52a1 - <code>src/api/config.py</code> \u2014 \u65b0\u589e <code>REDIS_URL</code>\u3001<code>CHECKPOINT_TTL</code> - <code>src/core/graph.py</code> \u2014 \u66ff\u6362 <code>create_async_sqlite_checkpointer()</code>\uff08L662-713\uff09 - <code>src/api/dependencies.py</code> \u2014 \u66ff\u6362 checkpointer \u521d\u59cb\u5316/\u6e05\u7406\uff08L60-93, L96-122\uff09 - <code>requirements.txt</code> \u2014 \u65b0\u589e <code>langgraph-checkpoint-redis</code>\u3001<code>redis[hiredis]</code></p> <p>\u6539\u52a8:</p> <p>5.2.1 Redis Stack Docker \u914d\u7f6e</p> <pre><code>redis:\n  image: redis/redis-stack:7.4.0-v3    # \u7248\u672c pin\uff0c\u4e0d\u7528 latest\n  ports:\n    - \"6379:6379\"\n    - \"8001:8001\"    # RedisInsight\uff08\u5f00\u53d1\u8c03\u8bd5\u7528\uff0c\u751f\u4ea7\u53ef\u79fb\u9664\uff09\n  volumes:\n    - redis_data:/data\n  command: &gt;\n    redis-stack-server\n    --appendonly yes\n    --appendfsync everysec\n    --save 900 1\n    --save 300 10\n    --maxmemory 512mb\n    --maxmemory-policy noeviction\n  healthcheck:\n    test: [\"CMD\", \"redis-cli\", \"ping\"]\n    interval: 10s\n    timeout: 5s\n    retries: 3\n</code></pre> <p>\u5173\u952e\u914d\u7f6e\u8bf4\u660e\uff1a - \u7248\u672c pin: <code>7.4.0-v3</code>\uff08\u6216\u5f53\u65f6\u6700\u65b0\u7a33\u5b9a\u7248\uff09\uff0c\u907f\u514d <code>latest</code> \u5bfc\u81f4\u4e0d\u53ef\u9884\u671f\u53d8\u66f4 - AOF \u6301\u4e45\u5316: <code>appendonly yes</code> + <code>appendfsync everysec</code>\uff08\u5e73\u8861\u6027\u80fd\u4e0e\u6570\u636e\u5b89\u5168\uff09 - RDB \u5feb\u7167: <code>save 900 1</code> / <code>save 300 10</code>\uff08\u515c\u5e95\u6062\u590d\uff09 - \u5185\u5b58\u7b56\u7565: <code>noeviction</code> \u2014 checkpoint \u662f\u6838\u5fc3\u72b6\u6001\uff0c\u4e0d\u5141\u8bb8\u88ab LRU \u6dd8\u6c70\uff1b\u5185\u5b58\u6ee1\u65f6\u8fd4\u56de OOM \u9519\u8bef\uff0c\u7531\u5e94\u7528\u5c42\u8fd4\u56de 503 - \u5355\u8282\u70b9\u90e8\u7f72: \u5f53\u524d\u9636\u6bb5\u4e0d\u5f15\u5165 Sentinel/Cluster\u3002\u5355\u8282\u70b9\u9650\u5236\uff1a\u65e0\u81ea\u52a8\u6545\u969c\u8f6c\u79fb\uff0cRedis \u8fdb\u7a0b\u6302\u6389\u9700\u624b\u52a8\u91cd\u542f\u3002\u540e\u7eed\u5982\u9700 HA\uff0c\u5347\u7ea7\u8def\u5f84\u4e3a Redis Sentinel\uff08\u4e3b\u4ece + \u81ea\u52a8\u6545\u969c\u8f6c\u79fb\uff09\u6216\u4e91\u6258\u7ba1 Redis</p> <p>5.2.2 Checkpointer \u8fc1\u79fb</p> <p><code>src/core/graph.py</code> \u2014 \u65b0\u589e <code>create_redis_checkpointer()</code> \u66ff\u6362 <code>create_async_sqlite_checkpointer()</code>\uff1a</p> <pre><code>async def create_redis_checkpointer(redis_url: str, ttl: dict | None = None):\n    from langgraph.checkpoint.redis.aio import AsyncRedisSaver\n    checkpointer = AsyncRedisSaver.from_conn_string(redis_url, ttl=ttl)\n    await checkpointer.setup()\n    return checkpointer\n</code></pre> <p><code>src/api/config.py</code> \u65b0\u589e\uff1a - <code>REDIS_URL: str = \"redis://localhost:6379\"</code> - <code>CHECKPOINT_TTL: int = 86400</code>\uff0824 \u5c0f\u65f6\uff0c\u79d2\uff09</p> <p><code>src/api/dependencies.py</code> \u6539\u52a8\uff1a - <code>init_globals()</code>: <code>create_redis_checkpointer(config.REDIS_URL, ttl={\"checkpoint_ns\": config.CHECKPOINT_TTL})</code> \u66ff\u6362 <code>create_async_sqlite_checkpointer()</code> - <code>close_globals()</code>: \u66ff\u6362 <code>checkpointer.conn.close()</code> \u4e3a Redis \u8fde\u63a5\u5173\u95ed - \u79fb\u9664 <code>LANGGRAPH_DB_PATH</code> \u914d\u7f6e\u9879\u548c <code>data/langgraph.db</code> \u6587\u4ef6\u4f9d\u8d56</p> <p>5.2.3 \u6545\u969c\u5904\u7406</p> <p>\u5f53\u524d\u6267\u884c\u8def\u5f84\u662f <code>POST /chat</code> \u2192 <code>task_manager.submit()</code> \u2192 \u7acb\u5373\u8fd4\u56de 200 \u2192 background task \u6267\u884c graph\u3002Redis \u6545\u969c\u5982\u679c\u53d1\u751f\u5728 background task \u9636\u6bb5\uff0cHTTP \u54cd\u5e94\u5df2\u7ecf\u8fd4\u56de\uff0c\u65e0\u6cd5\u8ffd\u6eaf\u6539\u4e3a 503\u3002\u56e0\u6b64\u9700\u8981\u533a\u5206\u4e24\u79cd\u573a\u666f\uff1a</p> <ul> <li>\u542f\u52a8\u65f6 Redis \u4e0d\u53ef\u7528 \u2192 <code>init_globals()</code> \u629b\u5f02\u5e38\uff0c\u5e94\u7528\u542f\u52a8\u5931\u8d25\uff08fail fast\uff09\uff0c\u4e0d\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1</li> <li>\u8bf7\u6c42\u65f6 Redis \u5df2\u77e5\u4e0d\u53ef\u7528 \u2192 submit \u524d\u5065\u5eb7\u95e8\u63a7\uff1a\u5728 <code>POST /chat</code> \u548c <code>resume</code> \u7684 router \u5165\u53e3\u5904\uff0c\u8c03\u7528 <code>redis.ping()</code> \u63a2\u6d3b\uff1b\u5931\u8d25\u5219\u76f4\u63a5\u8fd4\u56de HTTP 503 + <code>{\"detail\": \"Checkpoint service unavailable\"}</code>\uff0c\u4e0d\u63d0\u4ea4 background task</li> <li>\u6d89\u53ca\u6587\u4ef6\uff1a<code>src/api/routers/chat.py</code> L195, L441\uff08<code>task_manager.submit()</code> \u8c03\u7528\u524d\uff09</li> <li>\u5b9e\u73b0\u65b9\u5f0f\uff1a\u65b0\u589e FastAPI \u4f9d\u8d56 <code>require_redis_healthy()</code> \u6216\u5728 router \u51fd\u6570\u5165\u53e3\u663e\u5f0f\u68c0\u67e5</li> <li>\u6267\u884c\u4e2d Redis \u65ad\u8fde\uff08\u5df2\u901a\u8fc7\u5065\u5eb7\u95e8\u63a7\u4f46\u6267\u884c\u8fc7\u7a0b\u4e2d\u65ad\u8fde\uff09\u2192 background task \u6355\u83b7\u5f02\u5e38\uff0c\u63a8\u9001 SSE error \u4e8b\u4ef6 <code>{\"type\": \"error\", \"data\": {\"error\": \"Checkpoint service unavailable\"}}</code>\uff0c\u524d\u7aef\u5c55\u793a\u9519\u8bef\u63d0\u793a</li> <li>TTL \u8fc7\u671f \u2192 resume \u65f6 checkpointer \u67e5\u65e0\u6570\u636e \u2192 HTTP 410 Gone + <code>{\"detail\": \"\u4f1a\u8bdd\u72b6\u6001\u5df2\u8fc7\u671f\uff0c\u8bf7\u91cd\u65b0\u53d1\u9001\u6d88\u606f\"}</code></li> <li>\u65e5\u5fd7\u8bb0\u5f55 Redis \u8fde\u63a5\u72b6\u6001\u53d8\u5316\uff0c\u4fbf\u4e8e\u8fd0\u7ef4\u76d1\u63a7</li> </ul> <p>\u9000\u51fa\u6807\u51c6: - <code>checkpointer.setup()</code> \u6210\u529f\uff0cinterrupt/resume \u7aef\u5230\u7aef\u901a\u8fc7 - TTL \u81ea\u52a8\u8fc7\u671f\u9a8c\u8bc1\uff08\u8bbe\u77ed TTL \u2192 \u7b49\u5f85 \u2192 resume \u5f97\u5230 410\uff09 - \u542f\u52a8\u65f6 Redis \u4e0d\u53ef\u7528 \u2192 \u5e94\u7528\u542f\u52a8\u5931\u8d25\uff08fail fast \u9a8c\u8bc1\uff09 - \u8bf7\u6c42\u65f6 Redis \u4e0d\u53ef\u7528 \u2192 \u5065\u5eb7\u95e8\u63a7\u8fd4\u56de 503\uff08submit \u524d\u62e6\u622a\u9a8c\u8bc1\uff09 - \u6267\u884c\u4e2d Redis \u65ad\u8fde \u2192 SSE error \u4e8b\u4ef6\u63a8\u9001\u5230\u524d\u7aef - \u73b0\u6709\u56de\u5f52\u6d4b\u8bd5\u5168\u90e8\u901a\u8fc7\uff08checkpointer \u66ff\u6362\u5bf9\u4e0a\u5c42\u900f\u660e\uff09</p>"},{"location":"_archive/optimization-plan/#53-streammanager-\u8fc1\u79fb\u5230-redis-streams","title":"5.3 StreamManager \u8fc1\u79fb\u5230 Redis Streams","text":"<p>\u52a8\u673a: \u5f53\u524d <code>asyncio.Queue</code> \u4ec5\u652f\u6301\u5355\u8fdb\u7a0b\u90e8\u7f72\u3002Pub/Sub \u65ad\u7ebf\u4e0d\u53ef\u56de\u653e\uff0c\u4e0e\"\u65ad\u7ebf\u91cd\u8fde\u4e0d\u4e22\u6d88\u606f\"\u76ee\u6807\u51b2\u7a81\u3002Redis Streams \u662f\u552f\u4e00\u6ee1\u8db3\u53ef\u9760\u6295\u9012\u9700\u6c42\u7684\u65b9\u6848\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/services/stream_manager.py</code> \u2014 \u6838\u5fc3\u91cd\u6784 - <code>src/api/dependencies.py</code> \u2014 Redis \u8fde\u63a5\u590d\u7528\uff085.2 \u5df2\u5efa\u7acb\uff09 - <code>src/api/routers/stream.py</code> \u2014 \u652f\u6301 <code>Last-Event-ID</code> header</p> <p>\u6539\u52a8:</p> <p>5.3.1 \u4e3a\u4ec0\u4e48\u9009 Redis Streams\uff08\u975e Pub/Sub\uff09</p> \u7279\u6027 Pub/Sub Redis Streams \u65ad\u7ebf\u91cd\u653e \u274c \u6d88\u8d39\u8005\u4e0d\u5728\u7ebf\u5219\u6d88\u606f\u4e22\u5931 \u2705 \u57fa\u4e8e ID \u4ece\u65ad\u70b9\u91cd\u653e \u6d88\u606f\u6301\u4e45\u5316 \u274c \u5185\u5b58\u4e2d\u5373\u65f6\u6295\u9012 \u2705 \u6301\u4e45\u5316\u5230 AOF/RDB \u6d88\u8d39\u8005\u7ec4 \u274c \u2705 \u652f\u6301\u591a\u6d88\u8d39\u8005 + ACK \u5386\u53f2\u6d88\u606f\u67e5\u8be2 \u274c \u2705 XRANGE / XREAD \u80cc\u538b\u63a7\u5236 \u274c \u2705 MAXLEN / XTRIM <p>5.3.2 StreamManager \u91cd\u6784\u8bbe\u8ba1</p> <p>\u6838\u5fc3\u6a21\u578b\uff1a - \u6bcf\u4e2a <code>thread_id</code> \u5bf9\u5e94\u4e00\u4e2a Redis Stream key: <code>stream:{thread_id}</code> - \u4e8b\u4ef6\u5199\u5165: <code>XADD stream:{thread_id} MAXLEN ~1000 * event_type {type} data {json}</code> - \u4e8b\u4ef6\u6d88\u8d39: <code>XREAD BLOCK {timeout} STREAMS stream:{thread_id} {last_id}</code> - \u65ad\u7ebf\u91cd\u8fde: \u524d\u7aef\u901a\u8fc7 <code>Last-Event-ID</code> header \u4f20\u5165\u4e0a\u6b21\u6536\u5230\u7684 event ID \u2192 \u4ece\u8be5 ID \u4e4b\u540e\u8bfb\u53d6 - \u6e05\u7406: Stream key \u8bbe\u7f6e TTL\uff08<code>EXPIRE stream:{thread_id} {config.STREAM_TTL}</code>\uff09\uff0c\u7ec8\u7ed3\u4e8b\u4ef6\u540e\u5230\u671f\u81ea\u52a8\u5220\u9664 - \u6240\u6709\u6743\u9694\u79bb: Stream metadata \u4e2d\u5b58\u50a8 <code>owner_user_id</code>\uff0c\u6d88\u8d39\u65f6\u6821\u9a8c</p> <p>StreamManager \u5bf9\u5916 API \u4fdd\u6301\u4e0d\u53d8\uff08\u5bf9\u4e0a\u5c42\u900f\u660e\uff09\uff1a - <code>create_stream(thread_id, owner_user_id)</code> \u2192 \u521b\u5efa Stream key + \u5b58\u50a8 owner + \u8bbe\u7f6e TTL - <code>push_event(thread_id, event)</code> \u2192 <code>XADD</code>\uff0c\u8fd4\u56de False \u5f53 stream \u5df2\u5173\u95ed\uff08\u4fe1\u53f7 background task \u505c\u6b62\uff09 - <code>consume_events(thread_id, last_event_id?)</code> \u2192 <code>XREAD BLOCK</code> async generator\uff0c\u652f\u6301\u5fc3\u8df3 - <code>close_stream(thread_id)</code> \u2192 \u63a8\u9001\u7ec8\u7ed3\u4e8b\u4ef6 + \u6807\u8bb0\u5173\u95ed\uff08\u4fdd\u7559 TTL \u7a97\u53e3\u4f9b\u65ad\u7ebf\u91cd\u8fde\uff09</p> <p>\u5185\u90e8\u79fb\u9664\uff1a - <code>_streams: dict</code> \u2192 \u4e0d\u518d\u9700\u8981\u5185\u5b58\u5b57\u5178 - <code>asyncio.Queue</code> \u2192 \u66ff\u6362\u4e3a Redis Streams - <code>asyncio.Lock</code> \u2192 Redis \u539f\u5b50\u64cd\u4f5c\u5929\u7136\u5e76\u53d1\u5b89\u5168 - TTL asyncio.Task \u2192 Redis <code>EXPIRE</code> \u539f\u751f\u652f\u6301</p> <p>5.3.3 SSE \u7aef\u70b9\u652f\u6301\u65ad\u7ebf\u91cd\u8fde</p> <p><code>src/api/routers/stream.py</code> \u6539\u52a8\uff1a - \u8bfb\u53d6 <code>Last-Event-ID</code> request header - \u4f20\u5165 <code>consume_events(thread_id, last_event_id=...)</code> - SSE \u54cd\u5e94\u4e2d\u6bcf\u4e2a\u4e8b\u4ef6\u9644\u5e26 <code>id:</code> \u5b57\u6bb5\uff08\u4f7f\u7528 Redis Stream entry ID\uff0c\u5982 <code>1234567890-0</code>\uff09 - \u524d\u7aef\u9700\u6539\u52a8\uff1a\u6211\u4eec\u4f7f\u7528 fetch + ReadableStream\uff08\u975e EventSource\uff09\uff0c\u6d4f\u89c8\u5668\u4e0d\u4f1a\u81ea\u52a8\u5904\u7406 <code>Last-Event-ID</code>\u3002\u9700\u5728 <code>frontend/src/lib/sse.ts</code> \u4e2d\u624b\u52a8\u7ef4\u62a4 <code>last_event_id</code>\uff08\u4ece\u6bcf\u4e2a SSE \u4e8b\u4ef6\u7684 <code>id:</code> \u5b57\u6bb5\u63d0\u53d6\uff09\uff0c\u65ad\u7ebf\u91cd\u8fde\u65f6\u901a\u8fc7 <code>Last-Event-ID</code> request header \u643a\u5e26</p> <p>Redis \u6545\u969c\u4e0b <code>GET /stream</code> \u7684\u884c\u4e3a\u7ea6\u5b9a\uff08\u8865\u5145 5.2.3 \u4ec5\u8986\u76d6 POST/resume \u7684\u7f3a\u53e3\uff09\uff1a</p> <ul> <li>\u8fde\u63a5\u5efa\u7acb\u65f6 Redis \u4e0d\u53ef\u7528\uff08<code>XREAD</code> \u5931\u8d25\uff09\u2192 \u8fd4\u56de HTTP 503\uff08SSE \u8fde\u63a5\u672a\u5efa\u7acb\uff0c\u53ef\u7528 HTTP \u72b6\u6001\u7801\uff09</li> <li>\u6d41\u4f20\u8f93\u4e2d Redis \u65ad\u8fde \u2192 \u53d1\u9001 SSE error \u4e8b\u4ef6 <code>{\"type\": \"error\", \"data\": {\"error\": \"Stream service unavailable\"}}</code>\uff0c\u5173\u95ed SSE \u8fde\u63a5\u3002\u524d\u7aef\u53ef\u7528 <code>last_event_id</code> \u5c1d\u8bd5\u91cd\u8fde</li> <li>\u4e0e 5.2.3 \u7684\u8bed\u4e49\u4e00\u81f4\uff1a\u8bf7\u6c42\u5165\u53e3\u53ef\u62e6\u622a\u65f6\u7528 HTTP \u72b6\u6001\u7801\uff0c\u5df2\u8fdb\u5165\u6d41\u4f20\u8f93\u5219\u7528 SSE error \u4e8b\u4ef6</li> </ul> <p>\u9000\u51fa\u6807\u51c6: - \u8de8\u8bf7\u6c42\u4e8b\u4ef6\u6295\u9012\u6210\u529f\uff08POST push \u2192 GET consume\uff09 - \u65ad\u7ebf\u91cd\u8fde\u6d4b\u8bd5\uff1a\u6d88\u8d39\u4e2d\u65ad \u2192 \u7528 <code>last_event_id</code> \u91cd\u8fde \u2192 \u4e0d\u4e22\u6d88\u606f - TTL \u81ea\u52a8\u6e05\u7406\u9a8c\u8bc1\uff08Stream key \u8fc7\u671f\u540e\u88ab\u5220\u9664\uff09 - \u591a worker \u573a\u666f\u6d4b\u8bd5\uff08\u4e24\u4e2a\u8fdb\u7a0b\uff0c\u4e00\u4e2a push \u4e00\u4e2a consume\uff09 - \u6240\u6709\u6743\u9694\u79bb\u6d4b\u8bd5\uff08\u975e owner \u6d88\u8d39\u88ab\u62d2\u7edd\uff09 - Redis \u6545\u969c\u6d4b\u8bd5\uff1a<code>GET /stream</code> \u8fde\u63a5\u5efa\u7acb\u65f6 503 + \u6d41\u4e2d\u65ad\u65f6 SSE error - \u73b0\u6709\u56de\u5f52\u6d4b\u8bd5\u5168\u90e8\u901a\u8fc7</p>"},{"location":"_archive/optimization-plan/#54-manager-\u7f13\u5b58\u51b3\u7b56","title":"5.4 Manager \u7f13\u5b58\u51b3\u7b56","text":"<p>\u51b3\u7b56: ConversationManager \u548c ArtifactManager \u5747\u4fdd\u6301 request-local \u5185\u5b58\u7f13\u5b58\uff0c\u4e0d\u8fc1\u79fb\u5230 Redis\u3002</p> <p>\u8986\u76d6\u8303\u56f4: - <code>ConversationManager._cache</code>\uff08<code>conversation_manager.py</code> L88\uff09\u2014 <code>Dict[str, ConversationCache]</code> - <code>ArtifactManager._cache</code>\uff08<code>artifact_ops.py</code> L187\uff09\u2014 <code>Dict[str, Dict[str, ArtifactMemory]]</code></p> <p>\u4e24\u8005\u662f\u540c\u6784\u6a21\u5f0f\uff1a\u90fd\u662f\u8bf7\u6c42\u7ea7\u5b9e\u4f8b\u5185\u7684 Python dict\uff0c\u751f\u547d\u5468\u671f\u4e0e\u8bf7\u6c42\u7ed1\u5b9a\u3002</p> <p>\u7406\u7531: - \u4e24\u4e2a Manager \u90fd\u662f\u8bf7\u6c42\u7ea7\u5b9e\u4f8b\uff08<code>dependencies.py</code> L192 ArtifactManager, L208 ConversationManager\uff09\uff0c\u6bcf\u6b21\u8bf7\u6c42\u521b\u5efa\u65b0\u5b9e\u4f8b - <code>_cache</code> dict \u5929\u7136\u77ed\u751f\u547d\u5468\u671f\uff08\u968f\u8bf7\u6c42\u7ed3\u675f GC\uff09\uff0c\u4e0d\u5b58\u5728\u8de8\u8bf7\u6c42\u72b6\u6001\u5171\u4eab\u95ee\u9898 - \u8fc1\u79fb\u5230 Redis \u4f1a\u589e\u52a0\u6bcf\u6b21\u8bfb\u64cd\u4f5c\u7684\u7f51\u7edc RTT\uff08~0.1ms local dict \u2192 ~1ms Redis\uff09\uff0c\u65e0\u5b9e\u9645\u6536\u76ca - Phase 6 PostgreSQL \u8fc1\u79fb\u540e\uff0c\u6570\u636e\u5e93\u67e5\u8be2\u6027\u80fd\u8db3\u4ee5\u652f\u6491\u65e0\u7f13\u5b58\u573a\u666f</p> <p>\u4e0d\u505a\u6539\u52a8\u3002\u540e\u7eed\u82e5\u51fa\u73b0\u70ed\u70b9\u67e5\u8be2\u6027\u80fd\u95ee\u9898\uff0c\u518d\u8003\u8651 Redis \u7f13\u5b58\uff0c\u4f46\u4ec5\u5bf9\u7279\u5b9a\u70ed\u70b9\u8def\u5f84\uff0c\u4e0d\u5168\u91cf\u8fc1\u79fb\u3002</p>"},{"location":"_archive/optimization-plan/#55-taskmanager-\u591a-worker-\u9002\u914d","title":"5.5 TaskManager \u591a Worker \u9002\u914d","text":"<p>\u52a8\u673a: \u5f53\u524d <code>TaskManager</code> \u662f\u7eaf\u8fdb\u7a0b\u5185\u5b9e\u73b0\uff08<code>_tasks: dict</code> + <code>asyncio.Semaphore</code>\uff09\uff0c\u53ea\u80fd\u7ba1\u7406\u5355 worker \u5185\u7684\u4efb\u52a1\u3002\u591a worker \u90e8\u7f72\u4e0b\u65e0\u6cd5\u9632\u6b62\u540c\u4e00 <code>thread_id</code> \u88ab\u4e0d\u540c worker \u91cd\u590d\u6267\u884c\uff0c\u4e5f\u65e0\u6cd5\u505a\u5168\u5c40\u5e76\u53d1\u63a7\u5236\u3002</p> <p>\u8bbe\u8ba1\u539f\u5219: \u4e24\u5c42\u67b6\u6784 \u2014 \u4fdd\u7559\u672c\u5730 <code>TaskManager</code>\uff08\u751f\u547d\u5468\u671f\u7ba1\u7406\u3001\u4f18\u96c5\u505c\u673a\uff09\uff0c\u65b0\u589e Redis \u5206\u5e03\u5f0f\u534f\u8c03\u5c42\u3002</p> <p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/services/task_manager.py</code> \u2014 \u65b0\u589e\u5206\u5e03\u5f0f\u9501\u96c6\u6210 - <code>src/api/routers/chat.py</code> \u2014 <code>submit</code> \u524d\u52a0\u9501\uff08L195, L441\uff09 - <code>src/api/dependencies.py</code> \u2014 Redis \u8fde\u63a5\u6ce8\u5165\uff08\u590d\u7528 5.2 \u7684\u8fde\u63a5\uff09</p> <p>\u6539\u52a8:</p> <p>5.5.1 [P1] \u5206\u5e03\u5f0f\u9501 \u2014 \u9632\u91cd\u590d\u6267\u884c</p> <p>\u5728 <code>task_manager.submit()</code> \u524d\uff0c\u5bf9 <code>thread_id</code> \u52a0 Redis \u5206\u5e03\u5f0f\u9501\uff0c\u9632\u6b62\u540c\u4e00\u4efb\u52a1\u88ab\u591a\u4e2a worker \u540c\u65f6\u6267\u884c\uff1a</p> <pre><code># \u4f2a\u4ee3\u7801 \u2014 chat.py submit \u524d\nlock_key = f\"task_lock:{thread_id}\"\nlock_token = str(uuid4())  # \u552f\u4e00 token\uff0c\u6807\u8bc6\u672c\u6b21\u52a0\u9501\u8005\nacquired = await redis.set(lock_key, lock_token, nx=True, ex=config.STREAM_TIMEOUT)\nif not acquired:\n    raise HTTPException(409, \"Task already running for this thread\")\n# submit \u540e\u5728 background task finally \u4e2d\u91ca\u653e\u9501\uff08\u5fc5\u987b\u6821\u9a8c token\uff09\n</code></pre> <ul> <li>\u9501\u7684 TTL = <code>STREAM_TIMEOUT</code>\uff08\u515c\u5e95\u8d85\u65f6\u91ca\u653e\uff0c\u9632\u6b62 worker \u5d29\u6e83\u540e\u6b7b\u9501\uff09</li> <li>\u91ca\u653e\u65f6\u5fc5\u987b\u6821\u9a8c token\uff1a\u4f7f\u7528 Lua \u811a\u672c compare-and-del\uff0c\u9632\u6b62\u8bef\u5220\u5176\u4ed6 worker \u7684\u9501\uff08\u573a\u666f\uff1a\u4efb\u52a1\u8d85\u65f6 \u2192 \u9501\u8fc7\u671f \u2192 \u88ab\u65b0 worker \u62a2\u5360 \u2192 \u65e7\u4efb\u52a1 finally \u4e0d\u80fd\u76f4\u63a5 <code>DEL</code>\uff09</li> </ul> <pre><code>-- Lua compare-and-del\uff08\u539f\u5b50\u64cd\u4f5c\uff09\nif redis.call(\"GET\", KEYS[1]) == ARGV[1] then\n    return redis.call(\"DEL\", KEYS[1])\nelse\n    return 0\nend\n</code></pre> <ul> <li>resume \u7aef\u70b9\u540c\u7406\uff08L441\uff09</li> </ul> <p>\u6ce8\u610f\uff1a<code>thread_id</code> \u9501\u89e3\u51b3\u7684\u662f\"\u540c\u4e00\u4efb\u52a1\u88ab\u591a worker \u91cd\u590d\u6267\u884c\"\u7684\u95ee\u9898\u3002\u5b83\u4e0d\u8986\u76d6\u5ba2\u6237\u7aef\u91cd\u8bd5\u5e42\u7b49\u6027\uff08\u56e0\u4e3a\u6bcf\u6b21 <code>POST /chat</code> \u4f1a\u751f\u6210\u65b0 <code>thread_id</code>\uff09\u3002\u5982\u9700\u9632\u6b62\u5ba2\u6237\u7aef\u91cd\u8bd5\u5bfc\u81f4\u91cd\u590d\u6267\u884c\uff0c\u9700\u989d\u5916\u8bbe\u8ba1 idempotency key\uff08\u5982\u524d\u7aef\u751f\u6210\u8bf7\u6c42\u7ea7 UUID \u901a\u8fc7 header \u4f20\u5165\uff0c\u540e\u7aef\u7528 Redis <code>SET NX</code> \u53bb\u91cd\uff09\u3002\u5f53\u524d\u9636\u6bb5\u4e0d\u505a\uff0c\u4f5c\u4e3a\u540e\u7eed Phase \u53ef\u9009\u9879\u8bb0\u5f55\u3002</p> <p>5.5.2 [P2] \u5168\u5c40\u5e76\u53d1\u4e0a\u9650 \u23f8\ufe0f Deferred</p> <p>\u5f53\u524d\u9636\u6bb5\u4fdd\u7559\u672c\u5730 <code>Semaphore</code> \u505a per-worker \u5e76\u53d1\u63a7\u5236\uff0c\u4e0d\u505a Redis \u5168\u5c40\u9650\u6d41\u3002</p> <p>\u7406\u7531\uff1a\u672c\u5730 Semaphore \u5df2\u80fd\u9632\u6b62\u5355 worker \u8fc7\u8f7d\uff1b\u5168\u5c40\u9650\u6d41\uff08ZSET \u4fe1\u53f7\u91cf + Lua\uff09\u589e\u52a0\u590d\u6742\u5ea6\u4f46\u5728\u5f53\u524d\u90e8\u7f72\u89c4\u6a21\u4e0b\u6536\u76ca\u4e0d\u660e\u786e\u3002</p> <p>\u89e6\u53d1\u6761\u4ef6\uff08\u518d\u5f00\u542f\u672c\u9879\uff09\uff1a - \u538b\u6d4b\u6570\u636e\u8868\u660e\u591a worker \u95f4\u5e76\u53d1\u603b\u91cf\u9700\u8981\u5168\u5c40\u63a7\u5236 - \u51fa\u73b0\u8fc7\u56e0\u7f3a\u5c11\u5168\u5c40\u9650\u6d41\u5bfc\u81f4\u7684\u8d44\u6e90\u4e89\u62a2\u95ee\u9898</p> <p>\u5019\u9009\u65b9\u6848\uff08\u5df2\u8c03\u7814\uff0c\u672a\u843d\u5730\uff09\uff1aZSET \u4fe1\u53f7\u91cf + Lua \u539f\u5b50 acquire/release\uff08member=thread_id, score=\u8fc7\u671f\u65f6\u95f4\u6233\uff09\uff0cacquire \u65f6 ZREMRANGEBYSCORE \u6e05\u7406\u8fc7\u671f\u79df\u7ea6 \u2192 ZCARD \u68c0\u67e5 \u2192 ZADD \u767b\u8bb0\u3002\u907f\u514d\u88f8 INCR/DECR\uff08\u5d29\u6e83\u6cc4\u6f0f\uff09\u3001DBSIZE\uff08\u7edf\u8ba1\u65e0\u5173 key\uff09\u3001SCAN\uff08O(N) \u70ed\u8def\u5f84\uff09\u3002</p> <p>5.5.3 [P2] \u4efb\u52a1\u72b6\u6001\u767b\u8bb0 \u23f8\ufe0f Deferred</p> <p>\u5c06\u8fd0\u884c\u4e2d\u7684\u4efb\u52a1\u6ce8\u518c\u5230 Redis Hash \u63d0\u5347\u53ef\u89c2\u6d4b\u6027\u3002\u540c\u6837\u7b49\u538b\u6d4b\u6216\u8fd0\u7ef4\u9700\u6c42\u9a71\u52a8\u518d\u5b9e\u65bd\u3002</p> <p>\u9000\u51fa\u6807\u51c6\uff08\u672c\u8f6e\u4ec5\u8986\u76d6 5.5.1\uff09: - \u540c\u4e00 <code>thread_id</code> \u5e76\u53d1\u63d0\u4ea4\u5230\u4e0d\u540c worker \u2192 \u7b2c\u4e8c\u4e2a\u88ab\u62d2\u7edd\uff08409\uff09 - Worker \u5d29\u6e83\u540e\u9501\u81ea\u52a8\u91ca\u653e\uff08TTL \u515c\u5e95\uff09 - \u672c\u5730\u751f\u547d\u5468\u671f\u7ba1\u7406\uff08\u5f15\u7528\u6301\u6709\u3001\u4f18\u96c5\u505c\u673a\uff09\u4e0d\u53d7\u5f71\u54cd</p>"},{"location":"_archive/optimization-plan/#phase-6-postgresql-\u8fc1\u79fb","title":"Phase 6: PostgreSQL \u8fc1\u79fb","text":"<p>\u76ee\u6807: \u4e3b\u6570\u636e\u5e93\u4ece SQLite \u8fc1\u79fb\u5230 PostgreSQL\uff0c\u83b7\u5f97\u771f\u6b63\u7684\u591a\u5199\u8005\u5e76\u53d1\uff08MVCC\uff09\u3001\u590d\u5408\u7d22\u5f15\u6027\u80fd\u3001\u751f\u4ea7\u7ea7\u8fde\u63a5\u6c60\u7ba1\u7406\u3002</p> <p>\u524d\u7f6e\u4f9d\u8d56: Phase 5.1\uff08\u53ef\u79fb\u690d\u6027\u57fa\u7ebf + Alembic\uff09\u5df2\u5b8c\u6210\u3002</p>"},{"location":"_archive/optimization-plan/#61-\u6570\u636e\u5e93\u5f15\u64ce\u5207\u6362","title":"6.1 \u6570\u636e\u5e93\u5f15\u64ce\u5207\u6362","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>src/db/database.py</code> \u2014 <code>DatabaseManager</code> \u591a\u5f15\u64ce\u9002\u914d - <code>src/api/config.py</code> \u2014 <code>DATABASE_URL</code> \u9ed8\u8ba4\u503c\u66f4\u65b0 - <code>requirements.txt</code> \u2014 \u65b0\u589e <code>asyncpg</code> - <code>docker-compose.yml</code> \u2014 \u65b0\u589e PostgreSQL \u670d\u52a1</p> <p>\u6539\u52a8:</p> <p>6.1.1 DatabaseManager \u591a\u5f15\u64ce\u9002\u914d</p> <ul> <li>\u4fdd\u7559 <code>_is_sqlite()</code>\uff0c\u65b0\u589e <code>_get_dialect() -&gt; str</code>\uff08\u8fd4\u56de <code>\"sqlite\"</code> / <code>\"postgresql\"</code> / <code>\"mysql\"</code> \u7b49\uff09</li> <li>SQLite \u4fdd\u7559 WAL \u914d\u7f6e\uff08<code>_configure_sqlite_wal()</code> \u6761\u4ef6\u8c03\u7528\uff0c\u5f53\u524d\u5df2\u5b9e\u73b0 \u2705\uff09\uff0c\u4ecd\u53ef\u7528\u4e8e\u5f00\u53d1/\u6d4b\u8bd5</li> <li>PostgreSQL \u8fde\u63a5\u6c60\u53c2\u6570\uff1a</li> </ul> <pre><code>if self._get_dialect() == \"postgresql\":\n    engine_kwargs.update({\n        \"pool_size\": 10,          # \u57fa\u7840\u8fde\u63a5\u6570\n        \"max_overflow\": 20,       # \u5cf0\u503c\u6ea2\u51fa\u8fde\u63a5\n        \"pool_timeout\": 30,       # \u7b49\u5f85\u8fde\u63a5\u8d85\u65f6\n        \"pool_recycle\": 1800,     # \u8fde\u63a5\u6700\u5927\u5b58\u6d3b 30 \u5206\u949f\n        \"pool_pre_ping\": True,    # \u53d6\u8fde\u63a5\u524d ping \u9a8c\u6d3b\uff0c\u9632\u6b62\u4f7f\u7528\u5df2\u65ad\u5f00\u7684\u8fde\u63a5\n    })\n</code></pre> <ul> <li>\u53ef\u9009\uff1aPostgreSQL \u5355\u8bed\u53e5\u8d85\u65f6 <code>connect_args={\"server_settings\": {\"statement_timeout\": \"30000\"}}</code></li> </ul> <p>6.1.2 Docker PostgreSQL \u670d\u52a1</p> <pre><code>postgres:\n  image: postgres:16-alpine\n  environment:\n    POSTGRES_DB: artifactflow\n    POSTGRES_USER: artifactflow\n    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}\n  ports:\n    - \"5432:5432\"\n  volumes:\n    - postgres_data:/var/lib/postgresql/data\n  healthcheck:\n    test: [\"CMD-SHELL\", \"pg_isready -U artifactflow\"]\n    interval: 10s\n    timeout: 5s\n    retries: 5\n</code></pre> <p>backend \u670d\u52a1 <code>depends_on</code> \u589e\u52a0 <code>postgres</code> \u548c <code>redis</code>\uff08\u542b health condition\uff09\u3002</p>"},{"location":"_archive/optimization-plan/#62-schema-\u8fc1\u79fb\u4e0e\u7c7b\u578b\u9002\u914d","title":"6.2 Schema \u8fc1\u79fb\u4e0e\u7c7b\u578b\u9002\u914d","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>src/db/models.py</code> \u2014 \u7c7b\u578b\u5ba1\u67e5 - <code>src/db/migrations/</code> \u2014 Alembic \u8fc1\u79fb\u811a\u672c\uff085.1.2 \u5df2\u521d\u59cb\u5316\uff09 - <code>scripts/</code> \u2014 \u6570\u636e\u8fc1\u79fb\u811a\u672c</p> <p>\u6539\u52a8:</p> <p>6.2.1 ORM \u6a21\u578b\u7c7b\u578b\u5ba1\u67e5</p> <p>\u5f53\u524d\u6a21\u578b\u5df2\u57fa\u672c\u517c\u5bb9 PostgreSQL\uff0c\u9700\u786e\u8ba4\u7684\u70b9\uff1a - <code>JSON</code> \u2192 SQLAlchemy \u5728 PostgreSQL \u4e0a\u81ea\u52a8\u6620\u5c04\u4e3a <code>JSONB</code>\uff08\u517c\u5bb9 \u2705\uff0c\u53ef\u663e\u5f0f\u6807\u6ce8\u63d0\u5347\u53ef\u8bfb\u6027\uff09 - <code>DateTime</code> \u2192 PostgreSQL <code>TIMESTAMP</code>\uff08\u517c\u5bb9 \u2705\uff09 - <code>String(N)</code> \u2192 <code>VARCHAR(N)</code>\uff08\u517c\u5bb9 \u2705\uff09 - <code>Text</code> \u2192 <code>TEXT</code>\uff08\u517c\u5bb9 \u2705\uff09 - <code>Integer</code> + <code>autoincrement=True</code>\uff08<code>artifact_versions.id</code>\uff09\u2192 PostgreSQL <code>SERIAL</code>\uff08SQLAlchemy \u81ea\u52a8\u5904\u7406 \u2705\uff09</p> <p>6.2.2 \u6570\u636e\u8fc1\u79fb\u5de5\u5177</p> <p>\u7f16\u5199 <code>scripts/migrate_sqlite_to_pg.py</code>\uff1a - \u4ece SQLite \u6309 FK \u4f9d\u8d56\u987a\u5e8f\u8bfb\u53d6\u6240\u6709\u8868\u6570\u636e - \u5199\u5165 PostgreSQL\uff08\u6279\u91cf INSERT\uff09 - \u6821\u9a8c\u6bcf\u5f20\u8868\u7684\u8bb0\u5f55\u6570\u4e00\u81f4\u6027 - \u652f\u6301 <code>--dry-run</code> \u6a21\u5f0f\uff08\u53ea\u8bfb\u4e0d\u5199\uff0c\u8f93\u51fa\u8fc1\u79fb\u8ba1\u5212\uff09</p>"},{"location":"_archive/optimization-plan/#63-\u6027\u80fd\u4f18\u5316--\u590d\u5408\u7d22\u5f15","title":"6.3 \u6027\u80fd\u4f18\u5316 \u2014 \u590d\u5408\u7d22\u5f15","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>src/db/models.py</code> \u2014 \u65b0\u589e\u590d\u5408\u7d22\u5f15\u5b9a\u4e49 - Alembic \u8fc1\u79fb\u811a\u672c</p> <p>\u6539\u52a8:</p> <p>\u57fa\u4e8e\u70ed\u70b9\u67e5\u8be2\u5206\u6790\u65b0\u589e\u590d\u5408\u7d22\u5f15\uff1a</p> <pre><code># conversations \u8868\n# \u70ed\u70b9\u67e5\u8be2\uff1alist_conversations() \u2014 WHERE user_id=? ORDER BY updated_at DESC\n# \u6587\u4ef6\uff1aconversation_repo.py L210, L213\nIndex(\"ix_conversations_user_updated\", \"user_id\", \"updated_at\")\n\n# messages \u8868\n# \u70ed\u70b9\u67e5\u8be2\uff1aconversation \u5185\u6d88\u606f\u52a0\u8f7d \u2014 WHERE conversation_id=? ORDER BY created_at\n# \u6587\u4ef6\uff1aconversation_repo.py L386\nIndex(\"ix_messages_conv_created\", \"conversation_id\", \"created_at\")\n\n# artifact_versions \u8868\n# \u70ed\u70b9\u67e5\u8be2\uff1a\u7248\u672c\u5386\u53f2 \u2014 WHERE artifact_id=? AND session_id=? ORDER BY version\n# \u5df2\u6709 UniqueConstraint(artifact_id, session_id, version) \u53ef\u590d\u7528 \u2705\n</code></pre> <p>\u6ce8\u610f\uff1a\u8fd9\u4e9b\u7d22\u5f15\u5728 SQLite \u4e0a\u540c\u6837\u6709\u6548\uff08SQLAlchemy \u7edf\u4e00\u521b\u5efa\uff09\uff0c\u4e0d\u5f71\u54cd\u53ef\u79fb\u690d\u6027\u3002</p> <p>\u9000\u51fa\u6807\u51c6: - PostgreSQL \u4e0a\u6240\u6709\u56de\u5f52\u6d4b\u8bd5\u901a\u8fc7 - PostgreSQL \u5e76\u53d1\u5199\u5165\u6d4b\u8bd5\u901a\u8fc7\uff08\u6a21\u62df\u591a\u8bf7\u6c42\u540c\u65f6\u5199\u5165 conversation/message/artifact\uff09 - SQLite \u6a21\u5f0f\u4ecd\u53ef\u6b63\u5e38\u5de5\u4f5c\uff08\u5f00\u53d1/\u6d4b\u8bd5\u573a\u666f\uff09 - \u6570\u636e\u8fc1\u79fb\u811a\u672c\u6267\u884c\u6210\u529f + \u8bb0\u5f55\u6570\u6821\u9a8c\u901a\u8fc7 - \u590d\u5408\u7d22\u5f15\u5728 EXPLAIN \u4e2d\u88ab\u6b63\u786e\u4f7f\u7528</p>"},{"location":"_archive/optimization-plan/#\u6d4b\u8bd5\u7b56\u7565\u8d2f\u7a7f-phase-5--phase-6","title":"\u6d4b\u8bd5\u7b56\u7565\uff08\u8d2f\u7a7f Phase 5 / Phase 6\uff09","text":"<p>\u5f53\u524d\u6d4b\u8bd5\u57fa\u5ea7\u662f\u5185\u5b58 SQLite\uff08<code>tests/conftest.py</code> L50-60\uff09\uff0c\u65e0\u6cd5\u8986\u76d6 PostgreSQL/Redis \u884c\u4e3a\u5dee\u5f02\u3002\u9700\u8981\u5efa\u7acb\u591a\u6570\u636e\u5e93\u6d4b\u8bd5\u57fa\u7840\u8bbe\u65bd\u3002</p>"},{"location":"_archive/optimization-plan/#\u6d4b\u8bd5\u57fa\u7840\u8bbe\u65bd\u6539\u9020","title":"\u6d4b\u8bd5\u57fa\u7840\u8bbe\u65bd\u6539\u9020","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>tests/conftest.py</code> \u2014 \u591a\u6570\u636e\u5e93 fixture - <code>tests/integration/</code> \u2014 \u65b0\u589e\u96c6\u6210\u6d4b\u8bd5\u76ee\u5f55 - CI \u914d\u7f6e \u2014 \u591a\u6570\u636e\u5e93 matrix</p> <p>\u6539\u52a8:</p> <p>\u73af\u5883\u53d8\u91cf\u9a71\u52a8\u7684\u6570\u636e\u5e93\u9009\u62e9:</p> <pre><code># tests/conftest.py\n@pytest.fixture(scope=\"session\")\ndef db_manager():\n    db_url = os.environ.get(\"TEST_DATABASE_URL\", \"sqlite+aiosqlite:///:memory:\")\n    manager = DatabaseManager(db_url)\n    ...\n</code></pre> <p>CI Matrix:</p> <pre><code>strategy:\n  matrix:\n    database: [sqlite, postgres]\n    # MySQL \u53ef\u9009\uff0c\u540e\u7eed\u6309\u9700\u52a0\u5165\n</code></pre> <p>Redis \u96c6\u6210\u6d4b\u8bd5\uff08<code>tests/integration/</code>\uff09: - <code>test_redis_checkpointer.py</code> \u2014 checkpoint CRUD / TTL \u8fc7\u671f / interrupt-resume - <code>test_redis_stream_manager.py</code> \u2014 \u4e8b\u4ef6\u63a8\u9001/\u6d88\u8d39/\u65ad\u7ebf\u91cd\u8fde/TTL \u6e05\u7406 - <code>test_redis_fault.py</code> \u2014 Redis \u65ad\u8fde\u540e 503 \u54cd\u5e94\u3001Redis \u6062\u590d\u540e\u81ea\u52a8\u91cd\u8fde - <code>test_returning_adapter.py</code> \u2014 RETURNING \u9002\u914d\u5c42\u6d4b\u8bd5\uff1aSQLite / PostgreSQL \u884c\u4e3a\u4e00\u81f4\u6027 + mock <code>_supports_returning()=False</code> \u5f3a\u5236 fallback \u8def\u5f84\uff08CI \u7684\u4e24\u79cd\u6570\u636e\u5e93\u90fd\u652f\u6301 RETURNING\uff0c\u4e0d mock \u5219 fallback \u6c38\u8fdc\u4e0d\u88ab\u6267\u884c\uff09</p> <p>\u5e76\u53d1\u6d4b\u8bd5\u589e\u5f3a: - \u591a\u8bf7\u6c42\u5e76\u53d1\u5199\u5165 conversation/message/artifact\uff08\u9a8c\u8bc1 PostgreSQL MVCC \u4f18\u4e8e SQLite \u5355\u5199\u8005\uff09 - \u591a worker stream push/consume\uff08\u9a8c\u8bc1 Redis Streams \u8de8\u8fdb\u7a0b\u6295\u9012\uff09</p>"},{"location":"_archive/optimization-plan/#phase-7-\u6587\u4ef6\u4e0a\u4f20--artifact","title":"Phase 7: \u6587\u4ef6\u4e0a\u4f20 \u2192 Artifact","text":"<p>\u76ee\u6807: \u652f\u6301\u7528\u6237\u4e0a\u4f20\u6587\u6863\uff0c\u89e3\u6790\u4e3a Artifact \u4f9b Agent \u64cd\u4f5c\u3002</p>"},{"location":"_archive/optimization-plan/#71-\u540e\u7aef\u4e0a\u4f20-api","title":"7.1 \u540e\u7aef\u4e0a\u4f20 API","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/routers/artifacts.py</code> \u2014 \u65b0\u589e <code>POST /api/v1/artifacts/{session_id}/upload</code> - <code>src/api/schemas/</code> \u2014 \u65b0\u589e\u4e0a\u4f20\u8bf7\u6c42/\u54cd\u5e94 schema - <code>src/tools/implementations/artifact_ops.py</code> \u2014 \u65b0\u589e <code>create_from_upload()</code> \u65b9\u6cd5</p> <p>\u6539\u52a8: - \u65b0\u589e\u4e0a\u4f20\u7aef\u70b9\uff0c\u63a5\u53d7 <code>UploadFile</code>\uff08multipart/form-data\uff09 - \u652f\u6301\u6587\u4ef6\u7c7b\u578b\uff1a<code>.txt</code>, <code>.md</code>, <code>.pdf</code>, <code>.csv</code>, <code>.json</code> \u7b49 - \u6587\u4ef6\u89e3\u6790 pipeline\uff1a\u68c0\u6d4b\u7c7b\u578b \u2192 \u63d0\u53d6\u6587\u672c \u2192 \u521b\u5efa Artifact\uff08<code>metadata.source = \"user_upload\"</code>\uff09 - \u6587\u4ef6\u5927\u5c0f\u9650\u5236 + \u7c7b\u578b\u767d\u540d\u5355\u6821\u9a8c - PDF \u89e3\u6790\u53ef\u590d\u7528 <code>web_fetch</code> \u4e2d\u7684 PDF \u5904\u7406\u903b\u8f91\uff08\u5982\u6709\uff09</p>"},{"location":"_archive/optimization-plan/#72-\u524d\u7aef\u4e0a\u4f20-ui","title":"7.2 \u524d\u7aef\u4e0a\u4f20 UI","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>frontend/src/components/chat/</code> \u2014 \u5df2\u6709\u4e0a\u4f20\u6309\u94ae\uff08<code>d122b01</code> commit \u63d0\u5230 \"add upload file button\"\uff09 - <code>frontend/src/lib/api.ts</code> \u2014 \u65b0\u589e\u4e0a\u4f20 API \u8c03\u7528 - <code>frontend/src/stores/artifactStore.ts</code> \u2014 \u4e0a\u4f20\u72b6\u6001\u7ba1\u7406</p> <p>\u6539\u52a8: - \u8fde\u63a5\u5df2\u6709\u7684\u4e0a\u4f20\u6309\u94ae\u5230\u5b9e\u9645\u4e0a\u4f20\u903b\u8f91 - \u4e0a\u4f20\u8fdb\u5ea6\u5c55\u793a\uff08\u8fdb\u5ea6\u6761\u6216 spinner\uff09 - \u4e0a\u4f20\u5b8c\u6210\u540e\u81ea\u52a8\u5237\u65b0 artifact \u5217\u8868 - \u62d6\u62fd\u4e0a\u4f20\u652f\u6301\uff08\u53ef\u9009\uff09</p>"},{"location":"_archive/optimization-plan/#phase-8-\u7528\u6237\u76f4\u63a5\u7f16\u8f91-artifact","title":"Phase 8: \u7528\u6237\u76f4\u63a5\u7f16\u8f91 Artifact","text":"<p>\u76ee\u6807: \u5141\u8bb8\u7528\u6237\u901a\u8fc7\u524d\u7aef\u76f4\u63a5\u7f16\u8f91 Artifact \u5185\u5bb9\uff0c\u4e0e Agent \u534f\u4f5c\u4fee\u8ba2\u3002</p>"},{"location":"_archive/optimization-plan/#81-\u540e\u7aef-artifact-\u5199\u63a5\u53e3","title":"8.1 \u540e\u7aef Artifact \u5199\u63a5\u53e3","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>src/api/routers/artifacts.py</code> \u2014 \u65b0\u589e PUT/PATCH \u7aef\u70b9 - <code>src/api/schemas/</code> \u2014 \u65b0\u589e\u66f4\u65b0\u8bf7\u6c42 schema\uff08\u542b <code>lock_version</code> \u4e50\u89c2\u9501\uff09 - <code>src/tools/implementations/artifact_ops.py</code> \u2014 \u65b0\u589e <code>update_by_user()</code> \u65b9\u6cd5 - <code>src/db/models.py</code> \u2014 Artifact \u6a21\u578b\u5df2\u6709 <code>lock_version</code> \u5b57\u6bb5</p> <p>\u6539\u52a8: - <code>PUT /api/v1/artifacts/{session_id}/{artifact_id}</code> \u2014 \u5168\u91cf\u66f4\u65b0\u5185\u5bb9 - \u8bf7\u6c42\u4f53\u5305\u542b <code>content</code> + <code>lock_version</code>\uff0c\u4e50\u89c2\u9501\u9632\u6b62\u5e76\u53d1\u51b2\u7a81 - \u66f4\u65b0\u65f6\u521b\u5efa\u65b0 version \u8bb0\u5f55\uff08<code>update_type = \"user_edit\"</code>\uff09 - \u8fd4\u56de\u65b0\u7684 <code>lock_version</code> \u4f9b\u524d\u7aef\u4e0b\u6b21\u63d0\u4ea4\u4f7f\u7528</p>"},{"location":"_archive/optimization-plan/#82-\u524d\u7aef\u7f16\u8f91-ui","title":"8.2 \u524d\u7aef\u7f16\u8f91 UI","text":"<p>\u6d89\u53ca\u6587\u4ef6: - <code>frontend/src/components/artifact/</code> \u2014 ArtifactPanel \u4e2d\u589e\u52a0\u7f16\u8f91\u6a21\u5f0f - <code>frontend/src/lib/api.ts</code> \u2014 \u65b0\u589e\u66f4\u65b0 API \u8c03\u7528 - <code>frontend/src/stores/artifactStore.ts</code> \u2014 \u7f16\u8f91\u72b6\u6001\u7ba1\u7406</p> <p>\u6539\u52a8: - Artifact \u9884\u89c8\u9762\u677f\u589e\u52a0\"\u7f16\u8f91\"\u6309\u94ae\uff0c\u5207\u6362\u5230\u7f16\u8f91\u6a21\u5f0f - \u7f16\u8f91\u6a21\u5f0f\uff1a\u4ee3\u7801\u7c7b\u578b\u7528 code editor\uff08monaco-editor \u6216 CodeMirror\uff09\uff0c\u6587\u672c\u7c7b\u578b\u7528 textarea - \u4fdd\u5b58\u65f6\u5e26 <code>lock_version</code>\uff0c\u51b2\u7a81\u65f6\u63d0\u793a\u7528\u6237\uff08409 Conflict \u2192 \u663e\u793a diff \u8ba9\u7528\u6237\u9009\u62e9\uff09 - \u4e50\u89c2\u66f4\u65b0\uff1a\u4fdd\u5b58\u540e\u7acb\u5373\u66f4\u65b0\u672c\u5730\u72b6\u6001\uff0c\u5931\u8d25\u65f6\u56de\u6eda</p>"},{"location":"_archive/optimization-plan/#\u5404-phase-\u4f9d\u8d56\u5173\u7cfb","title":"\u5404 Phase \u4f9d\u8d56\u5173\u7cfb","text":"<pre><code>Phase 1 (\u6838\u5fc3 Bug)          \u2705 \u5df2\u5b8c\u6210\nPhase 2 (\u5b89\u5168\u52a0\u56fa)          \u2705 \u5df2\u5b8c\u6210\nPhase 3 (\u6570\u636e\u8d28\u91cf)          \u2190 3.1/3.2 \u2705, 3.3 \u23f8\ufe0f\nPhase 4 (\u8ba4\u8bc1\u6846\u67b6)          \u2705 \u5df2\u5b8c\u6210\nPhase 5 (Redis + \u53ef\u79fb\u690d\u6027)   \u2190 Phase 4 \u4e4b\u540e\n  5.1 \u53ef\u79fb\u690d\u6027\u57fa\u7ebf            \u2190 \u65e0\u4f9d\u8d56\n  5.2 Redis Checkpointer     \u2190 \u65e0\u4f9d\u8d56\uff08\u53ef\u4e0e 5.1 \u5e76\u884c\uff09\n  5.3 Redis StreamManager    \u2190 \u53ef\u4e0e 5.2 \u5e76\u884c\uff08\u5171\u7528 Redis \u8fde\u63a5\uff09\n  5.4 \u7f13\u5b58\u51b3\u7b56               \u2190 \u4e0d\u505a\u6539\u52a8\uff08\u4fdd\u6301 request-local\uff09\n  5.5 TaskManager \u9002\u914d       \u2190 \u4f9d\u8d56 5.2\uff08\u9700\u8981 Redis \u8fde\u63a5\uff09\nPhase 6 (PostgreSQL)         \u2190 \u4f9d\u8d56 5.1\uff08\u53ef\u79fb\u690d\u6027\u57fa\u7ebf + Alembic\uff09\n  6.1 \u5f15\u64ce\u5207\u6362\n  6.2 Schema \u8fc1\u79fb             \u2190 \u4f9d\u8d56 6.1\n  6.3 \u590d\u5408\u7d22\u5f15                \u2190 \u4f9d\u8d56 6.2\nPhase 7 (\u6587\u4ef6\u4e0a\u4f20)           \u2190 Phase 4 \u4e4b\u540e\uff08\u9700\u8981\u8ba4\u8bc1\u77e5\u9053\u4e0a\u4f20\u8005\u662f\u8c01\uff09\nPhase 8 (\u7f16\u8f91 Artifact)      \u2190 Phase 7 \u4e4b\u540e\uff08\u4e0a\u4f20\u548c\u7f16\u8f91\u5171\u4eab\u5199\u63a5\u53e3\u6a21\u5f0f\uff09\n</code></pre> <p>\u5173\u952e\u8def\u5f84: 5.1 \u2225 5.2/5.3 \u2192 5.5 \u2192 6.1 \u2192 6.2 \u2192 6.3\uff085.1 \u4e0e 5.2 \u53ef\u5e76\u884c\uff09\u30025.2 \u5b8c\u6210\u540e\u5373\u53ef\u83b7\u5f97\u6700\u5927\u7684\u5e76\u53d1\u6027\u80fd\u63d0\u5347\uff08checkpointer \u74f6\u9888\u89e3\u9664\uff09\u3002</p>"},{"location":"_archive/optimization-plan/#\u5907\u6ce8","title":"\u5907\u6ce8","text":"<ul> <li>Phase 1-3 \u662f\u7eaf\u4fee\u590d\uff0c\u4e0d\u5f15\u5165\u65b0\u4f9d\u8d56\uff0c\u98ce\u9669\u6700\u4f4e</li> <li>Phase 4 \u662f\u7b2c\u4e00\u4e2a\u9700\u8981\u524d\u7aef\u5927\u6539\u7684\u9636\u6bb5\uff08\u767b\u5f55\u9875 + token \u7ba1\u7406\uff09</li> <li>Phase 5 \u4f18\u5148 Redis\uff08\u89e3\u51b3\u5e76\u53d1\u74f6\u9888\uff09+ \u53ef\u79fb\u690d\u6027\u57fa\u7ebf\uff08\u4e3a Phase 6 \u94fa\u8def\uff09\uff0c5.1 \u548c 5.2 \u53ef\u5e76\u884c\u63a8\u8fdb</li> <li>Phase 6 PostgreSQL \u8fc1\u79fb\u4f9d\u8d56 5.1 \u7684 Alembic \u6846\u67b6\u548c\u65b9\u8a00\u9002\u914d\u5c42</li> <li>Phase 7-8 \u662f\u529f\u80fd\u589e\u5f3a\uff0c\u53ef\u6839\u636e\u4ea7\u54c1\u9700\u6c42\u8c03\u6574\u4f18\u5148\u7ea7</li> <li>\u6570\u636e\u5e93\u53ef\u79fb\u690d\u6027 CI \u8303\u56f4\uff1a\u5f53\u524d\u53ea\u8dd1 SQLite + PostgreSQL\uff1bMySQL/TDSQL \u7b49\u6709\u5b9e\u9645\u5207\u5e93\u9700\u6c42\u65f6\u518d\u52a0\u5165 matrix</li> <li>concurrency.md \u4e2d\u5df2\u6807\u8bb0 \u2705 \u7684\u9879\u76ee\uff08\u77ed\u4e8b\u52a1\u3001\u65e5\u5fd7\u4e0a\u4e0b\u6587\u3001SSE Heartbeat \u7b49\uff09\u4e0d\u5728\u6b64\u8ba1\u5212\u4e2d\u3002TaskManager \u591a worker \u9002\u914d\u5df2\u7eb3\u5165 5.5</li> <li>Phase 5/6 \u5b8c\u6210\u540e\u9700\u540c\u6b65\u66f4\u65b0 <code>docs/architecture/concurrency.md</code>\uff08\u6f14\u8fdb\u8def\u7ebf\u3001\u8d44\u6e90\u5206\u5c42\u56fe\uff09\u548c <code>CLAUDE.md</code>\uff08\u547d\u4ee4\u3001\u67b6\u6784\u63cf\u8ff0\uff09</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/","title":"\ud83e\udd16 \u57fa\u4e8eArtifact\u7684Multi-Agent\u7814\u7a76\u7cfb\u7edf\u8bbe\u8ba1\u65b9\u6848","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u6838\u5fc3\u7406\u5ff5","title":"\ud83d\udca1 \u6838\u5fc3\u7406\u5ff5","text":"<p>\u91c7\u7528Collaborative Authoring\u6a21\u5f0f\uff0c\u901a\u8fc7Artifact\u4f5c\u4e3a\u5171\u4eab\u8bb0\u5fc6\u8f7d\u4f53\u3002\u6452\u5f03\u4f20\u7edf\u9ed1\u76d2\u5f0f\u4e00\u6b21\u6027\u751f\u6210\uff0c\u8f6c\u5411\u900f\u660e\u3001\u53ef\u63a7\u3001\u6e10\u8fdb\u5f0f\u7684\u7814\u7a76\u8fc7\u7a0b\u3002\u76f8\u6bd4\u4f20\u7edf\u300c\u4e00\u6b21\u6027\u751f\u6210\u300d\u6216\u300c\u957f\u5bf9\u8bdd\u4e0a\u4e0b\u6587\u300d\uff0cArtifact\u673a\u5236\u80fd\u6301\u7eed\u79ef\u7d2f\u548c\u7ec4\u7ec7\u4fe1\u606f\uff0c\u907f\u514d\u4e0a\u4e0b\u6587\u6df7\u4e71\uff0c\u8ba9\u7528\u6237\u548cAI\u771f\u6b63\u534f\u4f5c\u6784\u5efa\u7814\u7a76\u6210\u679c\u3002</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u7cfb\u7edf\u67b6\u6784","title":"\ud83c\udfd7\ufe0f \u7cfb\u7edf\u67b6\u6784","text":"<p>\u7cfb\u7edf\u91c7\u7528\u5206\u5c42\u8bbe\u8ba1\uff0c\u4ee5Artifact\u4f5c\u4e3a\u6838\u5fc3\u8bb0\u5fc6\u8f7d\u4f53\uff0cLead Agent\u8d1f\u8d23\u4efb\u52a1\u534f\u8c03\uff0c\u591a\u4e2aSubagent\u4e13\u95e8\u5904\u7406\u5177\u4f53\u4efb\u52a1\u3002\u901a\u8fc7\u660e\u786e\u7684\u6743\u9650\u63a7\u5236\u548c\u5355\u5411\u4fe1\u606f\u6d41\uff0c\u786e\u4fdd\u7cfb\u7edf\u8fd0\u884c\u7684\u7a33\u5b9a\u6027\u548c\u53ef\u63a7\u6027\u3002</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u6838\u5fc3\u7ec4\u4ef6","title":"\ud83e\udde9 \u6838\u5fc3\u7ec4\u4ef6","text":"<pre><code> \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n \u2502                       ARTIFACT LAYER                       \u2502\n \u2502                                                            \u2502\n \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n \u2502  \u2502       Task Plan Artifact      \u2502  \u2502    Result Artifact \u2502 \u2502\n \u2502  \u2502  - \u4efb\u52a1\u5206\u89e3 &amp; \u8fdb\u5ea6\u8ddf\u8e2a          \u2502  \u2502  - \u6700\u7ec8\u4ea7\u51fa\u6587\u6863     \u2502 \u2502\n \u2502  \u2502  - \u5171\u4eab\u7ed9\u6240\u6709Agent \u6709\u6743\u9650\u63a7\u5236   \u2502  \u2502   - \u5171\u4eab\u7ed9\u7528\u6237      \u2502 \u2502\n \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n \u2502                                                            \u2502\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2191                     \u2191                    \u2191\n           \u2502                     \u2502                    \u2502\n           \u2502 (\u8bfb\u5199)              \u2502 (\u53ea\u8bfb)              \u2502 (\u8bfb\u5199)\n           \u2502                     \u2502                    \u2502\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n \u2502   Lead Agent  \u2502      \u2502   Subagents   \u2502      \u2502    User      \u2502\n \u2502  - \u7ba1\u7406\u4efb\u52a1    \u2502      \u2502 - Search Agent\u2502      \u2502 - \u53ef\u6d4f\u89c8\u7f16\u8f91  \u2502\n \u2502  - \u534f\u8c03\u6267\u884c    \u2502      \u2502 - Web Crawl   \u2502      \u2502 - \u53ef\u7ed9\u53cd\u9988    \u2502\n \u2502  - \u6574\u5408\u7ed3\u679c    \u2502      \u2502 - Others...   \u2502      \u2502              \u2502\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Lead Agent</p> <ul> <li>\u804c\u8d23: \u4efb\u52a1\u89c4\u5212\u3001\u4fe1\u606f\u6574\u5408\u3001\u7528\u6237\u4ea4\u4e92</li> <li>\u5de5\u5177:</li> <li>Artifact\u64cd\u4f5c (create/update/rewrite)</li> <li>Subagent\u8c03\u7528\u63a5\u53e3</li> <li>\u7279\u70b9: \u4fdd\u6301\u4e0a\u4e0b\u6587\u7b80\u6d01\uff0c\u4e13\u6ce8\u4e8e\u9ad8\u5c42\u51b3\u7b56</li> </ul> <p>Subagents</p> <ul> <li>Search Agent: \u4fe1\u606f\u68c0\u7d22\uff0c\u8fd4\u56de\u7ed3\u6784\u5316\u641c\u7d22\u7ed3\u679c</li> <li>Web Crawl Agent: \u6df1\u5ea6\u5185\u5bb9\u6293\u53d6\uff0c\u63d0\u53d6\u5173\u952e\u4fe1\u606f</li> <li>\u72ec\u7acb\u6027: \u6bcf\u4e2aagent\u72ec\u7acb\u5b8c\u6210\u5206\u914d\u4efb\u52a1\uff0c\u81ea\u4e3b\u5224\u65ad\u5b8c\u6210\u6807\u51c6</li> </ul> <p>\u53ccArtifact\u673a\u5236</p> <ul> <li>Task Plan Artifact:</li> <li>Lead Agent\u6743\u9650: \u8bfb\u5199 (\u66f4\u65b0\u4efb\u52a1\u72b6\u6001\u3001\u6dfb\u52a0\u65b0\u4efb\u52a1\u3001\u4fee\u6539\u4f18\u5148\u7ea7)</li> <li>Subagent\u6743\u9650: \u53ea\u8bfb (\u4e86\u89e3\u4efb\u52a1\u9700\u6c42\u3001\u67e5\u770b\u4e0a\u4e0b\u6587\u4fe1\u606f)</li> <li>\u7528\u6237\u6743\u9650: \u53ea\u8bfb (\u67e5\u770b\u7814\u7a76\u8fdb\u5ea6\u548c\u4efb\u52a1\u72b6\u6001)</li> <li>Result Artifact:</li> <li>Lead Agent\u6743\u9650: \u8bfb\u5199 (\u6574\u5408\u4fe1\u606f\u3001\u66f4\u65b0\u5185\u5bb9\u3001\u8c03\u6574\u7ed3\u6784)</li> <li>Subagent\u6743\u9650: \u65e0\u8bbf\u95ee\u6743\u9650 (\u4fdd\u6301\u804c\u8d23\u6e05\u6670\uff0c\u907f\u514d\u76f4\u63a5\u4fee\u6539\u6700\u7ec8\u7ed3\u679c)</li> <li>\u7528\u6237\u6743\u9650: \u8bfb\u5199 (\u7f16\u8f91\u5185\u5bb9\u3001\u8c03\u6574\u683c\u5f0f\u3001\u6dfb\u52a0\u6279\u6ce8)</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5de5\u4f5c\u6d41\u7a0b","title":"\ud83d\udd04 \u5de5\u4f5c\u6d41\u7a0b","text":"<pre><code>   \u7528\u6237\u63d0\u51fa\u9700\u6c42\n        \u2502\n        \u2502 (\u5bf9\u8bdd\u4ea4\u4e92)\n        \u2193\n   Lead Agent\u521b\u5efaTask Plan\n        \u2502\n        \u2502 (\u5206\u6790\u5e76\u6d3e\u53d1\u4efb\u52a1)\n        \u2193\n   \u250c\u2500\u2500\u2500 Search Agent \u2190\u2500\u2500 (\u8bfb\u53d6Task Plan\u83b7\u53d6\u5b8c\u6574\u4e0a\u4e0b\u6587)\n   \u2502         \u2502\n   \u2502         \u2514\u2500\u2500\u2192 \u8fd4\u56de\u641c\u7d22\u7ed3\u679c\n   \u2502\n   \u251c\u2500\u2500\u2500 Crawl Agent \u2190\u2500\u2500 (\u8bfb\u53d6Task Plan\u83b7\u53d6\u5b8c\u6574\u4e0a\u4e0b\u6587)  \n   \u2502         \u2502\n   \u2502         \u2514\u2500\u2500\u2192 \u8fd4\u56de\u6293\u53d6\u7ed3\u679c\n   \u2502\n   \u2514\u2500\u2500\u2500 Other Agents...\n        \u2502\n        \u2193\nLead Agent\u6574\u5408\u4fe1\u606f\n        \u2502\n        \u2502 (\u66f4\u65b0Task Plan\u72b6\u6001)\n        \u2502 (\u66f4\u65b0Result Artifact\u5185\u5bb9)\n        \u2193\n   \u7528\u6237\u67e5\u770b\u7ed3\u679c\n        \u2502\n        \u2502 (\u7f16\u8f91Artifact\u6216\u5bf9\u8bdd\u53cd\u9988)\n        \u2193\n   Lead Agent\u6839\u636e\u53cd\u9988\u8c03\u6574\n        \u2502\n        \u2502 (\u5faa\u73af\u6267\u884c\u76f4\u5230\u6ee1\u610f)\n        \u2193\n      \u4efb\u52a1\u5b8c\u6210\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#\u9636\u6bb51-\u7814\u7a76\u89c4\u5212","title":"\u9636\u6bb51: \u7814\u7a76\u89c4\u5212","text":"<ol> <li>\u7528\u6237\u63d0\u51fa\u7814\u7a76\u9700\u6c42</li> <li>Lead Agent\u5206\u6790\u9700\u6c42\uff0c\u521b\u5efaTask Plan Artifact\u548c\u521d\u59cbResult Artifact\u6846\u67b6</li> <li>\u7cfb\u7edf\u8fdb\u5165\u6267\u884c\u9636\u6bb5</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#\u9636\u6bb52-\u4fe1\u606f\u6536\u96c6","title":"\u9636\u6bb52: \u4fe1\u606f\u6536\u96c6","text":"<ol> <li>Lead Agent\u6839\u636eTask Plan\u6d3e\u53d1\u641c\u7d22\u4efb\u52a1</li> <li>Search Agent\u8bfb\u53d6Task Plan\uff0c\u4e86\u89e3\u5177\u4f53\u641c\u7d22\u9700\u6c42\u548c\u4e0a\u4e0b\u6587</li> <li>Search Agent\u72ec\u7acb\u6267\u884c\u641c\u7d22\uff0c\u8fd4\u56de\u7ed3\u679c\u7ed9Lead Agent\uff08\u4e0d\u76f4\u63a5\u4fee\u6539\u4efb\u4f55Artifact\uff09</li> <li>Lead Agent\u63a5\u6536\u7ed3\u679c\u540e\uff1a</li> <li>\u66f4\u65b0Task Plan\u4e2d\u7684\u4efb\u52a1\u72b6\u6001</li> <li>\u5c06\u4fe1\u606f\u6574\u5408\u5230Result Artifact</li> <li>\u8bc4\u4f30\u662f\u5426\u9700\u8981\u8fdb\u4e00\u6b65\u6293\u53d6</li> <li>\u5fc5\u8981\u65f6\u6d3e\u53d1URL\u7ed9Web Crawl Agent\uff0c\u91cd\u590d\u4e0a\u8ff0\u6d41\u7a0b</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#\u9636\u6bb53-\u534f\u4f5c\u4f18\u5316","title":"\u9636\u6bb53: \u534f\u4f5c\u4f18\u5316","text":"<ol> <li>\u4efb\u52a1\u5b8c\u6210\u540e\u7684\u4ea4\u4e92\uff1aLead Agent\u5b8c\u6210\u4e00\u8f6e\u4efb\u52a1\u6267\u884c\uff0c\u5411\u7528\u6237\u5c55\u793a\u66f4\u65b0\u540e\u7684Result Artifact</li> <li>\u7528\u6237\u53cd\u9988\u65b9\u5f0f\uff1a</li> <li>\u76f4\u63a5\u7f16\u8f91Result Artifact\uff08\u4fee\u6539\u5185\u5bb9\u3001\u8c03\u6574\u7ed3\u6784\u3001\u6dfb\u52a0\u8981\u6c42\uff09</li> <li>\u901a\u8fc7\u5bf9\u8bdd\u5411Lead Agent\u63d0\u51fa\u6539\u8fdb\u8981\u6c42\uff08\"\u9700\u8981\u66f4\u591a\u4e34\u5e8a\u6570\u636e\"\u3001\"\u589e\u52a0\u5e02\u573a\u5206\u6790\u7ae0\u8282\"\uff09</li> <li>Lead Agent\u54cd\u5e94\uff1a\u6839\u636e\u7528\u6237\u53cd\u9988\u8c03\u6574Task Plan\uff0c\u6d3e\u53d1\u65b0\u7684\u4efb\u52a1\u6216\u4f18\u5316\u73b0\u6709\u5185\u5bb9</li> <li>\u8fed\u4ee3\u5faa\u73af\uff1a\u91cd\u590d\u6267\u884c\u76f4\u5230\u7528\u6237\u6ee1\u610f</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u8be6\u7ec6\u793a\u4f8b","title":"\ud83d\udcda \u8be6\u7ec6\u793a\u4f8b","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#\u793a\u4f8b1-ai\u533b\u7597\u5e94\u7528\u7814\u7a76\u62a5\u544a","title":"\u793a\u4f8b1: AI\u533b\u7597\u5e94\u7528\u7814\u7a76\u62a5\u544a","text":"<p>Task Plan Artifact</p> <pre><code># AI\u533b\u7597\u5e94\u7528\u7814\u7a76\u8fdb\u5ea6\n## \u9879\u76ee\u72b6\u6001: \ud83d\udd04 \u8fdb\u884c\u4e2d\n## \u5f53\u524d\u6267\u884c: Search Agent - \u641c\u7d22FDA\u6279\u51c6\u7684AI\u533b\u7597\u8bbe\u5907\n\n### \u7814\u7a76\u5927\u7eb2\n#### 1. AI\u533b\u7597\u5e94\u7528\u6982\u8ff0\n- \u72b6\u6001: \u2705 \u5df2\u5b8c\u6210 (\u4fe1\u606f\u5145\u5206\u5ea6: 85%)\n- \u6765\u6e90: 12\u7bc7\u6743\u5a01\u6587\u732e, 3\u4e2a\u5b98\u65b9\u62a5\u544a\n- \u8d28\u91cf\u8bc4\u4f30: \u9ad8\u8d28\u91cf\uff0c\u6db5\u76d6\u4e3b\u8981\u5e94\u7528\u9886\u57df\n\n#### 2. \u4e34\u5e8a\u8bd5\u9a8c\u73b0\u72b6\n- \u72b6\u6001: \ud83d\udd04 \u8fdb\u884c\u4e2d (60%)\n- \u5f53\u524d\u4efb\u52a1: \u641c\u7d222024\u5e74FDA\u6279\u51c6\u7684AI\u533b\u7597\u8bbe\u5907\u6e05\u5355\n- \u5df2\u6536\u96c6: 15\u4e2a\u6279\u51c6\u8bbe\u5907\uff0c8\u4e2a\u4e34\u5e8a\u8bd5\u9a8c\u6848\u4f8b\n- \u4e0b\u4e00\u6b65: \u6df1\u5ea6\u6293\u53d6\u5177\u4f53\u4ea7\u54c1\u4fe1\u606f\u548c\u4e34\u5e8a\u6570\u636e\n- [\u6682\u505c\u6b64\u4efb\u52a1] [\u8c03\u6574\u641c\u7d22\u7b56\u7565]\n\n#### 3. \u5e02\u573a\u5206\u6790\n- \u72b6\u6001: \u23f3 \u7b49\u5f85\u4e2d\n- \u4f9d\u8d56: \u9700\u8981\u7b2c2\u7ae0\u5b8c\u6210\u540e\u542f\u52a8\n- \u9884\u8ba1\u4fe1\u606f\u9700\u6c42: \u5e02\u573a\u89c4\u6a21\u3001\u4e3b\u8981\u5382\u5546\u3001\u6295\u8d44\u8d8b\u52bf\n\n#### 4. \u672a\u6765\u5c55\u671b\n- \u72b6\u6001: \u23f3 \u8ba1\u5212\u4e2d\n- \u7528\u6237\u5907\u6ce8: \u91cd\u70b9\u5173\u6ce8\u76d1\u7ba1\u653f\u7b56\u53d8\u5316\n</code></pre> <p>\u5bf9\u5e94\u7684Result Artifact (\u90e8\u5206)</p> <pre><code># AI\u533b\u7597\u5e94\u7528\u7814\u7a76\u62a5\u544a\n\n## 1. AI\u533b\u7597\u5e94\u7528\u6982\u8ff0\n\n\u4eba\u5de5\u667a\u80fd\u5728\u533b\u7597\u9886\u57df\u7684\u5e94\u7528\u6b63\u5728\u5feb\u901f\u53d1\u5c55\uff0c\u4e3b\u8981\u96c6\u4e2d\u5728\u533b\u5b66\u5f71\u50cf\u5206\u6790\u3001\u836f\u7269\u53d1\u73b0\u3001\u4e34\u5e8a\u51b3\u7b56\u652f\u6301\u7b49\u9886\u57df\u3002\u6839\u636e\u6700\u65b0\u7edf\u8ba1\uff0c\u622a\u81f32024\u5e74...\n\n### 1.1 \u533b\u5b66\u5f71\u50cfAI\n- **\u5e94\u7528\u9886\u57df**: \u653e\u5c04\u5b66\u3001\u75c5\u7406\u5b66\u3001\u773c\u79d1\u7b49\n- **\u6280\u672f\u6210\u719f\u5ea6**: \u5546\u4e1a\u5316\u7a0b\u5ea6\u8f83\u9ad8\n- **\u4ee3\u8868\u4ea7\u54c1**: [\u5177\u4f53\u4ea7\u54c1\u5217\u8868]\n\n### 1.2 \u4e34\u5e8a\u51b3\u7b56\u652f\u6301\n- **\u5e94\u7528\u573a\u666f**: \u75be\u75c5\u8bca\u65ad\u3001\u6cbb\u7597\u65b9\u6848\u63a8\u8350\n- **\u6280\u672f\u6311\u6218**: \u6570\u636e\u8d28\u91cf\u3001\u6a21\u578b\u53ef\u89e3\u91ca\u6027\n- **\u76d1\u7ba1\u73b0\u72b6**: FDA\u5df2\u6279\u51c6\u591a\u6b3e\u4ea7\u54c1\n\n## 2. \u4e34\u5e8a\u8bd5\u9a8c\u73b0\u72b6 [\u6b63\u5728\u66f4\u65b0\u4e2d...]\n\n### 2.1 FDA\u6279\u51c6\u8bbe\u5907\u7edf\u8ba1\n[\u6b63\u5728\u6536\u96c6\u6700\u65b0\u6570\u636e...]\n\n### 2.2 \u4e34\u5e8a\u8bd5\u9a8c\u5206\u6790\n[\u7b49\u5f85Search Agent\u8fd4\u56de\u7ed3\u679c...]\n\n---\n*\u672c\u62a5\u544a\u7531AI\u7cfb\u7edf\u534f\u52a9\u751f\u6210\uff0c\u7528\u6237\u53ef\u968f\u65f6\u7f16\u8f91\u4fee\u6539*\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#\u793a\u4f8b2-\u7528\u6237\u5e72\u9884\u573a\u666f","title":"\u793a\u4f8b2: \u7528\u6237\u5e72\u9884\u573a\u666f","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#\u573a\u666f-\u7528\u6237\u60f3\u8981\u6dfb\u52a0\u65b0\u7684\u7814\u7a76\u65b9\u5411","title":"\u573a\u666f: \u7528\u6237\u60f3\u8981\u6dfb\u52a0\u65b0\u7684\u7814\u7a76\u65b9\u5411","text":"<p>\u7528\u6237\u64cd\u4f5c\u65b9\u5f0f1: \u5728Result Artifact\u4e2d\u6dfb\u52a0\u65b0\u7ae0\u8282\u6846\u67b6</p> <pre><code>## 5. \u6570\u636e\u9690\u79c1\u4e0e\u5b89\u5168 [\u7528\u6237\u65b0\u589e]\n### 5.1 HIPAA\u5408\u89c4\u8981\u6c42\n[\u8bf7\u8865\u5145\u76f8\u5173\u4fe1\u606f]\n### 5.2 \u6570\u636e\u6cc4\u9732\u6848\u4f8b\u5206\u6790\n[\u9700\u8981\u6536\u96c6\u8fd1\u671f\u6848\u4f8b]\n</code></pre> <p>\u7528\u6237\u64cd\u4f5c\u65b9\u5f0f2: \u901a\u8fc7\u5bf9\u8bdd\u5411Lead Agent\u63d0\u51fa\u8981\u6c42</p> <p>\"\u6211\u53d1\u73b0\u6570\u636e\u9690\u79c1\u662fAI\u533b\u7597\u7684\u91cd\u8981\u6311\u6218\uff0c\u9700\u8981\u589e\u52a0\u4e00\u4e2a\u4e13\u95e8\u7ae0\u8282\u6765\u5206\u6790HIPAA\u5408\u89c4\u548c\u5b89\u5168\u6280\u672f\u65b9\u6848\"</p> <p>\u7cfb\u7edf\u54cd\u5e94: Lead Agent\u8bc6\u522b\u7528\u6237\u9700\u6c42\uff0c\u81ea\u52a8\u66f4\u65b0Task Plan\u6dfb\u52a0\u76f8\u5e94\u641c\u7d22\u4efb\u52a1</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#\u573a\u666f-\u7528\u6237\u5bf9\u4fe1\u606f\u8d28\u91cf\u4e0d\u6ee1\u610f","title":"\u573a\u666f: \u7528\u6237\u5bf9\u4fe1\u606f\u8d28\u91cf\u4e0d\u6ee1\u610f","text":"<p>\u7528\u6237\u64cd\u4f5c\u65b9\u5f0f1: \u5728Result Artifact\u4e2d\u6dfb\u52a0\u6279\u6ce8</p> <pre><code>## 2. \u4e34\u5e8a\u8bd5\u9a8c\u73b0\u72b6\n[\u5f53\u524d\u5185\u5bb9\u591a\u4e3a\u65b0\u95fb\u62a5\u9053\uff0c\u7f3a\u5c11\u5b66\u672f\u8bba\u6587\u652f\u6491\uff0c\u8bf7\u8865\u5145\u66f4\u6743\u5a01\u7684\u7814\u7a76\u6570\u636e]\n</code></pre> <p>\u7528\u6237\u64cd\u4f5c\u65b9\u5f0f2: \u901a\u8fc7\u5bf9\u8bdd\u63d0\u51fa\u5177\u4f53\u8981\u6c42</p> <p>\"\u7b2c2\u7ae0\u7684\u4fe1\u606f\u8d28\u91cf\u4e0d\u591f\u597d\uff0c\u591a\u662f\u65b0\u95fb\u62a5\u9053\uff0c\u80fd\u4e0d\u80fd\u91cd\u65b0\u641c\u7d22\u4e00\u4e9b\u5b66\u672f\u8bba\u6587\u548cFDA\u7684\u5b98\u65b9\u6570\u636e\uff1f\"</p> <p>\u7cfb\u7edf\u54cd\u5e94: Lead Agent\u7406\u89e3\u53cd\u9988\uff0c\u66f4\u65b0Task Plan\u91cd\u65b0\u6267\u884c\u641c\u7d22\u4efb\u52a1</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u529f\u80fd\u8bbe\u8ba1\u8981\u70b9","title":"\u2699\ufe0f \u529f\u80fd\u8bbe\u8ba1\u8981\u70b9","text":"<p>\u7cfb\u7edf\u91c7\u7528Lead Agent\u7edf\u4e00\u534f\u8c03\u7684\u65b9\u5f0f\uff0c\u901a\u8fc7Task Plan\u5c55\u793a\u8fdb\u5ea6\uff0cSubagent\u72ec\u7acb\u6267\u884c\u5177\u4f53\u4efb\u52a1\u5e76\u8fd4\u56de\u7ed3\u6784\u5316\u7ed3\u679c\u3002Lead Agent\u8d1f\u8d23\u8d28\u91cf\u8bc4\u4f30\u548c\u4fe1\u606f\u6574\u5408\uff0c\u7528\u6237\u901a\u8fc7\u7f16\u8f91Result Artifact\u6216\u5bf9\u8bdd\u6765\u8868\u8fbe\u6539\u8fdb\u9700\u6c42\u3002\u6574\u4e2a\u8fc7\u7a0b\u5b9e\u73b0\u591a\u5c42\u8d28\u91cf\u63a7\u5236\uff0c\u4eceSubagent\u7684\u521d\u6b65\u7b5b\u9009\u5230Lead Agent\u7684\u7efc\u5408\u8bc4\u4f30\uff0c\u6700\u7ec8\u7531\u7528\u6237\u8fdb\u884c\u8d28\u91cf\u628a\u5173\u3002</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u7cfb\u7edf\u4f18\u52bf","title":"\ud83c\udfaf \u7cfb\u7edf\u4f18\u52bf","text":"<p>\u76f8\u6bd4\u4f20\u7edf\u7684\u591a\u5c42\u5d4c\u5957\u67b6\u6784\uff0c\u8fd9\u79cd\u8bbe\u8ba1\u5177\u6709\u66f4\u597d\u7684\u900f\u660e\u5ea6\u548c\u53ef\u63a7\u6027\u3002Task Plan\u63d0\u4f9b\u5b8c\u6574\u7684\u8fdb\u5ea6\u53ef\u89c6\u5316\uff0c\u7528\u6237\u80fd\u6e05\u695a\u4e86\u89e3\u7cfb\u7edf\u5de5\u4f5c\u72b6\u6001\u3002\u901a\u8fc7\u7b80\u5316\u4ea4\u4e92\u6a21\u5f0f\uff0c\u7528\u6237\u53ea\u9700\u8981\u7f16\u8f91\u6587\u6863\u548c\u6b63\u5e38\u5bf9\u8bdd\uff0c\u907f\u514d\u4e86\u590d\u6742\u7684\u4efb\u52a1\u7ba1\u7406\u754c\u9762\u3002\u7cfb\u7edf\u6613\u4e8e\u6269\u5c55\u65b0\u7684Agent\u7c7b\u578b\uff0c\u652f\u6301\u4e0d\u540c\u7814\u7a76\u573a\u666f\u7684\u590d\u7528\u3002</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5b9e\u73b0\u8def\u5f84","title":"\ud83d\ude80 \u5b9e\u73b0\u8def\u5f84","text":"<p>\u5efa\u8bae\u5206\u56db\u4e2a\u9636\u6bb5\u5b9e\u65bd\uff1a\u9996\u5148\u5b9e\u73b0Lead Agent\u548c\u57fa\u7840Artifact\u673a\u5236\uff0c\u5f00\u53d1\u6838\u5fc3\u7684Search Agent\u548cWeb Crawl Agent\uff1b\u7136\u540e\u5b8c\u5584\u7528\u6237\u4ea4\u4e92\u754c\u9762\uff0c\u652f\u6301\u5b9e\u65f6\u8fdb\u5ea6\u8ddf\u8e2a\u548c\u7f16\u8f91\u53cd\u9988\uff1b\u63a5\u7740\u589e\u5f3a\u4fe1\u606f\u8d28\u91cf\u8bc4\u4f30\u548c\u667a\u80fd\u4efb\u52a1\u8c03\u5ea6\uff1b\u6700\u540e\u6269\u5c55\u5230\u66f4\u591a\u7814\u7a76\u573a\u666f\uff0c\u5efa\u7acb\u63d0\u793a\u8bcd\u6a21\u677f\u5e93\u548c\u6700\u4f73\u5b9e\u8df5\u3002</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5173\u952e\u521b\u65b0\u70b9","title":"\u2728 \u5173\u952e\u521b\u65b0\u70b9","text":"<ol> <li>Artifact\u4f5c\u4e3a\u8bb0\u5fc6\u8f7d\u4f53: \u89e3\u51b3\u4e86\u4f20\u7edfmulti-agent\u7cfb\u7edf\u7684\u4e0a\u4e0b\u6587\u7ba1\u7406\u95ee\u9898</li> <li>\u5206\u5c42\u6743\u9650\u63a7\u5236: Lead Agent\u5168\u6743\u9650\uff0cSubagent\u53ea\u8bfbTask Plan\uff0c\u7528\u6237\u53ea\u8bfbTask Plan\u4f46\u53ef\u7f16\u8f91Result</li> <li>\u7b80\u5316\u4ea4\u4e92\u6a21\u5f0f: \u907f\u514d\u590d\u6742\u7684\u4efb\u52a1\u7ba1\u7406\u754c\u9762\uff0c\u7528\u6237\u901a\u8fc7\u7f16\u8f91\u6587\u6863\u548c\u5bf9\u8bdd\u6765\u8868\u8fbe\u9700\u6c42</li> <li>\u53ccArtifact\u5206\u79bb: Task Plan\u4e13\u6ce8\u8fdb\u5ea6\u5c55\u793a\uff0cResult Doc\u4e13\u6ce8\u5185\u5bb9\u534f\u4f5c</li> <li>\u6e10\u8fdb\u5f0f\u534f\u4f5c: \u4ece\u4e00\u6b21\u6027\u751f\u6210\u8f6c\u5411\u8fed\u4ee3\u4f18\u5316</li> <li>\u900f\u660e\u5316\u6267\u884c: \u6bcf\u4e2a\u6b65\u9aa4\u90fd\u53ef\u8ffd\u8e2a\u4f46\u4e0d\u5e72\u6270\u6267\u884c</li> <li>\u4fe1\u606f\u6d41\u5355\u5411\u6027: Subagent \u2192 Lead Agent \u2192 Artifact\uff0c\u907f\u514d\u5e76\u53d1\u51b2\u7a81</li> </ol> <p>\u8fd9\u79cd\u8bbe\u8ba1\u8ba9\u7814\u7a76\u8fc7\u7a0b\u53d8\u6210\u4e86\u4e00\u4e2a\u771f\u6b63\u7684\u4eba\u673a\u534f\u4f5c\u8fc7\u7a0b\uff0c\u5145\u5206\u53d1\u6325\u4e86\u4eba\u7c7b\u7684\u521b\u9020\u529b\u548cAI\u7684\u4fe1\u606f\u5904\u7406\u80fd\u529b\u3002</p>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#multi-agent\u7814\u7a76\u7cfb\u7edf---\u540e\u7aef\u5b9e\u65bd\u7ec6\u8282","title":"Multi-Agent\u7814\u7a76\u7cfb\u7edf - \u540e\u7aef\u5b9e\u65bd\u7ec6\u8282","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u6838\u5fc3\u529f\u80fd\u6a21\u5757","title":"\ud83c\udfaf \u6838\u5fc3\u529f\u80fd\u6a21\u5757","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#1-human-in-the-loop-\u673a\u5236","title":"1. Human in the Loop \u673a\u5236","text":"<p>\u539f\u59cb\u9700\u6c42: \u5141\u8bb8\u7528\u6237\u901a\u8fc7\u5bf9\u8bdd\u4ecb\u5165/\u6253\u65adagent\u6267\u884c\u7684\u4efb\u52a1</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u57fa\u7840\u63a7\u5236\u63a5\u53e3:</li> </ul> <pre><code>class ExecutionController:\n    def __init__(self, graph, checkpointer):\n        self.graph = graph\n        self.checkpointer = checkpointer\n        self.is_paused = False\n        self.additional_context = []\n\n    async def pause(self, thread_id):\n        \"\"\"\u6682\u505c\u6267\u884c\"\"\"\n        self.is_paused = True\n        # LangGraph\u4f1a\u5728\u4e0b\u4e2a\u8282\u70b9\u524d\u81ea\u52a8\u4fdd\u5b58checkpoint\n\n    async def resume(self, thread_id):\n        \"\"\"\u6062\u590d\u6267\u884c\uff0c\u5e26\u5165\u7528\u6237\u8865\u5145\u7684context\"\"\"\n        config = {\"configurable\": {\"thread_id\": thread_id}}\n        state = self.graph.get_state(config)\n\n        # \u5c06\u8865\u5145\u7684context\u52a0\u5165state\n        if self.additional_context:\n            state.values[\"user_context\"] = \"\\n\".join(self.additional_context)\n            self.additional_context = []\n\n        self.is_paused = False\n        return await self.graph.invoke(None, config)\n\n    async def rollback(self, thread_id, checkpoint_id=None):\n        \"\"\"\u56de\u6eda\u5230\u6307\u5b9acheckpoint\"\"\"\n        config = {\"configurable\": {\n            \"thread_id\": thread_id,\n            \"checkpoint_id\": checkpoint_id  # \u5982\u679cNone\u5219\u56de\u6eda\u5230\u4e0a\u4e00\u4e2a\n        }}\n        return self.graph.get_state(config)\n\n    def add_context(self, user_query):\n        \"\"\"\u6682\u505c\u72b6\u6001\u4e0b\uff0c\u7528\u6237\u8f93\u5165\u4f1a\u88ab\u6dfb\u52a0\u4e3a\u8865\u5145context\"\"\"\n        if self.is_paused:\n            self.additional_context.append(user_query)\n</code></pre> <ul> <li>Lead Agent\u5904\u7406\u8865\u5145context:</li> </ul> <pre><code>def lead_agent_node(state):\n    # \u68c0\u67e5\u662f\u5426\u6709\u7528\u6237\u8865\u5145\u7684context\n    user_context = state.get(\"user_context\", \"\")\n\n    # \u6784\u5efaprompt\u65f6\u5305\u542b\u7528\u6237\u8865\u5145\u4fe1\u606f\n    prompt = f\"\"\"\n    \u539f\u59cb\u4efb\u52a1: {state[\"original_task\"]}\n    \u5f53\u524d\u8fdb\u5ea6: {state[\"progress\"]}\n\n    {f\"\u7528\u6237\u8865\u5145\u8981\u6c42: {user_context}\" if user_context else \"\"}\n\n    \u8bf7\u7ee7\u7eed\u6267\u884c\u4efb\u52a1...\n    \"\"\"\n\n    # \u6e05\u7a7a\u5df2\u4f7f\u7528\u7684user_context\n    state[\"user_context\"] = \"\"\n    return state\n</code></pre> <ul> <li>\u4f7f\u7528\u793a\u4f8b:</li> </ul> <pre><code># \u7528\u6237\u53d1\u8d77\u4efb\u52a1\ncontroller = ExecutionController(graph, checkpointer)\ntask = controller.start(\"\u7814\u7a76AI\u533b\u7597\u5e94\u7528\")\n\n# \u7528\u6237\u6682\u505c\nawait controller.pause(\"thread_123\")\n\n# \u7528\u6237\u8865\u5145\u4fe1\u606f\uff08\u5728\u6682\u505c\u72b6\u6001\u4e0b\uff09\ncontroller.add_context(\"\u91cd\u70b9\u5173\u6ce8FDA\u6279\u51c6\u7684\u4ea7\u54c1\")\ncontroller.add_context(\"\u9700\u8981\u5305\u542b2024\u5e74\u7684\u6700\u65b0\u6570\u636e\")\n\n# \u6062\u590d\u6267\u884c\uff08\u81ea\u52a8\u5e26\u5165\u8865\u5145\u7684context\uff09\nawait controller.resume(\"thread_123\")\n\n# \u5982\u9700\u56de\u6eda\nawait controller.rollback(\"thread_123\")\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#2-context-compression-\u7b56\u7565","title":"2. Context Compression \u7b56\u7565","text":"<p>\u539f\u59cb\u9700\u6c42: \u667a\u80fd\u5224\u65ad\u5bf9context\u8fdb\u884c\u538b\u7f29\uff08\u521d\u671f2w\u5b57\u7b26\u622a\u65ad\uff09</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u5206\u7ea7\u538b\u7f29\u7b56\u7565:</li> </ul> <pre><code># \u4f2a\u4ee3\u7801\u793a\u4f8b\nclass ContextManager:\n    LEVELS = {\n        'full': 50000,      # \u5b8c\u6574\u4e0a\u4e0b\u6587\n        'normal': 20000,    # \u6807\u51c6\u538b\u7f29\n        'compact': 10000,   # \u7d27\u51d1\u6a21\u5f0f\n        'minimal': 5000     # \u6700\u5c0f\u5316\n    }\n</code></pre> <ul> <li> <p>\u667a\u80fd\u538b\u7f29\u7b97\u6cd5:</p> </li> <li> <p>\u4f18\u5148\u7ea7\u4fdd\u7559: \u4fdd\u7559\u6700\u8fd1N\u8f6e\u5bf9\u8bdd + \u5173\u952e\u51b3\u7b56\u70b9</p> </li> <li>\u6458\u8981\u66ff\u6362: \u5c06\u5386\u53f2\u5bf9\u8bdd\u538b\u7f29\u4e3a\u6458\u8981</li> <li>\u7ed3\u6784\u5316\u538b\u7f29: \u4fdd\u7559JSON/XML\u7ed3\u6784\uff0c\u538b\u7f29\u63cf\u8ff0\u6027\u6587\u672c</li> <li> <p>\u76f8\u5173\u6027\u7b5b\u9009: \u57fa\u4e8e\u5f53\u524d\u4efb\u52a1\u7b5b\u9009\u76f8\u5173\u4e0a\u4e0b\u6587</p> </li> <li> <p>\u538b\u7f29\u89e6\u53d1\u6761\u4ef6:</p> </li> <li> <p>Token\u6570\u8d85\u8fc7\u9608\u503c</p> </li> <li>\u5185\u5b58\u4f7f\u7528\u8d85\u9650</li> <li>\u7279\u5b9a\u4efb\u52a1\u7c7b\u578b\uff08\u5982\u7b80\u5355\u641c\u7d22\uff09\u81ea\u52a8\u4f7f\u7528\u7d27\u51d1\u6a21\u5f0f</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#3-\u975e\u963b\u585e\u5f0f\u54cd\u5e94\u673a\u5236","title":"3. \u975e\u963b\u585e\u5f0f\u54cd\u5e94\u673a\u5236","text":"<p>\u539f\u59cb\u9700\u6c42: Lead Agent\u6d41\u5f0f\u8fd4\u56de\uff0cSubagent\u6279\u91cf\u8fd4\u56de</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u6d41\u5f0f\u5904\u7406\u67b6\u6784:</li> </ul> <pre><code># Lead Agent \u6d41\u5f0f\u8fd4\u56de\nasync def lead_agent_stream():\n    async for chunk in model.astream():\n        yield chunk\n        await update_artifact_realtime(chunk)\n\n# Subagent \u6279\u91cf\u8fd4\u56de\nasync def subagent_execute():\n    result = await model.ainvoke()\n    return parse_complete_result(result)\n</code></pre> <ul> <li> <p>\u5e76\u53d1\u6267\u884c\u7ba1\u7406:</p> </li> <li> <p>\u4f7f\u7528asyncio\u7ba1\u7406\u591a\u4e2aSubagent\u5e76\u53d1</p> </li> <li>\u5b9e\u73b0\u4efb\u52a1\u961f\u5217\u548c\u7ebf\u7a0b\u6c60</li> <li> <p>\u652f\u6301\u52a8\u6001\u8c03\u6574\u5e76\u53d1\u6570</p> </li> <li> <p>\u7ed3\u679c\u7f13\u51b2\u7b56\u7565:</p> </li> <li> <p>Lead Agent: \u9010\u5b57\u7b26/\u9010\u8bcd\u6d41\u5f0f\u8f93\u51fa</p> </li> <li>Subagent: \u7ed3\u679c\u5b8c\u6210\u540e\u6279\u91cf\u8fd4\u56de</li> <li>\u652f\u6301\u90e8\u5206\u7ed3\u679c\u9884\u89c8\uff08\u5982\u641c\u7d22\u7ed3\u679c\u5b9e\u65f6\u663e\u793a\u524dN\u6761\uff09</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#4-langchainlanggraph-\u96c6\u6210","title":"4. LangChain/LangGraph \u96c6\u6210","text":"<p>\u539f\u59cb\u9700\u6c42: \u4f7f\u7528\u6210\u719f\u6846\u67b6\u907f\u514d\u9020\u8f6e\u5b50</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>Graph\u8bbe\u8ba1:</li> </ul> <pre><code># \u4f7f\u7528LangGraph\u6784\u5efa\u5de5\u4f5c\u6d41\nfrom langgraph.graph import StateGraph\nfrom langgraph.checkpoint.memory import MemorySaver\n\n# \u914d\u7f6echeckpoint\nmemory = MemorySaver()\n\nworkflow = StateGraph(AgentState)\nworkflow.add_node(\"lead_agent\", lead_agent_node)\nworkflow.add_node(\"search_agent\", search_agent_node)\nworkflow.add_node(\"crawl_agent\", crawl_agent_node)\n\n# \u914d\u7f6e\u6761\u4ef6\u8fb9\nworkflow.add_conditional_edges(\n    \"lead_agent\",\n    route_to_subagent,\n    {\n        \"search\": \"search_agent\",\n        \"crawl\": \"crawl_agent\",\n        \"continue\": \"lead_agent\"\n    }\n)\n\n# \u7f16\u8bd1\u5e26checkpoint\u7684graph\napp = workflow.compile(checkpointer=memory)\n</code></pre> <ul> <li> <p>\u81ea\u5b9a\u4e49\u7ec4\u4ef6:</p> </li> <li> <p>\u7ee7\u627fBaseAgent\u5b9e\u73b0\u81ea\u5b9a\u4e49Agent\u903b\u8f91</p> </li> <li>\u81ea\u5b9a\u4e49Tool\u5305\u88c5\u5668\u652f\u6301\u6743\u9650\u63a7\u5236</li> <li> <p>\u5b9e\u73b0\u81ea\u5b9a\u4e49Memory\u7ec4\u4ef6\u7ba1\u7406Artifact</p> </li> <li> <p>\u72b6\u6001\u7ba1\u7406:</p> </li> <li> <p>\u4f7f\u7528LangGraph\u7684State\u673a\u5236\u7ba1\u7406\u4efb\u52a1\u72b6\u6001</p> </li> <li>\u5229\u7528\u5185\u7f6eCheckpointer\u652f\u6301\u65ad\u70b9\u7eed\u4f20</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#5-\u591a\u6a21\u578b\u652f\u6301\u4e0e\u601d\u8003\u6a21\u578b\u96c6\u6210","title":"5. \u591a\u6a21\u578b\u652f\u6301\u4e0e\u601d\u8003\u6a21\u578b\u96c6\u6210","text":"<p>\u539f\u59cb\u9700\u6c42: \u652f\u6301\u4e0d\u540cagent\u8c03\u7528\u4e0d\u540c\u6a21\u578b\uff0c\u6b63\u786e\u89e3\u6790think\u90e8\u5206</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u6a21\u578b\u914d\u7f6e\u7ba1\u7406:</li> </ul> <pre><code>models:\n  lead_agent:\n    provider: \"anthropic\"\n    model: \"claude-3-opus\"\n    temperature: 0.7\n    supports_thinking: true\n\n  search_agent:\n    provider: \"openai\"\n    model: \"gpt-4-turbo\"\n    temperature: 0.3\n    supports_thinking: false\n</code></pre> <ul> <li>\u601d\u8003\u6a21\u578b\u5904\u7406:</li> </ul> <pre><code>class ThinkingModelParser:\n    def parse_response(self, response):\n        thinking = extract_thinking_tags(response)\n        answer = extract_answer_tags(response)\n        return {\n            'thinking': thinking,  # \u5185\u90e8\u63a8\u7406\u8fc7\u7a0b\n            'answer': answer,      # \u5b9e\u9645\u54cd\u5e94\n            'metadata': {...}      # \u5176\u4ed6\u5143\u6570\u636e\n        }\n</code></pre> <ul> <li> <p>\u6a21\u578b\u5207\u6362\u7b56\u7565:</p> </li> <li> <p>\u57fa\u4e8e\u4efb\u52a1\u7c7b\u578b\u81ea\u52a8\u9009\u62e9\u6a21\u578b</p> </li> <li>\u652f\u6301fallback\u673a\u5236\uff08\u4e3b\u6a21\u578b\u5931\u8d25\u5207\u6362\u5907\u7528\uff09</li> <li>\u6210\u672c\u4f18\u5316\uff08\u7b80\u5355\u4efb\u52a1\u7528\u5c0f\u6a21\u578b\uff09</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#6-xml\u5de5\u5177\u8c03\u7528\u7cfb\u7edf","title":"6. XML\u5de5\u5177\u8c03\u7528\u7cfb\u7edf","text":"<p>\u539f\u59cb\u9700\u6c42: \u4e0d\u7528tool call\u63a5\u53e3\uff0c\u81ea\u5df1\u8bbe\u8ba1XML\u5f62\u5f0f\u7684\u51fd\u6570\u8c03\u7528</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u7edf\u4e00\u7684XML Schema:</li> </ul> <pre><code>&lt;!-- \u5de5\u5177\u5b9a\u4e49 --&gt;\n&lt;tool&gt;\n  &lt;name&gt;web_search&lt;/name&gt;\n  &lt;description&gt;Search the web for information&lt;/description&gt;\n  &lt;parameters&gt;\n    &lt;param name=\"query\" type=\"string\" required=\"true\"/&gt;\n    &lt;param name=\"max_results\" type=\"int\" default=\"10\"/&gt;\n  &lt;/parameters&gt;\n  &lt;permissions&gt;\n    &lt;require_approval&gt;false&lt;/require_approval&gt;\n  &lt;/permissions&gt;\n&lt;/tool&gt;\n\n&lt;!-- \u5de5\u5177\u8c03\u7528 --&gt;\n&lt;tool_call&gt;\n  &lt;name&gt;web_search&lt;/name&gt;\n  &lt;params&gt;\n    &lt;query&gt;AI medical applications FDA approval&lt;/query&gt;\n    &lt;max_results&gt;20&lt;/max_results&gt;\n  &lt;/params&gt;\n&lt;/tool_call&gt;\n</code></pre> <ul> <li>\u63d0\u793a\u8bcd\u751f\u6210\u5668:</li> </ul> <pre><code>class ToolPromptGenerator:\n    def generate_system_prompt(self, tools):\n        # \u81ea\u52a8\u751f\u6210\u5de5\u5177\u4f7f\u7528\u8bf4\u660e\n        return f\"\"\"\n        Available tools:\n        {self.format_tools_xml(tools)}\n\n        To use a tool, wrap your call in &lt;tool_call&gt; tags...\n        \"\"\"\n</code></pre> <ul> <li> <p>\u52a8\u6001\u5de5\u5177\u6ce8\u518c:</p> </li> <li> <p>\u652f\u6301\u8fd0\u884c\u65f6\u6ce8\u518c\u65b0\u5de5\u5177</p> </li> <li>\u81ea\u52a8\u751f\u6210\u5bf9\u5e94\u7684XML schema\u548c\u63d0\u793a\u8bcd</li> <li>\u5de5\u5177\u7248\u672c\u7ba1\u7406</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#7-robust-xml\u89e3\u6790","title":"7. Robust XML\u89e3\u6790","text":"<p>\u539f\u59cb\u9700\u6c42: \u5065\u58ee\u7684XML\u89e3\u6790\u51fd\u6570</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u591a\u5c42\u89e3\u6790\u7b56\u7565:</li> </ul> <pre><code>class RobustXMLParser:\n    def parse(self, text):\n        # 1. \u5c1d\u8bd5\u6807\u51c6XML\u89e3\u6790\n        try:\n            return self.standard_parse(text)\n        except:\n            pass\n\n        # 2. \u5c1d\u8bd5\u4fee\u590d\u5e38\u89c1\u9519\u8bef\n        fixed = self.fix_common_issues(text)\n        try:\n            return self.standard_parse(fixed)\n        except:\n            pass\n\n        # 3. \u4f7f\u7528\u6b63\u5219\u63d0\u53d6\n        return self.regex_fallback(text)\n\n    def fix_common_issues(self, text):\n        # \u4fee\u590d\u672a\u95ed\u5408\u6807\u7b7e\n        # \u8f6c\u4e49\u7279\u6b8a\u5b57\u7b26\n        # \u5904\u7406\u5d4c\u5957\u9519\u8bef\n        pass\n</code></pre> <ul> <li> <p>\u9519\u8bef\u6062\u590d\u673a\u5236:</p> </li> <li> <p>\u90e8\u5206\u89e3\u6790\u6210\u529f\u65f6\u8fd4\u56de\u53ef\u7528\u90e8\u5206</p> </li> <li>\u8bb0\u5f55\u89e3\u6790\u5931\u8d25\u7684\u8be6\u7ec6\u4fe1\u606f</li> <li> <p>\u63d0\u4f9b\u4fee\u590d\u5efa\u8bae</p> </li> <li> <p>\u9a8c\u8bc1\u5c42:</p> </li> <li> <p>Schema\u9a8c\u8bc1</p> </li> <li>\u4e1a\u52a1\u903b\u8f91\u9a8c\u8bc1</li> <li>\u5b89\u5168\u6027\u68c0\u67e5\uff08\u9632\u6b62\u6ce8\u5165\uff09</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#8-\u5b8c\u5584\u7684logging\u7cfb\u7edf","title":"8. \u5b8c\u5584\u7684Logging\u7cfb\u7edf","text":"<p>\u539f\u59cb\u9700\u6c42: \u8ddf\u8e2a\u6240\u6709\u884c\u4e3a\uff1a\u6a21\u578bI/O\u3001token count\u3001\u5de5\u5177\u8c03\u7528</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u5206\u5c42\u65e5\u5fd7\u67b6\u6784:</li> </ul> <pre><code>class MultiAgentLogger:\n    LEVELS = {\n        'SYSTEM': logging.CRITICAL,     # \u7cfb\u7edf\u7ea7\u4e8b\u4ef6\n        'AGENT': logging.INFO,          # Agent\u51b3\u7b56\n        'TOOL': logging.INFO,           # \u5de5\u5177\u8c03\u7528\n        'MODEL': logging.DEBUG,         # \u6a21\u578b\u4ea4\u4e92\n        'TOKEN': logging.DEBUG          # Token\u7edf\u8ba1\n    }\n</code></pre> <ul> <li>\u7ed3\u6784\u5316\u65e5\u5fd7\u683c\u5f0f:</li> </ul> <pre><code>{\n  \"timestamp\": \"2024-01-20T10:30:00Z\",\n  \"session_id\": \"sess_123\",\n  \"agent\": \"lead_agent\",\n  \"event_type\": \"model_call\",\n  \"model\": \"claude-3-opus\",\n  \"tokens\": {\n    \"input\": 1500,\n    \"output\": 800,\n    \"total\": 2300\n  },\n  \"cost\": 0.023,\n  \"duration_ms\": 2500,\n  \"metadata\": {...}\n}\n</code></pre> <ul> <li> <p>\u76d1\u63a7\u6307\u6807:</p> </li> <li> <p>\u5b9e\u65f6Token\u6d88\u8017\u7edf\u8ba1</p> </li> <li>API\u8c03\u7528\u5ef6\u8fdf\u76d1\u63a7</li> <li>\u9519\u8bef\u7387\u548c\u91cd\u8bd5\u7edf\u8ba1</li> <li> <p>\u4efb\u52a1\u5b8c\u6210\u65f6\u95f4\u5206\u6790</p> </li> <li> <p>\u65e5\u5fd7\u5b58\u50a8\u7b56\u7565:</p> </li> <li> <p>\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u5b58\u50a8\u6240\u6709\u65e5\u5fd7</p> </li> <li>\u6309\u65e5\u671f\u5206\u5272\u65e5\u5fd7\u6587\u4ef6\uff08\u5982\uff1a<code>logs/2024-01-20.json</code>\uff09</li> <li>\u53ef\u9009\u7684\u65e5\u5fd7\u8f6e\u8f6c\uff08\u5982\uff1a\u4fdd\u7559\u6700\u8fd130\u5929\uff09</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#9-\u5de5\u5177\u6743\u9650\u63a7\u5236\u7cfb\u7edf","title":"9. \u5de5\u5177\u6743\u9650\u63a7\u5236\u7cfb\u7edf","text":"<p>\u539f\u59cb\u9700\u6c42: \u5de5\u5177\u5305\u542b\u53ef\u9009\u7684permission\u63a5\u53e3</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u6743\u9650\u7ea7\u522b\u5b9a\u4e49:</li> </ul> <pre><code>class PermissionLevel(Enum):\n    PUBLIC = 0      # \u65e0\u9700\u5ba1\u6279\n    NOTIFY = 1      # \u6267\u884c\u540e\u901a\u77e5\n    CONFIRM = 2     # \u6267\u884c\u524d\u786e\u8ba4\n    RESTRICTED = 3  # \u9700\u8981\u7279\u6b8a\u6388\u6743\n</code></pre> <ul> <li>\u5ba1\u6279\u6d41\u7a0b:</li> </ul> <pre><code>class ToolPermissionManager:\n    async def check_permission(self, tool, params, user):\n        level = tool.permission_level\n\n        if level == PermissionLevel.CONFIRM:\n            approval = await self.request_approval(\n                user, tool, params\n            )\n            if not approval:\n                raise PermissionDeniedError()\n\n        # \u8bb0\u5f55\u5ba1\u6279\u65e5\u5fd7\n        self.log_permission_check(...)\n</code></pre> <ul> <li> <p>\u7ec6\u7c92\u5ea6\u63a7\u5236:</p> </li> <li> <p>\u57fa\u4e8e\u7528\u6237\u89d2\u8272\u7684\u6743\u9650</p> </li> <li>\u57fa\u4e8e\u53c2\u6570\u7684\u6743\u9650\uff08\u5982\u6587\u4ef6\u8def\u5f84\u9650\u5236\uff09</li> <li>\u65f6\u95f4\u7a97\u53e3\u9650\u5236\uff08\u5982\u6bcf\u5c0f\u65f6\u6700\u591aN\u6b21\uff09</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#10-checkpoint\u673a\u5236","title":"10. Checkpoint\u673a\u5236","text":"<p>\u539f\u59cb\u9700\u6c42: \u652f\u6301checkpoint\u65ad\u70b9\u7eed\u4f20</p> <p>\u5b9e\u65bd\u7ec6\u8282:</p> <ul> <li>\u4f7f\u7528LangGraph\u5185\u5b58Checkpoint:</li> </ul> <pre><code>from langgraph.checkpoint.memory import MemorySaver\n\n# \u4f7f\u7528\u5185\u5b58\u5b58\u50a8checkpoint\nmemory = MemorySaver()\n\n# \u7f16\u8bd1\u65f6\u6307\u5b9acheckpointer\napp = workflow.compile(checkpointer=memory)\n\n# \u6062\u590dcheckpoint\nconfig = {\"configurable\": {\"thread_id\": \"session_123\"}}\nstate = app.get_state(config)\n\n# \u4ececheckpoint\u7ee7\u7eed\u6267\u884c\nresult = app.invoke(None, config)\n</code></pre> <ul> <li>\u7b80\u5355\u7684\u72b6\u6001\u7ba1\u7406:</li> </ul> <pre><code>class SimpleCheckpointManager:\n    def __init__(self):\n        self.checkpoints = {}  # \u5185\u5b58\u4e2d\u7684checkpoint\u5b58\u50a8\n\n    def save(self, thread_id, state):\n        \"\"\"\u4fdd\u5b58checkpoint\u5230\u5185\u5b58\"\"\"\n        self.checkpoints[thread_id] = {\n            'timestamp': datetime.now(),\n            'state': state,\n            'version': len(self.checkpoints.get(thread_id, []))\n        }\n\n    def load(self, thread_id):\n        \"\"\"\u4ece\u5185\u5b58\u52a0\u8f7dcheckpoint\"\"\"\n        return self.checkpoints.get(thread_id)\n\n    def clear(self, thread_id=None):\n        \"\"\"\u6e05\u7406checkpoint\"\"\"\n        if thread_id:\n            self.checkpoints.pop(thread_id, None)\n        else:\n            self.checkpoints.clear()\n</code></pre> <ul> <li> <p>\u6ce8\u610f\u4e8b\u9879:</p> </li> <li> <p>\u5185\u5b58\u5b58\u50a8\u9002\u5408\u5f00\u53d1\u548c\u6d4b\u8bd5\u73af\u5883</p> </li> <li>\u91cd\u542f\u670d\u52a1\u4f1a\u4e22\u5931\u6240\u6709checkpoint</li> <li>\u53ef\u6839\u636e\u9700\u8981\u540e\u7eed\u5347\u7ea7\u5230\u6301\u4e45\u5316\u5b58\u50a8</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#11-\u9519\u8bef\u5904\u7406\u4e0e\u91cd\u8bd5\u673a\u5236","title":"11. \u9519\u8bef\u5904\u7406\u4e0e\u91cd\u8bd5\u673a\u5236","text":"<ul> <li>\u667a\u80fd\u91cd\u8bd5\u7b56\u7565:</li> </ul> <pre><code>from tenacity import retry, stop_after_attempt, wait_exponential\n\n@retry(\n    stop=stop_after_attempt(3),\n    wait=wait_exponential(multiplier=1, min=4, max=10)\n)\nasync def call_model_with_retry(prompt):\n    return await model.ainvoke(prompt)\n</code></pre> <ul> <li> <p>\u9519\u8bef\u5206\u7c7b\u5904\u7406:</p> </li> <li> <p>API\u9650\u6d41: \u6307\u6570\u9000\u907f\u91cd\u8bd5</p> </li> <li>\u7f51\u7edc\u9519\u8bef: \u5feb\u901f\u91cd\u8bd5</li> <li>\u89e3\u6790\u9519\u8bef: \u964d\u7ea7\u5230\u5907\u7528\u89e3\u6790\u5668</li> <li> <p>\u4e1a\u52a1\u9519\u8bef: \u8bb0\u5f55\u5e76\u8df3\u8fc7</p> </li> <li> <p>\u964d\u7ea7\u65b9\u6848:</p> </li> <li> <p>\u4e3b\u6a21\u578b\u5931\u8d25\u5207\u6362\u5907\u7528\u6a21\u578b</p> </li> <li>\u590d\u6742\u5de5\u5177\u5931\u8d25\u964d\u7ea7\u5230\u7b80\u5355\u7248\u672c</li> <li>\u5b8c\u6574\u641c\u7d22\u5931\u8d25\u964d\u7ea7\u5230\u5feb\u901f\u641c\u7d22</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#multi-agent\u7814\u7a76\u7cfb\u7edf---\u9879\u76ee\u6587\u4ef6\u7ed3\u6784","title":"Multi-Agent\u7814\u7a76\u7cfb\u7edf - \u9879\u76ee\u6587\u4ef6\u7ed3\u6784","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5b8c\u6574\u76ee\u5f55\u6811","title":"\ud83d\udcc1 \u5b8c\u6574\u76ee\u5f55\u6811","text":"<pre><code>multi-agent-research/\n\u251c\u2500\u2500 \ud83d\udcc4 README.md\n\u251c\u2500\u2500 \ud83d\udcc4 requirements.txt\n\u251c\u2500\u2500 \ud83d\udcc4 .env.example\n\u251c\u2500\u2500 \ud83d\udcc4 .gitignore\n\u251c\u2500\u2500 \ud83d\udcc4 Dockerfile                     # Docker\u955c\u50cf\u5b9a\u4e49\n\u251c\u2500\u2500 \ud83d\udcc4 docker-compose.yml             # Docker Compose\u914d\u7f6e\n\u251c\u2500\u2500 \ud83d\udcc4 config.yaml                    # \u2b50 \u5168\u5c40\u914d\u7f6e\u6587\u4ef6\n\u2502\n\u251c\u2500\u2500 \ud83d\udcc1 src/\n\u2502   \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 \ud83d\udcc1 core/                      # \u2b50 \u6838\u5fc3\u6a21\u5757\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 graph.py               # LangGraph\u5de5\u4f5c\u6d41\u5b9a\u4e49\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 state.py               # \u72b6\u6001\u7ba1\u7406\u548c\u5b9a\u4e49\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 controller.py          # \u6267\u884c\u63a7\u5236\u5668(pause/resume/rollback)\n\u2502   \u2502   \u2514\u2500\u2500 \ud83d\udcc4 context_manager.py     # Context\u538b\u7f29\u548c\u7ba1\u7406\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 \ud83d\udcc1 agents/                    # \u2b50 Agent\u5b9e\u73b0\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 base.py                # BaseAgent\u62bd\u8c61\u7c7b\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 lead_agent.py          # Lead Agent\u5b9e\u73b0\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 search_agent.py        # Search Agent\u5b9e\u73b0\n\u2502   \u2502   \u2514\u2500\u2500 \ud83d\udcc4 crawl_agent.py         # Web Crawl Agent\u5b9e\u73b0\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 \ud83d\udcc1 tools/                     # \u5de5\u5177\u7cfb\u7edf\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 base.py                # BaseTool\u62bd\u8c61\u7c7b\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 registry.py            # \u5de5\u5177\u6ce8\u518c\u548c\u7ba1\u7406\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 prompt_generator.py    # XML\u63d0\u793a\u8bcd\u751f\u6210\u5668\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 permissions.py         # \u6743\u9650\u63a7\u5236\n\u2502   \u2502   \u2514\u2500\u2500 \ud83d\udcc1 implementations/       # \u5177\u4f53\u5de5\u5177\u5b9e\u73b0\n\u2502   \u2502       \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u2502       \u251c\u2500\u2500 \ud83d\udcc4 web_search.py\n\u2502   \u2502       \u251c\u2500\u2500 \ud83d\udcc4 web_fetch.py\n\u2502   \u2502       \u2514\u2500\u2500 \ud83d\udcc4 artifact_ops.py    # Artifact\u64cd\u4f5c\u5de5\u5177\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 \ud83d\udcc1 models/                    # \u6a21\u578b\u63a5\u53e3\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u2502   \u2514\u2500\u2500 \ud83d\udcc4 llm.py                 # \u2b50 \u7edf\u4e00\u7684LLM\u63a5\u53e3(\u57fa\u4e8eLangChain)\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 \ud83d\udcc1 utils/                     # \u5de5\u5177\u51fd\u6570\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 xml_parser.py          # \u2b50 Robust XML\u89e3\u6790\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 logger.py              # \u65e5\u5fd7\u7cfb\u7edf\n\u2502   \u2502   \u2514\u2500\u2500 \ud83d\udcc4 retry.py               # \u91cd\u8bd5\u673a\u5236\n\u2502   \u2502\n\u2502   \u2514\u2500\u2500 \ud83d\udcc1 api/                       # API\u63a5\u53e3\u5c42\n\u2502       \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502       \u251c\u2500\u2500 \ud83d\udcc4 server.py              # FastAPI/Flask\u670d\u52a1\u5668\n\u2502       \u251c\u2500\u2500 \ud83d\udcc4 websocket.py          # WebSocket\u5904\u7406\n\u2502       \u251c\u2500\u2500 \ud83d\udcc4 routes.py              # API\u8def\u7531\u5b9a\u4e49\n\u2502       \u2514\u2500\u2500 \ud83d\udcc4 schemas.py             # Pydantic\u6a21\u578b\u5b9a\u4e49\n\u2502\n\u251c\u2500\u2500 \ud83d\udcc1 prompts/                       # \u63d0\u793a\u8bcd\u6a21\u677f\n\u2502   \u251c\u2500\u2500 \ud83d\udcc4 lead_agent.xml\n\u2502   \u251c\u2500\u2500 \ud83d\udcc4 search_agent.xml\n\u2502   \u2514\u2500\u2500 \ud83d\udcc4 tools_instruction.xml\n\u2502\n\u251c\u2500\u2500 \ud83d\udcc1 tests/                         # \u6d4b\u8bd5\u6587\u4ef6\n\u2502   \u251c\u2500\u2500 \ud83d\udcc4 __init__.py\n\u2502   \u251c\u2500\u2500 \ud83d\udcc4 conftest.py               # Pytest\u914d\u7f6e\n\u2502   \u251c\u2500\u2500 \ud83d\udcc1 unit/\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 test_xml_parser.py\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 test_context_manager.py\n\u2502   \u2502   \u2514\u2500\u2500 \ud83d\udcc4 test_tools.py\n\u2502   \u251c\u2500\u2500 \ud83d\udcc1 integration/\n\u2502   \u2502   \u251c\u2500\u2500 \ud83d\udcc4 test_workflow.py\n\u2502   \u2502   \u2514\u2500\u2500 \ud83d\udcc4 test_agents.py\n\u2502   \u2514\u2500\u2500 \ud83d\udcc1 fixtures/                  # \u6d4b\u8bd5\u6570\u636e\n\u2502       \u251c\u2500\u2500 \ud83d\udcc4 sample_responses.json\n\u2502       \u2514\u2500\u2500 \ud83d\udcc4 mock_data.yaml\n\u2502\n\u251c\u2500\u2500 \ud83d\udcc1 logs/                          # \u65e5\u5fd7\u76ee\u5f55\n\u2502   \u2514\u2500\u2500 \ud83d\udcc4 .gitkeep\n\u2502\n\u251c\u2500\u2500 \ud83d\udcc1 examples/                      # \u793a\u4f8b\u4ee3\u7801\n\u2502   \u251c\u2500\u2500 \ud83d\udcc4 basic_research.py         # \u57fa\u7840\u7814\u7a76\u4efb\u52a1\u793a\u4f8b\n\u2502   \u251c\u2500\u2500 \ud83d\udcc4 with_interruption.py      # \u5e26\u4e2d\u65ad\u7684\u793a\u4f8b\n\u2502   \u2514\u2500\u2500 \ud83d\udcc4 custom_agent.py            # \u81ea\u5b9a\u4e49Agent\u793a\u4f8b\n\u2502\n\u2514\u2500\u2500 \ud83d\udcc1 docs/                          # \u6587\u6863\n    \u251c\u2500\u2500 \ud83d\udcc4 architecture.md            # \u67b6\u6784\u8bf4\u660e\n    \u251c\u2500\u2500 \ud83d\udcc4 api.md                     # API\u6587\u6863\n    \u2514\u2500\u2500 \ud83d\udcc4 deployment.md              # \u90e8\u7f72\u6307\u5357\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u6a21\u5757\u8bf4\u660e","title":"\ud83d\udcdd \u6a21\u5757\u8bf4\u660e","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u6838\u5fc3\u6a21\u5757-srccore","title":"\ud83c\udfaf \u6838\u5fc3\u6a21\u5757 (<code>src/core/</code>)","text":"<p>\u6838\u5fc3\u5de5\u4f5c\u6d41\u548c\u72b6\u6001\u7ba1\u7406\uff0c\u662f\u6574\u4e2a\u7cfb\u7edf\u7684\u9aa8\u67b6\u3002</p> <ul> <li>graph.py: LangGraph\u5de5\u4f5c\u6d41\u5b9a\u4e49\uff0c\u5305\u542b\u8282\u70b9\u3001\u8fb9\u3001\u6761\u4ef6\u8def\u7531\u7684\u914d\u7f6e</li> <li>state.py: \u5b9a\u4e49AgentState\u6570\u636e\u7ed3\u6784\uff0c\u7ba1\u7406\u5168\u5c40\u72b6\u6001</li> <li>controller.py: \u5b9e\u73b0pause/resume/rollback\u7b49\u63a7\u5236\u529f\u80fd</li> <li>context_manager.py: \u8d1f\u8d23context\u538b\u7f29\u3001\u622a\u65ad\u3001\u667a\u80fd\u7b5b\u9009</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-agent\u6a21\u5757-srcagents","title":"\ud83e\udd16 Agent\u6a21\u5757 (<code>src/agents/</code>)","text":"<p>\u6240\u6709Agent\u7684\u5b9e\u73b0\uff0c\u9075\u5faa\u7edf\u4e00\u7684BaseAgent\u63a5\u53e3\u3002</p> <ul> <li>base.py: \u5b9a\u4e49BaseAgent\u62bd\u8c61\u7c7b\uff0c\u89c4\u8303Agent\u63a5\u53e3</li> <li>lead_agent.py: \u534f\u8c03\u8005\uff0c\u8d1f\u8d23\u4efb\u52a1\u5206\u89e3\u3001\u6d3e\u53d1\u3001\u7ed3\u679c\u6574\u5408</li> <li>search_agent.py: \u4fe1\u606f\u641c\u7d22\u4e13\u5bb6\uff0c\u8fd4\u56de\u7ed3\u6784\u5316\u641c\u7d22\u7ed3\u679c</li> <li>crawl_agent.py: \u6df1\u5ea6\u5185\u5bb9\u6293\u53d6\uff0c\u63d0\u53d6\u7f51\u9875\u8be6\u7ec6\u4fe1\u606f</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5de5\u5177\u7cfb\u7edf-srctools","title":"\ud83d\udd27 \u5de5\u5177\u7cfb\u7edf (<code>src/tools/</code>)","text":"<p>\u53ef\u6269\u5c55\u7684\u5de5\u5177\u6ce8\u518c\u548c\u8c03\u7528\u7cfb\u7edf\u3002</p> <ul> <li>registry.py: \u52a8\u6001\u6ce8\u518c\u5de5\u5177\uff0c\u7ba1\u7406\u5de5\u5177\u751f\u547d\u5468\u671f</li> <li>prompt_generator.py: \u6839\u636e\u5de5\u5177\u5b9a\u4e49\u81ea\u52a8\u751f\u6210XML\u683c\u5f0f\u7684\u63d0\u793a\u8bcd</li> <li>permissions.py: \u5b9e\u73b0\u5de5\u5177\u6743\u9650\u63a7\u5236\uff08PUBLIC/NOTIFY/CONFIRM/RESTRICTED\uff09</li> <li>implementations/: \u5177\u4f53\u5de5\u5177\u5b9e\u73b0\uff0c\u6bcf\u4e2a\u5de5\u5177\u90fd\u662f\u72ec\u7acb\u6a21\u5757</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u6a21\u578b\u63a5\u53e3-srcmodels","title":"\ud83e\udde0 \u6a21\u578b\u63a5\u53e3 (<code>src/models/</code>)","text":"<p>\u7edf\u4e00\u7684\u6a21\u578b\u8c03\u7528\u63a5\u53e3\uff0c\u57fa\u4e8eLangChain\u5b9e\u73b0\u3002</p> <ul> <li>llm.py</li> </ul> <p>: \u4f7f\u7528LangChain\u5c01\u88c5\uff0c\u652f\u6301OpenAI\u901a\u7528\u63a5\u53e3\u3001Qwen\u3001DeepSeek\u7b49\u6a21\u578b</p> <pre><code># \u793a\u4f8b\u4ee3\u7801\u7ed3\u6784\nfrom langchain_openai import ChatOpenAI\n\ndef get_model(model_type=\"openai\", **kwargs):\n    if model_type == \"openai\":\n        return ChatOpenAI(**kwargs)\n    elif model_type == \"qwen\":\n        return ChatOpenAI(\n            base_url=\"https://dashscope.aliyuncs.com/compatible-mode/v1\",\n            **kwargs\n        )\n    elif model_type == \"deepseek\":\n        return ChatOpenAI(\n            base_url=\"https://api.deepseek.com/v1\",\n            **kwargs\n        )\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5de5\u5177\u51fd\u6570-srcutils","title":"\ud83d\udee0 \u5de5\u5177\u51fd\u6570 (<code>src/utils/</code>)","text":"<p>\u901a\u7528\u5de5\u5177\u51fd\u6570\uff0c\u88ab\u5176\u4ed6\u6a21\u5757\u590d\u7528\u3002</p> <ul> <li>xml_parser.py: \u4e09\u5c42\u89e3\u6790\u7b56\u7565\uff08\u6807\u51c6\u89e3\u6790\u2192\u4fee\u590d\u5e38\u89c1\u9519\u8bef\u2192\u6b63\u5219\u63d0\u53d6\uff09</li> <li>logger.py: \u7ed3\u6784\u5316\u65e5\u5fd7\uff0c\u652f\u6301\u4e0d\u540c\u7ea7\u522b\u548c\u6a21\u5757\u7684\u65e5\u5fd7\u8bb0\u5f55</li> <li>retry.py: \u667a\u80fd\u91cd\u8bd5\u673a\u5236\uff0c\u652f\u6301\u6307\u6570\u9000\u907f</li> <li>streaming.py: \u5904\u7406\u6d41\u5f0f\u54cd\u5e94\uff0c\u652f\u6301Lead Agent\u7684\u5b9e\u65f6\u8f93\u51fa</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-api\u5c42-srcapi","title":"\ud83c\udf10 API\u5c42 (<code>src/api/</code>)","text":"<p>\u5bf9\u5916\u63a5\u53e3\uff0c\u652f\u6301REST API\u548cWebSocket\u3002</p> <ul> <li>server.py: \u4e3b\u670d\u52a1\u5668\u5165\u53e3\uff0c\u53ef\u9009FastAPI\u6216Flask</li> <li>websocket.py: \u5b9e\u65f6\u63a8\u9001\u4efb\u52a1\u72b6\u6001\u3001\u652f\u6301\u53cc\u5411\u901a\u4fe1</li> <li>routes.py: \u5b9a\u4e49\u6240\u6709API\u7aef\u70b9</li> <li>schemas.py: \u8bf7\u6c42/\u54cd\u5e94\u7684\u6570\u636e\u6a21\u578b\u9a8c\u8bc1</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u914d\u7f6e\u548c\u6a21\u677f","title":"\ud83d\udccb \u914d\u7f6e\u548c\u6a21\u677f","text":"<ul> <li>config.yaml: \u96c6\u4e2d\u7ba1\u7406\u6240\u6709\u914d\u7f6e\uff08\u6a21\u578b\u914d\u7f6e\u3001\u5de5\u5177\u914d\u7f6e\u3001\u65e5\u5fd7\u7ea7\u522b\u7b49\uff09</li> <li>prompts/: XML\u683c\u5f0f\u7684\u63d0\u793a\u8bcd\u6a21\u677f\uff0c\u4fbf\u4e8e\u7ef4\u62a4\u548c\u7248\u672c\u63a7\u5236</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5feb\u901f\u5f00\u59cb","title":"\ud83d\ude80 \u5feb\u901f\u5f00\u59cb","text":"<pre><code># 1. \u5b89\u88c5\u4f9d\u8d56\npip install -r requirements.txt\n\n# 2. \u914d\u7f6e\u73af\u5883\u53d8\u91cf\ncp .env.example .env\n# \u7f16\u8f91.env\u6dfb\u52a0API keys\n\n# 3. \u4fee\u6539\u914d\u7f6e\n# \u7f16\u8f91config.yaml\u8bbe\u7f6e\u6a21\u578b\u548c\u5de5\u5177\n\n# 4. \u8fd0\u884c\u793a\u4f8b\npython examples/basic_research.py\n\n# 5. \u542f\u52a8API\u670d\u52a1\npython -m src.api.server\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u8bbe\u8ba1\u539f\u5219","title":"\ud83d\udca1 \u8bbe\u8ba1\u539f\u5219","text":"<ol> <li>\u6a21\u5757\u5316: \u6bcf\u4e2a\u6a21\u5757\u804c\u8d23\u5355\u4e00\uff0c\u4fbf\u4e8e\u6d4b\u8bd5\u548c\u7ef4\u62a4</li> <li>\u53ef\u6269\u5c55: \u901a\u8fc7\u7ee7\u627fBaseAgent/BaseTool\u8f7b\u677e\u6dfb\u52a0\u65b0\u529f\u80fd</li> <li>\u914d\u7f6e\u9a71\u52a8: \u4e3b\u8981\u884c\u4e3a\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u63a7\u5236\uff0c\u65e0\u9700\u4fee\u6539\u4ee3\u7801</li> <li>\u7c7b\u578b\u5b89\u5168: \u4f7f\u7528Pydantic\u548c\u7c7b\u578b\u63d0\u793a\u786e\u4fdd\u6570\u636e\u6b63\u786e\u6027</li> <li>\u6613\u4e8e\u6d4b\u8bd5: \u6e05\u6670\u7684\u4f9d\u8d56\u6ce8\u5165\uff0c\u4fbf\u4e8eMock\u548c\u5355\u5143\u6d4b\u8bd5</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5173\u952e\u6587\u4ef6\u6807\u6ce8\u8bf4\u660e","title":"\ud83d\udd11 \u5173\u952e\u6587\u4ef6\u6807\u6ce8\u8bf4\u660e","text":"<ul> <li>\u2b50 \u6807\u8bb0\u7684\u662f\u7cfb\u7edf\u6838\u5fc3\u6587\u4ef6\uff0c\u4f18\u5148\u5b9e\u73b0</li> <li>\u5176\u4ed6\u6587\u4ef6\u6839\u636e\u9700\u8981\u9010\u6b65\u6dfb\u52a0</li> <li>tests/\u548cdocs/\u53ef\u4ee5\u968f\u5f00\u53d1\u8fdb\u5ea6\u5b8c\u5584</li> </ul>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u6587\u4ef6\u521b\u5efa\u6b65\u9aa4","title":"\ud83d\udcdd \u6587\u4ef6\u521b\u5efa\u6b65\u9aa4","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-1-\u57fa\u7840\u8bbe\u65bd-\u7b2c1-2\u5929","title":"Phase 1: \u57fa\u7840\u8bbe\u65bd (\u7b2c1-2\u5929)","text":"<p>\u76ee\u6807: \u642d\u5efa\u9879\u76ee\u9aa8\u67b6\u548c\u57fa\u7840\u5de5\u5177</p> <ol> <li>\u9879\u76ee\u521d\u59cb\u5316</li> </ol> <pre><code># \u521b\u5efa\u76ee\u5f55\u7ed3\u6784\nmkdir -p src/{core,agents,tools,models,utils,api}\nmkdir -p {tests,logs,examples,docs,prompts}\n\n# \u521d\u59cb\u5316\u6587\u4ef6\ntouch requirements.txt .env.example .gitignore\ntouch Dockerfile docker-compose.yml config.yaml\n</code></pre> <ol> <li> <p>Utils\u6a21\u5757 (\u6700\u5148\u5b8c\u6210)</p> </li> <li> <p><code>utils/logger.py</code> - \u8bbe\u7f6e\u65e5\u5fd7\u683c\u5f0f\u548c\u6587\u4ef6\u8f93\u51fa</p> </li> <li><code>utils/xml_parser.py</code> - \u5b9e\u73b0robust\u7684XML\u89e3\u6790</li> <li><code>utils/retry.py</code> - \u57fa\u4e8etenacity\u7684\u91cd\u8bd5\u88c5\u9970\u5668</li> <li><code>utils/streaming.py</code> - \u5f02\u6b65\u6d41\u5904\u7406\u5de5\u5177</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-2-\u6a21\u578b\u5c42-\u7b2c2-3\u5929","title":"Phase 2: \u6a21\u578b\u5c42 (\u7b2c2-3\u5929)","text":"<p>\u76ee\u6807: \u5b9e\u73b0\u7edf\u4e00\u7684LLM\u8c03\u7528\u63a5\u53e3</p> <ol> <li> <p>Models\u6a21\u5757</p> </li> <li> <p><code>models/llm.py</code> - \u57fa\u4e8eLangChain\u5c01\u88c5\u591a\u6a21\u578b\u652f\u6301</p> </li> </ol> <pre><code># \u5173\u952e\u5b9e\u73b0\u70b9\uff1a\n- \u914d\u7f6e\u5316\u7684\u6a21\u578b\u521d\u59cb\u5316\n- \u7edf\u4e00\u7684\u8c03\u7528\u63a5\u53e3 (invoke/stream)\n- \u601d\u8003\u6a21\u578b\u7684\u54cd\u5e94\u89e3\u6790\n- Token\u8ba1\u6570\u548c\u6210\u672c\u7edf\u8ba1\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-3-\u5de5\u5177\u7cfb\u7edf-\u7b2c3-4\u5929","title":"Phase 3: \u5de5\u5177\u7cfb\u7edf (\u7b2c3-4\u5929)","text":"<p>\u76ee\u6807: \u5b9e\u73b0XML\u5de5\u5177\u8c03\u7528\u6846\u67b6</p> <ol> <li>Tools\u57fa\u7840\u6846\u67b6</li> <li><code>tools/base.py</code> - BaseTool\u62bd\u8c61\u7c7b</li> <li><code>tools/registry.py</code> - \u5de5\u5177\u6ce8\u518c\u5668</li> <li><code>tools/prompt_generator.py</code> - XML\u63d0\u793a\u8bcd\u751f\u6210</li> <li><code>tools/permissions.py</code> - \u6743\u9650\u63a7\u5236\u7cfb\u7edf</li> <li>\u5177\u4f53\u5de5\u5177\u5b9e\u73b0</li> <li><code>tools/implementations/web_search.py</code></li> <li><code>tools/implementations/artifact_ops.py</code></li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-4-\u6838\u5fc3\u5de5\u4f5c\u6d41-\u7b2c4-5\u5929","title":"Phase 4: \u6838\u5fc3\u5de5\u4f5c\u6d41 (\u7b2c4-5\u5929)","text":"<p>\u76ee\u6807: \u642d\u5efaLangGraph\u5de5\u4f5c\u6d41</p> <ol> <li>Core\u6a21\u5757</li> <li><code>core/state.py</code> - \u5b9a\u4e49AgentState</li> <li><code>core/graph.py</code> - LangGraph\u5de5\u4f5c\u6d41\u914d\u7f6e</li> <li><code>core/controller.py</code> - \u6267\u884c\u63a7\u5236\u5668</li> <li><code>core/context_manager.py</code> - Context\u7ba1\u7406</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-5-agent\u5b9e\u73b0-\u7b2c5-6\u5929","title":"Phase 5: Agent\u5b9e\u73b0 (\u7b2c5-6\u5929)","text":"<p>\u76ee\u6807: \u5b9e\u73b0\u5404\u7c7bAgent</p> <ol> <li>Agents\u6a21\u5757</li> <li><code>agents/base.py</code> - BaseAgent\u63a5\u53e3</li> <li><code>agents/lead_agent.py</code> - \u4e3b\u534f\u8c03Agent</li> <li><code>agents/search_agent.py</code> - \u641c\u7d22Agent</li> <li><code>agents/crawl_agent.py</code> - \u6293\u53d6Agent</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-6-api\u63a5\u53e3-\u7b2c6-7\u5929","title":"Phase 6: API\u63a5\u53e3 (\u7b2c6-7\u5929)","text":"<p>\u76ee\u6807: \u5bf9\u5916\u670d\u52a1\u63a5\u53e3</p> <ol> <li>API\u6a21\u5757</li> <li><code>api/schemas.py</code> - Pydantic\u6570\u636e\u6a21\u578b</li> <li><code>api/server.py</code> - FastAPI\u5e94\u7528</li> <li><code>api/routes.py</code> - \u8def\u7531\u5b9a\u4e49</li> <li><code>api/websocket.py</code> - WebSocket\u652f\u6301</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-7-\u6d4b\u8bd5\u548c\u6587\u6863-\u7b2c7-8\u5929","title":"Phase 7: \u6d4b\u8bd5\u548c\u6587\u6863 (\u7b2c7-8\u5929)","text":"<p>\u76ee\u6807: \u5b8c\u5584\u6d4b\u8bd5\u548c\u6587\u6863</p> <ol> <li>\u6d4b\u8bd5\u7528\u4f8b</li> <li>\u5355\u5143\u6d4b\u8bd5 (utils, tools)</li> <li>\u96c6\u6210\u6d4b\u8bd5 (workflow, agents)</li> <li>\u8fd0\u884c\u73af\u5883</li> <li>\u5b8c\u5584Dockerfile</li> <li>\u7f16\u5199examples</li> <li>\u66f4\u65b0README</li> </ol>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#-\u5feb\u901f\u9a8c\u8bc1\u6bcf\u4e2a\u9636\u6bb5","title":"\ud83d\ude80 \u5feb\u901f\u9a8c\u8bc1\u6bcf\u4e2a\u9636\u6bb5","text":""},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-1-\u9a8c\u8bc1","title":"Phase 1 \u9a8c\u8bc1","text":"<pre><code># \u6d4b\u8bd5logger\nfrom src.utils.logger import get_logger\nlogger = get_logger(\"test\")\nlogger.info(\"Logger working!\")\n\n# \u6d4b\u8bd5XML\u89e3\u6790\nfrom src.utils.xml_parser import parse_xml\nresult = parse_xml(\"&lt;tool&gt;&lt;name&gt;test&lt;/name&gt;&lt;/tool&gt;\")\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-2-\u9a8c\u8bc1","title":"Phase 2 \u9a8c\u8bc1","text":"<pre><code># \u6d4b\u8bd5\u6a21\u578b\u8c03\u7528\nfrom src.models.llm import get_model\nmodel = get_model(\"openai\", model=\"gpt-4\")\nresponse = model.invoke(\"Hello\")\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-3-\u9a8c\u8bc1","title":"Phase 3 \u9a8c\u8bc1","text":"<pre><code># \u6d4b\u8bd5\u5de5\u5177\u6ce8\u518c\u548c\u8c03\u7528\nfrom src.tools.registry import ToolRegistry\nregistry = ToolRegistry()\nregistry.register(my_tool)\nprompt = registry.generate_prompt()\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-4-\u9a8c\u8bc1","title":"Phase 4 \u9a8c\u8bc1","text":"<pre><code># \u6d4b\u8bd5\u57fa\u7840\u5de5\u4f5c\u6d41\nfrom src.core.graph import create_workflow\napp = create_workflow()\nresult = app.invoke({\"task\": \"test\"})\n</code></pre>"},{"location":"_archive/%E5%9F%BA%E4%BA%8EArtifact%E7%9A%84Multi-Agent%E7%A0%94%E7%A9%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/#phase-5-\u9a8c\u8bc1","title":"Phase 5 \u9a8c\u8bc1","text":"<pre><code># \u7aef\u5230\u7aef\u6d4b\u8bd5\nfrom src.agents.lead_agent import LeadAgent\nagent = LeadAgent()\nresult = await agent.execute(\"\u7814\u7a76AI\u533b\u7597\")\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/","title":"ArtifactFlow \u6301\u4e45\u5316\u6539\u9020\u65b9\u6848","text":"<p>\u7248\u672c: v1.1 | \u4f18\u5148\u7ea7: P0\uff08API\u548c\u524d\u7aef\u7684\u524d\u7f6e\u4f9d\u8d56\uff09</p> <p>\u53d8\u66f4\u8bb0\u5f55\uff1a - v1.1: \u65b0\u589e\u53cc\u5c42\u5b58\u50a8\u7b56\u7565\u3001\u4f9d\u8d56\u6ce8\u5165\u89c4\u8303\u3001\u4e50\u89c2\u9501\u673a\u5236\u3001Checkpointer\u66ff\u6362\u65b9\u6848</p>"},{"location":"_archive/frontend/01_persistence_design/#1-\u6539\u9020\u76ee\u6807","title":"1. \u6539\u9020\u76ee\u6807","text":"<p>\u5c06\u5f53\u524d\u57fa\u4e8e\u5185\u5b58\u7684 <code>ConversationManager</code> \u548c <code>ArtifactStore</code> \u6539\u9020\u4e3a SQLite \u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5b9e\u73b0\uff1a</p> <ol> <li>\u6570\u636e\u6301\u4e45\u5316\uff1a\u670d\u52a1\u91cd\u542f\u540e\u6570\u636e\u4e0d\u4e22\u5931</li> <li>\u89e3\u8026\u5b58\u50a8\uff1aConversation \u548c Artifact \u72ec\u7acb\u5b58\u50a8\uff0c\u901a\u8fc7 ID \u5173\u8054</li> <li>\u53ef\u6269\u5c55\u6027\uff1a\u4e3a\u540e\u7eed PostgreSQL \u8fc1\u79fb\u548c\u7528\u6237\u7cfb\u7edf\u9884\u7559\u63a5\u53e3</li> <li>\u6027\u80fd\u5e73\u8861\uff1a\u70ed\u6570\u636e\u5185\u5b58\u7f13\u5b58 + \u51b7\u6570\u636e\u6570\u636e\u5e93\u5b58\u50a8</li> <li>\ud83c\udd95 \u65e0\u72b6\u6001\u5316\uff1a\u652f\u6301\u5bb9\u5668\u5316\u6c34\u5e73\u6269\u5c55</li> </ol>"},{"location":"_archive/frontend/01_persistence_design/#2--\u53cc\u5c42\u5b58\u50a8\u7b56\u7565-dual-storage-strategy","title":"2. \ud83c\udd95 \u53cc\u5c42\u5b58\u50a8\u7b56\u7565 (Dual Storage Strategy)","text":""},{"location":"_archive/frontend/01_persistence_design/#21-\u6838\u5fc3\u6982\u5ff5","title":"2.1 \u6838\u5fc3\u6982\u5ff5","text":"<p>\u7cfb\u7edf\u91c7\u7528\u53cc\u5c42\u5b58\u50a8\u67b6\u6784\uff0c\u660e\u786e\u533a\u5206\u4e24\u7c7b\u5b58\u50a8\u7684\u804c\u8d23\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      \u53cc\u5c42\u5b58\u50a8\u67b6\u6784                                \u2502\n\u2502                                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502    Application DB       \u2502    \u2502  LangGraph Checkpointer \u2502    \u2502\n\u2502  \u2502    (SQLite/Postgres)    \u2502    \u2502   (AsyncSqliteSaver)    \u2502    \u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u2502\n\u2502  \u2502 \u89d2\u8272: \"\u957f\u671f\u8bb0\u5fc6\"         \u2502    \u2502 \u89d2\u8272: \"\u77ed\u671f\u5de5\u4f5c\u53f0\"       \u2502    \u2502\n\u2502  \u2502 \u771f\u76f8\u6765\u6e90 (Source of Truth)\u2502   \u2502 \u6267\u884c\u72b6\u6001\u6682\u5b58            \u2502    \u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u2502\n\u2502  \u2502 \u804c\u8d23:                   \u2502    \u2502 \u804c\u8d23:                   \u2502    \u2502\n\u2502  \u2502 - UI \u5c55\u793a               \u2502    \u2502 - \u6267\u884c\u6808\u4fdd\u5b58            \u2502    \u2502\n\u2502  \u2502 - \u641c\u7d22\u548c\u5386\u53f2\u56de\u6eaf         \u2502    \u2502 - \u4e2d\u65ad/\u6062\u590d\u72b6\u6001         \u2502    \u2502\n\u2502  \u2502 - \u8de8\u4f1a\u8bdd\u6301\u4e45\u5316          \u2502    \u2502 - Agent \u53d8\u91cf\u72b6\u6001        \u2502    \u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u2502\n\u2502  \u2502 \u6570\u636e:                   \u2502    \u2502 \u6570\u636e:                   \u2502    \u2502\n\u2502  \u2502 - conversations         \u2502    \u2502 - thread states        \u2502    \u2502\n\u2502  \u2502 - messages              \u2502    \u2502 - interrupt values     \u2502    \u2502\n\u2502  \u2502 - artifacts             \u2502    \u2502 - agent memories       \u2502    \u2502\n\u2502  \u2502 - artifact_versions     \u2502    \u2502                         \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502              \u2502                              \u2502                   \u2502\n\u2502              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                   \u2502\n\u2502                         \u2502                                       \u2502\n\u2502              ExecutionController                                \u2502\n\u2502              (\u72b6\u6001\u6ce8\u5165 &amp; \u540c\u6b65)                                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#22-\u72b6\u6001\u6ce8\u5165\u673a\u5236-state-injection","title":"2.2 \u72b6\u6001\u6ce8\u5165\u673a\u5236 (State Injection)","text":"<p>\u5173\u952e\u539f\u5219\uff1aApp DB \u662f\u771f\u76f8\u6765\u6e90\uff0cLangGraph Checkpointer \u4ec5\u7528\u4e8e\u6267\u884c\u8fc7\u7a0b\u3002</p> <p>\u5b9e\u73b0\u8981\u70b9\uff1a 1. \u6bcf\u6b21\u542f\u52a8\u65b0\u5bf9\u8bdd\u65f6\uff0c\u5f3a\u5236\u4ece App DB \u62c9\u53d6\u6e05\u6d17\u8fc7\u7684\u5386\u53f2\u8bb0\u5f55 2. \u5c06\u5386\u53f2\u8bb0\u5f55\u6ce8\u5165\u5230 Agent State \u7684 <code>conversation_history</code> \u5b57\u6bb5 3. \u8986\u76d6 LangGraph Checkpointer \u53ef\u80fd\u6b8b\u7559\u7684\u65e7\u6570\u636e</p> <pre><code># ExecutionController._execute_new_message() \u4e2d\u7684\u903b\u8f91\nasync def _execute_new_message(self, content, conversation_id, parent_message_id):\n    # 1. \u4ece App DB \u83b7\u53d6\u5bf9\u8bdd\u5386\u53f2\uff08\u771f\u76f8\u6765\u6e90\uff09\n    conversation_history = await self.conversation_manager.format_conversation_history_async(\n        conv_id=conversation_id,\n        to_message_id=parent_message_id\n    )\n\n    # 2. \u521b\u5efa\u65b0\u7684 thread_id\uff08\u6bcf\u6b21\u6267\u884c\u90fd\u662f\u65b0\u7ebf\u7a0b\uff09\n    thread_id = f\"thd-{uuid4().hex}\"\n\n    # 3. \u6784\u5efa\u521d\u59cb\u72b6\u6001\uff0c\u6ce8\u5165\u5386\u53f2\u8bb0\u5f55\n    initial_state = create_initial_state(\n        task=content,\n        conversation_history=conversation_history,  # \u6ce8\u5165\u5386\u53f2\n        thread_id=thread_id,\n        # ...\n    )\n\n    # 4. \u6267\u884c\u56fe\uff08Checkpointer \u53ea\u4fdd\u5b58\u672c\u6b21\u6267\u884c\u72b6\u6001\uff09\n    result = await self.graph.ainvoke(initial_state, config)\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#23-\u5206\u652f\u5bf9\u8bdd\u7684-thread-\u7b56\u7565","title":"2.3 \u5206\u652f\u5bf9\u8bdd\u7684 Thread \u7b56\u7565","text":"<p>\u5f53\u7528\u6237\u521b\u5efa\u5206\u652f\u65f6\uff1a</p> <ol> <li>App DB \u5c42\uff1a\u8bb0\u5f55\u6811\u72b6\u7ed3\u6784\uff08<code>messages.parent_id</code> \u6307\u5411\u5206\u652f\u70b9\uff09</li> <li>LangGraph \u5c42\uff1a\u521b\u5efa\u65b0\u7684 <code>thread_id</code></li> <li>\u72b6\u6001\u6ce8\u5165\uff1a\u5c06\u5206\u652f\u70b9\u4e4b\u524d\u7684\u5386\u53f2\u4f5c\u4e3a\u521d\u59cb\u72b6\u6001\u6ce8\u5165</li> </ol> <pre><code># \u5206\u652f\u521b\u5efa\u6d41\u7a0b\ndef create_branch(self, conv_id, parent_message_id, new_content):\n    # 1. \u83b7\u53d6\u4ece\u6839\u5230\u5206\u652f\u70b9\u7684\u5386\u53f2\n    history = self.conversation_manager.get_message_path(conv_id, parent_message_id)\n\n    # 2. \u521b\u5efa\u65b0\u7684 thread_id\uff08\u4e0d\u590d\u7528\u65e7\u5206\u652f\u7684\uff09\n    new_thread_id = f\"thd-{uuid4().hex}\"\n\n    # 3. \u6ce8\u5165\u5386\u53f2\u5230\u65b0\u6267\u884c\n    # ...\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#3--\u5f00\u53d1\u89c4\u8303","title":"3. \ud83c\udd95 \u5f00\u53d1\u89c4\u8303","text":""},{"location":"_archive/frontend/01_persistence_design/#31-\u4f9d\u8d56\u6ce8\u5165\u4e0e\u65e0\u72b6\u6001\u5316","title":"3.1 \u4f9d\u8d56\u6ce8\u5165\u4e0e\u65e0\u72b6\u6001\u5316","text":"<p>\u5f3a\u5236\u8981\u6c42\uff1a\u5e9f\u5f03\u6240\u6709\u6a21\u5757\u7ea7\u5168\u5c40\u5355\u4f8b\u53d8\u91cf\u3002</p> <p>\u5e9f\u5f03\u6a21\u5f0f\uff08\u4e0d\u518d\u4f7f\u7528\uff09\uff1a <pre><code># \u274c \u65e7\u4ee3\u7801 - artifact_ops.py\n_artifact_store = ArtifactStore()\n\ndef get_artifact_store():\n    return _artifact_store\n</code></pre></p> <p>\u65b0\u6a21\u5f0f\uff1a <pre><code># \u2705 \u65b0\u4ee3\u7801 - \u901a\u8fc7\u6784\u9020\u51fd\u6570\u6ce8\u5165\nclass ArtifactManager:\n    def __init__(self, repository: ArtifactRepository):\n        self.repository = repository\n        self._cache = {}  # \u5b9e\u4f8b\u7ea7\u7f13\u5b58\n\n# \u2705 API \u5c42\u4f7f\u7528 FastAPI Depends\nfrom fastapi import Depends\n\ndef get_artifact_manager(\n    db: AsyncSession = Depends(get_db_session)\n) -&gt; ArtifactManager:\n    repo = ArtifactRepository(db)\n    return ArtifactManager(repo)\n</code></pre></p> <p>\u76ee\u7684\uff1a - \u786e\u4fdd\u5185\u5b58\u4e2d\u4e0d\u6b8b\u7559\u7528\u6237\u72b6\u6001 - \u652f\u6301\u5bb9\u5668\u5316\u6c34\u5e73\u6269\u5c55 (Horizontal Scaling) - \u4fbf\u4e8e\u5355\u5143\u6d4b\u8bd5\uff08\u53ef\u6ce8\u5165 Mock\uff09</p>"},{"location":"_archive/frontend/01_persistence_design/#32-orm-\u89c4\u8303","title":"3.2 ORM \u89c4\u8303","text":"<p>\u5f3a\u5236\u8981\u6c42\uff1a\u6240\u6709\u6570\u636e\u5e93\u64cd\u4f5c\u5fc5\u987b\u901a\u8fc7 SQLAlchemy ORM \u6a21\u578b\u8fdb\u884c\uff0c\u7981\u6b62\u539f\u751f SQL\u3002</p> <pre><code># \u274c \u7981\u6b62\nresult = await session.execute(text(\"SELECT * FROM conversations WHERE id = :id\"), {\"id\": conv_id})\n\n# \u2705 \u5fc5\u987b\u4f7f\u7528 ORM\nresult = await session.execute(\n    select(Conversation).where(Conversation.id == conv_id)\n)\n</code></pre> <p>\u76ee\u7684\uff1a\u786e\u4fdd\u4ece SQLite \u8fc1\u79fb\u5230 PostgreSQL \u65f6\u53ea\u9700\u66f4\u6539\u8fde\u63a5\u5b57\u7b26\u4e32\uff0c\u65e0\u9700\u91cd\u5199\u67e5\u8be2\u903b\u8f91\u3002</p>"},{"location":"_archive/frontend/01_persistence_design/#4-\u6570\u636e\u5e93-schema-\u8bbe\u8ba1","title":"4. \u6570\u636e\u5e93 Schema \u8bbe\u8ba1","text":""},{"location":"_archive/frontend/01_persistence_design/#41-\u6838\u5fc3\u539f\u5219","title":"4.1 \u6838\u5fc3\u539f\u5219","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      \u5173\u7cfb\u8bbe\u8ba1\u539f\u5219                            \u2502\n\u2502                                                             \u2502\n\u2502  Conversation \u25c4\u2500\u25001:1\u2500\u2500\u25ba ArtifactSession                    \u2502\n\u2502       \u2502                        \u2502                            \u2502\n\u2502       \u2502 1:N                    \u2502 1:N                        \u2502\n\u2502       \u25bc                        \u25bc                            \u2502\n\u2502   Messages                 Artifacts                        \u2502\n\u2502       \u2502                        \u2502                            \u2502\n\u2502       \u2502 tree structure         \u2502 1:N                        \u2502\n\u2502       \u25bc                        \u25bc                            \u2502\n\u2502   (parent_id)           ArtifactVersions                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#42-\u8868\u7ed3\u6784\u8bbe\u8ba1","title":"4.2 \u8868\u7ed3\u6784\u8bbe\u8ba1","text":""},{"location":"_archive/frontend/01_persistence_design/#\u88681-conversations","title":"\u88681: <code>conversations</code>","text":"\u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e id TEXT PRIMARY KEY conversation_id\uff0c\u540c\u65f6\u4e5f\u662f\u5173\u8054\u7684 session_id active_branch TEXT \u5f53\u524d\u6d3b\u8dc3\u7684\u53f6\u5b50\u8282\u70b9 message_id created_at TIMESTAMP \u521b\u5efa\u65f6\u95f4 updated_at TIMESTAMP \u6700\u540e\u66f4\u65b0\u65f6\u95f4 user_id TEXT NULLABLE \u9884\u7559\uff1a\u7528\u6237ID\uff08Phase 2\uff09 title TEXT NULLABLE \u5bf9\u8bdd\u6807\u9898\uff08\u53ef\u7531\u9996\u6761\u6d88\u606f\u81ea\u52a8\u751f\u6210\uff09 metadata JSON \u6269\u5c55\u5143\u6570\u636e"},{"location":"_archive/frontend/01_persistence_design/#\u88682-messages","title":"\u88682: <code>messages</code>","text":"\u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e id TEXT PRIMARY KEY message_id conversation_id TEXT FK \u6240\u5c5e\u5bf9\u8bdd parent_id TEXT NULLABLE \u7236\u6d88\u606fID\uff08\u5b9e\u73b0\u6811\u7ed3\u6784\uff09 content TEXT \u7528\u6237\u6d88\u606f\u5185\u5bb9 thread_id TEXT \u5173\u8054\u7684 LangGraph \u7ebf\u7a0bID graph_response TEXT NULLABLE Graph \u6700\u7ec8\u54cd\u5e94 created_at TIMESTAMP \u521b\u5efa\u65f6\u95f4 metadata JSON \u6269\u5c55\u5143\u6570\u636e\uff08\u53ef\u5b58\u50a8\u7b80\u5316\u7684\u6267\u884c\u6458\u8981\uff09"},{"location":"_archive/frontend/01_persistence_design/#\u88683-artifact_sessions","title":"\u88683: <code>artifact_sessions</code>","text":"\u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e id TEXT PRIMARY KEY session_id\uff08\u4e0e conversation_id \u76f8\u540c\uff09 created_at TIMESTAMP \u521b\u5efa\u65f6\u95f4 updated_at TIMESTAMP \u6700\u540e\u66f4\u65b0\u65f6\u95f4"},{"location":"_archive/frontend/01_persistence_design/#\u88684-artifacts--\u589e\u52a0\u4e50\u89c2\u9501\u5b57\u6bb5","title":"\u88684: <code>artifacts</code> \ud83c\udd95 \u589e\u52a0\u4e50\u89c2\u9501\u5b57\u6bb5","text":"\u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e id TEXT artifact_id session_id TEXT FK \u6240\u5c5e\u4f1a\u8bdd content_type TEXT \u5185\u5bb9\u7c7b\u578b (markdown/python/etc) title TEXT \u6807\u9898 content TEXT \ud83c\udd95 \u5f53\u524d\u5185\u5bb9\uff08\u5197\u4f59\u5b58\u50a8\uff0c\u907f\u514d\u6bcf\u6b21\u67e5\u7248\u672c\u8868\uff09 current_version INTEGER \u5f53\u524d\u7248\u672c\u53f7 lock_version INTEGER DEFAULT 1 \ud83c\udd95 \u4e50\u89c2\u9501\u7248\u672c\u53f7 created_at TIMESTAMP \u521b\u5efa\u65f6\u95f4 updated_at TIMESTAMP \u6700\u540e\u66f4\u65b0\u65f6\u95f4 metadata JSON \u6269\u5c55\u5143\u6570\u636e PRIMARY KEY (id, session_id) \u590d\u5408\u4e3b\u952e"},{"location":"_archive/frontend/01_persistence_design/#\u88685-artifact_versions","title":"\u88685: <code>artifact_versions</code>","text":"\u5b57\u6bb5 \u7c7b\u578b \u8bf4\u660e id INTEGER PRIMARY KEY AUTOINCREMENT \u81ea\u589eID artifact_id TEXT \u6240\u5c5e artifact session_id TEXT \u6240\u5c5e\u4f1a\u8bdd version INTEGER \u7248\u672c\u53f7 content TEXT \u7248\u672c\u5185\u5bb9 update_type TEXT \u66f4\u65b0\u7c7b\u578b (create/update/rewrite) changes JSON NULLABLE \u53d8\u66f4\u8bb0\u5f55 [(old, new), ...] created_at TIMESTAMP \u521b\u5efa\u65f6\u95f4 UNIQUE (artifact_id, session_id, version) \u552f\u4e00\u7ea6\u675f"},{"location":"_archive/frontend/01_persistence_design/#43--\u4e50\u89c2\u9501\u673a\u5236","title":"4.3 \ud83c\udd95 \u4e50\u89c2\u9501\u673a\u5236","text":"<p>\u5b9e\u73b0\u65b9\u5f0f\uff1a <pre><code>class ArtifactRepository:\n    async def update_artifact(\n        self, \n        session_id: str, \n        artifact_id: str, \n        content: str,\n        expected_lock_version: int\n    ) -&gt; Artifact:\n        \"\"\"\n        \u66f4\u65b0 Artifact \u5185\u5bb9\uff08\u5e26\u4e50\u89c2\u9501\uff09\n\n        Raises:\n            VersionConflictError: \u7248\u672c\u51b2\u7a81\u65f6\u629b\u51fa\n        \"\"\"\n        result = await self.session.execute(\n            update(Artifact)\n            .where(\n                Artifact.id == artifact_id,\n                Artifact.session_id == session_id,\n                Artifact.lock_version == expected_lock_version  # \u4e50\u89c2\u9501\u68c0\u67e5\n            )\n            .values(\n                content=content,\n                current_version=Artifact.current_version + 1,\n                lock_version=Artifact.lock_version + 1,  # \u9012\u589e\u9501\u7248\u672c\n                updated_at=datetime.now()\n            )\n        )\n\n        if result.rowcount == 0:\n            raise VersionConflictError(\n                f\"Artifact {artifact_id} has been modified by another process\"\n            )\n\n        await self.session.commit()\n        return await self.get_artifact(session_id, artifact_id)\n</code></pre></p> <p>\u51b2\u7a81\u5904\u7406\u7b56\u7565\uff1a - Agent \u5de5\u5177\u8c03\u7528\u5931\u8d25\u65f6\uff0c\u8fd4\u56de\u9519\u8bef\u4fe1\u606f\u8ba9 Agent \u51b3\u5b9a\u91cd\u8bd5\u6216\u8bfb\u53d6\u6700\u65b0\u7248 - \u524d\u7aef\u53ef\u5c55\u793a\u51b2\u7a81\u63d0\u793a\uff0c\u8ba9\u7528\u6237\u9009\u62e9\u4fdd\u7559\u54ea\u4e2a\u7248\u672c</p>"},{"location":"_archive/frontend/01_persistence_design/#5--langgraph-checkpointer-\u914d\u7f6e","title":"5. \ud83c\udd95 LangGraph Checkpointer \u914d\u7f6e","text":""},{"location":"_archive/frontend/01_persistence_design/#51-\u66ff\u6362-memorysaver","title":"5.1 \u66ff\u6362 MemorySaver","text":"<p>\u5f53\u524d\u4ee3\u7801\uff08\u9700\u8981\u4fee\u6539\uff09\uff1a <pre><code># graph.py\nfrom langgraph.checkpoint.memory import MemorySaver\n\ndef compile(self, ...):\n    if checkpointer is None:\n        checkpointer = MemorySaver()  # \u274c \u5185\u5b58\u5b58\u50a8\uff0c\u91cd\u542f\u4e22\u5931\n</code></pre></p> <p>\u6539\u9020\u540e\uff1a <pre><code># graph.py\nfrom langgraph.checkpoint.sqlite.aio import AsyncSqliteSaver\n\nasync def compile(self, db_path: str = \"data/artifactflow.db\", ...):\n    if checkpointer is None:\n        # \u2705 \u4f7f\u7528 SQLite \u6301\u4e45\u5316\uff0c\u4e0e App DB \u5171\u4eab\u540c\u4e00\u6587\u4ef6\n        checkpointer = AsyncSqliteSaver.from_conn_string(\n            f\"sqlite+aiosqlite:///{db_path}\"\n        )\n</code></pre></p>"},{"location":"_archive/frontend/01_persistence_design/#52-\u914d\u7f6e\u5efa\u8bae","title":"5.2 \u914d\u7f6e\u5efa\u8bae","text":"\u914d\u7f6e\u9879 \u63a8\u8350\u503c \u8bf4\u660e \u6570\u636e\u5e93\u6587\u4ef6 <code>data/artifactflow.db</code> \u4e0e App DB \u5171\u4eab\uff0c\u7b80\u5316\u90e8\u7f72 \u8fde\u63a5\u6c60\u5927\u5c0f 5 SQLite \u6709\u5199\u9501\u9650\u5236\uff0c\u4e0d\u5b9c\u8fc7\u5927 WAL \u6a21\u5f0f \u542f\u7528 \u63d0\u9ad8\u5e76\u53d1\u8bfb\u6027\u80fd <pre><code># database.py\nfrom sqlalchemy.ext.asyncio import create_async_engine\n\nengine = create_async_engine(\n    \"sqlite+aiosqlite:///data/artifactflow.db\",\n    echo=False,\n    pool_size=5,\n    connect_args={\"check_same_thread\": False}\n)\n\n# \u542f\u7528 WAL \u6a21\u5f0f\n@event.listens_for(engine.sync_engine, \"connect\")\ndef set_sqlite_pragma(dbapi_connection, connection_record):\n    cursor = dbapi_connection.cursor()\n    cursor.execute(\"PRAGMA journal_mode=WAL\")\n    cursor.close()\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#6-\u67b6\u6784\u8bbe\u8ba1","title":"6. \u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"_archive/frontend/01_persistence_design/#61-\u5206\u5c42\u67b6\u6784","title":"6.1 \u5206\u5c42\u67b6\u6784","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Application Layer                        \u2502\n\u2502         (ExecutionController, Agents, Tools)                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Manager Layer (\u6539\u9020\u91cd\u70b9)                 \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502   \u2502 ConversationManager \u2502   \u2502    ArtifactManager      \u2502    \u2502\n\u2502   \u2502  - \u5185\u5b58\u7f13\u5b58\u70ed\u6570\u636e     \u2502   \u2502  - \u5185\u5b58\u7f13\u5b58\u70ed\u6570\u636e        \u2502    \u2502\n\u2502   \u2502  - \u8c03\u7528 Repository    \u2502   \u2502  - \u8c03\u7528 Repository       \u2502    \u2502\n\u2502   \u2502  - \ud83c\udd95 \u4f9d\u8d56\u6ce8\u5165        \u2502   \u2502  - \ud83c\udd95 \u4f9d\u8d56\u6ce8\u5165           \u2502    \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Repository Layer (\u65b0\u589e)                   \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502   \u2502ConversationRepository\u2502   \u2502  ArtifactRepository    \u2502    \u2502\n\u2502   \u2502  - CRUD \u64cd\u4f5c         \u2502   \u2502  - CRUD \u64cd\u4f5c            \u2502    \u2502\n\u2502   \u2502  - \u6811\u7ed3\u6784\u67e5\u8be2        \u2502   \u2502  - \u7248\u672c\u7ba1\u7406             \u2502    \u2502\n\u2502   \u2502  - \ud83c\udd95 ORM Only       \u2502   \u2502  - \ud83c\udd95 \u4e50\u89c2\u9501            \u2502    \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Database Layer (\u65b0\u589e)                    \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502   \u2502                   DatabaseManager                    \u2502  \u2502\n\u2502   \u2502  - \u8fde\u63a5\u6c60\u7ba1\u7406                                        \u2502  \u2502\n\u2502   \u2502  - \u4e8b\u52a1\u7ba1\u7406                                          \u2502  \u2502\n\u2502   \u2502  - \ud83c\udd95 WAL \u6a21\u5f0f                                       \u2502  \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                           \u2502                                  \u2502\n\u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                    \u2502\n\u2502              \u25bc                         \u25bc                    \u2502\n\u2502     App DB (SQLite)          LangGraph Checkpointer        \u2502\n\u2502     (conversations,          (AsyncSqliteSaver)            \u2502\n\u2502      messages, artifacts)    (thread states)               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#62-\u7f13\u5b58\u7b56\u7565","title":"6.2 \u7f13\u5b58\u7b56\u7565","text":"<p>\u70ed\u6570\u636e\u5b9a\u4e49\uff1a - \u5f53\u524d\u6d3b\u8dc3\u7684 Conversation\uff08\u6700\u8fd1\u8bbf\u95ee\u7684 N \u4e2a\uff09 - \u5f53\u524d\u6d3b\u8dc3\u7684 ArtifactSession - \u6700\u8fd1\u4fee\u6539\u7684 Artifact \u5185\u5bb9</p> <p>\u7f13\u5b58\u5931\u6548\u7b56\u7565\uff1a - LRU \u6dd8\u6c70\uff1a\u7f13\u5b58\u5bb9\u91cf\u8fbe\u5230\u9608\u503c\u65f6\u6dd8\u6c70\u6700\u4e45\u672a\u4f7f\u7528\u7684\u6570\u636e - \u5199\u7a7f\u900f\uff1a\u5199\u64cd\u4f5c\u540c\u65f6\u66f4\u65b0\u7f13\u5b58\u548c\u6570\u636e\u5e93 - \u5ef6\u8fdf\u52a0\u8f7d\uff1a\u9996\u6b21\u8bbf\u95ee\u65f6\u4ece\u6570\u636e\u5e93\u52a0\u8f7d\u5230\u7f13\u5b58</p>"},{"location":"_archive/frontend/01_persistence_design/#7-\u6587\u4ef6\u7ed3\u6784\u89c4\u5212","title":"7. \u6587\u4ef6\u7ed3\u6784\u89c4\u5212","text":""},{"location":"_archive/frontend/01_persistence_design/#71-\u65b0\u589e\u6587\u4ef6","title":"7.1 \u65b0\u589e\u6587\u4ef6","text":"<pre><code>src/\n\u251c\u2500\u2500 db/                          # \u65b0\u589e\uff1a\u6570\u636e\u5e93\u5c42\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 database.py              # DatabaseManager\uff1a\u8fde\u63a5\u6c60\u3001\u4e8b\u52a1\u7ba1\u7406\n\u2502   \u251c\u2500\u2500 models.py                # SQLAlchemy ORM \u6a21\u578b\u5b9a\u4e49\n\u2502   \u2514\u2500\u2500 migrations/              # \u6570\u636e\u5e93\u8fc1\u79fb\u811a\u672c\n\u2502       \u251c\u2500\u2500 __init__.py\n\u2502       \u2514\u2500\u2500 versions/\n\u2502           \u2514\u2500\u2500 001_initial_schema.py\n\u2502\n\u251c\u2500\u2500 repositories/                # \u65b0\u589e\uff1a\u6570\u636e\u8bbf\u95ee\u5c42\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 base.py                  # BaseRepository \u62bd\u8c61\u7c7b\n\u2502   \u251c\u2500\u2500 conversation_repo.py     # ConversationRepository\n\u2502   \u2514\u2500\u2500 artifact_repo.py         # ArtifactRepository\n\u2502\n\u251c\u2500\u2500 core/\n\u2502   \u251c\u2500\u2500 conversation_manager.py  # \u6539\u9020\uff1a\u4ece controller.py \u5206\u79bb\n\u2502   \u2514\u2500\u2500 ... (\u5176\u4ed6\u6587\u4ef6)\n\u2502\n\u2514\u2500\u2500 tools/implementations/\n    \u2514\u2500\u2500 artifact_ops.py          # \u6539\u9020\uff1aArtifactStore \u2192 ArtifactManager\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#72-\u6539\u9020\u6587\u4ef6","title":"7.2 \u6539\u9020\u6587\u4ef6","text":"\u6587\u4ef6 \u6539\u9020\u5185\u5bb9 <code>controller.py</code> \u5c06 <code>ConversationManager</code> \u7c7b\u79fb\u51fa\u5230\u72ec\u7acb\u6587\u4ef6\uff0c\u6539\u4e3a\u4f7f\u7528 Repository <code>artifact_ops.py</code> \u5c06 <code>ArtifactStore</code> \u6539\u9020\u4e3a <code>ArtifactManager</code>\uff0c\u5e95\u5c42\u4f7f\u7528 Repository\uff0c\ud83c\udd95 \u79fb\u9664\u5168\u5c40\u5355\u4f8b <code>graph.py</code> \ud83c\udd95 \u66f4\u65b0 Checkpointer \u4e3a AsyncSqliteSaver <code>requirements.txt</code> \u6dfb\u52a0 <code>sqlalchemy&gt;=2.0</code>, <code>aiosqlite</code>"},{"location":"_archive/frontend/01_persistence_design/#8-\u6838\u5fc3\u7c7b\u8bbe\u8ba1\u8981\u70b9","title":"8. \u6838\u5fc3\u7c7b\u8bbe\u8ba1\u8981\u70b9","text":""},{"location":"_archive/frontend/01_persistence_design/#81-databasemanager","title":"8.1 DatabaseManager","text":"<p>\u804c\u8d23\uff1a - \u7ba1\u7406\u6570\u636e\u5e93\u8fde\u63a5\uff08\u652f\u6301\u5f02\u6b65\uff09 - \u63d0\u4f9b\u4e8b\u52a1\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668 - \u521d\u59cb\u5316\u6570\u636e\u5e93 schema - \ud83c\udd95 \u914d\u7f6e WAL \u6a21\u5f0f</p> <p>\u8bbe\u8ba1\u8981\u70b9\uff1a - \u4f7f\u7528 <code>aiosqlite</code> \u5b9e\u73b0\u5f02\u6b65 SQLite \u8bbf\u95ee - \u63d0\u4f9b\u540c\u6b65\u548c\u5f02\u6b65\u4e24\u79cd\u63a5\u53e3\uff08\u517c\u5bb9\u73b0\u6709\u4ee3\u7801\uff09 - \u6570\u636e\u5e93\u8def\u5f84\u53ef\u914d\u7f6e\uff08\u9ed8\u8ba4 <code>data/artifactflow.db</code>\uff09</p>"},{"location":"_archive/frontend/01_persistence_design/#82-conversationrepository","title":"8.2 ConversationRepository","text":"<p>\u804c\u8d23\uff1a - Conversation CRUD - Message CRUD - \u6811\u7ed3\u6784\u67e5\u8be2\uff08\u83b7\u53d6\u4ece\u6839\u5230\u6307\u5b9a\u8282\u70b9\u7684\u8def\u5f84\uff09</p> <p>\u5173\u952e\u65b9\u6cd5\uff1a <pre><code>- create_conversation(conv_id) \u2192 Conversation\n- get_conversation(conv_id) \u2192 Optional[Conversation]\n- add_message(conv_id, message) \u2192 Message\n- get_message_path(conv_id, to_message_id) \u2192 List[Message]\n- update_response(conv_id, message_id, response)\n- list_conversations(user_id=None, limit, offset) \u2192 List[Conversation]\n</code></pre></p>"},{"location":"_archive/frontend/01_persistence_design/#83-artifactrepository","title":"8.3 ArtifactRepository","text":"<p>\u804c\u8d23\uff1a - ArtifactSession CRUD - Artifact CRUD - \u7248\u672c\u7ba1\u7406 - \ud83c\udd95 \u4e50\u89c2\u9501\u5e76\u53d1\u63a7\u5236</p> <p>\u5173\u952e\u65b9\u6cd5\uff1a <pre><code>- create_session(session_id) \u2192 ArtifactSession\n- get_session(session_id) \u2192 Optional[ArtifactSession]\n- create_artifact(session_id, artifact_data) \u2192 Artifact\n- get_artifact(session_id, artifact_id) \u2192 Optional[Artifact]\n- update_artifact(session_id, artifact_id, content, expected_lock_version) \u2192 Artifact  # \ud83c\udd95 \u4e50\u89c2\u9501\n- save_version(session_id, artifact_id, version_data) \u2192 ArtifactVersion\n- get_version(session_id, artifact_id, version) \u2192 Optional[ArtifactVersion]\n- list_artifacts(session_id) \u2192 List[Artifact]\n</code></pre></p>"},{"location":"_archive/frontend/01_persistence_design/#84-conversationmanager\u6539\u9020","title":"8.4 ConversationManager\uff08\u6539\u9020\uff09","text":"<p>\u6539\u9020\u8981\u70b9\uff1a - \u4fdd\u6301\u73b0\u6709 API \u4e0d\u53d8\uff08\u5411\u540e\u517c\u5bb9\uff09 - \u5185\u90e8\u589e\u52a0 <code>ConversationRepository</code> \u4f9d\u8d56 - \u589e\u52a0\u5185\u5b58\u7f13\u5b58\u5c42\uff08<code>Dict[str, Conversation]</code>\uff09 - \u5199\u64cd\u4f5c\uff1a\u540c\u65f6\u66f4\u65b0\u7f13\u5b58\u548c\u6570\u636e\u5e93 - \u8bfb\u64cd\u4f5c\uff1a\u4f18\u5148\u4ece\u7f13\u5b58\u8bfb\u53d6\uff0cmiss \u65f6\u4ece\u6570\u636e\u5e93\u52a0\u8f7d - \ud83c\udd95 \u901a\u8fc7\u6784\u9020\u51fd\u6570\u6ce8\u5165\u4f9d\u8d56\uff0c\u4e0d\u4f7f\u7528\u5168\u5c40\u5355\u4f8b</p> <p>\u7f13\u5b58\u7ba1\u7406\uff1a <pre><code>- \u6700\u5927\u7f13\u5b58 conversation \u6570\u91cf\uff1a100\uff08\u53ef\u914d\u7f6e\uff09\n- \u6dd8\u6c70\u7b56\u7565\uff1aLRU\n- \u63d0\u4f9b `load_conversation(conv_id)` \u65b9\u6cd5\u663e\u5f0f\u52a0\u8f7d\u5230\u7f13\u5b58\n- \u63d0\u4f9b `evict_conversation(conv_id)` \u65b9\u6cd5\u624b\u52a8\u6dd8\u6c70\n</code></pre></p>"},{"location":"_archive/frontend/01_persistence_design/#85-artifactmanager\u539f-artifactstore-\u6539\u9020","title":"8.5 ArtifactManager\uff08\u539f ArtifactStore \u6539\u9020\uff09","text":"<p>\u6539\u9020\u8981\u70b9\uff1a - \u4fdd\u6301\u73b0\u6709\u5de5\u5177\u8c03\u7528 API \u4e0d\u53d8 - \u5185\u90e8\u589e\u52a0 <code>ArtifactRepository</code> \u4f9d\u8d56 - \u589e\u52a0\u5185\u5b58\u7f13\u5b58\uff08\u5f53\u524d\u6d3b\u8dc3 session \u7684 artifacts\uff09 - <code>Artifact.update()</code> \u4e2d\u7684 diff-match-patch \u903b\u8f91\u4fdd\u6301\u4e0d\u53d8 - \u7248\u672c\u4fdd\u5b58\u65f6\u540c\u6b65\u5199\u5165\u6570\u636e\u5e93 - \ud83c\udd95 \u901a\u8fc7\u6784\u9020\u51fd\u6570\u6ce8\u5165\u4f9d\u8d56\uff0c\u4e0d\u4f7f\u7528\u5168\u5c40\u5355\u4f8b - \ud83c\udd95 \u66f4\u65b0\u64cd\u4f5c\u4f7f\u7528\u4e50\u89c2\u9501</p>"},{"location":"_archive/frontend/01_persistence_design/#9-\u5b9e\u65bd\u6b65\u9aa4","title":"9. \u5b9e\u65bd\u6b65\u9aa4","text":""},{"location":"_archive/frontend/01_persistence_design/#phase-1-\u57fa\u7840\u8bbe\u65bd\u9884\u8ba1-2-3-\u5929","title":"Phase 1: \u57fa\u7840\u8bbe\u65bd\uff08\u9884\u8ba1 2-3 \u5929\uff09","text":"<ol> <li>\u521b\u5efa <code>db/</code> \u6a21\u5757</li> <li>\u5b9e\u73b0 <code>DatabaseManager</code>\uff08\u542b WAL \u914d\u7f6e\uff09</li> <li>\u7f16\u5199 SQLAlchemy ORM \u6a21\u578b\uff08\u542b <code>lock_version</code> \u5b57\u6bb5\uff09</li> <li>\u7f16\u5199\u521d\u59cb\u5316 migration</li> <li> <p>\ud83c\udd95 \u914d\u7f6e AsyncSqliteSaver \u4e0e App DB \u5171\u4eab</p> </li> <li> <p>\u521b\u5efa <code>repositories/</code> \u6a21\u5757</p> </li> <li>\u5b9e\u73b0 <code>BaseRepository</code></li> <li>\u5b9e\u73b0 <code>ConversationRepository</code></li> <li> <p>\u5b9e\u73b0 <code>ArtifactRepository</code>\uff08\u542b\u4e50\u89c2\u9501\uff09</p> </li> <li> <p>\u7f16\u5199\u5355\u5143\u6d4b\u8bd5</p> </li> <li>Repository \u5c42\u7684 CRUD \u6d4b\u8bd5</li> <li>\u6811\u7ed3\u6784\u67e5\u8be2\u6d4b\u8bd5</li> <li>\ud83c\udd95 \u4e50\u89c2\u9501\u51b2\u7a81\u6d4b\u8bd5</li> </ol>"},{"location":"_archive/frontend/01_persistence_design/#phase-2-manager-\u5c42\u6539\u9020\u9884\u8ba1-2-3-\u5929","title":"Phase 2: Manager \u5c42\u6539\u9020\uff08\u9884\u8ba1 2-3 \u5929\uff09","text":"<ol> <li>\u5206\u79bb ConversationManager</li> <li>\u4ece <code>controller.py</code> \u79fb\u51fa\u5230\u72ec\u7acb\u6587\u4ef6</li> <li>\u6dfb\u52a0 Repository \u4f9d\u8d56\u6ce8\u5165</li> <li>\u5b9e\u73b0\u7f13\u5b58\u903b\u8f91</li> <li> <p>\ud83c\udd95 \u79fb\u9664\u5168\u5c40\u5355\u4f8b\u6a21\u5f0f</p> </li> <li> <p>\u6539\u9020 ArtifactStore \u2192 ArtifactManager</p> </li> <li>\u91cd\u6784\u4e3a\u4f7f\u7528 Repository</li> <li>\u4fdd\u6301 <code>Artifact</code> \u7c7b\u7684\u6838\u5fc3\u903b\u8f91\u4e0d\u53d8</li> <li>\u5b9e\u73b0\u7f13\u5b58\u903b\u8f91</li> <li>\ud83c\udd95 \u79fb\u9664\u5168\u5c40\u5355\u4f8b <code>_artifact_store</code></li> <li> <p>\ud83c\udd95 \u96c6\u6210\u4e50\u89c2\u9501</p> </li> <li> <p>\u66f4\u65b0\u4f9d\u8d56\u65b9</p> </li> <li><code>controller.py</code> \u4f7f\u7528\u65b0\u7684 ConversationManager</li> <li><code>graph.py</code> \u4f7f\u7528\u65b0\u7684 ArtifactManager</li> <li> <p>\ud83c\udd95 <code>graph.py</code> \u66ff\u6362 MemorySaver \u4e3a AsyncSqliteSaver</p> </li> <li> <p>\u96c6\u6210\u6d4b\u8bd5</p> </li> <li>\u8fd0\u884c\u73b0\u6709\u7684 <code>core_graph_test.py</code> \u786e\u4fdd\u529f\u80fd\u6b63\u5e38</li> <li>\u6dfb\u52a0\u6301\u4e45\u5316\u76f8\u5173\u7684\u6d4b\u8bd5\u7528\u4f8b</li> </ol>"},{"location":"_archive/frontend/01_persistence_design/#phase-3-\u4f18\u5316\u548c\u6e05\u7406\u9884\u8ba1-1-2-\u5929","title":"Phase 3: \u4f18\u5316\u548c\u6e05\u7406\uff08\u9884\u8ba1 1-2 \u5929\uff09","text":"<ol> <li>\u6027\u80fd\u4f18\u5316</li> <li>\u6dfb\u52a0\u6570\u636e\u5e93\u7d22\u5f15</li> <li> <p>\u4f18\u5316\u6279\u91cf\u67e5\u8be2</p> </li> <li> <p>\u914d\u7f6e\u5916\u90e8\u5316</p> </li> <li>\u6570\u636e\u5e93\u8def\u5f84\u914d\u7f6e</li> <li> <p>\u7f13\u5b58\u5927\u5c0f\u914d\u7f6e</p> </li> <li> <p>\u6e05\u7406\u5de5\u4f5c</p> </li> <li>\u79fb\u9664\u65e7\u7684\u5185\u5b58\u5b58\u50a8\u4ee3\u7801</li> <li>\u66f4\u65b0\u6587\u6863</li> </ol>"},{"location":"_archive/frontend/01_persistence_design/#10-\u540e\u7eed\u6269\u5c55\u9884\u7559","title":"10. \u540e\u7eed\u6269\u5c55\u9884\u7559","text":""},{"location":"_archive/frontend/01_persistence_design/#101-\u7528\u6237\u7cfb\u7edfphase-2","title":"10.1 \u7528\u6237\u7cfb\u7edf\uff08Phase 2\uff09","text":"<p>\u9884\u7559\u8bbe\u8ba1\uff1a - <code>conversations</code> \u8868\u7684 <code>user_id</code> \u5b57\u6bb5 - <code>artifact_sessions</code> \u8868\u6dfb\u52a0 <code>user_id</code> \u5b57\u6bb5 - Repository \u65b9\u6cd5\u652f\u6301 <code>user_id</code> \u8fc7\u6ee4</p> <p>\u8fc1\u79fb\u8def\u5f84\uff1a 1. \u6dfb\u52a0 <code>users</code> \u8868 2. \u4e3a\u73b0\u6709\u6570\u636e\u6dfb\u52a0\u9ed8\u8ba4 user_id 3. \u66f4\u65b0 Repository \u67e5\u8be2\u65b9\u6cd5 4. \u66f4\u65b0 Manager \u5c42\u4f20\u9012 user_id</p>"},{"location":"_archive/frontend/01_persistence_design/#102-postgresql-\u8fc1\u79fb","title":"10.2 PostgreSQL \u8fc1\u79fb","text":"<p>\u9884\u7559\u8bbe\u8ba1\uff1a - \u4f7f\u7528 SQLAlchemy ORM\uff08\u6570\u636e\u5e93\u65e0\u5173\uff09 - Repository \u5c42\u62bd\u8c61\u6570\u636e\u5e93\u64cd\u4f5c - \u4f7f\u7528 Alembic \u7ba1\u7406 migrations - \ud83c\udd95 ORM Only \u89c4\u8303\u786e\u4fdd\u8fc1\u79fb\u65e0\u75db</p> <p>\u8fc1\u79fb\u8def\u5f84\uff1a 1. \u4fee\u6539 <code>DatabaseManager</code> \u8fde\u63a5\u5b57\u7b26\u4e32 2. \u8fd0\u884c migration 3. \u6570\u636e\u8fc1\u79fb\u811a\u672c</p>"},{"location":"_archive/frontend/01_persistence_design/#11-\u6ce8\u610f\u4e8b\u9879","title":"11. \u6ce8\u610f\u4e8b\u9879","text":""},{"location":"_archive/frontend/01_persistence_design/#111-\u5e76\u53d1\u5b89\u5168","title":"11.1 \u5e76\u53d1\u5b89\u5168","text":"<ul> <li>SQLite \u5728\u5199\u5165\u65f6\u6709\u9501\uff0c\u9700\u8981\u6ce8\u610f\u5e76\u53d1\u573a\u666f</li> <li>\u5efa\u8bae\u4f7f\u7528 WAL \u6a21\u5f0f\u63d0\u9ad8\u5e76\u53d1\u6027\u80fd</li> <li>\ud83c\udd95 \u4f7f\u7528\u4e50\u89c2\u9501\u5904\u7406 Artifact \u5e76\u53d1\u66f4\u65b0</li> <li>\u5bf9\u4e8e\u9ad8\u5e76\u53d1\u573a\u666f\uff0c\u8003\u8651\u76f4\u63a5\u4f7f\u7528 PostgreSQL</li> </ul>"},{"location":"_archive/frontend/01_persistence_design/#112-\u6570\u636e\u4e00\u81f4\u6027","title":"11.2 \u6570\u636e\u4e00\u81f4\u6027","text":"<ul> <li>\u7f13\u5b58\u548c\u6570\u636e\u5e93\u53ef\u80fd\u51fa\u73b0\u4e0d\u4e00\u81f4</li> <li>\u5173\u952e\u5199\u64cd\u4f5c\u4f7f\u7528\u4e8b\u52a1</li> <li>\u63d0\u4f9b\u5f3a\u5236\u5237\u65b0\u7f13\u5b58\u7684\u63a5\u53e3</li> <li>\ud83c\udd95 App DB \u662f\u771f\u76f8\u6765\u6e90\uff0cLangGraph Checkpointer \u4ec5\u7528\u4e8e\u6267\u884c</li> </ul>"},{"location":"_archive/frontend/01_persistence_design/#113-\u5411\u540e\u517c\u5bb9","title":"11.3 \u5411\u540e\u517c\u5bb9","text":"<ul> <li>\u6240\u6709 public API \u4fdd\u6301\u4e0d\u53d8</li> <li>\u73b0\u6709\u6d4b\u8bd5\u5e94\u8be5\u5168\u90e8\u901a\u8fc7</li> <li>\u901a\u8fc7\u4f9d\u8d56\u6ce8\u5165\u652f\u6301\u6d4b\u8bd5\u65f6\u4f7f\u7528\u5185\u5b58\u6570\u636e\u5e93</li> </ul>"},{"location":"_archive/frontend/01_persistence_design/#12-\u4f9d\u8d56\u6e05\u5355","title":"12. \u4f9d\u8d56\u6e05\u5355","text":"<pre><code># \u65b0\u589e\u4f9d\u8d56\nsqlalchemy&gt;=2.0.0\naiosqlite&gt;=0.19.0\nalembic&gt;=1.12.0  # \u53ef\u9009\uff1a\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u7684\u6570\u636e\u5e93\u8fc1\u79fb\u7ba1\u7406\nlanggraph-checkpoint-sqlite&gt;=1.0.0  # \ud83c\udd95 LangGraph SQLite Checkpointer\n</code></pre>"},{"location":"_archive/frontend/01_persistence_design/#\u9644\u5f55\u67b6\u6784\u6f14\u8fdb\u8def\u7ebf\u56fe","title":"\u9644\u5f55\uff1a\u67b6\u6784\u6f14\u8fdb\u8def\u7ebf\u56fe","text":"<ol> <li>Phase 1 (\u5f53\u524d\u76ee\u6807)\uff1a\u5355\u673a Docker + SQLite</li> <li>\u5b9e\u73b0\u53cc\u5c42\u5b58\u50a8\uff0c\u786e\u4fdd\u6570\u636e\u4e0d\u4e22\u5931</li> <li>\u5b9e\u73b0\u4e50\u89c2\u9501\uff0c\u786e\u4fdd Artifact \u6570\u636e\u4e00\u81f4</li> <li> <p>\u4ee3\u7801\u5168\u5f02\u6b65\u5316\uff0c\u4f7f\u7528\u4f9d\u8d56\u6ce8\u5165</p> </li> <li> <p>Phase 2 (\u5c11\u91cf\u5e76\u53d1)\uff1a\u5206\u79bb\u6570\u636e\u5e93</p> </li> <li>SQLite \u2192 PostgreSQL \u5bb9\u5668</li> <li> <p>\u5229\u7528 ORM \u4f18\u52bf\u5e73\u6ed1\u8fc1\u79fb</p> </li> <li> <p>Phase 3 (\u751f\u4ea7\u5e76\u53d1)\uff1a\u6c34\u5e73\u6269\u5c55</p> </li> <li>Nginx \u8d1f\u8f7d\u5747\u8861 + \u591a\u5b9e\u4f8b API \u5bb9\u5668</li> <li>\u5f15\u5165 Redis \u505a\u5206\u5e03\u5f0f\u7f13\u5b58\u548c\u9501</li> </ol>"},{"location":"_archive/frontend/02_api_design/","title":"ArtifactFlow API \u5c42\u5b9e\u73b0\u65b9\u6848","text":"<p>\u7248\u672c: v1.5 | \u4f9d\u8d56: \u6301\u4e45\u5316\u6539\u9020\u5b8c\u6210</p> <p>v1.5 \u66f4\u65b0\uff1a - \u65b0\u589e Section 4.4\uff1a\u7edf\u4e00\u7684 StreamEventType \u4e8b\u4ef6\u7c7b\u578b\u8bbe\u8ba1 - \u65b0\u589e Section 4.5\uff1aExecutionMetrics \u53ef\u89c2\u6d4b\u6027\u6307\u6807\u8bbe\u8ba1 - \u66f4\u65b0 Section 4.3\uff1a\u6d41\u5f0f\u63a5\u53e3\u4e8b\u4ef6\u683c\u5f0f\u66f4\u65b0</p> <p>v1.4 \u66f4\u65b0\uff1a - \u66f4\u65b0 Section 6.2\uff1aCheckpointer \u4ece MemorySaver \u6539\u4e3a AsyncSqliteSaver - \u66f4\u65b0 Section 6.5\uff1a\u5e76\u53d1\u5b89\u5168\u8868\u66f4\u65b0 Checkpointer \u8bf4\u660e - <code>create_multi_agent_graph</code> \u6539\u4e3a async \u51fd\u6570</p> <p>v1.3 \u66f4\u65b0\uff1a - \u66f4\u65b0 Section 4.1\uff1aResume \u63a5\u53e3\u6539\u4e3a\u65e0\u72b6\u6001\u8bbe\u8ba1\uff08\u9700\u8981\u4f20\u5165 <code>message_id</code>\uff09</p> <p>v1.2 \u66f4\u65b0\uff1a - \u65b0\u589e Section 6.5\uff1a\u6570\u636e\u5e93\u4f1a\u8bdd\u4e0e\u4e8b\u52a1\u7ba1\u7406\uff08\u5e76\u53d1\u5b89\u5168\u8bbe\u8ba1\uff09 - \u66f4\u65b0 Section 6.2\uff1a\u5b8c\u6574\u7684\u4f9d\u8d56\u6ce8\u5165\u793a\u4f8b\uff08\u542b\u8bf7\u6c42\u7ea7\u522b session \u9694\u79bb\uff09</p> <p>v1.1 \u66f4\u65b0\uff1a - \u65b0\u589e Section 2.1\uff1a\u5168\u94fe\u8def\u5f02\u6b65 I/O \u5f00\u53d1\u6807\u51c6 - \u65b0\u589e Section 6.4\uff1a\u4e8b\u4ef6\u7f13\u51b2\u961f\u5217\u8bbe\u8ba1\uff08\u542b TTL \u673a\u5236\uff09 - \u66f4\u65b0 Section 7.2\uff1a\u660e\u786e SSE \u8fde\u63a5\u751f\u547d\u5468\u671f\u7ba1\u7406</p>"},{"location":"_archive/frontend/02_api_design/#1-\u8bbe\u8ba1\u76ee\u6807","title":"1. \u8bbe\u8ba1\u76ee\u6807","text":"<p>\u4e3a\u524d\u7aef\u63d0\u4f9b\u5b8c\u6574\u7684 API \u63a5\u53e3\uff0c\u652f\u6301\uff1a</p> <ol> <li>\u6d41\u5f0f\u8f93\u51fa\uff1a\u5b9e\u65f6\u63a8\u9001 Agent \u6267\u884c\u8fc7\u7a0b\uff08LLM \u8f93\u51fa\u3001\u5de5\u5177\u8c03\u7528\u3001\u6743\u9650\u8bf7\u6c42\uff09</li> <li>CRUD \u64cd\u4f5c\uff1a\u5bf9\u8bdd\u7ba1\u7406\u3001Artifact \u7ba1\u7406</li> <li>\u72b6\u6001\u540c\u6b65\uff1aArtifact \u7248\u672c\u83b7\u53d6\u3001\u5bf9\u8bdd\u6811\u67e5\u8be2</li> <li>\u6269\u5c55\u9884\u7559\uff1a\u7528\u6237\u8ba4\u8bc1\u63a5\u53e3\u9884\u7559</li> </ol>"},{"location":"_archive/frontend/02_api_design/#2-\u6280\u672f\u9009\u578b","title":"2. \u6280\u672f\u9009\u578b","text":"\u7ec4\u4ef6 \u9009\u578b \u7406\u7531 Web \u6846\u67b6 FastAPI \u539f\u751f\u5f02\u6b65\u3001\u81ea\u52a8 OpenAPI \u6587\u6863\u3001\u7c7b\u578b\u5b89\u5168 \u6d41\u5f0f\u4f20\u8f93 SSE (Server-Sent Events) \u5355\u5411\u63a8\u9001\u8db3\u591f\u3001\u6bd4 WebSocket \u7b80\u5355\u3001\u81ea\u52a8\u91cd\u8fde \u5e8f\u5217\u5316 Pydantic v2 \u4e0e FastAPI \u6df1\u5ea6\u96c6\u6210\u3001\u6027\u80fd\u4f18\u79c0 CORS fastapi.middleware.cors \u652f\u6301\u524d\u7aef\u8de8\u57df\u8bbf\u95ee <p>\u4e3a\u4ec0\u4e48\u9009 SSE \u800c\u4e0d\u662f WebSocket\uff1a - \u5f53\u524d\u9700\u6c42\u662f\u5355\u5411\u63a8\u9001\uff08Server \u2192 Client\uff09 - SSE \u66f4\u8f7b\u91cf\uff0c\u81ea\u5e26\u91cd\u8fde\u673a\u5236 - \u6d4f\u89c8\u5668\u539f\u751f\u652f\u6301 EventSource API - \u5982\u679c\u540e\u7eed\u9700\u8981\u53cc\u5411\u901a\u4fe1\uff08\u5982\u534f\u4f5c\u7f16\u8f91\uff09\uff0c\u518d\u5f15\u5165 WebSocket</p>"},{"location":"_archive/frontend/02_api_design/#21-\u5168\u94fe\u8def\u5f02\u6b65-io-\u5f00\u53d1\u6807\u51c6-","title":"2.1 \u5168\u94fe\u8def\u5f02\u6b65 I/O \u5f00\u53d1\u6807\u51c6 \ud83c\udd95","text":"<p>\u6838\u5fc3\u539f\u5219\uff1a\u9632\u6b62\u5355\u4e2a\u8017\u65f6\u64cd\u4f5c\uff08\u5982 LLM \u63a8\u7406\u3001\u7f51\u9875\u722c\u53d6\uff09\u963b\u585e Worker \u8fdb\u7a0b\uff0c\u5bfc\u81f4\u9ad8\u5e76\u53d1\u4e0b\u7cfb\u7edf\u5047\u6b7b\u3002</p> <p>\u5f3a\u5236\u8981\u6c42\uff1a</p> \u64cd\u4f5c\u7c7b\u578b \u2705 \u5fc5\u987b\u4f7f\u7528 \u274c \u7981\u6b62\u4f7f\u7528 HTTP \u8bf7\u6c42 <code>httpx.AsyncClient</code> <code>requests</code> \u6570\u636e\u5e93 <code>aiosqlite</code> / <code>asyncpg</code> <code>sqlite3</code> / <code>psycopg2</code> \u6587\u4ef6\u64cd\u4f5c <code>aiofiles</code> \u5185\u7f6e <code>open()</code> (\u5927\u6587\u4ef6) \u8fdb\u7a0b/\u7ebf\u7a0b <code>asyncio.to_thread()</code> <code>threading.Thread</code> \u76f4\u63a5\u8c03\u7528 <p>\u4ee3\u7801\u793a\u4f8b\uff1a</p> <pre><code># \u2705 \u6b63\u786e\uff1a\u5f02\u6b65 HTTP \u8bf7\u6c42\nasync def fetch_external_api():\n    async with httpx.AsyncClient() as client:\n        response = await client.get(\"https://api.example.com/data\")\n        return response.json()\n\n# \u274c \u9519\u8bef\uff1a\u540c\u6b65\u963b\u585e\ndef fetch_external_api_wrong():\n    response = requests.get(\"https://api.example.com/data\")  # \u4f1a\u963b\u585e\u6574\u4e2a Worker\n    return response.json()\n\n# \u2705 \u6b63\u786e\uff1aCPU \u5bc6\u96c6\u578b\u4efb\u52a1\u5305\u88c5\nasync def cpu_intensive_task(data):\n    result = await asyncio.to_thread(heavy_computation, data)\n    return result\n</code></pre> <p>Lint \u68c0\u67e5\u5efa\u8bae\uff1a - \u5728 CI \u4e2d\u6dfb\u52a0 <code>flake8-async</code> \u6216\u81ea\u5b9a\u4e49\u89c4\u5219\uff0c\u68c0\u6d4b\u540c\u6b65\u963b\u585e\u8c03\u7528</p>"},{"location":"_archive/frontend/02_api_design/#3-api-\u67b6\u6784\u8bbe\u8ba1","title":"3. API \u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"_archive/frontend/02_api_design/#31-\u6574\u4f53\u67b6\u6784","title":"3.1 \u6574\u4f53\u67b6\u6784","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Frontend                              \u2502\n\u2502                   (Next.js Application)                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u2502               \u2502               \u2502\n              \u25bc               \u25bc               \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502   SSE   \u2502    \u2502  REST API \u2502    \u2502  (\u9884\u7559)  \u2502\n        \u2502 /stream \u2502    \u2502  /api/v1  \u2502    \u2502  Auth   \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n              \u2502               \u2502               \u2502\n              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      API Layer (FastAPI)                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502   Routers   \u2502  \u2502   Schemas   \u2502  \u2502    Dependencies     \u2502 \u2502\n\u2502  \u2502 - chat      \u2502  \u2502 - request   \u2502  \u2502 - get_controller    \u2502 \u2502\n\u2502  \u2502 - artifact  \u2502  \u2502 - response  \u2502  \u2502 - get_artifact_mgr  \u2502 \u2502\n\u2502  \u2502 - stream    \u2502  \u2502 - event     \u2502  \u2502 - (get_current_user)\u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502              StreamManager (\u65b0\u589e)                    \u2502   \u2502\n\u2502  \u2502  - \u4e8b\u4ef6\u7f13\u51b2\u961f\u5217 (asyncio.Queue)                      \u2502   \u2502\n\u2502  \u2502  - TTL \u7ba1\u7406 (\u9632\u6b62\u5185\u5b58\u6cc4\u6f0f)                           \u2502   \u2502\n\u2502  \u2502  - \u8fde\u63a5\u72b6\u6001\u8ffd\u8e2a                                      \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      Core Layer (\u73b0\u6709)                       \u2502\n\u2502         ExecutionController, ArtifactManager, etc.          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/frontend/02_api_design/#32-url-\u7ed3\u6784\u8bbe\u8ba1","title":"3.2 URL \u7ed3\u6784\u8bbe\u8ba1","text":"<pre><code>/api/v1/\n\u251c\u2500\u2500 chat/                           # \u5bf9\u8bdd\u76f8\u5173\n\u2502   \u251c\u2500\u2500 POST   /                    # \u53d1\u9001\u6d88\u606f\uff08\u8fd4\u56de stream URL\uff09\n\u2502   \u251c\u2500\u2500 GET    /                    # \u5217\u51fa\u6240\u6709\u5bf9\u8bdd\n\u2502   \u251c\u2500\u2500 GET    /{conv_id}           # \u83b7\u53d6\u5bf9\u8bdd\u8be6\u60c5\uff08\u542b\u6d88\u606f\u6811\uff09\n\u2502   \u251c\u2500\u2500 DELETE /{conv_id}           # \u5220\u9664\u5bf9\u8bdd\n\u2502   \u2514\u2500\u2500 POST   /{conv_id}/resume    # \u6062\u590d\u4e2d\u65ad\u7684\u6267\u884c\n\u2502\n\u251c\u2500\u2500 artifacts/                      # Artifact \u76f8\u5173\n\u2502   \u251c\u2500\u2500 GET    /{session_id}        # \u5217\u51fa session \u4e0b\u6240\u6709 artifacts\n\u2502   \u251c\u2500\u2500 GET    /{session_id}/{artifact_id}           # \u83b7\u53d6 artifact \u8be6\u60c5\n\u2502   \u251c\u2500\u2500 GET    /{session_id}/{artifact_id}/versions  # \u83b7\u53d6\u7248\u672c\u5217\u8868\n\u2502   \u251c\u2500\u2500 GET    /{session_id}/{artifact_id}/versions/{version}  # \u83b7\u53d6\u7279\u5b9a\u7248\u672c\n\u2502   \u2514\u2500\u2500 GET    /{session_id}/{artifact_id}/diff      # \u83b7\u53d6\u7248\u672c\u95f4\u5dee\u5f02\uff08\u53ef\u9009\uff09\n\u2502\n\u2514\u2500\u2500 stream/                         # \u6d41\u5f0f\u8f93\u51fa\n    \u2514\u2500\u2500 GET    /{thread_id}         # SSE \u7aef\u70b9\uff0c\u8ba2\u9605\u6267\u884c\u8fc7\u7a0b\n</code></pre>"},{"location":"_archive/frontend/02_api_design/#4-\u63a5\u53e3\u8be6\u7ec6\u8bbe\u8ba1","title":"4. \u63a5\u53e3\u8be6\u7ec6\u8bbe\u8ba1","text":""},{"location":"_archive/frontend/02_api_design/#41-\u5bf9\u8bdd\u63a5\u53e3","title":"4.1 \u5bf9\u8bdd\u63a5\u53e3","text":""},{"location":"_archive/frontend/02_api_design/#post-apiv1chat","title":"POST /api/v1/chat","text":"<p>\u53d1\u9001\u65b0\u6d88\u606f\uff0c\u542f\u52a8 Graph \u6267\u884c\u3002</p> <p>Request Body: <pre><code>{\n  \"content\": \"string\",                    // \u7528\u6237\u6d88\u606f\n  \"conversation_id\": \"string | null\",     // \u53ef\u9009\uff1a\u7ee7\u7eed\u73b0\u6709\u5bf9\u8bdd\n  \"parent_message_id\": \"string | null\"    // \u53ef\u9009\uff1a\u5206\u652f\u5bf9\u8bdd\u7684\u7236\u6d88\u606f\n}\n</code></pre></p> <p>Response: <pre><code>{\n  \"conversation_id\": \"conv-xxx\",\n  \"message_id\": \"msg-xxx\",\n  \"thread_id\": \"thd-xxx\",\n  \"stream_url\": \"/api/v1/stream/thd-xxx\"  // \u524d\u7aef\u8ba2\u9605\u6b64 URL \u83b7\u53d6\u6d41\u5f0f\u8f93\u51fa\n}\n</code></pre></p> <p>\u8bbe\u8ba1\u8981\u70b9\uff1a - \u4e0d\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c\uff0c\u800c\u662f\u8fd4\u56de <code>stream_url</code> - \u524d\u7aef\u901a\u8fc7 SSE \u8ba2\u9605\u83b7\u53d6\u5b9e\u65f6\u66f4\u65b0 - \u652f\u6301\u4e50\u89c2 UI\uff08\u5148\u663e\u793a\u7528\u6237\u6d88\u606f\uff0c\u518d\u7b49\u5f85\u54cd\u5e94\uff09</p>"},{"location":"_archive/frontend/02_api_design/#post-apiv1chatconv_idresume","title":"POST /api/v1/chat/{conv_id}/resume","text":"<p>\u6062\u590d\u4e2d\u65ad\u7684\u6267\u884c\uff08\u6743\u9650\u786e\u8ba4\u540e\uff09\u3002</p> <p>Request Body: <pre><code>{\n  \"thread_id\": \"thd-xxx\",\n  \"message_id\": \"msg-xxx\",\n  \"approved\": true\n}\n</code></pre></p> <p>Response: <pre><code>{\n  \"stream_url\": \"/api/v1/stream/thd-xxx\"  // \u65b0\u7684 stream URL\n}\n</code></pre></p> <p>\u91cd\u8981\u8bf4\u660e\uff1a - \u5fc5\u987b\u53c2\u6570\uff1a<code>thread_id</code>\u3001<code>message_id</code>\u3001<code>approved</code>\uff08\u8fd9\u4e09\u4e2a\u53c2\u6570\u90fd\u53ef\u4ee5\u4ece\u4e2d\u65ad\u4e8b\u4ef6\u7684\u8fd4\u56de\u6570\u636e\u4e2d\u83b7\u53d6\uff09 - \u65e0\u72b6\u6001\u8bbe\u8ba1\uff1aController \u4e0d\u4fdd\u5b58\u4e2d\u65ad\u72b6\u6001\uff0cresume \u65f6\u5fc5\u987b\u4f20\u5165\u5b8c\u6574\u53c2\u6570 - \u6bcf\u6b21 resume \u8fd4\u56de\u7684 <code>stream_url</code> \u53ef\u80fd\u76f8\u540c\uff0c\u4f46\u524d\u7aef\u5e94\u9500\u6bc1\u65e7\u7684 EventSource \u5b9e\u4f8b\u540e\u518d\u5efa\u7acb\u65b0\u8fde\u63a5 - \u8fd9\u786e\u4fdd\u4e86\u8fde\u63a5\u72b6\u6001\u7684\u5e72\u51c0\u5207\u6362</p>"},{"location":"_archive/frontend/02_api_design/#get-apiv1chat","title":"GET /api/v1/chat","text":"<p>\u5217\u51fa\u5bf9\u8bdd\u5217\u8868\u3002</p> <p>Query Parameters: - <code>limit</code>: \u6570\u91cf\u9650\u5236\uff08\u9ed8\u8ba4 20\uff09 - <code>offset</code>: \u504f\u79fb\u91cf\uff08\u5206\u9875\uff09 - <code>user_id</code>: \u9884\u7559\uff0c\u7528\u6237 ID \u8fc7\u6ee4</p> <p>Response: <pre><code>{\n  \"conversations\": [\n    {\n      \"id\": \"conv-xxx\",\n      \"title\": \"\u5173\u4e8e\u91cf\u5b50\u8ba1\u7b97\u7684\u8ba8\u8bba\",\n      \"message_count\": 5,\n      \"created_at\": \"2024-01-01T00:00:00Z\",\n      \"updated_at\": \"2024-01-01T01:00:00Z\"\n    }\n  ],\n  \"total\": 100,\n  \"has_more\": true\n}\n</code></pre></p>"},{"location":"_archive/frontend/02_api_design/#get-apiv1chatconv_id","title":"GET /api/v1/chat/{conv_id}","text":"<p>\u83b7\u53d6\u5bf9\u8bdd\u8be6\u60c5\uff0c\u5305\u542b\u5b8c\u6574\u7684\u6d88\u606f\u6811\u3002</p> <p>Response: <pre><code>{\n  \"id\": \"conv-xxx\",\n  \"title\": \"\u5173\u4e8e\u91cf\u5b50\u8ba1\u7b97\u7684\u8ba8\u8bba\",\n  \"active_branch\": \"msg-latest\",\n  \"messages\": [\n    {\n      \"id\": \"msg-1\",\n      \"parent_id\": null,\n      \"content\": \"\u4ec0\u4e48\u662f\u91cf\u5b50\u8ba1\u7b97\uff1f\",\n      \"response\": \"\u91cf\u5b50\u8ba1\u7b97\u662f...\",\n      \"created_at\": \"...\",\n      \"children\": [\"msg-2\", \"msg-3\"]  // \u5b50\u6d88\u606f ID \u5217\u8868\uff08\u7528\u4e8e\u6e32\u67d3\u6811\uff09\n    }\n  ],\n  \"session_id\": \"sess-conv-xxx\",  // \u5173\u8054\u7684 artifact session\n  \"created_at\": \"...\",\n  \"updated_at\": \"...\"\n}\n</code></pre></p> <p>\u8bbe\u8ba1\u8981\u70b9\uff1a - <code>messages</code> \u662f\u6241\u5e73\u6570\u7ec4\uff0c\u901a\u8fc7 <code>parent_id</code> \u548c <code>children</code> \u8868\u8fbe\u6811\u7ed3\u6784 - \u524d\u7aef\u53ef\u4ee5\u9009\u62e9\u53ea\u6e32\u67d3\u5f53\u524d\u5206\u652f\u8def\u5f84\uff0c\u6216\u5c55\u793a\u5b8c\u6574\u6811</p>"},{"location":"_archive/frontend/02_api_design/#42-artifact-\u63a5\u53e3","title":"4.2 Artifact \u63a5\u53e3","text":""},{"location":"_archive/frontend/02_api_design/#get-apiv1artifactssession_id","title":"GET /api/v1/artifacts/{session_id}","text":"<p>\u5217\u51fa session \u4e0b\u6240\u6709 artifacts\u3002</p> <p>Response: <pre><code>{\n  \"session_id\": \"sess-xxx\",\n  \"artifacts\": [\n    {\n      \"id\": \"research_report\",\n      \"content_type\": \"markdown\",\n      \"title\": \"AI Research Report\",\n      \"current_version\": 3,\n      \"created_at\": \"...\",\n      \"updated_at\": \"...\"\n    }\n  ]\n}\n</code></pre></p>"},{"location":"_archive/frontend/02_api_design/#get-apiv1artifactssession_idartifact_id","title":"GET /api/v1/artifacts/{session_id}/{artifact_id}","text":"<p>\u83b7\u53d6 artifact \u8be6\u60c5\uff08\u5305\u542b\u5f53\u524d\u7248\u672c\u5185\u5bb9\uff09\u3002</p> <p>Response: <pre><code>{\n  \"id\": \"research_report\",\n  \"session_id\": \"sess-xxx\",\n  \"content_type\": \"markdown\",\n  \"title\": \"AI Research Report\",\n  \"content\": \"# Report\\n\\n...\",  // \u5f53\u524d\u7248\u672c\u5185\u5bb9\n  \"current_version\": 3,\n  \"created_at\": \"...\",\n  \"updated_at\": \"...\"\n}\n</code></pre></p>"},{"location":"_archive/frontend/02_api_design/#get-apiv1artifactssession_idartifact_idversions","title":"GET /api/v1/artifacts/{session_id}/{artifact_id}/versions","text":"<p>\u83b7\u53d6\u7248\u672c\u5386\u53f2\u5217\u8868\u3002</p> <p>Response: <pre><code>{\n  \"versions\": [\n    {\n      \"version\": 1,\n      \"update_type\": \"create\",\n      \"created_at\": \"...\"\n    },\n    {\n      \"version\": 2,\n      \"update_type\": \"update\",\n      \"created_at\": \"...\"\n    }\n  ]\n}\n</code></pre></p>"},{"location":"_archive/frontend/02_api_design/#get-apiv1artifactssession_idartifact_idversionsversion","title":"GET /api/v1/artifacts/{session_id}/{artifact_id}/versions/{version}","text":"<p>\u83b7\u53d6\u7279\u5b9a\u7248\u672c\u7684\u5b8c\u6574\u5185\u5bb9\u3002</p> <p>Response: <pre><code>{\n  \"version\": 2,\n  \"content\": \"...\",\n  \"update_type\": \"update\",\n  \"changes\": [[\"old text\", \"new text\"]],  // \u5982\u679c\u6709\u8bb0\u5f55\n  \"created_at\": \"...\"\n}\n</code></pre></p>"},{"location":"_archive/frontend/02_api_design/#43-\u6d41\u5f0f\u63a5\u53e3sse","title":"4.3 \u6d41\u5f0f\u63a5\u53e3\uff08SSE\uff09","text":""},{"location":"_archive/frontend/02_api_design/#get-apiv1streamthread_id","title":"GET /api/v1/stream/{thread_id}","text":"<p>SSE \u7aef\u70b9\uff0c\u63a8\u9001 Graph \u6267\u884c\u8fc7\u7a0b\u3002</p> <p>Event Format\uff08\u7edf\u4e00\u683c\u5f0f\uff09:</p> <p>\u6240\u6709\u4e8b\u4ef6\u4f7f\u7528\u7edf\u4e00\u7684 <code>StreamEventType</code> \u683c\u5f0f\uff1a</p> <pre><code>{\n  \"type\": \"agent_start | llm_chunk | llm_complete | agent_complete | tool_start | tool_complete | permission_request | permission_result | metadata | complete | error\",\n  \"timestamp\": \"2024-01-19T10:00:00.000Z\",\n  \"agent\": \"lead_agent\",       // \u53ef\u9009\uff0cagent \u76f8\u5173\u4e8b\u4ef6\n  \"tool\": \"web_search\",        // \u53ef\u9009\uff0ctool \u76f8\u5173\u4e8b\u4ef6\n  \"data\": {...}                // \u4e8b\u4ef6\u6570\u636e\n}\n</code></pre> <p>\u5b8c\u6574\u4e8b\u4ef6\u6d41\u793a\u4f8b:</p> <pre><code>// 1. \u4f1a\u8bdd\u5f00\u59cb\uff08Controller \u5c42\uff09\ndata: {\"type\": \"metadata\", \"timestamp\": \"...\", \"data\": {\"conversation_id\": \"conv-xxx\", \"message_id\": \"msg-xxx\", \"thread_id\": \"thd-xxx\"}}\n\n// 2. Agent \u5f00\u59cb\u6267\u884c\uff08Agent \u5c42\uff09\ndata: {\"type\": \"agent_start\", \"timestamp\": \"...\", \"agent\": \"lead_agent\", \"data\": {...}}\n\n// 3. LLM \u6d41\u5f0f\u8f93\u51fa\uff08Agent \u5c42\uff09\ndata: {\"type\": \"llm_chunk\", \"timestamp\": \"...\", \"agent\": \"lead_agent\", \"data\": {\"content\": \"\u6211\u9700\u8981\", \"reasoning_content\": \"...\"}}\ndata: {\"type\": \"llm_chunk\", \"timestamp\": \"...\", \"agent\": \"lead_agent\", \"data\": {\"content\": \"\u6211\u9700\u8981\u641c\u7d22\", \"reasoning_content\": \"...\"}}\n\n// 4. LLM \u5b8c\u6210\uff08Agent \u5c42\uff09\ndata: {\"type\": \"llm_complete\", \"timestamp\": \"...\", \"agent\": \"lead_agent\", \"data\": {\"token_usage\": {\"input_tokens\": 100, \"output_tokens\": 50}}}\n\n// 5. Agent \u5b8c\u6210\uff08\u53ef\u80fd\u5e26 routing\uff09\uff08Agent \u5c42\uff09\ndata: {\"type\": \"agent_complete\", \"timestamp\": \"...\", \"agent\": \"lead_agent\", \"data\": {\"routing\": {\"type\": \"subagent\", \"target\": \"search_agent\"}}}\n\n// 6. \u5de5\u5177\u5f00\u59cb\u6267\u884c\uff08Graph \u5c42\uff09\ndata: {\"type\": \"tool_start\", \"timestamp\": \"...\", \"agent\": \"search_agent\", \"tool\": \"web_search\", \"data\": {\"params\": {...}}}\n\n// 7. \u5de5\u5177\u6267\u884c\u5b8c\u6210\uff08Graph \u5c42\uff09\ndata: {\"type\": \"tool_complete\", \"timestamp\": \"...\", \"agent\": \"search_agent\", \"tool\": \"web_search\", \"data\": {\"success\": true, \"duration_ms\": 450}}\n\n// 8. \u6743\u9650\u8bf7\u6c42\uff08Graph \u5c42\uff0c\u5982\u679c\u9700\u8981\uff09\ndata: {\"type\": \"permission_request\", \"timestamp\": \"...\", \"agent\": \"crawl_agent\", \"tool\": \"web_fetch\", \"data\": {\"permission_level\": \"confirm\", \"params\": {...}}}\n\n// 9. \u6700\u7ec8\u5b8c\u6210\uff08Controller \u5c42\uff0c\u5305\u542b execution_metrics\uff09\ndata: {\"type\": \"complete\", \"timestamp\": \"...\", \"data\": {\"success\": true, \"interrupted\": false, \"response\": \"...\", \"execution_metrics\": {...}}}\n</code></pre> <p>\ud83c\udd95 SSE \u8fde\u63a5\u751f\u547d\u5468\u671f\uff1a</p> \u4e8b\u4ef6\u7c7b\u578b \u8fde\u63a5\u72b6\u6001 \u4ea7\u751f\u4f4d\u7f6e \u8bf4\u660e <code>metadata</code> \u4fdd\u6301 Controller \u9996\u4e2a\u4e8b\u4ef6\uff0c\u786e\u8ba4\u8fde\u63a5\u6210\u529f <code>agent_start</code> \u4fdd\u6301 Agent Agent \u5f00\u59cb\u6267\u884c <code>llm_chunk</code> \u4fdd\u6301 Agent LLM \u6d41\u5f0f\u8f93\u51fa <code>llm_complete</code> \u4fdd\u6301 Agent LLM \u5355\u6b21\u8c03\u7528\u5b8c\u6210 <code>agent_complete</code> \u4fdd\u6301 Agent Agent \u672c\u8f6e\u5b8c\u6210\uff08\u53ef\u80fd\u5e26 routing\uff09 <code>tool_start</code> \u4fdd\u6301 Graph \u5de5\u5177\u5f00\u59cb\u6267\u884c <code>tool_complete</code> \u4fdd\u6301 Graph \u5de5\u5177\u6267\u884c\u5b8c\u6210 <code>permission_request</code> \u4fdd\u6301 Graph \u8bf7\u6c42\u6743\u9650\u786e\u8ba4 <code>permission_result</code> \u4fdd\u6301 Graph \u6743\u9650\u786e\u8ba4\u7ed3\u679c <code>complete</code> \u5173\u95ed Controller \u6b63\u5e38\u5b8c\u6210/\u4e2d\u65ad\uff0c\u670d\u52a1\u7aef\u4e3b\u52a8\u5173\u95ed\u8fde\u63a5 <code>error</code> \u5173\u95ed Controller \u53d1\u751f\u9519\u8bef\uff0c\u670d\u52a1\u7aef\u4e3b\u52a8\u5173\u95ed\u8fde\u63a5 <p>\u8bbe\u8ba1\u8981\u70b9\uff1a - \u4f7f\u7528\u7edf\u4e00\u7684 <code>StreamEventType</code>\uff0c\u5404\u5c42\uff08Agent/Graph/Controller\uff09\u5171\u7528 - \u4e8b\u4ef6\u76f4\u63a5\u900f\u4f20\uff0c\u4e0d\u518d\u5305\u88c5\u4e3a <code>stream</code> \u4e8b\u4ef6 - <code>complete</code> / <code>error</code> \u4e8b\u4ef6\u540e\uff0c\u670d\u52a1\u7aef\u4e3b\u52a8\u5173\u95ed SSE \u8fde\u63a5 - <code>complete</code> \u4e8b\u4ef6\u5305\u542b\u5b8c\u6574\u7684 <code>execution_metrics</code> \u53ef\u89c2\u6d4b\u6027\u6570\u636e</p>"},{"location":"_archive/frontend/02_api_design/#44-\u7edf\u4e00\u4e8b\u4ef6\u7c7b\u578bstreameventtype","title":"4.4 \u7edf\u4e00\u4e8b\u4ef6\u7c7b\u578b\uff08StreamEventType\uff09\ud83c\udd95","text":"<p>\u6240\u6709\u5c42\u4f7f\u7528\u7edf\u4e00\u7684\u4e8b\u4ef6\u7c7b\u578b\u679a\u4e3e\uff1a</p> <pre><code>class StreamEventType(Enum):\n    \"\"\"\n    \u7edf\u4e00\u7684\u6267\u884c\u4e8b\u4ef6\u7c7b\u578b\n\n    \u4ea7\u751f\u4f4d\u7f6e\uff1a\n    - [Controller] \u4f1a\u8bdd\u7ea7\u522b\u5143\u6570\u636e\u548c\u6700\u7ec8\u7ed3\u679c\n    - [Agent]      LLM \u6267\u884c\u76f8\u5173\u4e8b\u4ef6\n    - [Graph]      \u5de5\u5177\u6267\u884c\u548c\u6743\u9650\u76f8\u5173\u4e8b\u4ef6\n    \"\"\"\n\n    # ========== Controller \u5c42 ==========\n    METADATA = \"metadata\"                # \u4f1a\u8bdd\u5143\u6570\u636e\n    COMPLETE = \"complete\"                # \u6574\u4f53\u5b8c\u6210\uff08\u542b execution_metrics\uff09\n    ERROR = \"error\"                      # \u9519\u8bef\n\n    # ========== Agent \u5c42 ==========\n    AGENT_START = \"agent_start\"          # agent \u5f00\u59cb\u6267\u884c\n    LLM_CHUNK = \"llm_chunk\"              # LLM token \u6d41\n    LLM_COMPLETE = \"llm_complete\"        # LLM \u5355\u6b21\u8c03\u7528\u5b8c\u6210\n    AGENT_COMPLETE = \"agent_complete\"    # agent \u672c\u8f6e\u5b8c\u6210\n\n    # ========== Graph \u5c42 ==========\n    TOOL_START = \"tool_start\"            # \u5de5\u5177\u5f00\u59cb\u6267\u884c\n    TOOL_COMPLETE = \"tool_complete\"      # \u5de5\u5177\u6267\u884c\u5b8c\u6210\n    PERMISSION_REQUEST = \"permission_request\"  # \u8bf7\u6c42\u6743\u9650\u786e\u8ba4\n    PERMISSION_RESULT = \"permission_result\"    # \u6743\u9650\u786e\u8ba4\u7ed3\u679c\n</code></pre> <p>\u524d\u7aef\u72b6\u6001\u63a8\u65ad\uff1a</p> \u6536\u5230\u4e8b\u4ef6 \u524d\u7aef\u663e\u793a <code>agent_start</code> \"Agent X \u6b63\u5728\u601d\u8003...\" <code>llm_chunk</code> \u6d41\u5f0f\u663e\u793a LLM \u8f93\u51fa\u5185\u5bb9 <code>tool_start</code> \"\u6b63\u5728\u6267\u884c web_search...\" <code>tool_complete</code> \u663e\u793a\u5de5\u5177\u6267\u884c\u7ed3\u679c <code>permission_request</code> \u5f39\u51fa\u6743\u9650\u786e\u8ba4\u5bf9\u8bdd\u6846 <code>complete</code> \u663e\u793a\u6700\u7ec8\u7ed3\u679c\u548c metrics"},{"location":"_archive/frontend/02_api_design/#45-executionmetrics-\u53ef\u89c2\u6d4b\u6027\u6307\u6807-","title":"4.5 ExecutionMetrics \u53ef\u89c2\u6d4b\u6027\u6307\u6807 \ud83c\udd95","text":"<p><code>complete</code> \u4e8b\u4ef6\u5305\u542b\u5b8c\u6574\u7684\u6267\u884c\u6307\u6807\uff0c\u7528\u4e8e\u524d\u7aef\u5c55\u793a\u6267\u884c\u7edf\u8ba1\u4fe1\u606f\u3002</p> <p>\u6570\u636e\u7ed3\u6784\uff1a</p> <pre><code>interface ExecutionMetrics {\n  started_at: string;                    // ISO timestamp\n  completed_at: string;                  // ISO timestamp\n  total_duration_ms: number;             // \u603b\u8017\u65f6\uff08\u6beb\u79d2\uff09\n\n  agent_executions: AgentExecutionRecord[];  // Agent \u6267\u884c\u8bb0\u5f55\u5217\u8868\n  tool_calls: ToolCallRecord[];              // \u5de5\u5177\u8c03\u7528\u8bb0\u5f55\u5217\u8868\n}\n\ninterface AgentExecutionRecord {\n  agent_name: string;                    // Agent \u540d\u79f0\n  model: string;                         // \u4f7f\u7528\u7684\u6a21\u578b\n  token_usage: {\n    input_tokens: number;\n    output_tokens: number;\n    total_tokens: number;\n  };\n  llm_duration_ms: number;               // LLM \u54cd\u5e94\u8017\u65f6\n  started_at: string;\n  completed_at: string;\n}\n\ninterface ToolCallRecord {\n  tool_name: string;                     // \u5de5\u5177\u540d\u79f0\n  success: boolean;                      // \u662f\u5426\u6210\u529f\n  duration_ms: number;                   // \u6267\u884c\u8017\u65f6\n  called_at: string;\n  completed_at: string;\n  agent: string;                         // \u8c03\u7528\u65b9 Agent\n}\n</code></pre> <p>\u793a\u4f8b\u6570\u636e\uff1a</p> <pre><code>{\n  \"execution_metrics\": {\n    \"started_at\": \"2024-01-19T10:00:00.000Z\",\n    \"completed_at\": \"2024-01-19T10:00:03.500Z\",\n    \"total_duration_ms\": 3500,\n\n    \"agent_executions\": [\n      {\n        \"agent_name\": \"lead_agent\",\n        \"model\": \"qwen-plus\",\n        \"token_usage\": {\"input_tokens\": 1200, \"output_tokens\": 350, \"total_tokens\": 1550},\n        \"llm_duration_ms\": 1200,\n        \"started_at\": \"2024-01-19T10:00:00.100Z\",\n        \"completed_at\": \"2024-01-19T10:00:01.300Z\"\n      },\n      {\n        \"agent_name\": \"search_agent\",\n        \"model\": \"qwen-plus\",\n        \"token_usage\": {\"input_tokens\": 800, \"output_tokens\": 200, \"total_tokens\": 1000},\n        \"llm_duration_ms\": 900,\n        \"started_at\": \"2024-01-19T10:00:01.400Z\",\n        \"completed_at\": \"2024-01-19T10:00:02.300Z\"\n      },\n      {\n        \"agent_name\": \"lead_agent\",\n        \"model\": \"qwen-plus\",\n        \"token_usage\": {\"input_tokens\": 1500, \"output_tokens\": 400, \"total_tokens\": 1900},\n        \"llm_duration_ms\": 600,\n        \"started_at\": \"2024-01-19T10:00:02.800Z\",\n        \"completed_at\": \"2024-01-19T10:00:03.400Z\"\n      }\n    ],\n\n    \"tool_calls\": [\n      {\n        \"tool_name\": \"web_search\",\n        \"success\": true,\n        \"duration_ms\": 450,\n        \"called_at\": \"2024-01-19T10:00:02.350Z\",\n        \"completed_at\": \"2024-01-19T10:00:02.800Z\",\n        \"agent\": \"search_agent\"\n      }\n    ]\n  }\n}\n</code></pre> <p>\u524d\u7aef\u4f7f\u7528\u5efa\u8bae\uff1a</p> <ol> <li>Token \u7edf\u8ba1\uff1a\u904d\u5386 <code>agent_executions</code> \u805a\u5408\u5404 Agent \u7684 token \u4f7f\u7528\u91cf</li> <li>\u8017\u65f6\u5206\u6790\uff1a\u5c55\u793a <code>total_duration_ms</code> \u548c\u5404\u6b65\u9aa4\u8017\u65f6</li> <li>\u5de5\u5177\u8c03\u7528\uff1a\u5c55\u793a <code>tool_calls</code> \u4e2d\u7684\u6210\u529f/\u5931\u8d25\u72b6\u6001</li> </ol>"},{"location":"_archive/frontend/02_api_design/#5-\u6587\u4ef6\u7ed3\u6784\u89c4\u5212","title":"5. \u6587\u4ef6\u7ed3\u6784\u89c4\u5212","text":""},{"location":"_archive/frontend/02_api_design/#51-\u65b0\u589e\u6587\u4ef6","title":"5.1 \u65b0\u589e\u6587\u4ef6","text":"<pre><code>src/\n\u251c\u2500\u2500 api/                             # API \u5c42\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 main.py                      # FastAPI \u5e94\u7528\u5165\u53e3\n\u2502   \u251c\u2500\u2500 config.py                    # API \u914d\u7f6e\n\u2502   \u251c\u2500\u2500 dependencies.py              # \u4f9d\u8d56\u6ce8\u5165\uff08Controller\u3001Manager \u7b49\uff09\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 routers/                     # \u8def\u7531\u6a21\u5757\n\u2502   \u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2502   \u251c\u2500\u2500 chat.py                  # /api/v1/chat\n\u2502   \u2502   \u251c\u2500\u2500 artifacts.py             # /api/v1/artifacts\n\u2502   \u2502   \u2514\u2500\u2500 stream.py                # /api/v1/stream (SSE)\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 schemas/                     # Pydantic \u6a21\u578b\n\u2502   \u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2502   \u251c\u2500\u2500 chat.py                  # \u5bf9\u8bdd\u76f8\u5173 schema\n\u2502   \u2502   \u251c\u2500\u2500 artifact.py              # Artifact \u76f8\u5173 schema\n\u2502   \u2502   \u2514\u2500\u2500 events.py                # SSE \u4e8b\u4ef6 schema\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 services/                    # \ud83c\udd95 \u670d\u52a1\u5c42\n\u2502   \u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2502   \u2514\u2500\u2500 stream_manager.py        # \u4e8b\u4ef6\u7f13\u51b2\u961f\u5217\u7ba1\u7406\n\u2502   \u2502\n\u2502   \u2514\u2500\u2500 utils/                       # API \u5de5\u5177\u51fd\u6570\n\u2502       \u251c\u2500\u2500 __init__.py\n\u2502       \u2514\u2500\u2500 sse.py                   # SSE \u54cd\u5e94\u6784\u5efa\u5668\n\u2502\n\u2514\u2500\u2500 run_server.py                    # \u670d\u52a1\u5668\u542f\u52a8\u811a\u672c\n</code></pre>"},{"location":"_archive/frontend/02_api_design/#52-\u6539\u9020\u6587\u4ef6","title":"5.2 \u6539\u9020\u6587\u4ef6","text":"\u6587\u4ef6 \u6539\u9020\u5185\u5bb9 <code>controller.py</code> \u6dfb\u52a0\u83b7\u53d6\u6267\u884c\u72b6\u6001\u7684\u65b9\u6cd5\uff08\u7528\u4e8e SSE \u91cd\u8fde\uff09 <code>requirements.txt</code> \u6dfb\u52a0 <code>fastapi</code>, <code>uvicorn</code>, <code>sse-starlette</code>, <code>aiofiles</code>"},{"location":"_archive/frontend/02_api_design/#6-\u6838\u5fc3\u7ec4\u4ef6\u8bbe\u8ba1","title":"6. \u6838\u5fc3\u7ec4\u4ef6\u8bbe\u8ba1","text":""},{"location":"_archive/frontend/02_api_design/#61-fastapi-\u5e94\u7528-mainpy","title":"6.1 FastAPI \u5e94\u7528 (main.py)","text":"<p>\u804c\u8d23\uff1a - \u521b\u5efa FastAPI \u5e94\u7528\u5b9e\u4f8b - \u914d\u7f6e CORS \u4e2d\u95f4\u4ef6 - \u6ce8\u518c\u8def\u7531 - \u914d\u7f6e\u5f02\u5e38\u5904\u7406</p> <p>\u8bbe\u8ba1\u8981\u70b9\uff1a - \u542f\u52a8\u65f6\u521d\u59cb\u5316\u6570\u636e\u5e93\u8fde\u63a5 - \u4f7f\u7528 lifespan context manager \u7ba1\u7406\u8d44\u6e90 - \u914d\u7f6e CORS \u5141\u8bb8\u524d\u7aef\u57df\u540d</p>"},{"location":"_archive/frontend/02_api_design/#62-\u4f9d\u8d56\u6ce8\u5165-dependenciespy","title":"6.2 \u4f9d\u8d56\u6ce8\u5165 (dependencies.py)","text":"<p>\u804c\u8d23\uff1a - \u63d0\u4f9b <code>get_db_session()</code> \u4f9d\u8d56\uff08\u8bf7\u6c42\u7ea7\u522b\u7684\u6570\u636e\u5e93\u4f1a\u8bdd\uff09\ud83c\udd95 - \u63d0\u4f9b <code>get_controller()</code> \u4f9d\u8d56 - \u63d0\u4f9b <code>get_artifact_manager()</code> \u4f9d\u8d56 - \u63d0\u4f9b <code>get_stream_manager()</code> \u4f9d\u8d56 - \u9884\u7559 <code>get_current_user()</code> \u4f9d\u8d56</p> <p>\u8bbe\u8ba1\u8981\u70b9\uff1a - \u4f7f\u7528 FastAPI \u7684 <code>Depends</code> \u7cfb\u7edf - \u6bcf\u4e2a\u8bf7\u6c42\u83b7\u5f97\u72ec\u7acb\u7684\u6570\u636e\u5e93 session\uff08\u8bf7\u6c42\u7ed3\u675f\u65f6\u81ea\u52a8 commit/rollback\uff09\ud83c\udd95 - Controller \u548c Manager \u901a\u8fc7\u6784\u9020\u51fd\u6570\u6ce8\u5165\uff0c\u7ed1\u5b9a\u5230\u8bf7\u6c42\u7684 session - \u7528\u6237\u4f9d\u8d56\u9884\u7559\u4e3a\u8fd4\u56de <code>None</code>\uff08\u65e0\u8ba4\u8bc1\u65f6\uff09</p> <p>\u793a\u4f8b\u4ee3\u7801\uff1a <pre><code># dependencies.py\nfrom functools import lru_cache\nfrom typing import AsyncGenerator, Any\nfrom fastapi import Depends\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom core.controller import ExecutionController\nfrom core.conversation_manager import ConversationManager\nfrom core.graph import create_multi_agent_graph, create_async_sqlite_checkpointer\nfrom tools.implementations.artifact_ops import ArtifactManager\nfrom db.database import DatabaseManager\nfrom repositories.artifact_repo import ArtifactRepository\nfrom repositories.conversation_repo import ConversationRepository\nfrom api.services.stream_manager import StreamManager\n\n# ============================================================\n# \u5168\u5c40\u5355\u4f8b\uff08\u8de8\u8bf7\u6c42\u5171\u4eab\uff09\n# ============================================================\n\n_db_manager: DatabaseManager = None\n_checkpointer: Any = None  # AsyncSqliteSaver\uff0cLangGraph \u72b6\u6001\u6301\u4e45\u5316\n\nasync def init_globals():\n    \"\"\"\u5e94\u7528\u542f\u52a8\u65f6\u521d\u59cb\u5316\"\"\"\n    global _db_manager, _checkpointer\n    _db_manager = DatabaseManager()\n    await _db_manager.initialize()\n    # \u521b\u5efa\u5171\u4eab\u7684 checkpointer\uff08\u7528\u4e8e interrupt/resume\uff09\n    # \u4f7f\u7528 AsyncSqliteSaver \u6301\u4e45\u5316\u5230 SQLite\n    _checkpointer = await create_async_sqlite_checkpointer(\"data/langgraph.db\")\n\nasync def close_globals():\n    \"\"\"\u5e94\u7528\u5173\u95ed\u65f6\u6e05\u7406\"\"\"\n    global _db_manager, _checkpointer\n    # \u5173\u95ed checkpointer \u7684 aiosqlite \u8fde\u63a5\n    if _checkpointer and hasattr(_checkpointer, 'conn'):\n        await _checkpointer.conn.close()\n    if _db_manager:\n        await _db_manager.close()\n\n@lru_cache()\ndef get_stream_manager() -&gt; StreamManager:\n    return StreamManager(ttl_seconds=30)\n\ndef get_checkpointer() -&gt; Any:\n    return _checkpointer\n\n# ============================================================\n# \u8bf7\u6c42\u7ea7\u522b\u4f9d\u8d56\uff08\u6bcf\u4e2a\u8bf7\u6c42\u72ec\u7acb\uff09\n# ============================================================\n\nasync def get_db_session() -&gt; AsyncGenerator[AsyncSession, None]:\n    \"\"\"\n    \u6bcf\u4e2a\u8bf7\u6c42\u83b7\u5f97\u72ec\u7acb\u7684\u6570\u636e\u5e93 session\n\n    \u8bf7\u6c42\u6210\u529f \u2192 \u81ea\u52a8 commit\n    \u8bf7\u6c42\u5931\u8d25 \u2192 \u81ea\u52a8 rollback\n    \"\"\"\n    async with _db_manager.session() as session:\n        yield session\n\nasync def get_artifact_manager(\n    session: AsyncSession = Depends(get_db_session)\n) -&gt; ArtifactManager:\n    \"\"\"\u6bcf\u4e2a\u8bf7\u6c42\u83b7\u5f97\u72ec\u7acb\u7684 ArtifactManager\uff08\u7ed1\u5b9a\u5230\u8bf7\u6c42\u7684 session\uff09\"\"\"\n    repo = ArtifactRepository(session)\n    return ArtifactManager(repo)\n\nasync def get_conversation_manager(\n    session: AsyncSession = Depends(get_db_session)\n) -&gt; ConversationManager:\n    \"\"\"\u6bcf\u4e2a\u8bf7\u6c42\u83b7\u5f97\u72ec\u7acb\u7684 ConversationManager\uff08\u7ed1\u5b9a\u5230\u8bf7\u6c42\u7684 session\uff09\"\"\"\n    repo = ConversationRepository(session)\n    return ConversationManager(repo)\n\nasync def get_controller(\n    artifact_manager: ArtifactManager = Depends(get_artifact_manager),\n    conversation_manager: ConversationManager = Depends(get_conversation_manager),\n) -&gt; ExecutionController:\n    \"\"\"\n    \u6bcf\u4e2a\u8bf7\u6c42\u83b7\u5f97\u72ec\u7acb\u7684 Controller\n\n    \u6ce8\u610f\uff1a\n    - Graph \u6bcf\u6b21\u521b\u5efa\u65b0\u5b9e\u4f8b\uff0c\u56e0\u4e3a\u5b83\u6301\u6709 artifact_manager \u5f15\u7528\n    - \u4f46 checkpointer \u662f\u5171\u4eab\u7684\uff0c\u4ee5\u652f\u6301\u8de8\u8bf7\u6c42\u7684 interrupt/resume\n    - create_multi_agent_graph \u662f async \u51fd\u6570\n    \"\"\"\n    compiled_graph = await create_multi_agent_graph(\n        artifact_manager=artifact_manager,\n        checkpointer=get_checkpointer()  # \u4f7f\u7528\u5171\u4eab\u7684 checkpointer\n    )\n    return ExecutionController(\n        compiled_graph,\n        artifact_manager=artifact_manager,\n        conversation_manager=conversation_manager\n    )\n</code></pre></p>"},{"location":"_archive/frontend/02_api_design/#63-sse-\u8def\u7531-streampy","title":"6.3 SSE \u8def\u7531 (stream.py)","text":"<p>\u804c\u8d23\uff1a - \u8ba2\u9605 Graph \u6267\u884c\u8fc7\u7a0b - \u8f6c\u53d1 <code>stream_execute</code> \u7684\u4e8b\u4ef6 - \u5904\u7406\u8fde\u63a5\u65ad\u5f00</p> <p>\u8bbe\u8ba1\u8981\u70b9\uff1a <pre><code>\u6d41\u7a0b\uff1a\n1. \u524d\u7aef POST /chat \u83b7\u53d6 thread_id\n2. POST \u5904\u7406\u5668\u542f\u52a8\u4efb\u52a1\uff0c\u4e8b\u4ef6\u5199\u5165 StreamManager \u961f\u5217\n3. \u524d\u7aef EventSource \u8fde\u63a5 /stream/{thread_id}\n4. GET \u5904\u7406\u5668\u4ece\u961f\u5217\u6d88\u8d39\u4e8b\u4ef6\uff0c\u901a\u8fc7 SSE \u63a8\u9001\n5. \u6536\u5230 complete/interrupt/error \u4e8b\u4ef6\u540e\u5173\u95ed\u8fde\u63a5\n</code></pre></p>"},{"location":"_archive/frontend/02_api_design/#64-\u4e8b\u4ef6\u7f13\u51b2\u961f\u5217\u8bbe\u8ba1streammanager","title":"6.4 \u4e8b\u4ef6\u7f13\u51b2\u961f\u5217\u8bbe\u8ba1\uff08StreamManager\uff09\ud83c\udd95","text":"<p>\u89e3\u51b3\u7684\u95ee\u9898\uff1aPOST /chat \u542f\u52a8\u4efb\u52a1\u540e\uff0cGraph \u53ef\u80fd\u5728\u524d\u7aef SSE \u8fde\u63a5\u5efa\u7acb\u4e4b\u524d\u5c31\u5df2\u7ecf\u5f00\u59cb\u4ea7\u751f\u4e8b\u4ef6\uff0c\u5bfc\u81f4 <code>metadata</code> / <code>start</code> \u7b49\u65e9\u671f\u4e8b\u4ef6\u4e22\u5931\u3002</p> <p>\u67b6\u6784\u8bbe\u8ba1\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      StreamManager                           \u2502\n\u2502                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502  streams: Dict[thread_id, StreamContext]               \u2502 \u2502\n\u2502  \u2502                                                        \u2502 \u2502\n\u2502  \u2502  StreamContext:                                        \u2502 \u2502\n\u2502  \u2502    - queue: asyncio.Queue[SSEEvent]                   \u2502 \u2502\n\u2502  \u2502    - created_at: datetime                             \u2502 \u2502\n\u2502  \u2502    - status: pending | streaming | closed             \u2502 \u2502\n\u2502  \u2502    - ttl_task: asyncio.Task (\u81ea\u52a8\u6e05\u7406)                 \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                             \u2502\n\u2502  \u65b9\u6cd5:                                                       \u2502\n\u2502    - create_stream(thread_id) \u2192 StreamContext               \u2502\n\u2502    - push_event(thread_id, event)                          \u2502\n\u2502    - consume_events(thread_id) \u2192 AsyncGenerator[SSEEvent]  \u2502\n\u2502    - close_stream(thread_id)                               \u2502\n\u2502    - cleanup_expired()  # \u5b9a\u671f\u6e05\u7406\u8fc7\u671f\u961f\u5217                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>TTL \u673a\u5236\uff1a</p> <pre><code># stream_manager.py\n\nclass StreamContext:\n    queue: asyncio.Queue\n    created_at: datetime\n    status: Literal[\"pending\", \"streaming\", \"closed\"]\n    ttl_task: Optional[asyncio.Task]\n\nclass StreamManager:\n    def __init__(self, ttl_seconds: int = 30):\n        self.streams: Dict[str, StreamContext] = {}\n        self.ttl_seconds = ttl_seconds\n\n    def create_stream(self, thread_id: str) -&gt; StreamContext:\n        \"\"\"\u521b\u5efa\u4e8b\u4ef6\u961f\u5217\uff0c\u5e76\u542f\u52a8 TTL \u5b9a\u65f6\u5668\"\"\"\n        context = StreamContext(\n            queue=asyncio.Queue(),\n            created_at=datetime.now(),\n            status=\"pending\",\n            ttl_task=None\n        )\n        self.streams[thread_id] = context\n\n        # \u542f\u52a8 TTL \u5b9a\u65f6\u5668\n        context.ttl_task = asyncio.create_task(\n            self._ttl_cleanup(thread_id)\n        )\n        return context\n\n    async def _ttl_cleanup(self, thread_id: str):\n        \"\"\"TTL \u5230\u671f\u540e\u81ea\u52a8\u6e05\u7406\u961f\u5217\uff08\u9632\u6b62\u5185\u5b58\u6cc4\u6f0f\uff09\"\"\"\n        await asyncio.sleep(self.ttl_seconds)\n\n        context = self.streams.get(thread_id)\n        if context and context.status == \"pending\":\n            # \u524d\u7aef\u672a\u8fde\u63a5\uff0c\u6e05\u7406\u961f\u5217\n            logger.warning(f\"Stream {thread_id} expired (TTL={self.ttl_seconds}s)\")\n            self.close_stream(thread_id)\n\n    async def consume_events(self, thread_id: str):\n        \"\"\"\u6d88\u8d39\u4e8b\u4ef6\uff08\u524d\u7aef SSE \u8fde\u63a5\u65f6\u8c03\u7528\uff09\"\"\"\n        context = self.streams.get(thread_id)\n        if not context:\n            raise StreamNotFoundError(thread_id)\n\n        # \u53d6\u6d88 TTL \u5b9a\u65f6\u5668\uff08\u524d\u7aef\u5df2\u8fde\u63a5\uff09\n        if context.ttl_task:\n            context.ttl_task.cancel()\n            context.ttl_task = None\n\n        context.status = \"streaming\"\n\n        while True:\n            event = await context.queue.get()\n            yield event\n\n            # \u7ec8\u7ed3\u4e8b\u4ef6\u540e\u9000\u51fa\n            if event.type in (\"complete\", \"interrupt\", \"error\"):\n                break\n\n        self.close_stream(thread_id)\n</code></pre> <p>\u4ea4\u4e92\u65f6\u5e8f\uff1a</p> <pre><code>\u65f6\u95f4\u8f74 \u2192\n\nPOST /chat                          GET /stream/{thread_id}\n    \u2502                                      \u2502\n    \u25bc                                      \u2502\n[\u521b\u5efa StreamContext]                       \u2502\n[\u542f\u52a8 TTL \u5b9a\u65f6\u5668 (30s)]                    \u2502\n    \u2502                                      \u2502\n    \u25bc                                      \u2502\n[\u542f\u52a8 graph.astream()]                     \u2502\n    \u2502                                      \u2502\n    \u25bc                                      \u25bc\n[push metadata \u4e8b\u4ef6\u5230\u961f\u5217]         [\u8fde\u63a5\u5efa\u7acb, \u53d6\u6d88 TTL \u5b9a\u65f6\u5668]\n    \u2502                                      \u2502\n    \u25bc                                      \u25bc\n[push stream \u4e8b\u4ef6\u5230\u961f\u5217]  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba [\u6d88\u8d39\u5e76\u63a8\u9001 SSE]\n    \u2502                                      \u2502\n    \u25bc                                      \u25bc\n[push complete \u4e8b\u4ef6]      \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba [\u63a8\u9001\u540e\u5173\u95ed\u8fde\u63a5]\n    \u2502                                      \u2502\n    \u25bc                                      \u2502\n[close_stream()]                           \u2502\n</code></pre>"},{"location":"_archive/frontend/02_api_design/#65-\u6570\u636e\u5e93\u4f1a\u8bdd\u4e0e\u4e8b\u52a1\u7ba1\u7406-","title":"6.5 \u6570\u636e\u5e93\u4f1a\u8bdd\u4e0e\u4e8b\u52a1\u7ba1\u7406 \ud83c\udd95","text":"<p>\u6838\u5fc3\u539f\u5219\uff1a\u6bcf\u4e2a HTTP \u8bf7\u6c42\u4f7f\u7528\u72ec\u7acb\u7684\u6570\u636e\u5e93 session\uff0c\u8bf7\u6c42\u7ed3\u675f\u65f6\u81ea\u52a8 commit \u6216 rollback\u3002</p> <p>\u4e3a\u4ec0\u4e48\u9700\u8981\u8bf7\u6c42\u7ea7\u522b\u7684 Session \u9694\u79bb\uff1a</p> <ol> <li>\u5e76\u53d1\u5b89\u5168\uff1a\u591a\u4e2a\u5e76\u53d1\u8bf7\u6c42\u4e0d\u4f1a\u5171\u4eab session\uff0c\u907f\u514d\u6570\u636e\u7ade\u4e89</li> <li>\u4e8b\u52a1\u8fb9\u754c\u6e05\u6670\uff1a\u4e00\u4e2a\u8bf7\u6c42 = \u4e00\u4e2a\u4e8b\u52a1\uff0c\u8981\u4e48\u5168\u90e8\u6210\u529f\uff0c\u8981\u4e48\u5168\u90e8\u56de\u6eda</li> <li>\u8d44\u6e90\u53ca\u65f6\u91ca\u653e\uff1a\u8bf7\u6c42\u7ed3\u675f\u540e session \u81ea\u52a8\u5173\u95ed\uff0c\u907f\u514d\u8fde\u63a5\u6cc4\u6f0f</li> </ol> <p>\u4f9d\u8d56\u6ce8\u5165\u94fe\u8def\uff1a</p> <pre><code>HTTP Request\n    \u2502\n    \u25bc\nget_db_session()        # \u521b\u5efa\u72ec\u7acb\u7684 AsyncSession\n    \u2502\n    \u251c\u2500\u2500\u25ba get_artifact_manager()     # \u521b\u5efa ArtifactRepository \u2192 ArtifactManager\n    \u2502\n    \u251c\u2500\u2500\u25ba get_conversation_manager() # \u521b\u5efa ConversationRepository \u2192 ConversationManager\n    \u2502\n    \u2514\u2500\u2500\u25ba get_controller()           # \u521b\u5efa Graph \u2192 ExecutionController\n             \u2502\n             \u25bc\n        \u6267\u884c\u8bf7\u6c42\u5904\u7406\n             \u2502\n             \u25bc\n        \u8bf7\u6c42\u6210\u529f \u2192 session.commit()\n        \u8bf7\u6c42\u5931\u8d25 \u2192 session.rollback()\n             \u2502\n             \u25bc\n        session.close()\n</code></pre> <p>\u5e76\u53d1\u5b89\u5168\u4fdd\u8bc1\uff1a</p> \u7ec4\u4ef6 \u5171\u4eab\u65b9\u5f0f \u8bf4\u660e <code>DatabaseManager</code> \u5168\u5c40\u5355\u4f8b \u53ea\u7ba1\u7406\u8fde\u63a5\u6c60\uff0c\u4e0d\u6301\u6709 session \u72b6\u6001 <code>Checkpointer</code> \u5168\u5c40\u5355\u4f8b AsyncSqliteSaver\uff0cLangGraph \u72b6\u6001\u6301\u4e45\u5316\uff0c\u652f\u6301 interrupt/resume <code>AsyncSession</code> \u8bf7\u6c42\u72ec\u7acb \u6bcf\u4e2a\u8bf7\u6c42\u521b\u5efa\u65b0\u7684\u6570\u636e\u5e93\u4f1a\u8bdd <code>Repository</code> \u8bf7\u6c42\u72ec\u7acb \u7ed1\u5b9a\u5230\u8bf7\u6c42\u7684 session <code>Manager</code> \u8bf7\u6c42\u72ec\u7acb \u7ed1\u5b9a\u5230\u8bf7\u6c42\u7684 repository <code>Graph</code> \u8bf7\u6c42\u72ec\u7acb \u6301\u6709 manager \u5f15\u7528\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u521b\u5efa\u65b0\u5b9e\u4f8b\uff08\u4f46\u5171\u4eab checkpointer\uff09 <code>Controller</code> \u8bf7\u6c42\u72ec\u7acb \u7ed1\u5b9a\u5230\u8bf7\u6c42\u7684 managers <code>StreamManager</code> \u5168\u5c40\u5355\u4f8b \u65e0\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u53ef\u5b89\u5168\u5171\u4eab <p>\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ol> <li>Graph \u6bcf\u6b21\u8bf7\u6c42\u521b\u5efa\u65b0\u5b9e\u4f8b\uff1a\u56e0\u4e3a Graph \u5185\u7684\u5de5\u5177\u6301\u6709 <code>artifact_manager</code> \u5f15\u7528\uff0c\u5982\u679c\u5171\u4eab Graph \u5b9e\u4f8b\uff0c\u5e76\u53d1\u8bf7\u6c42\u4f1a\u4e92\u76f8\u8986\u76d6 manager \u7684 repository</li> <li>Graph \u521b\u5efa\u5f00\u9500\uff1a\u6bcf\u6b21\u8bf7\u6c42\u521b\u5efa Graph \u6709\u4e00\u5b9a\u5f00\u9500\uff0c\u4f46\u76f8\u6bd4 LLM \u63a8\u7406\u65f6\u95f4\u53ef\u4ee5\u5ffd\u7565</li> <li>\u5982\u9700\u4f18\u5316\uff1a\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 <code>contextvars</code> \u5b9e\u73b0\u8bf7\u6c42\u4e0a\u4e0b\u6587\u9694\u79bb\uff0c\u4f46\u4f1a\u589e\u52a0\u590d\u6742\u5ea6</li> </ol>"},{"location":"_archive/frontend/02_api_design/#7-\u6267\u884c\u6d41\u7a0b","title":"7. \u6267\u884c\u6d41\u7a0b","text":""},{"location":"_archive/frontend/02_api_design/#71-\u53d1\u9001\u6d88\u606f\u6d41\u7a0b","title":"7.1 \u53d1\u9001\u6d88\u606f\u6d41\u7a0b","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Frontend  \u2502     \u2502  API Layer \u2502     \u2502 StreamManager\u2502     \u2502 Controller \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502  POST /chat      \u2502                   \u2502                   \u2502\n      \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                   \u2502                   \u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502                  \u2502  create_stream    \u2502                   \u2502\n      \u2502                  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                   \u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502                  \u2502  \u542f\u52a8\u540e\u53f0\u4efb\u52a1      \u2502                   \u2502\n      \u2502                  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502  \u8fd4\u56de stream_url \u2502                   \u2502                   \u2502\n      \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                   \u2502                   \u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502  GET /stream     \u2502                   \u2502                   \u2502\n      \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                   \u2502                   \u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502                  \u2502  consume_events   \u2502                   \u2502\n      \u2502                  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                   \u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502                  \u2502                   \u2502  \u4e8b\u4ef6\u63a8\u9001         \u2502\n      \u2502                  \u2502                   \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n      \u2502  SSE events      \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                   \u2502\n      \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                   \u2502                   \u2502\n      \u2502                  \u2502                   \u2502                   \u2502\n</code></pre>"},{"location":"_archive/frontend/02_api_design/#72-\u6743\u9650\u786e\u8ba4\u6d41\u7a0b\u542b-sse-\u751f\u547d\u5468\u671f","title":"7.2 \u6743\u9650\u786e\u8ba4\u6d41\u7a0b\uff08\u542b SSE \u751f\u547d\u5468\u671f\uff09\ud83c\udd95","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Frontend  \u2502     \u2502  API Layer \u2502     \u2502 StreamManager\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502                  \u2502                   \u2502\n      \u2502  SSE \u8fde\u63a5\u4e2d...    \u2502                   \u2502\n      \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  \u6536\u5230 interrupt \u4e8b\u4ef6                  \u2502\n      \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502                  \u2502  close_stream     \u2502\n      \u2502                  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  SSE \u8fde\u63a5\u5173\u95ed \u2702\ufe0f  \u2502                   \u2502\n      \u2502\u25c4 \u2500 \u2500 \u2500 \u2500 \u2500 \u2500 \u2500 \u2500\u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  [\u663e\u793a\u786e\u8ba4\u5bf9\u8bdd\u6846] \u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  \u7528\u6237\u70b9\u51fb\u786e\u8ba4/\u62d2\u7edd\u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  POST /resume    \u2502                   \u2502\n      \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502                  \u2502  create_stream    \u2502\n      \u2502                  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  \u8fd4\u56de\u65b0 stream_url                    \u2502\n      \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  \u9500\u6bc1\u65e7 EventSource                   \u2502\n      \u2502  \u5efa\u7acb\u65b0 EventSource                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  GET /stream (\u65b0\u8fde\u63a5)                 \u2502\n      \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                   \u2502\n      \u2502                  \u2502                   \u2502\n      \u2502  \u7ee7\u7eed\u63a5\u6536\u540e\u7eed\u4e8b\u4ef6 \u2502                   \u2502\n      \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                   \u2502\n</code></pre> <p>\u5173\u952e\u70b9\uff1a 1. \u6536\u5230 <code>interrupt</code> \u4e8b\u4ef6\u540e\uff0c\u670d\u52a1\u7aef\u4e3b\u52a8\u5173\u95ed SSE \u8fde\u63a5 2. \u524d\u7aef\u8c03\u7528 <code>/resume</code> \u540e\u83b7\u5f97\u65b0\u7684 <code>stream_url</code> 3. \u524d\u7aef\u5fc5\u987b\u9500\u6bc1\u65e7\u7684 EventSource \u5b9e\u4f8b\u540e\u518d\u5efa\u7acb\u65b0\u8fde\u63a5 4. \u8fd9\u907f\u514d\u4e86 SSE \u8fde\u63a5\u5728\u7b49\u5f85\u7528\u6237\u64cd\u4f5c\u671f\u95f4\u957f\u65f6\u95f4\u6302\u8d77</p>"},{"location":"_archive/frontend/02_api_design/#8-\u5b9e\u65bd\u6b65\u9aa4","title":"8. \u5b9e\u65bd\u6b65\u9aa4","text":""},{"location":"_archive/frontend/02_api_design/#phase-1-\u57fa\u7840\u6846\u67b6\u9884\u8ba1-1-2-\u5929","title":"Phase 1: \u57fa\u7840\u6846\u67b6\uff08\u9884\u8ba1 1-2 \u5929\uff09","text":"<ol> <li>\u642d\u5efa FastAPI \u5e94\u7528</li> <li>\u521b\u5efa <code>api/main.py</code></li> <li>\u914d\u7f6e CORS</li> <li> <p>\u521b\u5efa\u57fa\u7840\u8def\u7531\u7ed3\u6784</p> </li> <li> <p>\u5b9e\u73b0\u4f9d\u8d56\u6ce8\u5165</p> </li> <li><code>get_controller()</code></li> <li><code>get_artifact_manager()</code></li> <li> <p><code>get_stream_manager()</code> \ud83c\udd95</p> </li> <li> <p>\u5b9a\u4e49 Schemas</p> </li> <li>\u8bf7\u6c42\u6a21\u578b</li> <li>\u54cd\u5e94\u6a21\u578b</li> </ol>"},{"location":"_archive/frontend/02_api_design/#phase-2-rest-api\u9884\u8ba1-2-3-\u5929","title":"Phase 2: REST API\uff08\u9884\u8ba1 2-3 \u5929\uff09","text":"<ol> <li>\u5b9e\u73b0 Chat \u8def\u7531</li> <li>POST /chat</li> <li>GET /chat</li> <li>GET /chat/{id}</li> <li>DELETE /chat/{id}</li> <li> <p>POST /chat/{id}/resume</p> </li> <li> <p>\u5b9e\u73b0 Artifact \u8def\u7531</p> </li> <li>GET /artifacts/{session_id}</li> <li>GET /artifacts/{session_id}/{id}</li> <li>GET /artifacts/{session_id}/{id}/versions</li> <li> <p>GET /artifacts/{session_id}/{id}/versions/{v}</p> </li> <li> <p>\u7f16\u5199 API \u6d4b\u8bd5</p> </li> <li>\u4f7f\u7528 pytest + httpx (AsyncClient)</li> </ol>"},{"location":"_archive/frontend/02_api_design/#phase-3-sse-\u6d41\u5f0f\u9884\u8ba1-2-3-\u5929","title":"Phase 3: SSE \u6d41\u5f0f\uff08\u9884\u8ba1 2-3 \u5929\uff09","text":"<ol> <li>\u5b9e\u73b0 StreamManager \ud83c\udd95</li> <li>\u4e8b\u4ef6\u7f13\u51b2\u961f\u5217</li> <li>TTL \u673a\u5236</li> <li> <p>\u8fde\u63a5\u72b6\u6001\u8ffd\u8e2a</p> </li> <li> <p>\u5b9e\u73b0 Stream \u8def\u7531</p> </li> <li>GET /stream/{thread_id}</li> <li>\u4e0e Controller \u96c6\u6210</li> <li> <p>\u7ec8\u7ed3\u4e8b\u4ef6\u540e\u4e3b\u52a8\u5173\u95ed\u8fde\u63a5 \ud83c\udd95</p> </li> <li> <p>\u5904\u7406\u8fb9\u7f18\u60c5\u51b5</p> </li> <li>\u8fde\u63a5\u65ad\u5f00\u91cd\u8fde</li> <li>\u8d85\u65f6\u5904\u7406</li> <li>TTL \u8fc7\u671f\u6e05\u7406 \ud83c\udd95</li> </ol>"},{"location":"_archive/frontend/02_api_design/#phase-4-\u96c6\u6210\u6d4b\u8bd5\u9884\u8ba1-1-2-\u5929","title":"Phase 4: \u96c6\u6210\u6d4b\u8bd5\uff08\u9884\u8ba1 1-2 \u5929\uff09","text":"<ol> <li>\u7aef\u5230\u7aef\u6d4b\u8bd5</li> <li>\u5b8c\u6574\u7684\u5bf9\u8bdd\u6d41\u7a0b</li> <li>\u6743\u9650\u786e\u8ba4\u6d41\u7a0b\uff08\u542b\u8fde\u63a5\u5173\u95ed/\u91cd\u5efa\uff09\ud83c\udd95</li> <li> <p>\u5206\u652f\u5bf9\u8bdd\u6d41\u7a0b</p> </li> <li> <p>\u6027\u80fd\u6d4b\u8bd5</p> </li> <li>\u5e76\u53d1\u8fde\u63a5\u6570</li> <li>SSE \u63a8\u9001\u5ef6\u8fdf</li> <li>\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\uff08TTL \u673a\u5236\u9a8c\u8bc1\uff09\ud83c\udd95</li> </ol>"},{"location":"_archive/frontend/02_api_design/#9-\u540e\u7eed\u6269\u5c55\u9884\u7559","title":"9. \u540e\u7eed\u6269\u5c55\u9884\u7559","text":""},{"location":"_archive/frontend/02_api_design/#91-\u7528\u6237\u8ba4\u8bc1phase-2","title":"9.1 \u7528\u6237\u8ba4\u8bc1\uff08Phase 2\uff09","text":"<p>\u9884\u7559\u4f4d\u7f6e\uff1a - <code>dependencies.py</code> \u4e2d\u7684 <code>get_current_user()</code> - \u6240\u6709\u8def\u7531\u7684 <code>user_id</code> \u53c2\u6570</p> <p>\u5b9e\u73b0\u65b9\u5f0f\uff08\u5efa\u8bae\uff09\uff1a - JWT Token \u8ba4\u8bc1 - \u53ef\u9009\uff1aOAuth2 (Google/GitHub \u767b\u5f55)</p> <p>\u8fc1\u79fb\u8def\u5f84\uff1a 1. \u6dfb\u52a0 <code>users</code> \u8868\u548c Repository 2. \u5b9e\u73b0 JWT \u751f\u6210/\u9a8c\u8bc1 3. \u5b9e\u73b0 <code>get_current_user()</code> \u4f9d\u8d56 4. \u6dfb\u52a0 <code>/auth</code> \u8def\u7531</p>"},{"location":"_archive/frontend/02_api_design/#92-websocket\u5982\u9700\u53cc\u5411\u901a\u4fe1","title":"9.2 WebSocket\uff08\u5982\u9700\u53cc\u5411\u901a\u4fe1\uff09","text":"<p>\u9884\u7559\u4f4d\u7f6e\uff1a - <code>api/routers/ws.py</code></p> <p>\u4f7f\u7528\u573a\u666f\uff1a - \u534f\u4f5c\u7f16\u8f91 - \u5b9e\u65f6\u901a\u77e5 - \u53cc\u5411\u63a7\u5236\uff08\u5982\u53d6\u6d88\u6267\u884c\uff09</p>"},{"location":"_archive/frontend/02_api_design/#10-\u4f9d\u8d56\u6e05\u5355","title":"10. \u4f9d\u8d56\u6e05\u5355","text":"<pre><code># API \u4f9d\u8d56\nfastapi&gt;=0.109.0\nuvicorn[standard]&gt;=0.27.0\nsse-starlette&gt;=1.8.0\npydantic&gt;=2.5.0\npython-multipart&gt;=0.0.6  # \u6587\u4ef6\u4e0a\u4f20\u652f\u6301\uff08\u9884\u7559\uff09\naiofiles&gt;=23.2.0         # \ud83c\udd95 \u5f02\u6b65\u6587\u4ef6\u64cd\u4f5c\n\n# \u6d4b\u8bd5\u4f9d\u8d56\nhttpx&gt;=0.26.0\npytest-asyncio&gt;=0.23.0\n</code></pre>"},{"location":"_archive/frontend/02_api_design/#11-\u914d\u7f6e\u9879","title":"11. \u914d\u7f6e\u9879","text":"<pre><code># api/config.py\n\nclass APIConfig:\n    # \u670d\u52a1\u5668\u914d\u7f6e\n    HOST: str = \"0.0.0.0\"\n    PORT: int = 8000\n    DEBUG: bool = True\n\n    # CORS \u914d\u7f6e\n    CORS_ORIGINS: list = [\"http://localhost:3000\"]  # Next.js \u5f00\u53d1\u670d\u52a1\u5668\n\n    # SSE \u914d\u7f6e\n    SSE_PING_INTERVAL: int = 15  # \u79d2\uff0c\u4fdd\u6301\u8fde\u63a5\u6d3b\u8dc3\n    STREAM_TIMEOUT: int = 300    # \u79d2\uff0c\u6700\u5927\u6267\u884c\u65f6\u95f4\n    STREAM_TTL: int = 30         # \ud83c\udd95 \u79d2\uff0c\u961f\u5217 TTL\uff08\u524d\u7aef\u672a\u8fde\u63a5\u65f6\u81ea\u52a8\u6e05\u7406\uff09\n\n    # \u5206\u9875\u9ed8\u8ba4\u503c\n    DEFAULT_PAGE_SIZE: int = 20\n    MAX_PAGE_SIZE: int = 100\n</code></pre>"},{"location":"_archive/frontend/02_api_design/#\u9644\u5f55v14--v15-\u53d8\u66f4\u6458\u8981","title":"\u9644\u5f55\uff1av1.4 \u2192 v1.5 \u53d8\u66f4\u6458\u8981","text":"\u7ae0\u8282 \u53d8\u66f4\u7c7b\u578b \u8bf4\u660e 4.3 \ud83d\udd04 \u66f4\u65b0 \u6d41\u5f0f\u63a5\u53e3\u4e8b\u4ef6\u683c\u5f0f\u66f4\u65b0\u4e3a\u7edf\u4e00\u7684 StreamEventType 4.4 \ud83c\udd95 \u65b0\u589e \u7edf\u4e00\u4e8b\u4ef6\u7c7b\u578b\uff08StreamEventType\uff09\u8bbe\u8ba1 4.5 \ud83c\udd95 \u65b0\u589e ExecutionMetrics \u53ef\u89c2\u6d4b\u6027\u6307\u6807\u8bbe\u8ba1 <p>\u5173\u952e\u53d8\u66f4\u8bf4\u660e\uff1a</p> <ol> <li>\u7edf\u4e00\u4e8b\u4ef6\u7c7b\u578b\uff1a\u79fb\u9664 <code>ControllerEventType</code>\uff0c\u6240\u6709\u5c42\uff08Agent/Graph/Controller\uff09\u4f7f\u7528\u7edf\u4e00\u7684 <code>StreamEventType</code></li> <li>\u4e8b\u4ef6\u76f4\u63a5\u900f\u4f20\uff1aController \u4e0d\u518d\u5c06\u4e8b\u4ef6\u5305\u88c5\u4e3a <code>stream</code> \u7c7b\u578b\uff0c\u76f4\u63a5\u900f\u4f20 graph \u7684\u4e8b\u4ef6</li> <li>ExecutionMetrics\uff1a\u65b0\u589e\u53ef\u89c2\u6d4b\u6027\u6307\u6807\uff0c\u5728 <code>complete</code> \u4e8b\u4ef6\u4e2d\u8fd4\u56de\u5b8c\u6574\u7684\u6267\u884c\u7edf\u8ba1\u4fe1\u606f</li> <li>\u4e8b\u4ef6\u547d\u540d\u53d8\u66f4\uff1a</li> <li><code>start</code> \u2192 <code>agent_start</code></li> <li><code>complete</code>\uff08Agent \u5c42\uff09\u2192 <code>agent_complete</code></li> <li><code>tool_result</code> \u2192 <code>tool_complete</code></li> <li><code>permission_required</code> \u2192 <code>permission_request</code></li> <li>\u65b0\u589e\u4e8b\u4ef6\uff1a<code>tool_start</code>\uff08\u5de5\u5177\u5f00\u59cb\u6267\u884c\uff09\u3001<code>permission_result</code>\uff08\u6743\u9650\u786e\u8ba4\u7ed3\u679c\uff09</li> </ol>"},{"location":"_archive/frontend/02_api_design/#\u9644\u5f55v13--v14-\u53d8\u66f4\u6458\u8981","title":"\u9644\u5f55\uff1av1.3 \u2192 v1.4 \u53d8\u66f4\u6458\u8981","text":"\u7ae0\u8282 \u53d8\u66f4\u7c7b\u578b \u8bf4\u660e 6.2 \ud83d\udd04 \u66f4\u65b0 Checkpointer \u4ece MemorySaver \u6539\u4e3a AsyncSqliteSaver 6.5 \ud83d\udd04 \u66f4\u65b0 \u5e76\u53d1\u5b89\u5168\u8868\u66f4\u65b0 Checkpointer \u8bf4\u660e <p>\u5173\u952e\u53d8\u66f4\u8bf4\u660e\uff1a</p> <ol> <li>Checkpointer \u6301\u4e45\u5316\uff1a\u4ece\u5185\u5b58\u5b58\u50a8 (<code>MemorySaver</code>) \u6539\u4e3a SQLite \u6301\u4e45\u5316 (<code>AsyncSqliteSaver</code>)\uff0c\u670d\u52a1\u91cd\u542f\u540e interrupt/resume \u72b6\u6001\u4e0d\u4e22\u5931</li> <li><code>create_multi_agent_graph</code> \u6539\u4e3a async\uff1a\u56e0\u4e3a\u521b\u5efa checkpointer \u9700\u8981\u5f02\u6b65\u521d\u59cb\u5316</li> <li>\u8fde\u63a5\u6e05\u7406\uff1a<code>close_globals()</code> \u9700\u8981\u5173\u95ed checkpointer \u7684 aiosqlite \u8fde\u63a5\uff0c\u907f\u514d\u7a0b\u5e8f\u65e0\u6cd5\u6b63\u5e38\u9000\u51fa</li> </ol>"},{"location":"_archive/frontend/02_api_design/#\u9644\u5f55v12--v13-\u53d8\u66f4\u6458\u8981","title":"\u9644\u5f55\uff1av1.2 \u2192 v1.3 \u53d8\u66f4\u6458\u8981","text":"\u7ae0\u8282 \u53d8\u66f4\u7c7b\u578b \u8bf4\u660e 4.1 \ud83d\udd04 \u66f4\u65b0 Resume \u63a5\u53e3\u589e\u52a0 <code>message_id</code> \u53c2\u6570\uff0c\u6539\u4e3a\u65e0\u72b6\u6001\u8bbe\u8ba1 6.2 \ud83d\udd04 \u66f4\u65b0 \u4f9d\u8d56\u6ce8\u5165\u793a\u4f8b\u589e\u52a0\u5171\u4eab checkpointer 6.5 \ud83d\udd04 \u66f4\u65b0 \u5e76\u53d1\u5b89\u5168\u8868\u589e\u52a0 Checkpointer \u7ec4\u4ef6 <p>\u5173\u952e\u53d8\u66f4\u8bf4\u660e\uff1a</p> <ol> <li>Controller \u65e0\u72b6\u6001\u8bbe\u8ba1\uff1aController \u4e0d\u518d\u4fdd\u5b58 <code>interrupted_threads</code> \u72b6\u6001</li> <li>Resume \u63a5\u53e3\u53d8\u66f4\uff1a\u5fc5\u987b\u4f20\u5165 <code>thread_id</code>\u3001<code>message_id</code>\u3001<code>approved</code> \u4e09\u4e2a\u53c2\u6570</li> <li>\u53c2\u6570\u6765\u6e90\uff1a\u6240\u6709 resume \u6240\u9700\u53c2\u6570\u90fd\u53ef\u4ee5\u4ece\u4e2d\u65ad\u4e8b\u4ef6\uff08<code>interrupt</code>\uff09\u7684\u8fd4\u56de\u6570\u636e\u4e2d\u83b7\u53d6</li> <li>Checkpointer \u5171\u4eab\uff1aLangGraph \u7684 checkpointer \u5fc5\u987b\u8de8\u8bf7\u6c42\u5171\u4eab\uff0c\u5426\u5219 interrupt/resume \u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c</li> </ol>"},{"location":"_archive/frontend/02_api_design/#\u9644\u5f55v11--v12-\u53d8\u66f4\u6458\u8981","title":"\u9644\u5f55\uff1av1.1 \u2192 v1.2 \u53d8\u66f4\u6458\u8981","text":"\u7ae0\u8282 \u53d8\u66f4\u7c7b\u578b \u8bf4\u660e 6.2 \ud83d\udd04 \u91cd\u5199 \u5b8c\u6574\u7684\u4f9d\u8d56\u6ce8\u5165\u793a\u4f8b\uff0c\u5305\u542b\u8bf7\u6c42\u7ea7\u522b session \u9694\u79bb 6.5 \ud83c\udd95 \u65b0\u589e \u6570\u636e\u5e93\u4f1a\u8bdd\u4e0e\u4e8b\u52a1\u7ba1\u7406\uff08\u5e76\u53d1\u5b89\u5168\u8bbe\u8ba1\uff09 <p>\u5173\u952e\u53d8\u66f4\u8bf4\u660e\uff1a</p> <ol> <li>Controller \u4e0d\u518d\u7ba1\u7406\u4e8b\u52a1\uff1a\u4e8b\u52a1\u8fb9\u754c\u7531 API \u5c42\u7684\u4f9d\u8d56\u6ce8\u5165\u7ba1\u7406</li> <li>\u6bcf\u4e2a\u8bf7\u6c42\u72ec\u7acb\u7684\u7ec4\u4ef6\u94fe\uff1aSession \u2192 Repository \u2192 Manager \u2192 Graph \u2192 Controller</li> <li>Graph \u6bcf\u6b21\u8bf7\u6c42\u521b\u5efa\u65b0\u5b9e\u4f8b\uff1a\u56e0\u4e3a Graph \u6301\u6709 artifact_manager \u5f15\u7528\uff0c\u5171\u4eab\u4f1a\u5bfc\u81f4\u5e76\u53d1\u95ee\u9898</li> </ol>"},{"location":"_archive/frontend/02_api_design/#\u9644\u5f55v10--v11-\u53d8\u66f4\u6458\u8981","title":"\u9644\u5f55\uff1av1.0 \u2192 v1.1 \u53d8\u66f4\u6458\u8981","text":"\u7ae0\u8282 \u53d8\u66f4\u7c7b\u578b \u8bf4\u660e 2.1 \ud83c\udd95 \u65b0\u589e \u5168\u94fe\u8def\u5f02\u6b65 I/O \u5f00\u53d1\u6807\u51c6 3.1 \u66f4\u65b0 \u67b6\u6784\u56fe\u589e\u52a0 StreamManager 4.1 \u66f4\u65b0 resume \u63a5\u53e3\u8bf4\u660e\u589e\u5f3a 4.3 \u66f4\u65b0 SSE \u8fde\u63a5\u751f\u547d\u5468\u671f\u8868 5.1 \u66f4\u65b0 \u65b0\u589e services/stream_manager.py 6.2 \u66f4\u65b0 \u4f9d\u8d56\u6ce8\u5165\u793a\u4f8b\u4ee3\u7801 6.4 \ud83c\udd95 \u65b0\u589e StreamManager \u8be6\u7ec6\u8bbe\u8ba1 7.2 \ud83c\udd95 \u91cd\u5199 \u6743\u9650\u786e\u8ba4\u6d41\u7a0b\u542b SSE \u751f\u547d\u5468\u671f 8 \u66f4\u65b0 \u5b9e\u65bd\u6b65\u9aa4\u589e\u52a0 StreamManager \u76f8\u5173\u4efb\u52a1 10 \u66f4\u65b0 \u4f9d\u8d56\u589e\u52a0 aiofiles 11 \u66f4\u65b0 \u914d\u7f6e\u589e\u52a0 STREAM_TTL"},{"location":"_archive/frontend/03_frontend_design/","title":"Frontend Design: UI &amp; Layout Specification","text":"<p>\u672c\u6587\u6863\u805a\u7126\u4e8e\u9875\u9762\u5e03\u5c40\u3001\u7ec4\u4ef6\u5c42\u7ea7\u3001\u4ea4\u4e92\u884c\u4e3a\u7684\u8bbe\u8ba1\u63cf\u8ff0\u3002</p> <ul> <li>\u89c6\u89c9\u98ce\u683c\u89c4\u8303\uff08\u8272\u5f69\u3001\u6392\u7248\u3001\u95f4\u8ddd\u3001\u7ec4\u4ef6\u6837\u5f0f\uff09\u8be6\u89c1 <code>DESIGN_SYSTEM.md</code></li> <li>API \u63a5\u53e3\u548c\u6570\u636e\u7ed3\u6784\u8be6\u89c1 <code>docs/api.md</code></li> <li>SSE \u4e8b\u4ef6\u534f\u8bae\u548c StreamManager \u8be6\u89c1 <code>docs/streaming.md</code></li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#1-\u9875\u9762\u603b\u4f53\u5e03\u5c40","title":"1. \u9875\u9762\u603b\u4f53\u5e03\u5c40","text":""},{"location":"_archive/frontend/03_frontend_design/#11-\u4e09\u680f\u5e03\u5c40","title":"1.1 \u4e09\u680f\u5e03\u5c40","text":"<p>\u5c55\u5f00\u6001\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502          \u2502  \u2502                     \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2502  \u5de6\u4fa7\u680f   \u2502  \u2502    \u4e2d\u95f4\u533a\uff1a\u5bf9\u8bdd\u9762\u677f   \u2502 \u2506 \u2502    \u53f3\u4fa7\u680f\uff1aArtifact \u9762\u677f \u2502 \u2502\n\u2502  \u2502  240px   \u2502  \u2502    flex: 1          \u2502 \u2506 \u2502    flex: 0~1            \u2502 \u2502\n\u2502  \u2502          \u2502  \u2502                     \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2510 \u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 \u2502 \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502\n\u2502  \u2502  \u2502 \u64cd\u4f5c \u2502 \u2502  \u2502  \u2502               \u2502  \u2502 \u2502 \u2502  \u2502  \u5de5\u5177\u680f           \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502  \u533a  \u2502 \u2502  \u2502  \u2502   \u6d88\u606f\u5217\u8868     \u2502  \u2502 \u2502 \u2502  \u2502  [copy][dl][\u27f3]  \u2502 \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2518 \u2502  \u2502  \u2502               \u2502  \u2502 \u2502 \u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2510 \u2502  \u2502  \u2502               \u2502  \u2502 \u2502 \u2502  \u2502                   \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502 \u5bf9\u8bdd \u2502 \u2502  \u2502  \u2502               \u2502  \u2502 \u2502 \u2502  \u2502  \u5185\u5bb9\u533a           \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502 \u5386\u53f2 \u2502 \u2502  \u2502  \u2502               \u2502  \u2502 \u2502 \u2502  \u2502  (Markdown/Code)  \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502 \u5217\u8868 \u2502 \u2502  \u2502  \u2502               \u2502  \u2502 \u2502 \u2502  \u2502                   \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502     \u2502 \u2502  \u2502  \u2502               \u2502  \u2502 \u2502 \u2502  \u2502                   \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502 [\u00ab] \u2502 \u2502  \u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502 \u2502 \u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 \u2502\n\u2502  \u2502  \u2502     \u2502 \u2502  \u2502  \u2502  \u8f93\u5165\u533a        \u2502  \u2502 \u2502 \u2502  \u2502  \u7248\u672c\u5bfc\u822a          \u2502 \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2518 \u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u2502 \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                         \u2191\n                                    \u62d6\u62fd\u5206\u9694\u6761\n</code></pre> <p>\u6298\u53e0\u6001\uff08\u5de6\u4fa7\u680f\u70b9\u51fb <code>\u00ab</code> \u6298\u53e0\u540e\uff09\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502[+] \u2502  \u2502                           \u2502 \u2506 \u2502                         \u2502 \u2502\n\u2502  \u2502[\ud83d\udccb]\u2502  \u2502       \u4e2d\u95f4\u533a\uff1a\u5bf9\u8bdd\u9762\u677f      \u2502 \u2506 \u2502    \u53f3\u4fa7\u680f\uff1aArtifact \u9762\u677f \u2502 \u2502\n\u2502  \u2502[\ud83d\udcac]\u2502  \u2502       (\u6269\u5c55\u5360\u636e\u66f4\u591a\u5bbd\u5ea6)    \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2502    \u2502  \u2502                           \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2502    \u2502  \u2502                           \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2502    \u2502  \u2502                           \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2502    \u2502  \u2502                           \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2502[\u00bb] \u2502  \u2502                           \u2502 \u2502 \u2502                         \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502  48px                                                                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/frontend/03_frontend_design/#12-\u5de6\u4fa7\u680f\u6298\u53e0","title":"1.2 \u5de6\u4fa7\u680f\u6298\u53e0","text":"<p>\u5de6\u4fa7\u680f\u5e95\u90e8\u63d0\u4f9b\u6298\u53e0/\u5c55\u5f00\u6309\u94ae\uff08<code>\u00ab</code> / <code>\u00bb</code>\uff09\uff1a</p> \u72b6\u6001 \u5bbd\u5ea6 \u663e\u793a\u5185\u5bb9 \u5c55\u5f00 240px \u5b8c\u6574\u64cd\u4f5c\u533a + \u5bf9\u8bdd\u5386\u53f2\u5217\u8868 + \u5e95\u90e8\u6298\u53e0\u6309\u94ae <code>\u00ab</code> \u6298\u53e0 48px \u56fe\u6807\u5217\uff1a<code>[+]</code> \u65b0\u5efa\u5bf9\u8bdd\u3001<code>[\ud83d\udccb]</code> Artifacts\u3001<code>[\ud83d\udcac]</code> \u5bf9\u8bdd\u5217\u8868\u3001\u5e95\u90e8\u5c55\u5f00\u6309\u94ae <code>\u00bb</code> <ul> <li>\u70b9\u51fb\u6298\u53e0\u6309\u94ae\u5207\u6362\u72b6\u6001\uff0c\u5e26 200ms \u8fc7\u6e21\u52a8\u753b</li> <li>\u6298\u53e0\u6001\u56fe\u6807 hover \u663e\u793a tooltip\uff08\"\u65b0\u5efa\u5bf9\u8bdd\" / \"Artifacts\" / \"\u5bf9\u8bdd\u5386\u53f2\"\uff09</li> <li>\u6298\u53e0\u6001\u70b9\u51fb <code>[\ud83d\udcac]</code> \u4ee5 overlay \u5f39\u51fa\u5bf9\u8bdd\u5217\u8868\u6d6e\u5c42\uff0c\u9009\u62e9\u540e\u81ea\u52a8\u6536\u8d77</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#13-\u4e2d\u95f4\u533a\u4e0e\u53f3\u4fa7\u680f\u7684\u62d6\u62fd\u5206\u9694\u6761","title":"1.3 \u4e2d\u95f4\u533a\u4e0e\u53f3\u4fa7\u680f\u7684\u62d6\u62fd\u5206\u9694\u6761","text":"<p>\u4e2d\u95f4\u5bf9\u8bdd\u9762\u677f\u548c\u53f3\u4fa7 Artifact \u9762\u677f\u4e4b\u95f4\u6709\u4e00\u6761\u53ef\u62d6\u62fd\u7684\u5206\u9694\u6761\uff08<code>\u2506</code>\uff09\uff1a</p> <ul> <li>\u62d6\u62fd\u65f6\u5b9e\u65f6\u8c03\u6574\u4e24\u680f\u5bbd\u5ea6\u6bd4\u4f8b</li> <li>\u9f20\u6807\u60ac\u505c\u5206\u9694\u6761\u65f6\u5149\u6807\u53d8\u4e3a <code>col-resize</code></li> <li>\u62d6\u62fd\u8303\u56f4\u7ea6\u675f\uff1a\u4e2d\u95f4\u533a\u6700\u5c0f\u5bbd\u5ea6 400px\uff0c\u53f3\u4fa7\u680f\u6700\u5c0f\u5bbd\u5ea6 300px</li> <li>\u53cc\u51fb\u5206\u9694\u6761\u91cd\u7f6e\u4e3a\u9ed8\u8ba4\u6bd4\u4f8b</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#14-\u54cd\u5e94\u5f0f\u7b56\u7565","title":"1.4 \u54cd\u5e94\u5f0f\u7b56\u7565","text":"\u89c6\u53e3\u5bbd\u5ea6 \u5e03\u5c40\u8c03\u6574 \u2265 1280px \u4e09\u680f\u5b8c\u6574\u5c55\u793a 1024\u20131279px \u5de6\u4fa7\u680f\u81ea\u52a8\u6298\u53e0\u4e3a\u56fe\u6807\u680f\uff0848px\uff09 768\u20131023px \u5de6\u4fa7\u680f\u9690\u85cf\uff08\u6c49\u5821\u83dc\u5355\u5524\u51fa\uff09\uff0cArtifact \u9762\u677f\u4e3a\u8986\u76d6\u5f0f\u62bd\u5c49 &lt; 768px \u5355\u680f\u6a21\u5f0f\uff0c\u5e95\u90e8 Tab \u5207\u6362\u300c\u5bf9\u8bdd / Artifact\u300d <p>\u9762\u677f\u5c3a\u5bf8\u89c4\u5219\uff1a - \u5de6\u4fa7\u680f\u5c55\u5f00 240px / \u6298\u53e0 48px - \u4e2d\u95f4\u533a\u4e0e\u53f3\u4fa7\u680f\u901a\u8fc7\u62d6\u62fd\u5206\u9694\u6761\u8c03\u6574\u6bd4\u4f8b\uff0c\u4e2d\u95f4\u533a\u6700\u5c0f 400px\uff0c\u53f3\u4fa7\u680f\u6700\u5c0f 300px - \u5f53 Artifact \u9762\u677f\u4e0d\u53ef\u89c1\u65f6\uff08\u65e0 artifact \u6216\u7528\u6237\u5173\u95ed\uff09\uff0c\u4e2d\u95f4\u533a\u5360\u636e\u5168\u90e8\u5269\u4f59\u5bbd\u5ea6</p>"},{"location":"_archive/frontend/03_frontend_design/#2-\u5de6\u4fa7\u680f\u5bfc\u822a\u4e0e\u5bf9\u8bdd\u5386\u53f2","title":"2. \u5de6\u4fa7\u680f\uff1a\u5bfc\u822a\u4e0e\u5bf9\u8bdd\u5386\u53f2","text":""},{"location":"_archive/frontend/03_frontend_design/#21-\u9876\u90e8\u64cd\u4f5c\u533a","title":"2.1 \u9876\u90e8\u64cd\u4f5c\u533a","text":"<p>\u5c55\u5f00\u6001\uff1a <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  [+ \u65b0\u5efa\u5bf9\u8bdd]      \u2502   \u4e3b\u64cd\u4f5c\u6309\u94ae\n\u2502  [\ud83d\udccb Artifacts]    \u2502   \u6253\u5f00 Artifact \u5217\u8868\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre></p> <p>\u6298\u53e0\u6001\uff1a <pre><code>\u250c\u2500\u2500\u2500\u2500\u2510\n\u2502[+] \u2502  \u2192 tooltip: \u65b0\u5efa\u5bf9\u8bdd\n\u2502[\ud83d\udccb]\u2502  \u2192 tooltip: Artifacts\n\u2502[\ud83d\udcac]\u2502  \u2192 tooltip: \u5bf9\u8bdd\u5386\u53f2\n\u2514\u2500\u2500\u2500\u2500\u2518\n</code></pre></p> <ul> <li>\u65b0\u5efa\u5bf9\u8bdd\uff1a\u6e05\u7a7a\u5f53\u524d\u5bf9\u8bdd\u72b6\u6001\uff0c\u8def\u7531\u5230 <code>/chat</code></li> <li>\u67e5\u770b Artifacts\uff1a\u6253\u5f00\u53f3\u4fa7\u9762\u677f\u7684 Artifact \u5217\u8868\u89c6\u56fe\uff08\u00a74.4\uff09</li> <li>\u5bf9\u8bdd\u5386\u53f2\uff08\u4ec5\u6298\u53e0\u6001\uff09\uff1a\u70b9\u51fb\u5f39\u51fa\u5bf9\u8bdd\u5217\u8868\u6d6e\u5c42</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#22-\u5386\u53f2\u5bf9\u8bdd\u5217\u8868","title":"2.2 \u5386\u53f2\u5bf9\u8bdd\u5217\u8868","text":"<p>\u6bcf\u6761\u5bf9\u8bdd\u9879\u5c55\u793a\uff1a - \u5bf9\u8bdd\u6807\u9898\uff08\u622a\u65ad \u2264 30 \u5b57\u7b26\uff09 - \u6700\u540e\u66f4\u65b0\u65f6\u95f4\uff08\u76f8\u5bf9\u65f6\u95f4\uff1a\u521a\u521a / 3\u5206\u949f\u524d / \u6628\u5929 / 1\u67085\u65e5\uff09 - Hover \u65f6\u53f3\u4fa7\u51fa\u73b0 <code>\u22ef</code> \u64cd\u4f5c\u83dc\u5355\uff08\u91cd\u547d\u540d / \u5220\u9664\uff09</p> <p>\u4ea4\u4e92\uff1a - \u70b9\u51fb\u5207\u6362\u5230\u8be5\u5bf9\u8bdd - \u5f53\u524d\u5bf9\u8bdd\u9879\u9ad8\u4eae - \u5217\u8868\u6309\u6700\u8fd1\u66f4\u65b0\u6392\u5e8f - \u521d\u59cb\u52a0\u8f7d\u6700\u8fd1 20 \u6761\uff0c\u5e95\u90e8\u300c\u52a0\u8f7d\u66f4\u591a\u300d\u6309\u94ae</p>"},{"location":"_archive/frontend/03_frontend_design/#23-\u672a\u6765\u6269\u5c55\u9884\u7559","title":"2.3 \u672a\u6765\u6269\u5c55\u9884\u7559","text":"<p>\u5e95\u90e8\u533a\u57df\u9884\u7559\uff1a - \u767b\u5f55\u5165\u53e3 - \u8bbe\u7f6e\u6309\u94ae</p>"},{"location":"_archive/frontend/03_frontend_design/#3-\u4e2d\u95f4\u533a\u5bf9\u8bdd\u4e3b\u9762\u677f","title":"3. \u4e2d\u95f4\u533a\uff1a\u5bf9\u8bdd\u4e3b\u9762\u677f","text":""},{"location":"_archive/frontend/03_frontend_design/#31-\u6d88\u606f\u6c14\u6ce1\u7ed3\u6784","title":"3.1 \u6d88\u606f\u6c14\u6ce1\u7ed3\u6784","text":""},{"location":"_archive/frontend/03_frontend_design/#\u7528\u6237\u6d88\u606f","title":"\u7528\u6237\u6d88\u606f","text":"<p>\u9760\u53f3\u5bf9\u9f50\u7684\u6c14\u6ce1\u6846\uff0c\u652f\u6301 Markdown \u6e32\u67d3\uff1a</p> <pre><code>                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502  \u6d88\u606f\u5185\u5bb9\u6587\u672c\uff08Markdown\uff09\u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    [Copy] [Edit] [Rerun]\n</code></pre> <p>\u64cd\u4f5c\u6309\u94ae hover \u65f6\u663e\u793a\uff1a - Copy\uff1a\u590d\u5236\u6d88\u606f\u6587\u672c - Edit\uff1a\u7f16\u8f91\u6b64\u6d88\u606f\u5e76\u91cd\u65b0\u53d1\u9001\uff08\u521b\u5efa\u5206\u652f\uff0c\u89c1 \u00a73.3\uff09 - Rerun\uff1a\u4ee5\u76f8\u540c\u5185\u5bb9\u91cd\u65b0\u53d1\u9001\uff08\u521b\u5efa\u5144\u5f1f\u5206\u652f\uff0c\u89c1 \u00a73.3\uff09</p>"},{"location":"_archive/frontend/03_frontend_design/#\u52a9\u624b\u6d88\u606f","title":"\u52a9\u624b\u6d88\u606f","text":"<p>\u4e0d\u4f7f\u7528\u6c14\u6ce1\u6846\uff0c\u5185\u5bb9\u81ea\u7136\u94fa\u6ee1\u4e2d\u95f4\u533a\u5bbd\u5ea6\uff0c\u652f\u6301 Markdown \u6e32\u67d3\uff08\u6807\u9898\u3001\u5217\u8868\u3001\u8868\u683c\u3001\u4ee3\u7801\u5757\u7b49\uff09\u3002\u91c7\u7528\u5206\u5c42\u6298\u53e0\u7ed3\u6784\uff0c\u5b8c\u6210\u540e\u53ea\u5c55\u793a\u6700\u7ec8\u54cd\u5e94\uff1a</p> <pre><code>\u25b6 Lead Agent (thinking)              \u2190 \u6298\u53e0\n\u25b6 \ud83d\udd27 web_search (0.8s) \u2713            \u2190 \u6298\u53e0\n\u25b6 Search Agent (thinking)            \u2190 \u6298\u53e0\n\u25b6 \ud83d\udd27 crawl_page (2.1s) \u2713            \u2190 \u6298\u53e0\n\n\u6700\u7ec8\u54cd\u5e94\u5185\u5bb9\uff08Markdown \u5168\u5bbd\u6e32\u67d3\uff09\n# \u6807\u9898\n\u6b63\u6587\u6bb5\u843d\uff0c\u652f\u6301 **\u52a0\u7c97**\u3001`\u4ee3\u7801`\u3001\u94fe\u63a5\u7b49...\n- \u5217\u8868\u9879 A\n- \u5217\u8868\u9879 B\n\n[Copy]\n</code></pre> <p>\u6298\u53e0\u89c4\u5219\uff08\u5b8c\u6210\u6001\uff09\uff1a</p> UI \u5143\u7d20 \u9ed8\u8ba4\u72b6\u6001 \u8bf4\u660e Thinking \u5185\u5bb9 \u6298\u53e0 \u6298\u53e0\u4e3a\u4e00\u884c\u6807\u7b7e <code>\u25b6 Agent (thinking)</code>\uff0c\u70b9\u51fb\u5c55\u5f00 \u5de5\u5177\u8c03\u7528 \u6298\u53e0 \u6298\u53e0\u4e3a\u4e00\u884c <code>\u25b6 \ud83d\udd27 tool_name (\u8017\u65f6) \u2713/\u2717</code>\uff0c\u70b9\u51fb\u5c55\u5f00\u67e5\u770b\u53c2\u6570\u548c\u7ed3\u679c Agent \u5207\u6362 \u6298\u53e0 \u663e\u793a agent \u540d\u79f0\u6807\u7b7e\uff0c\u5c55\u5f00\u67e5\u770b\u8be6\u60c5 \u6700\u7ec8\u54cd\u5e94 \u5c55\u5f00 Markdown \u6e32\u67d3\u7684\u6700\u7ec8\u8f93\u51fa\uff0c\u59cb\u7ec8\u53ef\u89c1 \u6743\u9650\u786e\u8ba4 \u5c55\u5f00 \u5386\u53f2\u6d88\u606f\u4e2d\u663e\u793a\u4e3a\u5df2\u786e\u8ba4/\u5df2\u62d2\u7edd\u7684\u8bb0\u5f55"},{"location":"_archive/frontend/03_frontend_design/#32-sse-\u5de5\u4f5c\u6d41\u72b6\u6001\u5c55\u793a\u6d41\u5f0f\u8fdb\u884c\u4e2d","title":"3.2 SSE \u5de5\u4f5c\u6d41\u72b6\u6001\u5c55\u793a\uff08\u6d41\u5f0f\u8fdb\u884c\u4e2d\uff09","text":"<p>\u6d41\u5f0f\u8f93\u51fa\u8fdb\u884c\u4e2d\u65f6\uff0c\u6d88\u606f\u533a\u5e95\u90e8\u5c55\u793a\u5b9e\u65f6\u6267\u884c\u72b6\u6001\u3002\u5404 SSE \u4e8b\u4ef6\u7c7b\u578b\u5bf9\u5e94\u7684 UI \u884c\u4e3a\uff1a</p> <p>SSE \u4e8b\u4ef6\u7c7b\u578b\u5b9a\u4e49\u548c\u6570\u636e\u683c\u5f0f\u8be6\u89c1 <code>streaming.md</code></p>"},{"location":"_archive/frontend/03_frontend_design/#agent-\u6267\u884c\u6307\u793a\u5668","title":"Agent \u6267\u884c\u6307\u793a\u5668","text":"<p>\u89e6\u53d1\u4e8b\u4ef6\uff1a<code>agent_start</code></p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \ud83e\udd16 Lead Agent                \u25cf \u6267\u884c\u4e2d  \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n</code></pre> <p>\u663e\u793a\u5f53\u524d\u6267\u884c agent \u540d\u79f0\u548c\u8fd0\u884c\u72b6\u6001 badge\u3002\u5f53 <code>agent_complete</code> \u540e\u6709 routing \u5230\u4e0b\u4e00\u4e2a agent \u65f6\uff0c\u663e\u793a\u8f6c\u4ea4\u6307\u793a\uff1a</p> <pre><code>\u2502  \u2713 Lead Agent \u2192 Search Agent           \u2502\n</code></pre>"},{"location":"_archive/frontend/03_frontend_design/#thinking-\u6298\u53e0\u533a","title":"Thinking \u6298\u53e0\u533a","text":"<p>\u89e6\u53d1\u4e8b\u4ef6\uff1a<code>llm_chunk</code>\uff08\u5f53 <code>data.reasoning_content</code> \u589e\u957f\u65f6\uff09</p> <pre><code>\u2502  \u25bc Thinking...                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502  \uff08reasoning \u5185\u5bb9\u5b9e\u65f6\u66f4\u65b0\uff09        \u2502   \u2502\n\u2502  \u2502  \u7528\u6237\u9700\u8981\u4e86\u89e3 XX \u7684\u6700\u65b0\u4fe1\u606f...     \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n</code></pre> <ul> <li>\u9ed8\u8ba4\u6298\u53e0\uff0c\u663e\u793a <code>\u25b6 Thinking...</code> + \u65cb\u8f6c\u52a8\u753b</li> <li>\u7528\u6237\u53ef\u70b9\u51fb\u5c55\u5f00\u67e5\u770b\u5b9e\u65f6 reasoning \u5185\u5bb9</li> <li>\u5f53 <code>reasoning_content</code> \u505c\u6b62\u589e\u957f\u3001<code>content</code> \u5f00\u59cb\u589e\u957f\u65f6\uff0cthinking \u533a\u81ea\u52a8\u6298\u53e0</li> </ul> <p>\u5224\u65ad\u903b\u8f91\uff08\u53c2\u8003 CLI <code>StreamDisplay.handle_event</code>\uff09\uff1a - <code>reasoning_content</code> \u6709\u503c\u4e14 <code>content</code> \u4e3a\u7a7a \u2192 \u6b63\u5728 thinking - <code>content</code> \u5f00\u59cb\u51fa\u73b0 \u2192 thinking \u7ed3\u675f\uff0c\u5207\u6362\u5230\u8f93\u51fa\u6e32\u67d3</p>"},{"location":"_archive/frontend/03_frontend_design/#\u5de5\u5177\u8c03\u7528\u5361\u7247","title":"\u5de5\u5177\u8c03\u7528\u5361\u7247","text":"<p>\u89e6\u53d1\u4e8b\u4ef6\uff1a<code>tool_start</code> \u2192 <code>tool_complete</code></p> <p>\u8fdb\u884c\u4e2d\u72b6\u6001\uff1a <pre><code>\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502  \ud83d\udd27 web_search        \u27f3 \u6267\u884c\u4e2d  \u2502   \u2502\n\u2502  \u2502  query: \"AI \u6700\u65b0\u8fdb\u5c55\"            \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n</code></pre></p> <p>\u5b8c\u6210\u72b6\u6001\uff1a <pre><code>\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502  \ud83d\udd27 web_search    \u2713 \u6210\u529f (0.8s) \u2502   \u2502\n\u2502  \u2502  query: \"AI \u6700\u65b0\u8fdb\u5c55\"            \u2502   \u2502\n\u2502  \u2502  \u2192 3 results returned           \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n</code></pre></p> <p>\u5931\u8d25\u72b6\u6001\uff1a <pre><code>\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502  \ud83d\udd27 crawl_page    \u2717 \u5931\u8d25 (5.2s) \u2502   \u2502\n\u2502  \u2502  url: \"https://example.com\"     \u2502   \u2502\n\u2502  \u2502  \u2192 Error: Connection timeout    \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n</code></pre></p> <p>\u5361\u7247\u4fe1\u606f\u6765\u6e90\uff1a - <code>tool_start</code> \u4e8b\u4ef6 \u2192 \u5de5\u5177\u540d\u3001\u53c2\u6570\u6458\u8981\u3001loading spinner - <code>tool_complete</code> \u4e8b\u4ef6 \u2192 \u6210\u529f/\u5931\u8d25\u72b6\u6001\u3001\u8017\u65f6\uff08<code>duration_ms</code>\uff09\u3001\u7ed3\u679c\u6458\u8981\uff08<code>result_data</code>\uff09</p> <p>\u53c2\u6570\u663e\u793a\u7b56\u7565\uff1a\u622a\u53d6\u5173\u952e\u53c2\u6570\uff0c\u8d85\u8fc7 80 \u5b57\u7b26\u7701\u7565\u3002\u7ed3\u679c\u6458\u8981\u683c\u5f0f\u53c2\u8003 CLI <code>StreamDisplay._format_result_data()</code> \u7684\u903b\u8f91\u3002</p>"},{"location":"_archive/frontend/03_frontend_design/#final-response-\u5c55\u5f00\u533a","title":"Final Response \u5c55\u5f00\u533a","text":"<p>\u89e6\u53d1\u4e8b\u4ef6\uff1a<code>llm_chunk</code>\uff08\u5f53 <code>data.content</code> \u589e\u957f\u65f6\uff09</p> <pre><code>\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u6700\u7ec8\u54cd\u5e94\u5185\u5bb9\uff0c\u5b9e\u65f6\u6253\u5b57\u673a\u6548\u679c\u6e32\u67d3...      \u2502\n\u2502  \u652f\u6301 Markdown \u683c\u5f0f \u258a                   \u2502\n</code></pre> <ul> <li>\u4f7f\u7528 Markdown \u5b9e\u65f6\u6e32\u67d3\uff08<code>react-markdown</code>\uff09</li> <li>\u5149\u6807\u95ea\u70c1\u6548\u679c\uff08CSS \u52a8\u753b\uff09</li> <li>\u81ea\u52a8\u6eda\u52a8\u5230\u5e95\u90e8</li> </ul> <p>\u6d41\u5f0f\u7ed3\u675f\u540e\uff08\u6536\u5230 <code>complete</code> \u4e8b\u4ef6\uff09\uff1a\u6240\u6709\u4e2d\u95f4\u6b65\u9aa4\uff08thinking\u3001tool \u5361\u7247\u3001agent \u5207\u6362\uff09\u9ed8\u8ba4\u6298\u53e0\u4e3a\u4e00\u884c\u6458\u8981\uff0c\u53ea\u5c55\u793a\u6700\u7ec8 response\u3002</p>"},{"location":"_archive/frontend/03_frontend_design/#33-\u5bf9\u8bdd\u6811\u4e0e\u5206\u652f","title":"3.3 \u5bf9\u8bdd\u6811\u4e0e\u5206\u652f","text":"<p>\u4f9d\u8d56\u540e\u7aef <code>ConversationDetailResponse.messages</code> \u7684 <code>parent_id</code> / <code>children</code> \u5b57\u6bb5\u6784\u5efa\u6d88\u606f\u6811\u3002</p> <p>\u6570\u636e\u7ed3\u6784\u8be6\u89c1 <code>api.md</code> \u4e2d <code>GET /api/v1/chat/{id}</code> \u7684\u54cd\u5e94\u683c\u5f0f</p>"},{"location":"_archive/frontend/03_frontend_design/#edit-\u89e6\u53d1\u5206\u652f","title":"Edit \u89e6\u53d1\u5206\u652f","text":"<ol> <li>\u7528\u6237\u70b9\u51fb\u67d0\u6761\u5df2\u53d1\u9001\u6d88\u606f\u7684 Edit \u6309\u94ae</li> <li>\u8be5\u6d88\u606f\u53d8\u4e3a\u53ef\u7f16\u8f91\u8f93\u5165\u6846\uff0c\u9884\u586b\u539f\u59cb\u5185\u5bb9</li> <li>\u7528\u6237\u4fee\u6539\u540e\u63d0\u4ea4</li> <li>\u8c03\u7528 <code>POST /api/v1/chat</code>\uff0c<code>parent_message_id</code> \u8bbe\u4e3a\u88ab\u7f16\u8f91\u6d88\u606f\u7684\u7236\u8282\u70b9 ID</li> <li>\u540e\u7aef\u521b\u5efa\u65b0\u6d88\u606f\uff08\u65b0\u7684\u5206\u652f\uff09\uff0c\u524d\u7aef\u81ea\u52a8\u5207\u6362\u5230\u65b0\u5206\u652f</li> </ol>"},{"location":"_archive/frontend/03_frontend_design/#rerun-\u7684\u8bed\u4e49","title":"Rerun \u7684\u8bed\u4e49","text":"<ol> <li>\u7528\u6237\u70b9\u51fb\u67d0\u6761\u6d88\u606f\u7684 Rerun \u6309\u94ae</li> <li>\u4ee5\u5b8c\u5168\u76f8\u540c\u7684\u5185\u5bb9\u91cd\u65b0\u53d1\u9001</li> <li><code>parent_message_id</code> \u8bbe\u4e3a\u540c\u4e00\u4e2a\u7236\u8282\u70b9\uff08\u521b\u5efa\u5144\u5f1f\u5206\u652f\uff09</li> <li>\u540e\u7aef\u91cd\u65b0\u6267\u884c\uff0c\u524d\u7aef\u5207\u6362\u5230\u65b0\u5206\u652f</li> </ol>"},{"location":"_archive/frontend/03_frontend_design/#\u5206\u652f\u5bfc\u822a-ui","title":"\u5206\u652f\u5bfc\u822a UI","text":"<p>\u5f53\u67d0\u4e2a\u4f4d\u7f6e\u5b58\u5728\u591a\u4e2a\u5144\u5f1f\u6d88\u606f\uff08\u540c\u4e00 <code>parent_id</code> \u4e0b\u6709\u591a\u4e2a <code>children</code>\uff09\u65f6\uff0c\u5728\u6d88\u606f\u4e0a\u65b9\u663e\u793a\u5206\u652f\u5bfc\u822a\u5668\uff1a</p> <pre><code>            \u25c0  2 / 3  \u25b6\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u6d88\u606f\u5185\u5bb9...                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u663e\u793a\u5f53\u524d\u5206\u652f\u5e8f\u53f7 / \u603b\u5206\u652f\u6570</li> <li><code>\u25c0</code> <code>\u25b6</code> \u6309\u94ae\u5207\u6362\u5206\u652f</li> <li>\u5207\u6362\u65f6\uff0c\u8be5\u6d88\u606f\u53ca\u5176\u6240\u6709\u5b50\u6d88\u606f\u540c\u6b65\u66f4\u65b0</li> </ul> <p>\u6811\u6784\u5efa\u903b\u8f91\uff1a - \u540e\u7aef\u8fd4\u56de\u7684 <code>messages</code> \u662f\u6241\u5e73\u6570\u7ec4\uff0c\u6bcf\u6761\u6d88\u606f\u542b <code>parent_id</code> \u548c <code>children</code> \u5b57\u6bb5 - \u524d\u7aef\u7ef4\u62a4\u4e00\u6761 <code>currentBranchPath: string[]</code>\uff08\u4ece\u6839\u5230\u5f53\u524d\u53f6\u8282\u70b9\u7684 message ID \u5217\u8868\uff09 - \u5207\u6362\u5206\u652f\u65f6\uff0c\u627e\u5230\u5206\u652f\u70b9\uff0c\u66ff\u6362\u8be5\u70b9\u4e4b\u540e\u7684\u8def\u5f84</p>"},{"location":"_archive/frontend/03_frontend_design/#34-\u8f93\u5165\u533a","title":"3.4 \u8f93\u5165\u533a","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502  \u8f93\u5165\u6d88\u606f...                       \u2502  \u2502  \u53d1\u9001 \u2191 \u2502 \u2502\n\u2502  \u2502                                   \u2502  \u2502        \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502  [\ud83d\udcce]                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u6587\u672c\u8f93\u5165\uff1a\u652f\u6301\u591a\u884c\uff0c<code>Enter</code> \u53d1\u9001\uff0c<code>Shift+Enter</code> \u6362\u884c</li> <li>\u53d1\u9001\u6309\u94ae\uff1a\u6d41\u5f0f\u6267\u884c\u4e2d\u53d8\u4e3a Stop \u6309\u94ae\uff08\u53d6\u6d88\u5f53\u524d\u6267\u884c\uff09</li> <li>\u9644\u4ef6\u6309\u94ae <code>[\ud83d\udcce]</code>\uff1a\u9884\u7559\uff0c\u672a\u6765\u652f\u6301\u6587\u4ef6\u4e0a\u4f20</li> <li>\u6d41\u5f0f\u6267\u884c\u4e2d\u8f93\u5165\u533a\u7981\u7528\uff08\u663e\u793a \"\u7b49\u5f85\u54cd\u5e94...\" \u5360\u4f4d\u6587\u672c\uff09</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#4-\u53f3\u4fa7\u680fartifact-\u9762\u677f","title":"4. \u53f3\u4fa7\u680f\uff1aArtifact \u9762\u677f","text":"<p>Artifact \u9762\u677f\u5728\u4ee5\u4e0b\u65f6\u673a\u81ea\u52a8\u6253\u5f00\uff1a - \u76d1\u542c\u5230 <code>tool_complete</code> \u4e8b\u4ef6\u4e2d artifact \u76f8\u5173\u5de5\u5177\u6267\u884c\u6210\u529f\u65f6 - \u7528\u6237\u4ece\u5bf9\u8bdd\u4e2d\u70b9\u51fb artifact \u5f15\u7528\u94fe\u63a5\u65f6</p> <p>\u5f53\u9762\u677f\u5904\u4e8e\u6536\u8d77\u72b6\u6001\u65f6\uff08\u4f8b\u5982\u52a0\u8f7d\u5386\u53f2\u5bf9\u8bdd\uff09\uff0c\u5bf9\u8bdd\u8f93\u5165\u533a\u53f3\u4fa7\u663e\u793a\u4e00\u4e2a <code>[\ud83d\udcc4]</code> toggle \u6309\u94ae\uff0c\u70b9\u51fb\u53ef\u624b\u52a8\u5c55\u5f00/\u6536\u8d77 Artifact \u9762\u677f\u3002\u5f53\u9762\u677f\u5df2\u5c55\u5f00\u65f6\u8be5\u6309\u94ae\u4ecd\u53ef\u89c1\uff0c\u7528\u4e8e\u624b\u52a8\u6536\u8d77\u3002</p>"},{"location":"_archive/frontend/03_frontend_design/#41-\u9876\u90e8\u5de5\u5177\u680f","title":"4.1 \u9876\u90e8\u5de5\u5177\u680f","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \ud83d\udcc4 research_report          v3 \u25be       \u2502\n\u2502  [Copy] [Download] [\u27f3 Refresh] [\u2261 List] \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u6807\u9898\u533a\uff1a\u5f53\u524d artifact \u7684 title + \u7248\u672c\u9009\u62e9\u5668</li> <li>Copy\uff1a\u590d\u5236\u5f53\u524d\u5185\u5bb9\u5230\u526a\u8d34\u677f</li> <li>Download\uff1a\u4e0b\u8f7d\u4e3a\u6587\u4ef6\uff08\u6839\u636e <code>content_type</code> \u786e\u5b9a\u6269\u5c55\u540d\uff09</li> <li>Refresh\uff1a\u624b\u52a8\u5237\u65b0\u5f53\u524d artifact \u5185\u5bb9</li> <li>List\uff1a\u5207\u6362\u5230 Artifact \u5217\u8868\u89c6\u56fe\uff08\u00a74.4\uff09</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#42-\u6e32\u67d3\u6a21\u5f0fmarkdown-preview","title":"4.2 \u6e32\u67d3\u6a21\u5f0f\uff1aMarkdown Preview","text":"<p>\u9ed8\u8ba4\u6e32\u67d3\u6a21\u5f0f\uff0c\u9002\u7528\u4e8e <code>content_type</code> \u4e3a <code>markdown</code> \u7684 artifact\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  [Preview] [Source] [Diff]               \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502\n\u2502                                          \u2502\n\u2502  # \u7814\u7a76\u62a5\u544a\u6807\u9898                           \u2502\n\u2502                                          \u2502\n\u2502  ## 1. \u6982\u8ff0                              \u2502\n\u2502  \u8fd9\u662f\u4e00\u4efd\u5173\u4e8e AI \u6700\u65b0\u8fdb\u5c55\u7684\u7814\u7a76\u62a5\u544a...     \u2502\n\u2502                                          \u2502\n\u2502  ## 2. \u4e3b\u8981\u53d1\u73b0                           \u2502\n\u2502  - \u53d1\u73b0 A                                \u2502\n\u2502  - \u53d1\u73b0 B                                \u2502\n\u2502                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u4f7f\u7528 <code>react-markdown</code> + <code>remark-gfm</code> \u6e32\u67d3</li> <li>\u652f\u6301\u8868\u683c\u3001\u4ee3\u7801\u5757\uff08\u8bed\u6cd5\u9ad8\u4eae\uff09\u3001\u94fe\u63a5</li> <li>\u5bf9\u4e8e <code>content_type</code> \u4e3a <code>python</code>/<code>javascript</code> \u7b49\u4ee3\u7801\u7c7b\u578b\uff0cPreview \u6a21\u5f0f\u663e\u793a\u8bed\u6cd5\u9ad8\u4eae\u7684\u4ee3\u7801</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#43-\u6e32\u67d3\u6a21\u5f0fsource--git-diff","title":"4.3 \u6e32\u67d3\u6a21\u5f0f\uff1aSource + Git Diff","text":""},{"location":"_archive/frontend/03_frontend_design/#source-\u6a21\u5f0f","title":"Source \u6a21\u5f0f","text":"<p>\u663e\u793a artifact \u539f\u59cb\u5185\u5bb9\uff0c\u5e26\u884c\u53f7\u548c\u8bed\u6cd5\u9ad8\u4eae\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  [Preview] [Source] [Diff]               \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502\n\u2502   1 \u2502 # \u7814\u7a76\u62a5\u544a\u6807\u9898                      \u2502\n\u2502   2 \u2502                                    \u2502\n\u2502   3 \u2502 ## 1. \u6982\u8ff0                         \u2502\n\u2502   4 \u2502 \u8fd9\u662f\u4e00\u4efd\u5173\u4e8e AI \u6700\u65b0\u8fdb\u5c55...          \u2502\n\u2502  ...                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/frontend/03_frontend_design/#diff-\u6a21\u5f0f","title":"Diff \u6a21\u5f0f","text":"<p>\u70b9\u51fb Diff Tab \u540e\uff0c\u8fdb\u5165\u7248\u672c\u5bf9\u6bd4\u89c6\u56fe\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  [Preview] [Source] [Diff]               \u2502\n\u2502  \u5bf9\u6bd4: v2 \u25be \u2190\u2192 v3 \u25be                     \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502\n\u2502   - \u65e7\u7248\u672c\u88ab\u5220\u9664\u7684\u884c                      \u2502\n\u2502   + \u65b0\u7248\u672c\u65b0\u589e\u7684\u884c                        \u2502\n\u2502     \u672a\u53d8\u5316\u7684\u4e0a\u4e0b\u6587\u884c                       \u2502\n\u2502  ...                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u9ed8\u8ba4\u5bf9\u6bd4 \u5f53\u524d\u7248\u672c vs \u4e0a\u4e00\u7248\u672c</li> <li>\u4e24\u4e2a\u7248\u672c\u9009\u62e9\u5668\u53ef\u72ec\u7acb\u8c03\u6574</li> <li>Diff \u6570\u636e\u6765\u6e90\uff1a<code>VersionDetailResponse.changes</code> \u5b57\u6bb5\uff08<code>[[old_text, new_text], ...]</code>\uff09</li> <li>\u4f7f\u7528 unified diff \u683c\u5f0f\u5c55\u793a\uff0c\u9ad8\u4eae\u589e\u5220\u884c</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#44-artifact-\u5217\u8868\u89c6\u56fe","title":"4.4 Artifact \u5217\u8868\u89c6\u56fe","text":"<p>\u70b9\u51fb\u5de5\u5177\u680f List \u6309\u94ae\u65f6\u5207\u6362\u5230\u5217\u8868\u89c6\u56fe\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u2261 Artifacts (3)            [\u2190 \u8fd4\u56de]    \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  \ud83d\udcc4 research_report     v3        \u2502  \u2502\n\u2502  \u2502  markdown \u00b7 \u66f4\u65b0\u4e8e 2 \u5206\u949f\u524d        \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  \ud83d\udcc4 data_analysis       v1   \ud83d\udd34   \u2502  \u2502\n\u2502  \u2502  python \u00b7 \u66f4\u65b0\u4e8e 5 \u5206\u949f\u524d          \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  \ud83d\udcc4 summary             v2        \u2502  \u2502\n\u2502  \u2502  markdown \u00b7 \u66f4\u65b0\u4e8e 10 \u5206\u949f\u524d       \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u6bcf\u9879\u663e\u793a artifact ID\u3001\u6807\u9898\u3001\u7248\u672c\u53f7\u3001content_type\u3001\u66f4\u65b0\u65f6\u95f4</li> <li>\ud83d\udd34 \u5c0f\u5706\u70b9\u6807\u8bb0\u6709\u5f85\u5237\u65b0\u7684 artifact\uff08<code>pendingUpdates</code>\uff09</li> <li>\u70b9\u51fb\u67d0\u9879\u5207\u6362\u5230\u8be5 artifact \u7684\u5185\u5bb9\u89c6\u56fe</li> <li>\u8fd4\u56de \u6309\u94ae\u56de\u5230\u5f53\u524d artifact \u5185\u5bb9\u89c6\u56fe</li> </ul>"},{"location":"_archive/frontend/03_frontend_design/#45-\u7248\u672c\u5bfc\u822a","title":"4.5 \u7248\u672c\u5bfc\u822a","text":"<p>\u7248\u672c\u9009\u62e9\u5668\u4f4d\u4e8e\u5de5\u5177\u680f\u6807\u9898\u65c1\uff1a</p> <pre><code>  v3 \u25be\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502 v3 (\u6700\u65b0) - rewrite \u2502\n  \u2502 v2 - update        \u2502\n  \u2502 v1 - create        \u2502\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u4e0b\u62c9\u5217\u8868\u663e\u793a\u6240\u6709\u7248\u672c\u53f7 + \u66f4\u65b0\u7c7b\u578b\uff08<code>update_type</code>\uff09</li> <li>\u9009\u62e9\u7248\u672c\u540e\u52a0\u8f7d\u8be5\u7248\u672c\u5185\u5bb9</li> <li>\u4f7f\u7528\u7248\u672c\u7f13\u5b58\u907f\u514d\u91cd\u590d\u8bf7\u6c42</li> </ul> <p>\u5b9e\u65f6\u66f4\u65b0\uff1a - \u6d41\u5f0f\u6267\u884c\u4e2d\uff0c\u76d1\u542c <code>tool_complete</code> \u4e8b\u4ef6\uff0c\u5f53 artifact \u5de5\u5177\uff08<code>create_artifact</code>/<code>update_artifact</code>/<code>rewrite_artifact</code>\uff09\u6210\u529f\u65f6\uff0c\u6807\u8bb0\u8be5 artifact \u6709\u66f4\u65b0 - Tab \u4e0a\u663e\u793a \ud83d\udd34 \u66f4\u65b0\u6307\u793a - \u6d41\u7ed3\u675f\u540e\u7edf\u4e00\u5237\u65b0\u6709\u66f4\u65b0\u7684 artifact\uff08\u907f\u514d\u6d41\u5f0f\u4e2d\u9891\u7e41\u8bf7\u6c42\uff09 - \u7528\u6237\u4e5f\u53ef\u5728\u6d41\u5f0f\u8fdb\u884c\u4e2d\u70b9\u51fb Refresh \u624b\u52a8\u5237\u65b0\u5355\u4e2a artifact</p>"},{"location":"_archive/frontend/03_frontend_design/#5-\u6743\u9650\u786e\u8ba4\u5f39\u7a97","title":"5. \u6743\u9650\u786e\u8ba4\u5f39\u7a97","text":"<p>\u5f53 SSE \u6d41\u6536\u5230 <code>permission_request</code> \u4e8b\u4ef6\u540e\uff0c\u968f\u540e\u4f1a\u6536\u5230 <code>complete(interrupted=true)</code> \u4e8b\u4ef6\uff08SSE \u8fde\u63a5\u5173\u95ed\uff09\u3002\u6b64\u65f6\u5f39\u51fa\u6a21\u6001\u5bf9\u8bdd\u6846\uff1a</p> <p>\u6743\u9650\u4e2d\u65ad\u548c\u6062\u590d\u7684\u5b8c\u6574\u6d41\u7a0b\u8be6\u89c1 <code>streaming.md</code></p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502          \u26a0\ufe0f  \u6743\u9650\u786e\u8ba4                     \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502                                          \u2502\n\u2502  \u5de5\u5177: crawl_page                        \u2502\n\u2502  \u6743\u9650\u7ea7\u522b: CONFIRM                       \u2502\n\u2502                                          \u2502\n\u2502  \u53c2\u6570:                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  url: \"https://example.com/page\"  \u2502  \u2502\n\u2502  \u2502  ...                              \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                          \u2502\n\u2502         [\u62d2\u7edd]          [\u786e\u8ba4\u6267\u884c]        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u4ea4\u4e92\u6d41\u7a0b\uff1a 1. \u5f39\u7a97\u51fa\u73b0\u65f6\uff0cSSE \u8fde\u63a5\u5df2\u5173\u95ed\uff08<code>complete(interrupted=true)</code> \u5df2\u6536\u5230\uff09 2. \u5f39\u7a97\u4e3a\u6a21\u6001\u8986\u76d6\u5c42\uff0c\u963b\u65ad\u5176\u4ed6\u64cd\u4f5c 3. \u5c55\u793a\u5de5\u5177\u540d\u79f0\u3001\u6743\u9650\u7ea7\u522b\u3001\u8c03\u7528\u53c2\u6570 4. \u7528\u6237\u70b9\u51fb\u300c\u786e\u8ba4\u6267\u884c\u300d\u6216\u300c\u62d2\u7edd\u300d 5. \u8c03\u7528 <code>POST /api/v1/chat/{id}/resume</code>\uff08<code>approved: true/false</code>\uff09 6. \u83b7\u53d6\u65b0\u7684 <code>stream_url</code>\uff0c\u5efa\u7acb\u65b0\u7684 SSE \u8fde\u63a5 7. \u65b0\u6d41\u4e2d\u6536\u5230 <code>permission_result</code> \u2192 \u7ee7\u7eed\u540e\u7eed\u5de5\u5177\u6267\u884c</p>"},{"location":"_archive/frontend/03_frontend_design/#6-\u72b6\u6001\u7ba1\u7406\u6982\u8981","title":"6. \u72b6\u6001\u7ba1\u7406\u6982\u8981","text":"<p>\u5efa\u8bae\u4f7f\u7528 Zustand \u6309\u804c\u8d23\u5212\u5206 4 \u4e2a store\uff1a</p> Store \u804c\u8d23 \u5173\u952e\u72b6\u6001 <code>conversationStore</code> \u5bf9\u8bdd\u5217\u8868\u3001\u5f53\u524d\u5bf9\u8bdd\u3001\u6d88\u606f\u6811\u3001\u5206\u652f\u8def\u5f84 <code>conversations</code>, <code>currentConversation</code>, <code>currentBranchPath</code> <code>artifactStore</code> Artifact \u5217\u8868\u3001\u5f53\u524d\u9009\u4e2d\u9879\u3001\u7248\u672c\u7f13\u5b58\u3001\u66f4\u65b0\u6807\u8bb0 <code>artifacts</code>, <code>currentArtifact</code>, <code>versionCache</code>, <code>pendingUpdates</code> <code>streamStore</code> \u6d41\u5f0f\u6267\u884c\u72b6\u6001\u3001\u5f53\u524d agent\u3001\u5de5\u5177\u8c03\u7528\u5217\u8868\u3001\u6743\u9650\u8bf7\u6c42 <code>isStreaming</code>, <code>streamContent</code>, <code>reasoningContent</code>, <code>toolCalls</code> <code>uiStore</code> \u9762\u677f\u6298\u53e0\u72b6\u6001\u3001\u89c6\u56fe\u6a21\u5f0f\u3001\u9762\u677f\u5bbd\u5ea6 <code>sidebarCollapsed</code>, <code>artifactPanelVisible</code>, <code>artifactViewMode</code> <p>Store \u7684\u5177\u4f53\u5b57\u6bb5\u5b9a\u4e49\u548c action \u7b7e\u540d\u4e0d\u5728\u672c\u6587\u6863\u8303\u56f4\u3002\u6570\u636e\u7ed3\u6784\u4ee5 <code>api.md</code> \u4e2d\u7684 Response Schema \u4e3a\u51c6\uff0cSSE \u4e8b\u4ef6\u683c\u5f0f\u4ee5 <code>streaming.md</code> \u4e3a\u51c6\u3002</p>"},{"location":"_archive/frontend/03_frontend_design/#\u9644\u5f55","title":"\u9644\u5f55","text":""},{"location":"_archive/frontend/03_frontend_design/#a-\u53c2\u8003cli-streamdisplay-\u7684\u6e32\u67d3\u7b56\u7565","title":"A. \u53c2\u8003\uff1aCLI StreamDisplay \u7684\u6e32\u67d3\u7b56\u7565","text":"<p>CLI \u7aef <code>cli/ui.py</code> \u4e2d\u7684 <code>StreamDisplay</code> \u7c7b\u5b9e\u73b0\u4e86 SSE \u4e8b\u4ef6\u5230\u7ec8\u7aef UI \u7684\u6620\u5c04\uff0c\u5176\u6838\u5fc3\u903b\u8f91\u53ef\u4f5c\u4e3a\u524d\u7aef\u5b9e\u73b0\u7684\u53c2\u8003\uff1a</p> SSE \u4e8b\u4ef6 CLI \u884c\u4e3a \u524d\u7aef\u5bf9\u5e94 <code>agent_start</code> \u65b0\u5efa agent Panel\uff0c\u91cd\u7f6e\u72b6\u6001 \u663e\u793a agent badge + \u8fd0\u884c\u6307\u793a\u5668 <code>llm_chunk</code> (reasoning) \u5728 dim Panel \u4e2d\u5b9e\u65f6\u66f4\u65b0 thinking Thinking \u6298\u53e0\u533a\u5b9e\u65f6\u66f4\u65b0 <code>llm_chunk</code> (content) \u5148 finalize reasoning\uff0c\u518d\u5728 cyan Panel \u4e2d\u8f93\u51fa \u81ea\u52a8\u6298\u53e0 thinking\uff0c\u5207\u6362\u5230 final response \u533a <code>tool_start</code> finalize \u5f53\u524d agent\uff0c\u663e\u793a yellow Panel + \u53c2\u6570\u6458\u8981 \u5de5\u5177\u5361\u7247\uff08\u8fdb\u884c\u4e2d\uff09 <code>tool_complete</code> \u6253\u5370 green/red Panel\uff08\u8017\u65f6 + \u7ed3\u679c\u6458\u8981\uff09 \u5de5\u5177\u5361\u7247\u66f4\u65b0\u4e3a\u5b8c\u6210\u72b6\u6001 <code>agent_complete</code> finalize \u5e76\u6253\u5370 agent Panel \u6298\u53e0\u8be5 agent \u7684\u6240\u6709\u4e2d\u95f4\u6b65\u9aa4 <code>permission_request</code> \u6253\u5370 warning \u63d0\u793a \u5f39\u51fa\u6743\u9650\u786e\u8ba4\u5f39\u7a97 <p>\u5173\u952e\u8bbe\u8ba1\u51b3\u7b56\uff1a - Thinking \u2192 Content \u5207\u6362\u68c0\u6d4b\uff1a\u5f53 <code>content</code> \u5b57\u6bb5\u9996\u6b21\u51fa\u73b0\u975e\u7a7a\u503c\u65f6\uff0c\u8bf4\u660e thinking \u9636\u6bb5\u7ed3\u675f - \u7d2f\u79ef\u503c\u800c\u975e\u589e\u91cf\uff1a<code>llm_chunk</code> \u7684 <code>content</code> \u548c <code>reasoning_content</code> \u90fd\u662f\u7d2f\u79ef\u503c\uff0c\u524d\u7aef\u76f4\u63a5\u66ff\u6362\uff08\u4e0d\u662f append\uff09 - \u7ed3\u679c\u6458\u8981\u683c\u5f0f\u5316\uff1a<code>_format_result_data()</code> \u5bf9\u4e0d\u540c\u5de5\u5177\u7c7b\u578b\u6709\u9488\u5bf9\u6027\u7684\u683c\u5f0f\u5316\u903b\u8f91\uff08artifact \u5de5\u5177\u663e\u793a message + version\uff0c\u641c\u7d22\u5de5\u5177\u663e\u793a\u5b57\u7b26\u6570\u7b49\uff09</p>"},{"location":"_archive/frontend/03_frontend_design/#b-\u4e0e-apimd--streamingmd-\u7684\u5173\u7cfb\u8bf4\u660e","title":"B. \u4e0e api.md / streaming.md \u7684\u5173\u7cfb\u8bf4\u660e","text":"<pre><code>\u672c\u6587\u6863 (03_frontend_design.md)\n  \u2502\n  \u2502  \u63cf\u8ff0\uff1a\u9875\u9762\u5e03\u5c40\u3001\u7ec4\u4ef6\u5c42\u7ea7\u3001\u4ea4\u4e92\u884c\u4e3a\u3001UX \u7b56\u7565\n  \u2502\n  \u251c\u2500\u2500 \u5f15\u7528 api.md\n  \u2502     \u63d0\u4f9b\uff1aAPI \u7aef\u70b9\u3001\u8bf7\u6c42/\u54cd\u5e94 Schema\u3001\u9519\u8bef\u7801\n  \u2502     \u672c\u6587\u6863\u4e0d\u91cd\u590d\uff1a\u5177\u4f53\u7684 URL\u3001\u8bf7\u6c42\u53c2\u6570\u3001\u54cd\u5e94\u5b57\u6bb5\u5b9a\u4e49\n  \u2502\n  \u2514\u2500\u2500 \u5f15\u7528 streaming.md\n        \u63d0\u4f9b\uff1aSSE \u4e8b\u4ef6\u7c7b\u578b\u3001\u6570\u636e\u683c\u5f0f\u3001StreamManager \u5b9e\u73b0\u3001\u8fde\u63a5\u751f\u547d\u5468\u671f\n        \u672c\u6587\u6863\u4e0d\u91cd\u590d\uff1a\u4e8b\u4ef6 data \u7684\u5b8c\u6574\u5b57\u6bb5\u5b9a\u4e49\u3001SSE \u534f\u8bae\u7ec6\u8282\n</code></pre> <p>\u672c\u6587\u6863\u5173\u6ce8\u7684\u662f\u300c\u6536\u5230\u67d0\u4e8b\u4ef6\u540e UI \u5e94\u8be5\u5982\u4f55\u53d8\u5316\u300d\uff0c\u800c\u975e\u300c\u4e8b\u4ef6\u7684\u6570\u636e\u7ed3\u6784\u662f\u4ec0\u4e48\u300d\u3002\u524d\u7aef\u5f00\u53d1\u8005\u5e94\u540c\u65f6\u53c2\u8003\u4e09\u4efd\u6587\u6863\uff1a - \u672c\u6587\u6863\uff1a\u7406\u89e3\u9875\u9762\u7ed3\u6784\u548c\u4ea4\u4e92\u8bbe\u8ba1 - api.md\uff1a\u4e86\u89e3\u6bcf\u4e2a API \u7684\u8bf7\u6c42/\u54cd\u5e94\u683c\u5f0f - streaming.md\uff1a\u4e86\u89e3 SSE \u4e8b\u4ef6\u7684\u5b8c\u6574\u5b9a\u4e49\u548c\u8fde\u63a5\u7ba1\u7406</p>"},{"location":"_archive/frontend/DESIGN_SYSTEM/","title":"Design System","text":"<p>\u53c2\u8003 Claude App \u89c6\u89c9\u98ce\u683c\uff1a\u7b80\u7ea6\u3001\u4eba\u6587\u3001\u6e29\u6696\u3002</p>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u6838\u5fc3\u539f\u5219","title":"\u6838\u5fc3\u539f\u5219","text":"<ol> <li>\u7559\u767d\u5373\u547c\u5438 \u2014 \u5145\u88d5\u7684\u95f4\u8ddd\u8ba9\u5185\u5bb9\u81ea\u7136\u5448\u73b0\uff0c\u4e0d\u62e5\u6324</li> <li>\u6e29\u6696\u800c\u975e\u51b0\u51b7 \u2014 \u6696\u8272\u8c03\u80cc\u666f\uff0c\u907f\u514d\u7eaf\u767d\u7eaf\u9ed1</li> <li>\u5185\u5bb9\u4f18\u5148 \u2014 \u754c\u9762\u9000\u5c45\u5e55\u540e\uff0c\u7528\u6237\u4e13\u6ce8\u4e8e\u5bf9\u8bdd\u4e0e\u7ed3\u679c</li> <li>\u514b\u5236\u88c5\u9970 \u2014 \u65e0\u591a\u4f59\u9634\u5f71\u3001\u6e10\u53d8\u3001\u52a8\u6548\uff0c\u4e00\u5207\u670d\u52a1\u4e8e\u529f\u80fd</li> </ol>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u8272\u5f69","title":"\u8272\u5f69","text":"<pre><code>\u80cc\u666f (Background)\n\u251c\u2500\u2500 Light: #f5f0e8  (\u6696\u7c73\u8272)\n\u2514\u2500\u2500 Dark:  #1a1915  (\u6696\u6df1\u8272)\n\n\u5bb9\u5668 (Surface)\n\u251c\u2500\u2500 Light: #ffffff  (\u7eaf\u767d\u5361\u7247)\n\u2514\u2500\u2500 Dark:  #262520  (\u6df1\u7070\u5361\u7247)\n\n\u6587\u5b57 (Text)\n\u251c\u2500\u2500 Primary:   #1a1a1a / #e8e4dc\n\u251c\u2500\u2500 Secondary: #6b6560 / #9b9590\n\u2514\u2500\u2500 Tertiary:  #9b9590 / #6b6560\n\n\u5f3a\u8c03\u8272 (Accent)\n\u2514\u2500\u2500 #c96442  (\u6e29\u6696\u7684\u8d6d\u8910\u8272)\n    \u251c\u2500\u2500 Hover:  #b5573a\n    \u2514\u2500\u2500 Light BG: #fdf4f0\n\n\u8fb9\u6846 (Border)\n\u251c\u2500\u2500 Light: #e5ddd3\n\u2514\u2500\u2500 Dark:  #3a3530\n</code></pre> <p>\u7528\u8272\u539f\u5219\uff1a - \u754c\u9762 90% \u4ee5\u4e0a\u4e3a\u4e2d\u6027\u6696\u8272\u8c03 - \u5f3a\u8c03\u8272\u4ec5\u7528\u4e8e\u4e3b\u8981\u64cd\u4f5c\u6309\u94ae\u548c\u5173\u952e\u94fe\u63a5 - \u72b6\u6001\u8272\u4fdd\u6301\u4f4e\u9971\u548c\uff1a\u6210\u529f <code>#4a8c6f</code>\u3001\u9519\u8bef <code>#c25d4e</code>\u3001\u8b66\u544a <code>#c49a3c</code></p>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u6392\u7248","title":"\u6392\u7248","text":"<pre><code>\u5b57\u4f53: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif\n\u4ee3\u7801: 'SF Mono', 'Fira Code', ui-monospace, monospace\n\n\u5b57\u53f7\n\u251c\u2500\u2500 \u6807\u9898:   text-lg (18px)  font-semibold\n\u251c\u2500\u2500 \u6b63\u6587:   text-sm (14px)  font-normal\n\u251c\u2500\u2500 \u8f85\u52a9:   text-xs (12px)  text-secondary\n\u2514\u2500\u2500 \u884c\u9ad8:   leading-relaxed (1.625)\n</code></pre>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u95f4\u8ddd","title":"\u95f4\u8ddd","text":"<p>\u57fa\u4e8e 4px \u7f51\u683c\uff0c\u504f\u597d\u5bbd\u677e\uff1a</p> <pre><code>\u5143\u7d20\u5185\u8fb9\u8ddd:   12\u201316px\n\u5361\u7247\u5185\u8fb9\u8ddd:   20\u201324px\n\u533a\u5757\u95f4\u8ddd:     24\u201332px\n\u9875\u9762\u8fb9\u8ddd:     32\u201348px\n</code></pre>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u5706\u89d2","title":"\u5706\u89d2","text":"<pre><code>\u6309\u94ae/\u8f93\u5165\u6846:  8px   (rounded-lg)\n\u5361\u7247/\u9762\u677f:    12px  (rounded-xl)\n\u5bf9\u8bdd\u6c14\u6ce1:     16px  (rounded-2xl)\n\u5934\u50cf/\u6807\u7b7e:    9999px (rounded-full)\n</code></pre>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u9634\u5f71\u4e0e\u8fb9\u6846","title":"\u9634\u5f71\u4e0e\u8fb9\u6846","text":"<p>\u4ee5\u7ec6\u8fb9\u6846\u4ee3\u66ff\u9634\u5f71\u6765\u533a\u5206\u5c42\u7ea7\uff0c\u4fdd\u6301\u5e73\u9762\u611f\uff1a</p> <pre><code>\u9ed8\u8ba4\u5bb9\u5668:  border 1px solid border-color\n\u60ac\u6d6e\u5c42:    shadow-sm (0 1px 2px rgba(0,0,0,0.05))\n\u5f39\u7a97:      shadow-md (0 4px 12px rgba(0,0,0,0.08))\n</code></pre>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u4ea4\u4e92","title":"\u4ea4\u4e92","text":"<pre><code>\u8fc7\u6e21\u65f6\u957f:     150ms ease-out\n\u60ac\u505c\u53cd\u9988:     \u80cc\u666f\u8272\u5fae\u53d8 (opacity \u6216 \u7565\u6df1\u4e00\u7ea7)\n\u6309\u94ae\u6309\u4e0b:     opacity-90\n\u7126\u70b9\u73af:       2px solid accent, offset 2px\n\u7981\u7528\u72b6\u6001:     opacity-40, cursor-not-allowed\n</code></pre> <p>\u907f\u514d\uff1a\u5f39\u8df3\u52a8\u753b\u3001\u6d9f\u6f2a\u6548\u679c\u3001\u8fc7\u5ea6\u7684\u60ac\u6d6e\u9634\u5f71\u3002</p>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u6df1\u8272\u6a21\u5f0f","title":"\u6df1\u8272\u6a21\u5f0f","text":"Light Dark \u7528\u9014 #f5f0e8 #1a1915 \u80cc\u666f #ffffff #262520 \u5bb9\u5668 #e5ddd3 #3a3530 \u8fb9\u6846 #1a1a1a #e8e4dc \u4e3b\u6587\u5b57 #c96442 #c96442 \u5f3a\u8c03\u8272\u4e0d\u53d8 <p>\u6df1\u8272\u6a21\u5f0f\u4e0b\u9634\u5f71\u8fdb\u4e00\u6b65\u5f31\u5316\uff0c\u4f9d\u9760\u8fb9\u6846\u548c\u5fae\u5999\u7684\u80cc\u666f\u8272\u5dee\u533a\u5206\u5c42\u7ea7\u3002</p>"},{"location":"_archive/frontend/DESIGN_SYSTEM/#\u65e0\u969c\u788d","title":"\u65e0\u969c\u788d","text":"<ul> <li>\u6587\u5b57\u5bf9\u6bd4\u5ea6 \u2265 4.5:1 (WCAG AA)</li> <li>\u53ef\u70b9\u51fb\u76ee\u6807 \u2265 44px</li> <li>\u56fe\u6807\u6309\u94ae\u63d0\u4f9b <code>aria-label</code></li> <li>\u6240\u6709\u4ea4\u4e92\u652f\u6301\u952e\u76d8\u5bfc\u822a</li> </ul>"},{"location":"architecture/agents/","title":"Agent \u7cfb\u7edf","text":"<p>Agent \u662f ArtifactFlow \u4e2d\u7684\u667a\u80fd\u6267\u884c\u5355\u5143\uff0c\u6bcf\u4e2a Agent \u4e13\u6ce8\u4e8e\u7279\u5b9a\u7c7b\u578b\u7684\u4efb\u52a1\u3002</p>"},{"location":"architecture/agents/#\u6a21\u5757\u7ed3\u6784","title":"\u6a21\u5757\u7ed3\u6784","text":"<pre><code>src/agents/\n\u251c\u2500\u2500 base.py          # Agent \u57fa\u7c7b\u548c\u6838\u5fc3\u6570\u636e\u7ed3\u6784\n\u251c\u2500\u2500 lead_agent.py    # Lead Agent\uff08\u4efb\u52a1\u534f\u8c03\uff09\n\u251c\u2500\u2500 search_agent.py  # Search Agent\uff08\u4fe1\u606f\u68c0\u7d22\uff09\n\u2514\u2500\u2500 crawl_agent.py   # Crawl Agent\uff08\u5185\u5bb9\u91c7\u96c6\uff09\n</code></pre>"},{"location":"architecture/agents/#\u6838\u5fc3\u6570\u636e\u7ed3\u6784-basepy","title":"\u6838\u5fc3\u6570\u636e\u7ed3\u6784 (base.py)","text":""},{"location":"architecture/agents/#agentconfig","title":"AgentConfig","text":"<p>Agent \u914d\u7f6e\uff1a</p> <pre><code>@dataclass\nclass AgentConfig:\n    name: str                        # Agent \u540d\u79f0\uff08\u552f\u4e00\u6807\u8bc6\uff09\n    description: str                 # Agent \u63cf\u8ff0\n\n    # \u5143\u4fe1\u606f\uff08\u7528\u4e8e\u6ce8\u518c\u5230 Lead\u3001\u521b\u5efa toolkit\uff09\n    capabilities: List[str] = []     # \u80fd\u529b\u5217\u8868\n    required_tools: List[str] = []   # \u6240\u9700\u5de5\u5177\u540d\u79f0\u5217\u8868\n\n    # LLM \u914d\u7f6e\n    model: str = \"qwen-plus\"         # LLM \u6a21\u578b\n    temperature: float = 0.7         # \u751f\u6210\u6e29\u5ea6\n    max_tool_rounds: int = 3         # \u5355\u6b21\u6267\u884c\u6700\u5927\u5de5\u5177\u8c03\u7528\u8f6e\u6570\n    streaming: bool = False          # \u662f\u5426\u9ed8\u8ba4\u6d41\u5f0f\u8f93\u51fa\n\n    llm_max_retries: int = 3         # LLM \u8c03\u7528\u6700\u5927\u91cd\u8bd5\u6b21\u6570\n    llm_retry_delay: float = 1.0     # \u521d\u59cb\u91cd\u8bd5\u5ef6\u8fdf\uff08\u79d2\uff09\n</code></pre>"},{"location":"architecture/agents/#agentresponse","title":"AgentResponse","text":"<p>Agent \u5355\u8f6e\u6267\u884c\u7684\u54cd\u5e94\uff1a</p> <pre><code>@dataclass\nclass AgentResponse:\n    success: bool = True                     # \u6267\u884c\u662f\u5426\u6210\u529f\n    content: str = \"\"                        # \u56de\u590d\u5185\u5bb9\u6216\u9519\u8bef\u4fe1\u606f\n    tool_interactions: List[Dict] = []       # assistant-tool \u4ea4\u4e92\u5386\u53f2\uff08\u7528\u4e8e\u6062\u590d\uff09\n    reasoning_content: Optional[str] = None  # \u601d\u8003\u8fc7\u7a0b\uff08\u652f\u6301 reasoning model\uff09\n    metadata: Dict[str, Any] = {}            # \u5143\u6570\u636e\n    routing: Optional[Dict[str, Any]] = None # \u8def\u7531\u4fe1\u606f\n    token_usage: Optional[Dict[str, Any]] = None  # Token \u7edf\u8ba1\n</code></pre> <p>routing \u5b57\u6bb5\u7ed3\u6784\uff1a</p> <pre><code># \u5de5\u5177\u8c03\u7528\nrouting = {\n    \"type\": \"tool_call\",\n    \"tool_name\": \"web_search\",\n    \"params\": {\"query\": \"...\"}\n}\n\n# \u8c03\u7528 SubAgent\nrouting = {\n    \"type\": \"subagent\",\n    \"target\": \"search_agent\",\n    \"instruction\": \"\u641c\u7d22\u76f8\u5173\u4fe1\u606f...\"\n}\n\n# \u4efb\u52a1\u5b8c\u6210\uff08\u65e0 routing \u5b57\u6bb5\uff09\n# \u5f53 routing \u4e3a None \u65f6\u8868\u793a Agent \u5b8c\u6210\u6267\u884c\n</code></pre>"},{"location":"architecture/agents/#baseagent-\u57fa\u7c7b","title":"BaseAgent \u57fa\u7c7b","text":""},{"location":"architecture/agents/#\u6838\u5fc3\u804c\u8d23","title":"\u6838\u5fc3\u804c\u8d23","text":"<ol> <li>\u5355\u8f6e LLM \u8c03\u7528\uff1a\u6bcf\u6b21\u6267\u884c\u53ea\u8c03\u7528\u4e00\u6b21 LLM</li> <li>\u54cd\u5e94\u89e3\u6790\uff1a\u89e3\u6790 XML \u683c\u5f0f\u7684\u5de5\u5177\u8c03\u7528</li> <li>\u6d41\u5f0f\u8f93\u51fa\uff1a\u652f\u6301 LLM token \u7ea7\u522b\u7684\u6d41\u5f0f</li> <li>\u9519\u8bef\u91cd\u8bd5\uff1aLLM \u8c03\u7528\u5931\u8d25\u81ea\u52a8\u91cd\u8bd5</li> </ol>"},{"location":"architecture/agents/#\u62bd\u8c61\u65b9\u6cd5","title":"\u62bd\u8c61\u65b9\u6cd5","text":"<p>\u5b50\u7c7b\u5fc5\u987b\u5b9e\u73b0\uff1a</p> <pre><code>class BaseAgent(ABC):\n    @abstractmethod\n    def build_system_prompt(self, context: Optional[Dict[str, Any]] = None) -&gt; str:\n        \"\"\"\n        \u6784\u5efa\u7cfb\u7edf\u63d0\u793a\u8bcd\uff08\u4e0d\u542b\u5de5\u5177\u8bf4\u660e\uff09\n\n        Args:\n            context: \u52a8\u6001\u4e0a\u4e0b\u6587\uff08\u5982 artifacts_inventory\uff09\n\n        Returns:\n            \u7cfb\u7edf\u63d0\u793a\u8bcd\n        \"\"\"\n        pass\n\n    @abstractmethod\n    def format_final_response(self, content: str) -&gt; str:\n        \"\"\"\n        \u683c\u5f0f\u5316\u6700\u7ec8\u54cd\u5e94\n\n        Args:\n            content: LLM \u7684\u6700\u7ec8\u56de\u590d\n\n        Returns:\n            \u683c\u5f0f\u5316\u540e\u7684\u54cd\u5e94\n        \"\"\"\n        pass\n</code></pre> <p>\u5de5\u5177\u8bf4\u660e\u7531 <code>build_complete_system_prompt()</code> \u81ea\u52a8\u8ffd\u52a0\u5230 <code>build_system_prompt()</code> \u7ed3\u679c\u540e\u9762\u3002</p>"},{"location":"architecture/agents/#\u6267\u884c\u6d41\u7a0b","title":"\u6267\u884c\u6d41\u7a0b","text":"<pre><code>async def stream(\n    self,\n    messages: List[Dict],\n    is_resuming: bool = False\n) -&gt; AsyncGenerator[StreamEvent, None]:\n    \"\"\"\n    \u6d41\u5f0f\u6267\u884c Agent\uff08\u5355\u8f6e LLM \u8c03\u7528\uff09\n\n    Args:\n        messages: \u5b8c\u6574\u7684\u6d88\u606f\u5217\u8868\uff08\u7531 ContextManager \u6784\u5efa\uff09\n        is_resuming: \u662f\u5426\u4ece\u5de5\u5177\u6267\u884c\u6062\u590d\n    \"\"\"\n\n    # 1. \u53d1\u9001 Agent \u5f00\u59cb\u4e8b\u4ef6\n    yield StreamEvent(type=AGENT_START, agent=self.config.name, data=current_response)\n\n    # 2. \u6d41\u5f0f\u8c03\u7528 LLM\uff08\u5e26\u91cd\u8bd5\uff09\n    stream = await self._call_llm_with_retry(messages, streaming=True)\n    async for chunk in stream:\n        if chunk[\"type\"] == \"content\":\n            response_content += chunk[\"content\"]\n            yield StreamEvent(type=LLM_CHUNK, agent=self.config.name, data=current_response)\n        elif chunk[\"type\"] == \"reasoning\":\n            reasoning_content += chunk[\"content\"]\n            yield StreamEvent(type=LLM_CHUNK, agent=self.config.name, data=current_response)\n\n    yield StreamEvent(type=LLM_COMPLETE, agent=self.config.name, data=current_response)\n\n    # 3. \u89e3\u6790\u54cd\u5e94\uff08\u5185\u8054\u5904\u7406\uff09\n    tool_calls = parse_tool_calls(response_content)\n    if tool_calls:\n        tool_call = tool_calls[0]  # \u6bcf\u8f6e\u53ea\u5904\u7406\u4e00\u4e2a\n        if tool_call.name == \"call_subagent\":\n            result = await self.toolkit.execute_tool(\"call_subagent\", tool_call.params)\n            if result.success:\n                current_response.routing = {\"type\": \"subagent\", ...}\n            else:\n                current_response.routing = {\"type\": \"tool_call\", ...}  # \u9a8c\u8bc1\u5931\u8d25\n        else:\n            current_response.routing = {\"type\": \"tool_call\", ...}\n\n    # 4. \u53d1\u9001 Agent \u5b8c\u6210\u4e8b\u4ef6\n    yield StreamEvent(type=AGENT_COMPLETE, agent=self.config.name, data=current_response)\n</code></pre>"},{"location":"architecture/agents/#\u54cd\u5e94\u89e3\u6790","title":"\u54cd\u5e94\u89e3\u6790","text":"<p>\u54cd\u5e94\u89e3\u6790\u5728 <code>_execute_generator()</code> \u4e2d\u5185\u8054\u5904\u7406\uff1a</p> <pre><code># \u5728 _execute_generator \u4e2d\ntool_calls = parse_tool_calls(response_content)\n\nif tool_calls:\n    tool_call = tool_calls[0]  # \u6bcf\u8f6e\u53ea\u5904\u7406\u4e00\u4e2a\u5de5\u5177\u8c03\u7528\n\n    if tool_call.name == \"call_subagent\":\n        # \u5148\u8c03\u7528 execute() \u9a8c\u8bc1\u53c2\u6570\n        result = await self.toolkit.execute_tool(\"call_subagent\", tool_call.params)\n        if result.success:\n            # \u9a8c\u8bc1\u901a\u8fc7\uff0c\u8bbe\u7f6e subagent \u8def\u7531\n            current_response.routing = {\n                \"type\": \"subagent\",\n                \"target\": result.data[\"agent_name\"],\n                \"instruction\": result.data[\"instruction\"]\n            }\n        else:\n            # \u9a8c\u8bc1\u5931\u8d25\uff0c\u5f53\u4f5c\u666e\u901a tool_call \u8ba9 graph \u8fd4\u56de\u9519\u8bef\n            current_response.routing = {\n                \"type\": \"tool_call\",\n                \"tool_name\": tool_call.name,\n                \"params\": tool_call.params\n            }\n    else:\n        current_response.routing = {\n            \"type\": \"tool_call\",\n            \"tool_name\": tool_call.name,\n            \"params\": tool_call.params\n        }\n\n    yield StreamEvent(type=AGENT_COMPLETE, ...)\n    return\n\n# \u65e0\u5de5\u5177\u8c03\u7528 \u2192 Agent \u5b8c\u6210\n# routing \u4e3a None\uff0c\u7531 Graph \u5c42\u51b3\u5b9a\u662f COMPLETED \u8fd8\u662f\u8fd4\u56de Lead\nfinal_response = self.format_final_response(content)\ncurrent_response.content = final_response\n\nyield StreamEvent(type=AGENT_COMPLETE, ...)\n</code></pre> <p>\u6ce8\u610f\uff1a\u5de5\u5177\u8f6e\u6570\u9650\u5236\u7531 Graph \u5c42\u63a7\u5236\uff08\u8bfb\u53d6 <code>agent.config.max_tool_rounds</code>\uff09\uff0c\u4e0d\u5728 Agent \u5185\u90e8\u5224\u65ad\u3002</p>"},{"location":"architecture/agents/#lead-agent","title":"Lead Agent","text":""},{"location":"architecture/agents/#\u89d2\u8272\u5b9a\u4f4d","title":"\u89d2\u8272\u5b9a\u4f4d","text":"<p>Lead Agent \u662f\u4efb\u52a1\u7684\u603b\u534f\u8c03\u8005\uff1a</p> <ul> <li>\u7406\u89e3\u7528\u6237\u610f\u56fe\uff0c\u5236\u5b9a\u4efb\u52a1\u8ba1\u5212</li> <li>\u7ba1\u7406 Task Plan Artifact</li> <li>\u8c03\u5ea6 SubAgent \u6267\u884c\u5177\u4f53\u4efb\u52a1</li> <li>\u6574\u5408\u7ed3\u679c\u5230 Result Artifact</li> <li>\u4e0e\u7528\u6237\u4ea4\u4e92\uff0c\u54cd\u5e94\u53cd\u9988</li> </ul>"},{"location":"architecture/agents/#\u914d\u7f6e","title":"\u914d\u7f6e","text":"<pre><code>class LeadAgent(BaseAgent):\n    def __init__(self, config: Optional[AgentConfig] = None, toolkit=None):\n        if not config:\n            config = AgentConfig(\n                name=\"lead_agent\",\n                description=\"Task coordinator and information integrator\",\n                required_tools=[\n                    \"create_artifact\",\n                    \"update_artifact\",\n                    \"rewrite_artifact\",\n                    \"read_artifact\",\n                    \"call_subagent\"\n                ],\n                model=\"qwen3-next-80b-thinking\",  # \u4f7f\u7528\u601d\u8003\u6a21\u578b\n                temperature=0.7,\n                max_tool_rounds=5,    # \u9700\u8981\u66f4\u591a\u8f6e\u6b21\u534f\u8c03\n                streaming=True\n            )\n        super().__init__(config, toolkit)\n\n        # \u6ce8\u518c\u7684\u5b50 Agent \u914d\u7f6e\uff08\u7528\u4e8e\u751f\u6210 system prompt\uff09\n        self.sub_agents: Dict[str, AgentConfig] = {}\n\n    def register_subagent(self, config: AgentConfig):\n        \"\"\"\u6ce8\u518c\u5b50 Agent\uff0c\u4f7f\u5176\u51fa\u73b0\u5728 system prompt \u4e2d\"\"\"\n        self.sub_agents[config.name] = config\n</code></pre>"},{"location":"architecture/agents/#\u7cfb\u7edf\u63d0\u793a\u8bcd\u7ed3\u6784","title":"\u7cfb\u7edf\u63d0\u793a\u8bcd\u7ed3\u6784","text":"<pre><code>def build_system_prompt(self, context: Optional[Dict[str, Any]] = None) -&gt; str:\n    \"\"\"\n    \u6784\u5efa Lead Agent \u7cfb\u7edf\u63d0\u793a\u8bcd\n\n    Args:\n        context: \u5305\u542b artifacts_inventory\u3001user_feedback \u7b49\u4e0a\u4e0b\u6587\n\n    \u63d0\u793a\u8bcd\u7ed3\u6784\uff08\u4f7f\u7528 XML \u6807\u7b7e\u7ec4\u7ec7\uff09\uff1a\n    - &lt;system_time&gt;: \u5f53\u524d\u65f6\u95f4\n    - &lt;agent_role&gt;: \u89d2\u8272\u5b9a\u4e49\u548c\u6838\u5fc3\u804c\u8d23\n    - &lt;execution_flow&gt;: \u6267\u884c\u6d41\u7a0b\u548c\u6307\u5bfc\u539f\u5219\n    - &lt;task_planning_strategy&gt;: \u4efb\u52a1\u89c4\u5212\u7b56\u7565\n    - &lt;artifact_management&gt;: Artifact \u7ba1\u7406\u89c4\u8303\n    - &lt;available_subagents&gt;: \u53ef\u7528\u7684\u5b50 Agent \u5217\u8868\uff08\u52a8\u6001\u751f\u6210\uff09\n    - &lt;current_context&gt;: \u5f53\u524d\u4e0a\u4e0b\u6587\uff08artifacts_inventory\u3001user_feedback\uff09\n    \"\"\"\n</code></pre> <p>\u63d0\u793a\u8bcd\u6838\u5fc3\u7ed3\u6784\uff1a</p> <pre><code>&lt;agent_role&gt;\nYou are lead_agent, the Lead Agent coordinating a multi-agent system.\n\n## Your Role and Responsibilities\n1. Task Planning: Analyze user requests and create structured task plans\n2. Coordination: Delegate specific tasks to specialized sub-agents\n3. Integration: Synthesize information from various sources\n4. Quality Control: Ensure quality and completeness\n&lt;/agent_role&gt;\n\n&lt;artifact_management&gt;\n## Artifact Management\n\n### Task Plan Artifact (ID: \"task_plan\")\n- \u56fa\u5b9a ID\uff0c\u7528\u4e8e\u4efb\u52a1\u8ddf\u8e2a\n\n### Result Artifacts (Flexible IDs)\n- \u6839\u636e\u7528\u6237\u9700\u6c42\u521b\u5efa\uff0c\u5982 \"research_report\"\u3001\"main.py\" \u7b49\n&lt;/artifact_management&gt;\n\n&lt;available_subagents&gt;\n## Available Sub-Agents\n\uff08\u52a8\u6001\u751f\u6210\u5df2\u6ce8\u518c\u7684\u5b50 Agent \u5217\u8868\uff09\n&lt;/available_subagents&gt;\n</code></pre>"},{"location":"architecture/agents/#search-agent","title":"Search Agent","text":""},{"location":"architecture/agents/#\u89d2\u8272\u5b9a\u4f4d_1","title":"\u89d2\u8272\u5b9a\u4f4d","text":"<p>\u4e13\u6ce8\u4e8e\u4fe1\u606f\u68c0\u7d22\uff1a</p> <ul> <li>\u4f18\u5316\u641c\u7d22\u67e5\u8be2</li> <li>\u591a\u8f6e\u8fed\u4ee3\u641c\u7d22</li> <li>\u7ed3\u679c\u7b5b\u9009\u4e0e\u7ed3\u6784\u5316</li> </ul>"},{"location":"architecture/agents/#\u914d\u7f6e_1","title":"\u914d\u7f6e","text":"<pre><code>class SearchAgent(BaseAgent):\n    def __init__(self, config: Optional[AgentConfig] = None, toolkit=None):\n        if not config:\n            config = AgentConfig(\n                name=\"search_agent\",\n                description=\"Web search and information retrieval specialist\",\n                capabilities=[\"Web search\", \"Information retrieval\"],\n                required_tools=[\"web_search\"],\n                model=\"qwen3-next-80b-instruct\",\n                temperature=0.5,      # \u8f83\u4f4e\u6e29\u5ea6 for \u7cbe\u786e\u641c\u7d22\n                max_tool_rounds=3,    # \u6700\u591a 3 \u8f6e\u641c\u7d22\u4f18\u5316\n                streaming=True\n            )\n        super().__init__(config, toolkit)\n</code></pre>"},{"location":"architecture/agents/#\u5de5\u4f5c\u6a21\u5f0f","title":"\u5de5\u4f5c\u6a21\u5f0f","text":"<pre><code>flowchart TD\n    A[\u6536\u5230\u641c\u7d22\u6307\u4ee4] --&gt; B[\u5206\u6790\u641c\u7d22\u610f\u56fe]\n    B --&gt; C[\u6784\u9020\u641c\u7d22\u67e5\u8be2]\n    C --&gt; D[\u6267\u884c web_search]\n    D --&gt; E{\u7ed3\u679c\u662f\u5426\u5145\u5206?}\n    E --&gt;|\u5426| F[\u4f18\u5316\u67e5\u8be2]\n    F --&gt; C\n    E --&gt;|\u662f| G[\u6574\u7406\u7ed3\u6784\u5316\u7ed3\u679c]\n    G --&gt; H[\u8fd4\u56de\u7ed9 Lead Agent]</code></pre>"},{"location":"architecture/agents/#crawl-agent","title":"Crawl Agent","text":""},{"location":"architecture/agents/#\u89d2\u8272\u5b9a\u4f4d_2","title":"\u89d2\u8272\u5b9a\u4f4d","text":"<p>\u4e13\u6ce8\u4e8e\u5185\u5bb9\u91c7\u96c6\uff1a</p> <ul> <li>\u7f51\u9875\u5185\u5bb9\u6293\u53d6</li> <li>\u5185\u5bb9\u89e3\u6790\u4e0e\u63d0\u53d6</li> <li>\u5904\u7406\u5f02\u5e38\u60c5\u51b5</li> </ul>"},{"location":"architecture/agents/#\u914d\u7f6e_2","title":"\u914d\u7f6e","text":"<pre><code>class CrawlAgent(BaseAgent):\n    def __init__(self, config: Optional[AgentConfig] = None, toolkit=None):\n        if not config:\n            config = AgentConfig(\n                name=\"crawl_agent\",\n                description=\"Web content extraction and cleaning specialist\",\n                capabilities=[\n                    \"Deep content extraction\",\n                    \"Web scraping\",\n                    \"IMPORTANT: Instructions must include a specific URL to crawl\"\n                ],\n                required_tools=[\"web_fetch\"],\n                model=\"qwen3-next-80b-instruct\",\n                temperature=0.3,      # \u66f4\u4f4e\u6e29\u5ea6 for \u7cbe\u786e\u63d0\u53d6\n                max_tool_rounds=2,    # \u901a\u5e38 1-2 \u8f6e\u5373\u53ef\n                streaming=True\n            )\n        super().__init__(config, toolkit)\n</code></pre>"},{"location":"architecture/agents/#agent-\u534f\u4f5c\u6a21\u5f0f","title":"Agent \u534f\u4f5c\u6a21\u5f0f","text":"<pre><code>sequenceDiagram\n    participant User\n    participant Lead\n    participant Search\n    participant Crawl\n    participant Artifact\n\n    User-&gt;&gt;Lead: \u5206\u6790 Python \u5f02\u6b65\u7f16\u7a0b\u6700\u4f73\u5b9e\u8df5\n    Lead-&gt;&gt;Artifact: \u521b\u5efa Task Plan\n    Lead-&gt;&gt;Search: \u641c\u7d22\u76f8\u5173\u8d44\u6599\n    Search-&gt;&gt;Search: web_search x N\n    Search-&gt;&gt;Lead: \u8fd4\u56de\u641c\u7d22\u7ed3\u679c\n\n    Lead-&gt;&gt;Crawl: \u6293\u53d6\u91cd\u70b9\u6587\u7ae0\n    Crawl-&gt;&gt;Crawl: web_fetch x N\n    Crawl-&gt;&gt;Lead: \u8fd4\u56de\u6587\u7ae0\u5185\u5bb9\n\n    Lead-&gt;&gt;Artifact: \u66f4\u65b0 Result\n    Lead-&gt;&gt;User: \u8fd4\u56de\u5206\u6790\u62a5\u544a</code></pre>"},{"location":"architecture/agents/#agent-\u8bb0\u5fc6\u7cfb\u7edf","title":"Agent \u8bb0\u5fc6\u7cfb\u7edf","text":"<p>\u6bcf\u4e2a Agent \u7ef4\u62a4\u72ec\u7acb\u7684\u8bb0\u5fc6\uff08<code>NodeMemory</code>\uff09\uff0c\u7528\u4e8e\u8de8\u8f6e\u6b21\u4fdd\u6301\u4e0a\u4e0b\u6587\uff1a</p> <pre><code># state[\"agent_memories\"] \u7ed3\u6784\n{\n    \"lead_agent\": {\n        \"tool_interactions\": [...],    # assistant-tool \u4ea4\u4e92\u5386\u53f2\n        \"last_response\": {...},        # \u6700\u540e\u7684 AgentResponse\n        \"tool_round_count\": 2          # \u5f53\u524d\u5de5\u5177\u8c03\u7528\u8f6e\u6570\n    },\n    \"search_agent\": {...},\n    \"crawl_agent\": {...}\n}\n</code></pre> <p>\u8bb0\u5fc6\u5728 <code>merge_agent_response_to_state()</code> \u4e2d\u81ea\u52a8\u66f4\u65b0\uff1a</p> <pre><code># \u81ea\u52a8\u5408\u5e76 tool_interactions\nif response.tool_interactions:\n    memory[\"tool_interactions\"].extend(response.tool_interactions)\n\n# \u81ea\u52a8\u66f4\u65b0 last_response\nmemory[\"last_response\"] = {\n    \"success\": response.success,\n    \"content\": response.content,\n    \"metadata\": response.metadata,\n    \"reasoning\": response.reasoning_content\n}\n</code></pre> <p>\u6ce8\u610f\uff1a\u53ef\u89c2\u6d4b\u6027\u6307\u6807\uff08\u6267\u884c\u65f6\u95f4\u3001token \u7edf\u8ba1\u7b49\uff09\u5df2\u79fb\u81f3 <code>ExecutionMetrics</code>\uff0c\u7531 Graph \u5c42\u8bb0\u5f55\u3002</p>"},{"location":"architecture/agents/#\u6dfb\u52a0\u65b0-agent","title":"\u6dfb\u52a0\u65b0 Agent","text":"<p>\u53c2\u89c1 Extension Guide\u3002</p>"},{"location":"architecture/concurrency/","title":"Concurrency Architecture","text":"<p>\u672c\u6587\u6863\u63cf\u8ff0 ArtifactFlow \u7684\u5e76\u53d1\u6a21\u578b\uff1a\u5f53\u524d\u8bbe\u8ba1\u3001\u5df2\u77e5\u5c40\u9650\u3001\u4ee5\u53ca\u9762\u5411\u751f\u4ea7\u73af\u5883\u7684\u6f14\u8fdb\u8def\u7ebf\u3002</p>"},{"location":"architecture/concurrency/#\u5f53\u524d\u8bbe\u8ba1","title":"\u5f53\u524d\u8bbe\u8ba1","text":""},{"location":"architecture/concurrency/#\u8d44\u6e90\u5206\u5c42\u6a21\u578b","title":"\u8d44\u6e90\u5206\u5c42\u6a21\u578b","text":"<pre><code>graph TB\n    subgraph Global[\"\u5168\u5c40\u5355\u4f8b\uff08\u8de8\u8bf7\u6c42\u5171\u4eab\uff0c\u5e94\u7528\u542f\u52a8\u65f6\u521d\u59cb\u5316\uff09\"]\n        DM[\"DatabaseManager&lt;br/&gt;&lt;i&gt;SQLAlchemy async engine + \u8fde\u63a5\u6c60&lt;/i&gt;\"]\n        CP[\"Checkpointer&lt;br/&gt;&lt;i&gt;AsyncSqliteSaver\uff08\u5355 aiosqlite \u8fde\u63a5\uff09&lt;/i&gt;\"]\n        SM[\"StreamManager&lt;br/&gt;&lt;i&gt;\u4e8b\u4ef6\u7f13\u51b2\u961f\u5217 + TTL \u6e05\u7406&lt;/i&gt;\"]\n    end\n\n    subgraph PerReq[\"\u8bf7\u6c42\u7ea7\u5b9e\u4f8b\uff08AsyncSession \u2192 Repository \u2192 Manager \u2192 Controller\uff09\"]\n        Session[\"AsyncSession\"]\n        Repo[\"Repository\"]\n        Mgr[\"Manager\"]\n        Ctrl[\"Controller\"]\n        Session --&gt; Repo --&gt; Mgr --&gt; Ctrl\n    end\n\n    Global -- \"Depends() \u6ce8\u5165 / background task \u521b\u5efa\" --&gt; PerReq</code></pre> <p>Note: HTTP \u8bf7\u6c42\uff08POST /chat\uff09\u53ea\u505a\u8f7b\u91cf\u540c\u6b65\u64cd\u4f5c\uff08<code>ensure_conversation</code> + <code>create_stream</code>\uff09\uff0c\u7136\u540e\u7acb\u5373\u8fd4\u56de\u3002Graph \u6267\u884c\u7531 background task\uff08<code>asyncio.create_task</code>\uff09\u72ec\u7acb\u7ba1\u7406\uff0ctask \u5185\u90e8\u521b\u5efa\u81ea\u5df1\u7684 session / manager / controller \u5b9e\u4f8b\uff08\u56e0\u4e3a HTTP \u8bf7\u6c42\u7684\u4f9d\u8d56\u5728\u8fd4\u56de\u540e\u5373\u91ca\u653e\uff09\u3002</p>"},{"location":"architecture/concurrency/#\u4f9d\u8d56\u6ce8\u5165\u94fe\u8def","title":"\u4f9d\u8d56\u6ce8\u5165\u94fe\u8def","text":"<pre><code>graph TD\n    Req[\"HTTP Request\"] --&gt; GDS[\"get_db_session()&lt;i&gt;&lt;br/&gt;\u4ece DatabaseManager \u8fde\u63a5\u6c60&lt;br/&gt;\u83b7\u53d6 AsyncSession&lt;/i&gt;\"]\n    GDS --&gt; AR[\"ArtifactRepository \u2192 ArtifactManager\"]\n    GDS --&gt; CR[\"ConversationRepository \u2192 &lt;br/&gt;ConversationManager\"]\n    GDS --&gt; Graph[\"create_multi_agent_graph() + &lt;br/&gt;Controller\"]\n    Graph -. \"\u5171\u4eab\u5355\u4f8b\" .-&gt; CP[\"Checkpointer&lt;br/&gt;&lt;i&gt;\u652f\u6301\u8de8\u8bf7\u6c42 interrupt/resume&lt;/i&gt;\"]</code></pre> <p>\u5e76\u53d1\u5b89\u5168\u4fdd\u8bc1\uff1a - DatabaseManager: \u5168\u5c40\u5355\u4f8b\uff0c\u5185\u90e8\u7ef4\u62a4 SQLAlchemy \u8fde\u63a5\u6c60\uff0c\u5929\u7136\u652f\u6301\u5e76\u53d1 - Checkpointer: \u5168\u5c40\u5355\u4f8b\uff0c\u6240\u6709 graph \u6267\u884c\u5171\u4eab\u540c\u4e00\u4e2a checkpoint \u5b58\u50a8 - StreamManager: \u5168\u5c40\u5355\u4f8b\uff0c\u4f7f\u7528 <code>asyncio.Lock</code> \u4fdd\u62a4 stream \u521b\u5efa/\u5173\u95ed\u64cd\u4f5c - AsyncSession: \u8bf7\u6c42\u72ec\u7acb\uff0c\u6bcf\u4e2a\u8bf7\u6c42\uff08\u6216 background task\uff09\u521b\u5efa\u65b0\u7684\u6570\u636e\u5e93\u4f1a\u8bdd</p>"},{"location":"architecture/concurrency/#post-chat-\u6267\u884c\u6d41\u7a0b","title":"POST /chat \u6267\u884c\u6d41\u7a0b","text":"<p>\u6b64\u56fe\u4fa7\u91cd\u5e76\u53d1\u4e0e\u751f\u547d\u5468\u671f\u89c6\u89d2\uff0c\u5b8c\u6574\u7684\u7aef\u5230\u7aef\u6d41\u7a0b\u89c1 Request Lifecycle \u2014 \u6574\u4f53\u6d41\u7a0b\u3002</p> <pre><code>sequenceDiagram\n    participant Client as Frontend\n    participant POST as POST /chat\n    participant SM as StreamManager\n    participant BG as Background Task\n    participant SSE as GET /stream/{thread_id}\n\n    Client-&gt;&gt;POST: \u53d1\u9001\u6d88\u606f\n    POST-&gt;&gt;POST: 1. ensure_conversation_exists()\n    POST-&gt;&gt;SM: 2. create_stream(thread_id)\n    POST-&gt;&gt;BG: 3. asyncio.create_task(execute_and_push())\n    POST--&gt;&gt;Client: 4. \u8fd4\u56de { stream_url }\n\n    Note over BG: \u521b\u5efa\u72ec\u7acb\u7684&lt;br/&gt;db session / manager / controller\n\n    Client-&gt;&gt;SSE: \u8ba2\u9605 SSE\n\n    loop Graph \u6267\u884c\n        BG-&gt;&gt;SM: push_event(event)\n        SM-&gt;&gt;SSE: consume_events()\n        SSE--&gt;&gt;Client: event: {type} + data: {event}\n    end\n\n    BG-&gt;&gt;SM: push_event({ type: \"complete\" })\n    SM-&gt;&gt;SSE: \u7ec8\u7ed3\u4e8b\u4ef6\n    SSE--&gt;&gt;Client: event: complete + data: {complete}\n    SSE-&gt;&gt;SM: close_stream()</code></pre> <p>\u5173\u952e\u8bbe\u8ba1\u51b3\u7b56\uff1a - Background task \u521b\u5efa\u72ec\u7acb\u7684\u4f9d\u8d56\u5b9e\u4f8b\uff0c\u4e0d\u590d\u7528 HTTP \u8bf7\u6c42\u7684 session\uff08\u907f\u514d\u8bf7\u6c42\u7ed3\u675f\u540e session \u5931\u6548\uff09 - StreamManager \u4f5c\u4e3a\u4e2d\u95f4\u7f13\u51b2\u5c42\uff0c\u89e3\u8026 POST\uff08\u751f\u4ea7\u4e8b\u4ef6\uff09\u548c GET\uff08\u6d88\u8d39\u4e8b\u4ef6\uff09\u7684\u65f6\u5e8f - TTL \u673a\u5236\u9632\u6b62\u524d\u7aef\u4e0d\u8fde\u63a5\u65f6\u961f\u5217\u65e0\u9650\u589e\u957f - Graph \u6267\u884c\u72ec\u7acb\u4e8e SSE \u8fde\u63a5\uff1a\u524d\u7aef\u65ad\u5f00 SSE \u540e\uff0cgraph \u4ecd\u7ee7\u7eed\u8fd0\u884c\u5230\u5b8c\u6210\uff0c\u7ed3\u679c\u6301\u4e45\u5316\u5230\u6570\u636e\u5e93\uff0c\u7528\u6237\u5237\u65b0\u9875\u9762\u540e\u53ef\u67e5\u770b</p>"},{"location":"architecture/concurrency/#\u6570\u636e\u5e93\u5e76\u53d1\u914d\u7f6e","title":"\u6570\u636e\u5e93\u5e76\u53d1\u914d\u7f6e","text":"<p>\u5f53\u524d\u4f7f\u7528 SQLite + WAL \u6a21\u5f0f\uff1a</p> <pre><code>PRAGMA journal_mode=WAL       # \u8bfb\u5199\u53ef\u5e76\u53d1\nPRAGMA synchronous=NORMAL     # \u5e73\u8861\u6027\u80fd\u548c\u5b89\u5168\nPRAGMA busy_timeout=15000     # \u5199\u9501\u7b49\u5f85 15 \u79d2\nPRAGMA foreign_keys=ON\nPRAGMA cache_size=-64000      # 64MB \u7f13\u5b58\n</code></pre> <p>WAL \u6a21\u5f0f\u5141\u8bb8\u591a\u4e2a\u8bfb\u64cd\u4f5c\u5e76\u53d1\u6267\u884c\uff0c\u4f46\u5199\u64cd\u4f5c\u4ecd\u7136\u662f\u4e32\u884c\u7684\uff08\u5355\u5199\u8005\u6a21\u578b\uff09\u3002</p>"},{"location":"architecture/concurrency/#\u8fd0\u884c\u8fb9\u754c\u4e0e\u5df2\u77e5\u5c40\u9650","title":"\u8fd0\u884c\u8fb9\u754c\u4e0e\u5df2\u77e5\u5c40\u9650","text":""},{"location":"architecture/concurrency/#checkpointer-\u5355\u8fde\u63a5\u74f6\u9888","title":"Checkpointer \u5355\u8fde\u63a5\u74f6\u9888","text":"<p><code>AsyncSqliteSaver</code> \u4f7f\u7528\u5355\u4e2a <code>aiosqlite.connect()</code> \u8fde\u63a5\uff0c\u4f5c\u4e3a\u5168\u5c40\u5355\u4f8b\u88ab\u6240\u6709\u5e76\u53d1\u8bf7\u6c42\u5171\u4eab\u3002<code>aiosqlite</code> \u5185\u90e8\u53ea\u6709\u4e00\u4e2a\u540e\u53f0\u7ebf\u7a0b + \u961f\u5217\uff0c\u6240\u6709\u64cd\u4f5c\u4e32\u884c\u6267\u884c\u3002LangGraph \u6bcf\u4e2a node \u6267\u884c\u5b8c\u90fd\u8981\u5199 checkpoint\uff0cN \u4e2a\u5e76\u53d1\u7528\u6237 = \u6240\u6709 checkpoint \u8bfb\u5199\u6392\u961f\uff0c\u9ad8\u5e76\u53d1\u65f6\u6210\u4e3a\u5168\u5c40\u5ef6\u8fdf\u74f6\u9888\u3002</p> <p>\u7f13\u89e3: \u6f14\u8fdb\u8def\u7ebf Phase 2 \u8fc1\u79fb\u5230 <code>langgraph-checkpoint-redis</code>\u3002</p>"},{"location":"architecture/concurrency/#graph-\u91cd\u590d\u7f16\u8bd1","title":"Graph \u91cd\u590d\u7f16\u8bd1","text":"<p>\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u4f1a\u6267\u884c\uff1a\u521b\u5efa 3 \u4e2a Agent \u2192 \u521b\u5efa\u6240\u6709 Tool \u2192 \u6ce8\u518c\u5230 Registry \u2192 \u7f16\u8bd1 StateGraph\u3002Graph \u7ed3\u6784\u672c\u8eab\u662f\u65e0\u72b6\u6001\u7684\uff08\u72b6\u6001\u5b58\u5728 checkpointer \u91cc\uff09\uff0c\u7406\u8bba\u4e0a\u53ef\u7f16\u8bd1\u4e00\u6b21\u540e\u590d\u7528\u3002\u5f53\u524d\u8bbe\u8ba1\u662f\u56e0\u4e3a <code>artifact_manager</code> \u901a\u8fc7\u95ed\u5305\u7ed1\u5b9a\u5230 graph \u8282\u70b9\u4e2d\uff0c\u5bfc\u81f4 graph \u4e0e\u8bf7\u6c42\u7ea7\u5b9e\u4f8b\u8026\u5408\u3002</p> <p>\u7f13\u89e3: \u6f14\u8fdb\u8def\u7ebf Phase 3 \u2014 \u901a\u8fc7 state \u4f20\u9012 <code>artifact_manager</code> \u800c\u975e\u95ed\u5305\u6355\u83b7\uff0c\u5b9e\u73b0 graph \u7f16\u8bd1\u7f13\u5b58\u3002</p>"},{"location":"architecture/concurrency/#\u9519\u8bef\u4fe1\u606f\u6cc4\u9732\u5df2\u90e8\u5206\u7f13\u89e3","title":"\u9519\u8bef\u4fe1\u606f\u6cc4\u9732\uff08\u5df2\u90e8\u5206\u7f13\u89e3\uff09","text":"<p><code>_sanitize_error_event()</code>\uff08<code>api/routers/chat.py</code>\uff09\u5728\u975e DEBUG \u6a21\u5f0f\u4e0b\u5c06 error \u4e8b\u4ef6\u7684\u8be6\u60c5\u66ff\u6362\u4e3a <code>\"Internal server error\"</code>\uff0c\u5f00\u53d1\u6a21\u5f0f\u4fdd\u7559\u539f\u59cb <code>str(e)</code> \u4fbf\u4e8e\u8c03\u8bd5\u3002\u5f53\u524d\u8131\u654f\u4ec5\u8986\u76d6 SSE error \u4e8b\u4ef6\uff0cHTTP \u5f02\u5e38\uff08\u5982 500\uff09\u7684\u54cd\u5e94\u4f53\u5c1a\u672a\u7edf\u4e00\u5904\u7406\u3002</p>"},{"location":"architecture/concurrency/#\u5df2\u89e3\u51b3\u7684\u95ee\u9898","title":"\u5df2\u89e3\u51b3\u7684\u95ee\u9898","text":"<p>\u4ee5\u4e0b\u95ee\u9898\u5df2\u5728\u5386\u6b21\u8fed\u4ee3\u4e2d\u4fee\u590d\uff0c\u8be6\u7ec6\u4fee\u590d\u8bb0\u5f55\u89c1 optimization-plan.md\uff1a</p> <ul> <li>Background Task \u751f\u547d\u5468\u671f\u7ba1\u7406 \u2014 <code>TaskManager</code> \u6301\u6709\u4efb\u52a1\u5f15\u7528\u9632 GC\u3001Semaphore \u9650\u5236\u5e76\u53d1\u6570\u3001graceful shutdown</li> <li>SQLite \u5199\u5e76\u53d1 \u2014 \u77ed\u4e8b\u52a1\u6a21\u5f0f\uff0cRepository \u5c42\u7acb\u5373 <code>flush() + commit()</code></li> <li>\u8bf7\u6c42\u7ea7\u65e5\u5fd7\u4e0a\u4e0b\u6587 \u2014 <code>contextvars</code> + <code>RequestContextFilter</code> \u5b9e\u73b0 <code>[conv_id|thread_id]</code> \u65e5\u5fd7\u8ffd\u8e2a</li> <li>StreamManager \u5185\u5b58\u6cc4\u6f0f \u2014 \u5ef6\u8fdf\u6e05\u7406\u4efb\u52a1\uff0c\u5173\u95ed\u540e 5 \u79d2\u81ea\u52a8\u79fb\u9664</li> <li>\u8bf7\u6c42\u7ea7\u8d85\u65f6 \u2014 <code>asyncio.timeout(config.STREAM_TIMEOUT)</code></li> <li>SSE Heartbeat \u2014 <code>SSE_PING_INTERVAL</code> \u79d2\u53d1\u9001 <code>: ping</code> \u6ce8\u91ca</li> <li>\u8ba4\u8bc1\u9274\u6743 \u2014 JWT \u8ba4\u8bc1\u6846\u67b6 + \u6570\u636e\u9694\u79bb</li> </ul>"},{"location":"architecture/concurrency/#\u6f14\u8fdb\u65b9\u5411","title":"\u6f14\u8fdb\u65b9\u5411","text":""},{"location":"architecture/concurrency/#phase-1-redis-\u5f15\u5165--\u652f\u6301\u591a-worker-\u90e8\u7f72","title":"Phase 1: Redis \u5f15\u5165 \u2014 \u652f\u6301\u591a Worker \u90e8\u7f72","text":"<p>\u76ee\u6807: \u5c06\u8fdb\u7a0b\u5185\u72b6\u6001\u8fc1\u79fb\u5230 Redis\uff0c\u652f\u6301\u591a worker \u5b9e\u4f8b\u3002</p> \u7ec4\u4ef6 \u5f53\u524d \u8fc1\u79fb\u5230 ConversationManager._cache Python dict Redis Hash StreamManager \u4e8b\u4ef6\u961f\u5217 asyncio.Queue Redis Pub/Sub (\u6216 Redis Streams) <p>\u8fc1\u79fb\u540e\u7684\u67b6\u6784\uff1a</p> <pre><code>graph LR\n    W1[\"Worker 1\"] --&gt; Redis[\"Redis Pub/Sub\"]\n    W2[\"Worker 2\"] --&gt; Redis\n    W3[\"Worker 3\"] --&gt; Redis\n    Redis --&gt; C1[\"SSE Client A\"]\n    Redis --&gt; C2[\"SSE Client B\"]\n    Redis --&gt; C3[\"SSE Client C\"]</code></pre> <p>\u6ce8\u610f\u4e8b\u9879\uff1a - Redis Pub/Sub \u662f\"\u53d1\u540e\u5373\u5fd8\"\u7684\uff0c\u5982\u679c\u6d88\u8d39\u8005\u4e0d\u5728\u7ebf\u5219\u6d88\u606f\u4e22\u5931\u3002\u5982\u679c\u9700\u8981\u53ef\u9760\u6295\u9012\uff0c\u8003\u8651 Redis Streams\uff08\u652f\u6301\u6d88\u8d39\u8005\u7ec4 + ACK\uff09 - ConversationManager cache \u8fc1\u79fb\u540e\uff0c\u9700\u8981\u5904\u7406 cache invalidation \u7b56\u7565</p>"},{"location":"architecture/concurrency/#phase-2-checkpointer-\u8fc1\u79fb--ttl-\u7ba1\u7406","title":"Phase 2: Checkpointer \u8fc1\u79fb + TTL \u7ba1\u7406","text":"<p>\u76ee\u6807: \u89e3\u51b3 checkpoint \u5355\u8fde\u63a5\u74f6\u9888\u3002</p> \u7ec4\u4ef6 \u5f53\u524d \u8fc1\u79fb\u5230 LangGraph Checkpointer AsyncSqliteSaver\uff08\u5355 aiosqlite \u8fde\u63a5\uff09 langgraph-checkpoint-redis <p>Redis \u4f5c\u4e3a checkpointer \u7684\u4f18\u52bf\uff1a - \u5929\u7136\u652f\u6301\u5e76\u53d1\u8bfb\u5199\uff08\u65e0\u5199\u9501\u7ade\u4e89\uff09 - \u5185\u7f6e TTL\uff0ccheckpoint \u6570\u636e\u81ea\u52a8\u8fc7\u671f\u6e05\u7406 - \u8bfb\u5199\u5ef6\u8fdf\u8fdc\u4f4e\u4e8e SQLite</p> <pre><code># \u8fc1\u79fb\u793a\u4f8b\nfrom langgraph.checkpoint.redis.aio import AsyncRedisSaver\n\nasync def create_redis_checkpointer(redis_url: str):\n    checkpointer = AsyncRedisSaver.from_conn_string(redis_url)\n    await checkpointer.setup()\n    return checkpointer\n</code></pre>"},{"location":"architecture/concurrency/#phase-25-\u4e3b\u6570\u636e\u5e93\u8fc1\u79fb\u6309\u9700","title":"Phase 2.5: \u4e3b\u6570\u636e\u5e93\u8fc1\u79fb\uff08\u6309\u9700\uff09","text":"<p>\u89e6\u53d1\u6761\u4ef6: \u5f53\u77ed\u4e8b\u52a1\u6a21\u5f0f\u4ecd\u65e0\u6cd5\u6ee1\u8db3\u5e76\u53d1\u9700\u6c42\u65f6\uff08\u4f8b\u5982\u6781\u9ad8\u5199\u5165\u9891\u7387\uff09\u3002\u5f53\u524d SQLite + \u77ed\u4e8b\u52a1\u6a21\u5f0f\u53ef\u6ee1\u8db3\u4e2d\u7b49\u5e76\u53d1\u573a\u666f\u3002</p> <p>\u65b9\u6848 \u2014 \u8fc1\u79fb\u5230 PostgreSQL\uff1a - \u5f7b\u5e95\u89e3\u51b3\u5199\u5e76\u53d1\u95ee\u9898\uff08MVCC \u652f\u6301\u771f\u6b63\u7684\u591a\u5199\u8005\uff09 - SQLAlchemy \u5207\u6362\u53ea\u9700\u6539 <code>DATABASE_URL</code> \u548c driver</p>"},{"location":"architecture/concurrency/#phase-3-\u751f\u4ea7\u5316\u5b8c\u5584","title":"Phase 3: \u751f\u4ea7\u5316\u5b8c\u5584","text":"<ul> <li>API Rate Limiting\uff08per-user \u9650\u6d41\uff09</li> <li>\u5206\u5e03\u5f0f\u9501\uff08\u9632\u6b62\u540c\u4e00 conversation \u7684\u5e76\u53d1\u5199\u5165\u51b2\u7a81\uff09</li> <li>\u9519\u8bef\u4fe1\u606f\u8131\u654f\u8865\u5168\uff08SSE \u5df2\u8131\u654f\uff0cHTTP 500 \u54cd\u5e94\u4f53\u5f85\u7edf\u4e00\uff09</li> <li>Metrics \u91c7\u96c6\uff08Prometheus / OpenTelemetry\uff0c\u57fa\u4e8e\u5df2\u6709\u7684 <code>contextvars</code> \u8bf7\u6c42\u4e0a\u4e0b\u6587\u6269\u5c55 trace/span\uff09</li> <li>Graph \u7f16\u8bd1\u7f13\u5b58\uff08\u7f16\u8bd1\u4e00\u6b21\uff0c\u901a\u8fc7 state \u4f20\u9012 <code>artifact_manager</code> \u800c\u975e\u95ed\u5305\u6355\u83b7\uff09</li> </ul>"},{"location":"architecture/concurrency/#\u53c2\u8003","title":"\u53c2\u8003","text":"<ul> <li>Python asyncio.create_task \u2014 \u5173\u4e8e\u4efb\u52a1\u5f15\u7528\u7684\u8b66\u544a</li> <li>langgraph-checkpoint-redis</li> <li>SQLite WAL Mode</li> <li>FastAPI Lifespan Events</li> </ul>"},{"location":"architecture/core/","title":"Core \u6a21\u5757","text":"<p>Core \u6a21\u5757\u662f ArtifactFlow \u7684\u6838\u5fc3\u5f15\u64ce\uff0c\u8d1f\u8d23\u72b6\u6001\u7ba1\u7406\u3001\u5de5\u4f5c\u6d41\u7f16\u6392\u548c\u6267\u884c\u63a7\u5236\u3002</p>"},{"location":"architecture/core/#\u6a21\u5757\u7ed3\u6784","title":"\u6a21\u5757\u7ed3\u6784","text":"<pre><code>src/core/\n\u251c\u2500\u2500 state.py              # \u72b6\u6001\u5b9a\u4e49\u4e0e\u8f6c\u6362\n\u251c\u2500\u2500 events.py             # \u4e8b\u4ef6\u7c7b\u578b\u4e0e\u6307\u6807\n\u251c\u2500\u2500 graph.py              # LangGraph \u5de5\u4f5c\u6d41\n\u251c\u2500\u2500 controller.py         # \u6267\u884c\u63a7\u5236\u5668\n\u251c\u2500\u2500 context_manager.py    # \u4e0a\u4e0b\u6587\u7ba1\u7406\n\u2514\u2500\u2500 conversation_manager.py # \u5bf9\u8bdd\u7ba1\u7406\n</code></pre>"},{"location":"architecture/core/#\u72b6\u6001\u7cfb\u7edf-statepy","title":"\u72b6\u6001\u7cfb\u7edf (state.py)","text":""},{"location":"architecture/core/#executionphase","title":"ExecutionPhase","text":"<p>\u6267\u884c\u9636\u6bb5\u679a\u4e3e\uff0c\u63a7\u5236\u5de5\u4f5c\u6d41\u8def\u7531\uff1a</p> <pre><code>class ExecutionPhase(Enum):\n    LEAD_EXECUTING = \"lead_executing\"          # Lead Agent \u6267\u884c\u4e2d\n    SUBAGENT_EXECUTING = \"subagent_executing\"  # SubAgent \u6267\u884c\u4e2d\n    TOOL_EXECUTING = \"tool_executing\"          # \u5de5\u5177\u6267\u884c\u4e2d\n    WAITING_PERMISSION = \"waiting_permission\"  # \u7b49\u5f85\u6743\u9650\u786e\u8ba4\n    COMPLETED = \"completed\"                    # \u4efb\u52a1\u5b8c\u6210\n</code></pre>"},{"location":"architecture/core/#agentstate","title":"AgentState","text":"<p>LangGraph \u5168\u5c40\u72b6\u6001\uff0c\u8d2f\u7a7f\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\uff1a</p> <pre><code>class AgentState(TypedDict):\n    # \u57fa\u7840\u4fe1\u606f\n    current_task: str                           # \u5f53\u524d\u4efb\u52a1\u63cf\u8ff0\n    session_id: str                             # Artifact \u4f1a\u8bdd ID\n    thread_id: str                              # LangGraph \u7ebf\u7a0b ID\n\n    # \u5bf9\u8bdd\u4e0a\u4e0b\u6587\n    conversation_history: Optional[List[Dict]]  # \u683c\u5f0f\u5316\u7684\u5bf9\u8bdd\u5386\u53f2\n\n    # \u6267\u884c\u63a7\u5236\n    phase: ExecutionPhase                       # \u5f53\u524d\u6267\u884c\u9636\u6bb5\n    current_agent: str                          # \u5f53\u524d Agent \u540d\u79f0\n\n    # \u8def\u7531\u4fe1\u606f\n    subagent_pending: Optional[Dict]            # {\"target\", \"instruction\", \"subagent_result\"}\n    pending_tool_call: Optional[Dict]           # {\"tool_name\", \"params\", \"from_agent\", \"tool_result\"}\n\n    # \u8bb0\u5fc6\u7cfb\u7edf\n    agent_memories: Dict[str, NodeMemory]       # \u5404 Agent \u7684\u8bb0\u5fc6\uff08\u542b tool_round_count\uff09\n\n    # Context \u7ba1\u7406\n    compression_level: str                      # \u538b\u7f29\u7ea7\u522b\n\n    # \u7528\u6237\u4ea4\u4e92\u5c42\n    user_message_id: str                        # \u5f53\u524d\u7528\u6237\u6d88\u606f ID\n    graph_response: Optional[str]               # Graph \u6700\u7ec8\u54cd\u5e94\n\n    # \u53ef\u89c2\u6d4b\u6027\n    execution_metrics: ExecutionMetrics         # \u6267\u884c\u6307\u6807\n</code></pre> <p>\u5176\u4e2d <code>NodeMemory</code> \u7ed3\u6784\uff1a</p> <pre><code>class NodeMemory(TypedDict):\n    tool_interactions: List[Dict]      # assistant-tool \u4ea4\u4e92\u5386\u53f2\n    last_response: Optional[Dict]      # \u6700\u540e\u7684 AgentResponse\n    tool_round_count: int              # \u5f53\u524d\u8282\u70b9\u5de5\u5177\u8c03\u7528\u8ba1\u6570\n</code></pre>"},{"location":"architecture/core/#\u72b6\u6001\u8f6c\u6362\u51fd\u6570","title":"\u72b6\u6001\u8f6c\u6362\u51fd\u6570","text":"<p><code>merge_agent_response_to_state()</code> \u662f\u72b6\u6001\u66f4\u65b0\u7684\u7edf\u4e00\u5165\u53e3\uff08\u539f\u5730\u4fee\u6539 state\uff09\uff1a</p> <pre><code>def merge_agent_response_to_state(\n    state: AgentState,\n    agent_name: str,\n    response: AgentResponse,\n    is_resuming: bool = False\n) -&gt; None:\n    \"\"\"\n    \u5904\u7406 Agent \u54cd\u5e94\uff0c\u66f4\u65b0\u72b6\u6001\uff08\u539f\u5730\u4fee\u6539\uff09\n    - \u66f4\u65b0 current_agent\n    - \u6e05\u7406\u6062\u590d\u72b6\u6001\uff08\u5982\u679c is_resuming\uff09\n    - \u66f4\u65b0 agent_memories\uff08tool_interactions, last_response, tool_round_count\uff09\n    - \u89e3\u6790 routing \u4fe1\u606f\uff0c\u8bbe\u7f6e phase \u548c\u8def\u7531\u6570\u636e\n    \"\"\"\n</code></pre> <p>\u8def\u7531\u903b\u8f91\uff1a</p> <pre><code>flowchart TD\n    A[Agent \u8fd4\u56de Response] --&gt; B{\u68c0\u67e5 routing.type}\n    B --&gt;|tool_call| C[phase = TOOL_EXECUTING]\n    B --&gt;|subagent| D[phase = SUBAGENT_EXECUTING]\n    B --&gt;|\u65e0 routing| E{\u662f Lead Agent?}\n    E --&gt;|\u662f| F[phase = COMPLETED]\n    E --&gt;|\u5426| G[phase = LEAD_EXECUTING]\n    C --&gt; H[\u8bbe\u7f6e pending_tool_call]\n    D --&gt; I[\u8bbe\u7f6e subagent_pending]</code></pre>"},{"location":"architecture/core/#\u4e8b\u4ef6\u7cfb\u7edf-eventspy","title":"\u4e8b\u4ef6\u7cfb\u7edf (events.py)","text":""},{"location":"architecture/core/#streameventtype","title":"StreamEventType","text":"<p>\u7edf\u4e00\u7684\u4e8b\u4ef6\u7c7b\u578b\u5b9a\u4e49\uff0c\u8d2f\u7a7f Agent\u3001Graph\u3001Controller \u4e09\u5c42\uff1a</p> <pre><code>class StreamEventType(Enum):\n    # Controller \u5c42\u4e8b\u4ef6\n    METADATA = \"metadata\"          # \u521d\u59cb\u5143\u6570\u636e\n    COMPLETE = \"complete\"          # \u6267\u884c\u5b8c\u6210\n    ERROR = \"error\"                # \u6267\u884c\u9519\u8bef\n\n    # Agent \u5c42\u4e8b\u4ef6\n    AGENT_START = \"agent_start\"    # Agent \u5f00\u59cb\u6267\u884c\n    LLM_CHUNK = \"llm_chunk\"        # LLM \u6d41\u5f0f\u8f93\u51fa\u7247\u6bb5\n    LLM_COMPLETE = \"llm_complete\"  # LLM \u8f93\u51fa\u5b8c\u6210\n    AGENT_COMPLETE = \"agent_complete\"  # Agent \u6267\u884c\u5b8c\u6210\n\n    # Graph \u5c42\u4e8b\u4ef6\n    TOOL_START = \"tool_start\"        # \u5de5\u5177\u5f00\u59cb\u6267\u884c\n    TOOL_COMPLETE = \"tool_complete\"  # \u5de5\u5177\u6267\u884c\u5b8c\u6210\n    PERMISSION_REQUEST = \"permission_request\"  # \u8bf7\u6c42\u6743\u9650\u786e\u8ba4\n    PERMISSION_RESULT = \"permission_result\"    # \u6743\u9650\u786e\u8ba4\u7ed3\u679c\n</code></pre>"},{"location":"architecture/core/#executionmetrics","title":"ExecutionMetrics","text":"<p>\u53ef\u89c2\u6d4b\u6027\u6307\u6807\uff0c\u8bb0\u5f55\u6267\u884c\u8fc7\u7a0b\uff08\u4f7f\u7528 TypedDict\uff09\uff1a</p> <pre><code>class ExecutionMetrics(TypedDict):\n    started_at: str                               # ISO timestamp\n    completed_at: Optional[str]                   # ISO timestamp\n    total_duration_ms: Optional[int]\n    agent_executions: List[AgentExecutionRecord]  # append-only\n    tool_calls: List[ToolCallRecord]              # append-only\n\nclass AgentExecutionRecord(TypedDict):\n    agent_name: str\n    model: str\n    token_usage: TokenUsage\n    llm_duration_ms: int\n    started_at: str\n    completed_at: str\n\nclass ToolCallRecord(TypedDict):\n    tool_name: str\n    success: bool\n    duration_ms: int\n    called_at: str\n    completed_at: str\n    agent: str  # \u8c03\u7528\u65b9 agent\n</code></pre> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code># \u8bb0\u5f55 Agent \u6267\u884c\nappend_agent_execution(\n    metrics=state[\"execution_metrics\"],\n    agent_name=\"lead_agent\",\n    model=\"qwen-plus\",\n    token_usage={\"input_tokens\": 1000, \"output_tokens\": 500, \"total_tokens\": 1500},\n    started_at=start_time.isoformat(),\n    completed_at=end_time.isoformat(),\n    llm_duration_ms=1200\n)\n\n# \u8bb0\u5f55\u5de5\u5177\u8c03\u7528\nappend_tool_call(\n    metrics=state[\"execution_metrics\"],\n    tool_name=\"web_search\",\n    success=True,\n    duration_ms=1500,\n    called_at=start_time.isoformat(),\n    completed_at=end_time.isoformat(),\n    agent=\"search_agent\"\n)\n</code></pre>"},{"location":"architecture/core/#\u5de5\u4f5c\u6d41\u5f15\u64ce-graphpy","title":"\u5de5\u4f5c\u6d41\u5f15\u64ce (graph.py)","text":""},{"location":"architecture/core/#extendablegraph","title":"ExtendableGraph","text":"<p>\u57fa\u4e8e LangGraph \u7684\u53ef\u6269\u5c55\u5de5\u4f5c\u6d41\uff1a</p> <pre><code>class ExtendableGraph:\n    def __init__(self):\n        self.workflow = StateGraph(AgentState)\n        self.agents: Dict[str, BaseAgent] = {}\n\n    def register_agent(self, agent: BaseAgent):\n        \"\"\"\u6ce8\u518c Agent \u5e76\u521b\u5efa\u5bf9\u5e94\u8282\u70b9\"\"\"\n\n    async def compile(\n        self,\n        checkpointer: Optional[Any] = None,\n        interrupt_before: Optional[list] = None,\n        db_path: str = \"data/langgraph.db\"\n    ) -&gt; CompiledGraph:\n        \"\"\"\u7f16\u8bd1 Graph\uff0c\u6ce8\u5165 Checkpointer\"\"\"\n</code></pre>"},{"location":"architecture/core/#\u8282\u70b9\u7c7b\u578b","title":"\u8282\u70b9\u7c7b\u578b","text":"<p>Agent \u8282\u70b9\uff1a\u6267\u884c\u5355\u8f6e LLM \u8c03\u7528</p> <pre><code>def _create_agent_node(self, agent_name: str) -&gt; Callable:\n    async def agent_node(state: AgentState, writer: StreamWriter) -&gt; AgentState:\n        agent = self.agents[agent_name]\n\n        # \u6784\u5efa messages\n        messages = ContextManager.build_agent_messages(\n            agent=agent,\n            state=state,\n            instruction=instruction,\n            tool_interactions=tool_interactions,\n            pending_tool_result=pending_tool_result\n        )\n\n        # \u6d41\u5f0f\u6267\u884c Agent\n        async for event in agent.stream(messages, is_resuming):\n            writer({\n                \"type\": event.type.value,\n                \"agent\": event.agent,\n                \"timestamp\": event.timestamp.isoformat(),\n                \"data\": self._serialize_event_data(event.data)\n            })\n\n        # \u66f4\u65b0\u72b6\u6001\uff08\u539f\u5730\u4fee\u6539\uff09\n        merge_agent_response_to_state(state, agent_name, final_response, is_resuming)\n        return state\n\n    return agent_node\n</code></pre> <p>\u5de5\u5177\u6267\u884c\u8282\u70b9\uff1a\u7edf\u4e00\u5904\u7406\u5de5\u5177\u8c03\u7528</p> <pre><code>async def tool_execution_node(state: AgentState, writer: StreamWriter) -&gt; AgentState:\n    pending = state.get(\"pending_tool_call\")\n    from_agent = pending[\"from_agent\"]\n    tool_name = pending[\"tool_name\"]\n    params = pending[\"params\"]\n\n    # \u83b7\u53d6\u5de5\u5177\uff08\u901a\u8fc7 agent \u7684 toolkit\uff09\n    agent = self.agents.get(from_agent)\n    tool = agent.toolkit.get_tool(tool_name)\n\n    # \u6743\u9650\u68c0\u67e5\n    if tool.permission == ToolPermission.CONFIRM:\n        writer({...})  # PERMISSION_REQUEST\n        is_approved = interrupt({...})\n        if not is_approved:\n            pending[\"tool_result\"] = ToolResult(success=False, error=\"Permission denied\")\n            state[\"phase\"] = self._get_return_phase(from_agent)\n            return state\n\n    # \u6267\u884c\u5de5\u5177\n    writer({...})  # TOOL_START\n    tool_result = await agent.toolkit.execute_tool(tool_name, params)\n    writer({...})  # TOOL_COMPLETE\n\n    # \u4fdd\u5b58\u7ed3\u679c\u5e76\u8fd4\u56de\u539f Agent\n    pending[\"tool_result\"] = tool_result\n    state[\"phase\"] = self._get_return_phase(from_agent)\n    return state\n</code></pre>"},{"location":"architecture/core/#\u8def\u7531\u89c4\u5219","title":"\u8def\u7531\u89c4\u5219","text":"<pre><code>def _add_routing_rules(self, agent_name: str):\n    def route_func(state: AgentState) -&gt; str:\n        phase = state[\"phase\"]\n        if phase == ExecutionPhase.TOOL_EXECUTING:\n            return \"tool_execution\"\n        elif phase == ExecutionPhase.SUBAGENT_EXECUTING:\n            return state[\"subagent_pending\"][\"target\"]\n        elif phase == ExecutionPhase.LEAD_EXECUTING:\n            return \"lead_agent\"\n        elif phase == ExecutionPhase.COMPLETED:\n            return END\n        return END\n\n    # Agent \u8282\u70b9\u540e\u7684\u8def\u7531\n    self.workflow.add_conditional_edges(\n        agent_name,\n        route_func,\n        {\n            \"tool_execution\": \"tool_execution\",\n            \"lead_agent\": \"lead_agent\",\n            \"search_agent\": \"search_agent\",\n            \"crawl_agent\": \"crawl_agent\",\n            END: END\n        }\n    )\n</code></pre>"},{"location":"architecture/core/#\u72b6\u6001\u673a\u56fe\u793a","title":"\u72b6\u6001\u673a\u56fe\u793a","text":"<p>\u4ee5 Lead \u2192 Search \u8c03\u7528\u4e3a\u4f8b\uff1a</p> <pre><code>stateDiagram-v2\n    [*] --&gt; lead_agent: START\n\n    lead_agent --&gt; tool_execution: \u5de5\u5177\u8c03\u7528\n    lead_agent --&gt; search_agent: \u8c03\u7528 SubAgent\n    lead_agent --&gt; [*]: COMPLETED\n\n    search_agent --&gt; tool_execution: \u5de5\u5177\u8c03\u7528\n    search_agent --&gt; lead_agent: \u8fd4\u56de\u7ed3\u679c\n\n    tool_execution --&gt; lead_agent: \u8fd4\u56de\u539f Agent\n    tool_execution --&gt; search_agent: \u8fd4\u56de\u539f Agent</code></pre> <p>\u5176\u4ed6 SubAgent\uff08\u5982 crawl_agent\uff09\u7684\u6d41\u7a0b\u4e0e search_agent \u76f8\u540c\u3002</p>"},{"location":"architecture/core/#\u6267\u884c\u63a7\u5236\u5668-controllerpy","title":"\u6267\u884c\u63a7\u5236\u5668 (controller.py)","text":""},{"location":"architecture/core/#executioncontroller","title":"ExecutionController","text":"<p>\u534f\u8c03\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\u7684\u5165\u53e3\uff1a</p> <pre><code>class ExecutionController:\n    def __init__(\n        self,\n        compiled_graph,\n        artifact_manager: Optional[ArtifactManager] = None,\n        conversation_manager: Optional[ConversationManager] = None\n    ):\n        self.graph = compiled_graph\n        self.conversation_manager = conversation_manager or ConversationManager()\n        self.artifact_manager = artifact_manager or ArtifactManager()\n\n    async def stream_execute(\n        self,\n        content: Optional[str] = None,\n        thread_id: Optional[str] = None,\n        conversation_id: Optional[str] = None,\n        parent_message_id: Any = _UNSET,  # _UNSET=auto-detect, None=root, str=specific parent\n        message_id: Optional[str] = None,\n        resume_data: Optional[Dict] = None\n    ) -&gt; AsyncGenerator[Dict[str, Any], None]:\n        \"\"\"\u6d41\u5f0f\u6267\u884c\uff0cyield \u4e8b\u4ef6\u5b57\u5178\"\"\"\n\n    async def execute(self, ...) -&gt; Dict[str, Any]:\n        \"\"\"\u6279\u91cf\u6267\u884c\uff0c\u7b49\u5f85\u5b8c\u6210\"\"\"\n</code></pre>"},{"location":"architecture/core/#\u6267\u884c\u6d41\u7a0b","title":"\u6267\u884c\u6d41\u7a0b","text":"<pre><code>async def _stream_new_message(self, content, conversation_id, parent_message_id):\n    # 1. \u786e\u4fdd conversation \u5b58\u5728\n    if not conversation_id:\n        conversation_id = await self.conversation_manager.start_conversation_async()\n    else:\n        await self.conversation_manager.ensure_conversation_exists(conversation_id)\n\n    # 2. \u81ea\u52a8\u8bbe\u7f6e parent_message_id\uff08\u4ec5\u5f53\u672a\u663e\u5f0f\u63d0\u4f9b\u65f6\uff09\n    # _UNSET = \u672a\u4f20\uff0c\u81ea\u52a8\u68c0\u6d4b\uff1bNone = \u663e\u5f0f\u521b\u5efa\u6839\u6d88\u606f\uff1bstr = \u6307\u5b9a\u7236\u6d88\u606f\n    if parent_message_id is _UNSET:\n        parent_message_id = await self.conversation_manager.get_active_branch(conversation_id)\n    resolved_parent = parent_message_id if isinstance(parent_message_id, str) else None\n\n    # 3. \u683c\u5f0f\u5316\u5bf9\u8bdd\u5386\u53f2\n    conversation_history = await self.conversation_manager.format_conversation_history_async(\n        conv_id=conversation_id,\n        to_message_id=parent_message_id\n    )\n\n    # 4. \u751f\u6210 ID\n    message_id = f\"msg-{uuid4().hex}\"\n    thread_id = f\"thd-{uuid4().hex}\"\n    session_id = self._get_or_create_session(conversation_id)\n\n    # 5. \u521b\u5efa\u521d\u59cb\u72b6\u6001\n    initial_state = create_initial_state(\n        task=content,\n        session_id=session_id,\n        thread_id=thread_id,\n        message_id=message_id,\n        conversation_history=conversation_history\n    )\n\n    # 6. \u6dfb\u52a0\u6d88\u606f\u5230 conversation\n    await self.conversation_manager.add_message_async(\n        conv_id=conversation_id,\n        message_id=message_id,\n        content=content,\n        thread_id=thread_id,\n        parent_id=parent_message_id\n    )\n\n    # 7. \u53d1\u9001\u5143\u6570\u636e\u4e8b\u4ef6\n    yield {\n        \"type\": StreamEventType.METADATA.value,\n        \"timestamp\": datetime.now().isoformat(),\n        \"data\": {\"conversation_id\": conversation_id, \"message_id\": message_id, \"thread_id\": thread_id}\n    }\n\n    # 8. \u6267\u884c Graph\n    async for chunk in self.graph.astream(initial_state, config, stream_mode=\"custom\"):\n        yield chunk\n\n    # 9. \u4fdd\u5b58\u54cd\u5e94\n    await self.conversation_manager.update_response_async(\n        conv_id=conversation_id,\n        message_id=message_id,\n        response=response\n    )\n\n    # 10. \u53d1\u9001\u5b8c\u6210\u4e8b\u4ef6\n    yield {\"type\": StreamEventType.COMPLETE.value, \"data\": {...}}\n</code></pre>"},{"location":"architecture/core/#\u4e0a\u4e0b\u6587\u7ba1\u7406-context_managerpy","title":"\u4e0a\u4e0b\u6587\u7ba1\u7406 (context_manager.py)","text":""},{"location":"architecture/core/#contextmanager","title":"ContextManager","text":"<p>\u4e3a Agent \u51c6\u5907\u6267\u884c\u4e0a\u4e0b\u6587\uff1a</p> <pre><code>class ContextManager:\n    @classmethod\n    def prepare_agent_context(cls, state: Dict[str, Any]) -&gt; Dict[str, Any]:\n        \"\"\"\n        \u6784\u5efa\u8def\u7531\u4e0a\u4e0b\u6587\uff08\u7528\u4e8e\u7cfb\u7edf\u63d0\u793a\u6ce8\u5165\uff09\uff1a\n        - session_id, thread_id, user_message_id\n        - artifacts_inventory\uff08Artifact \u5217\u8868\uff09\n        \"\"\"\n\n    @classmethod\n    def build_agent_messages(\n        cls,\n        agent: Any,  # BaseAgent \u5b9e\u4f8b\n        state: Dict[str, Any],\n        instruction: str,\n        tool_interactions: Optional[List[Dict]] = None,\n        pending_tool_result: Optional[Tuple[str, Any]] = None\n    ) -&gt; List[Dict]:\n        \"\"\"\n        \u7edf\u4e00\u6784\u5efa Agent messages\uff0c\u62fc\u63a5\u987a\u5e8f\uff1a\n        system \u2192 conversation_history \u2192 instruction \u2192 tool_interactions \u2192 tool_result\n        \"\"\"\n</code></pre>"},{"location":"architecture/core/#\u6d88\u606f\u538b\u7f29","title":"\u6d88\u606f\u538b\u7f29","text":"<p>\u57fa\u4e8e\u5b57\u7b26\u6570\u9650\u5236\u7684\u6d88\u606f\u538b\u7f29\uff1a</p> <pre><code>COMPRESSION_LEVELS = {\n    'full': 160000,\n    'normal': 80000,\n    'compact': 40000,\n    'minimal': 20000\n}\n\n@classmethod\ndef should_compress(cls, messages: List[Dict], level: str = \"normal\") -&gt; bool:\n    \"\"\"\u5224\u65ad\u662f\u5426\u9700\u8981\u538b\u7f29\"\"\"\n\n@classmethod\ndef compress_messages(\n    cls,\n    messages: List[Dict],\n    level: str = \"normal\",\n    preserve_recent: int = 5\n) -&gt; List[Dict]:\n    \"\"\"\n    \u538b\u7f29\u6d88\u606f\u5386\u53f2\uff08\u540c\u6b65\u65b9\u6cd5\uff0c\u57fa\u4e8e\u5b57\u7b26\u6570\u622a\u65ad\uff09\n    - \u4fdd\u7559\u6700\u8fd1 N \u6761\u5b8c\u6574\u6d88\u606f\n    - \u8d85\u51fa\u90e8\u5206\u6dfb\u52a0\u622a\u65ad\u6807\u8bb0\n    \"\"\"\n</code></pre>"},{"location":"architecture/core/#\u5bf9\u8bdd\u7ba1\u7406-conversation_managerpy","title":"\u5bf9\u8bdd\u7ba1\u7406 (conversation_manager.py)","text":""},{"location":"architecture/core/#conversationmanager","title":"ConversationManager","text":"<p>\u7ba1\u7406\u5bf9\u8bdd\u6811\u7ed3\u6784\uff1a</p> <pre><code>class ConversationManager:\n    def __init__(self, repository: Optional[ConversationRepository] = None):\n        self.repository = repository\n        self._cache: Dict[str, ConversationCache] = {}\n\n    async def start_conversation_async(\n        self,\n        conversation_id: Optional[str] = None\n    ) -&gt; str:\n        \"\"\"\u521b\u5efa\u65b0\u5bf9\u8bdd\uff0c\u8fd4\u56de\u5bf9\u8bdd ID\"\"\"\n\n    async def add_message_async(\n        self,\n        conv_id: str,\n        message_id: str,\n        content: str,\n        thread_id: str,\n        parent_id: Optional[str] = None\n    ) -&gt; Dict:\n        \"\"\"\u6dfb\u52a0\u6d88\u606f\u5230\u5bf9\u8bdd\u6811\"\"\"\n\n    async def format_conversation_history_async(\n        self,\n        conv_id: str,\n        to_message_id: Optional[str] = None\n    ) -&gt; List[Dict]:\n        \"\"\"\n        \u683c\u5f0f\u5316\u4ece root \u5230\u6307\u5b9a\u6d88\u606f\u7684\u5bf9\u8bdd\u5386\u53f2\n        \u8fd4\u56de: [{\"role\": \"user\", \"content\": ...}, {\"role\": \"assistant\", ...}, ...]\n        \"\"\"\n\n    async def get_active_branch(self, conv_id: str) -&gt; Optional[str]:\n        \"\"\"\u83b7\u53d6\u5bf9\u8bdd\u7684\u6d3b\u8dc3\u5206\u652f\uff08\u5f53\u524d\u6700\u65b0\u6d88\u606f ID\uff09\"\"\"\n\n    async def list_conversations_async(\n        self,\n        limit: int = 50,\n        offset: int = 0\n    ) -&gt; List[Dict]:\n        \"\"\"\u5217\u51fa\u6240\u6709\u5bf9\u8bdd\"\"\"\n</code></pre>"},{"location":"architecture/core/#\u6811\u72b6\u6d88\u606f\u7ed3\u6784","title":"\u6811\u72b6\u6d88\u606f\u7ed3\u6784","text":"<pre><code>Conversation\n    \u2502\n    \u2514\u2500\u2500 Message (root, parent_id=None)\n            \u2502\n            \u251c\u2500\u2500 Message (branch 1)\n            \u2502       \u2502\n            \u2502       \u2514\u2500\u2500 Message (leaf)\n            \u2502\n            \u2514\u2500\u2500 Message (branch 2)\n                    \u2502\n                    \u2514\u2500\u2500 Message (leaf)\n</code></pre> <p>\u652f\u6301\u4ece\u4efb\u610f\u6d88\u606f\u8282\u70b9\u521b\u5efa\u5206\u652f\uff0c\u5b9e\u73b0\u5bf9\u8bdd\u7248\u672c\u63a7\u5236\u3002</p>"},{"location":"architecture/data-layer/","title":"\u6570\u636e\u5c42","text":"<p>\u6570\u636e\u5c42\u8d1f\u8d23\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5305\u62ec\u5bf9\u8bdd\u5386\u53f2\u3001\u6d88\u606f\u3001Artifact \u7b49\u3002</p>"},{"location":"architecture/data-layer/#\u6a21\u5757\u7ed3\u6784","title":"\u6a21\u5757\u7ed3\u6784","text":"<pre><code>src/\n\u251c\u2500\u2500 db/\n\u2502   \u251c\u2500\u2500 models.py      # SQLAlchemy ORM \u6a21\u578b\n\u2502   \u2514\u2500\u2500 database.py    # \u6570\u636e\u5e93\u7ba1\u7406\u5668\n\u2514\u2500\u2500 repositories/\n    \u251c\u2500\u2500 base.py        # Repository \u57fa\u7c7b\n    \u251c\u2500\u2500 conversation_repo.py\n    \u251c\u2500\u2500 artifact_repo.py\n    \u2514\u2500\u2500 user_repo.py   # \u7528\u6237\u6570\u636e\u8bbf\u95ee\n</code></pre>"},{"location":"architecture/data-layer/#\u6570\u636e\u6a21\u578b-modelspy","title":"\u6570\u636e\u6a21\u578b (models.py)","text":""},{"location":"architecture/data-layer/#er-\u56fe","title":"ER \u56fe","text":"<pre><code>erDiagram\n    User ||--o{ Conversation : owns\n    Conversation ||--o{ Message : contains\n    Conversation ||--o| ArtifactSession : has\n    ArtifactSession ||--o{ Artifact : contains\n    Artifact ||--o{ ArtifactVersion : versions\n\n    User {\n        string id PK\n        string username UK\n        string hashed_password\n        string display_name\n        string role\n        bool is_active\n        datetime created_at\n        datetime updated_at\n    }\n\n    Conversation {\n        string id PK\n        string active_branch\n        string title\n        string user_id FK\n        datetime created_at\n        datetime updated_at\n        json metadata_\n    }\n\n    Message {\n        string id PK\n        string conversation_id FK\n        string parent_id\n        text content\n        string thread_id\n        text graph_response\n        datetime created_at\n        json metadata_\n    }\n\n    ArtifactSession {\n        string id PK \"FK\"\n        datetime created_at\n        datetime updated_at\n    }\n\n    Artifact {\n        string id PK\n        string session_id PK \"FK\"\n        string content_type\n        string title\n        text content\n        int current_version\n        int lock_version\n        datetime created_at\n        datetime updated_at\n        json metadata_\n    }\n\n    ArtifactVersion {\n        int id PK\n        string artifact_id FK\n        string session_id FK\n        int version\n        text content\n        string update_type\n        json changes\n        datetime created_at\n    }</code></pre>"},{"location":"architecture/data-layer/#user","title":"User","text":"<p>\u7528\u6237\u5b9e\u4f53\uff08\u8ba4\u8bc1\u4e0e\u6570\u636e\u9694\u79bb\uff09\uff1a</p> <pre><code>class User(Base):\n    __tablename__ = \"users\"\n\n    id: Mapped[str] = mapped_column(String(64), primary_key=True)       # \"user-{uuid}\"\n    username: Mapped[str] = mapped_column(String(64), unique=True, index=True)\n    hashed_password: Mapped[str] = mapped_column(String(256))\n    display_name: Mapped[Optional[str]] = mapped_column(String(128), nullable=True)\n    role: Mapped[str] = mapped_column(String(16), default=\"user\")       # \"admin\" | \"user\"\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now)\n    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now, onupdate=datetime.now)\n\n    conversations: Mapped[List[\"Conversation\"]] = relationship(\"Conversation\", back_populates=\"owner\")\n</code></pre> <p>\u89d2\u8272\u8bf4\u660e\uff1a - <code>admin</code>\uff1a\u53ef\u521b\u5efa/\u7ba1\u7406\u7528\u6237\u3001\u67e5\u770b\u6240\u6709\u7528\u6237\u5217\u8868 - <code>user</code>\uff1a\u666e\u901a\u7528\u6237\uff0c\u53ea\u80fd\u8bbf\u95ee\u81ea\u5df1\u7684\u5bf9\u8bdd\u548c Artifact</p>"},{"location":"architecture/data-layer/#conversation","title":"Conversation","text":"<p>\u5bf9\u8bdd\u5b9e\u4f53\uff1a</p> <pre><code>class Conversation(Base):\n    __tablename__ = \"conversations\"\n\n    id: Mapped[str] = mapped_column(String(64), primary_key=True)\n    active_branch: Mapped[Optional[str]] = mapped_column(String(64), nullable=True)\n    title: Mapped[Optional[str]] = mapped_column(String(256), nullable=True)\n    user_id: Mapped[Optional[str]] = mapped_column(\n        String(64), ForeignKey(\"users.id\", ondelete=\"SET NULL\"), nullable=True, index=True\n    )\n    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now)\n    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now, onupdate=datetime.now)\n    metadata_: Mapped[Optional[Dict[str, Any]]] = mapped_column(\"metadata\", JSON, nullable=True)\n\n    # \u5173\u7cfb\n    owner: Mapped[Optional[\"User\"]] = relationship(\"User\", back_populates=\"conversations\")\n    messages: Mapped[List[\"Message\"]] = relationship(\n        \"Message\", back_populates=\"conversation\", cascade=\"all, delete-orphan\", lazy=\"selectin\"\n    )\n    artifact_session: Mapped[Optional[\"ArtifactSession\"]] = relationship(\n        \"ArtifactSession\", back_populates=\"conversation\", uselist=False, cascade=\"all, delete-orphan\"\n    )\n</code></pre> <p>\u6570\u636e\u9694\u79bb\uff1a<code>user_id</code> \u5916\u952e\u5173\u8054 <code>users.id</code>\uff0cAPI \u5c42\u901a\u8fc7 ownership \u6821\u9a8c\u786e\u4fdd\u7528\u6237\u53ea\u80fd\u8bbf\u95ee\u81ea\u5df1\u7684\u5bf9\u8bdd\u3002\u8de8\u7528\u6237\u8bbf\u95ee\u7edf\u4e00\u8fd4\u56de 404\uff08\u4e0d\u66b4\u9732\u5b58\u5728\u6027\uff09\u3002</p>"},{"location":"architecture/data-layer/#message","title":"Message","text":"<p>\u6d88\u606f\u5b9e\u4f53\uff08\u6811\u72b6\u7ed3\u6784\uff09\uff1a</p> <pre><code>class Message(Base):\n    __tablename__ = \"messages\"\n\n    id: Mapped[str] = mapped_column(String(64), primary_key=True)\n    conversation_id: Mapped[str] = mapped_column(\n        String(64), ForeignKey(\"conversations.id\", ondelete=\"CASCADE\")\n    )\n    parent_id: Mapped[Optional[str]] = mapped_column(String(64), nullable=True)  # None = \u6839\u6d88\u606f\n    content: Mapped[str] = mapped_column(Text)                      # \u7528\u6237\u6d88\u606f\n    thread_id: Mapped[str] = mapped_column(String(64))              # LangGraph \u7ebf\u7a0b ID\n    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now)\n    graph_response: Mapped[Optional[str]] = mapped_column(Text)     # Agent \u56de\u590d\n    metadata_: Mapped[Optional[Dict]] = mapped_column(\"metadata\", JSON)  # \u6269\u5c55\u5143\u6570\u636e\n\n    conversation: Mapped[\"Conversation\"] = relationship(\"Conversation\", back_populates=\"messages\")\n</code></pre> <p>\u6811\u72b6\u7ed3\u6784\u8bf4\u660e\uff1a</p> <pre><code>parent_id \u5b9e\u73b0\u6d88\u606f\u6811\uff1a\n\nmsg_1 (parent_id=None)     \u2190 \u6839\u6d88\u606f\n  \u251c\u2500\u2500 msg_2 (parent_id=msg_1)\n  \u2502     \u2514\u2500\u2500 msg_4 (parent_id=msg_2)\n  \u2514\u2500\u2500 msg_3 (parent_id=msg_1)    \u2190 \u5206\u652f\n        \u2514\u2500\u2500 msg_5 (parent_id=msg_3)\n</code></pre>"},{"location":"architecture/data-layer/#artifact","title":"Artifact","text":"<p>\u6587\u7a3f\u5b9e\u4f53\uff08\u590d\u5408\u4e3b\u952e + \u4e50\u89c2\u9501\uff09\uff1a</p> <pre><code>class Artifact(Base):\n    __tablename__ = \"artifacts\"\n\n    # \u590d\u5408\u4e3b\u952e\n    id: Mapped[str] = mapped_column(String(64), primary_key=True)\n    session_id: Mapped[str] = mapped_column(\n        String(64), ForeignKey(\"artifact_sessions.id\", ondelete=\"CASCADE\"), primary_key=True\n    )\n\n    content_type: Mapped[str] = mapped_column(String(32))  # markdown/python/etc\n    title: Mapped[str] = mapped_column(String(256))\n    content: Mapped[str] = mapped_column(Text, default=\"\")\n\n    # \u7248\u672c\u63a7\u5236\n    current_version: Mapped[int] = mapped_column(Integer, default=1)\n    lock_version: Mapped[int] = mapped_column(Integer, default=1)  # \u4e50\u89c2\u9501\n\n    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now)\n    updated_at: Mapped[datetime] = mapped_column(DateTime, onupdate=datetime.now)\n    metadata_: Mapped[Optional[Dict]] = mapped_column(\"metadata\", JSON)\n\n    versions: Mapped[List[\"ArtifactVersion\"]] = relationship(\n        \"ArtifactVersion\", back_populates=\"artifact\", cascade=\"all, delete-orphan\"\n    )\n</code></pre>"},{"location":"architecture/data-layer/#artifactversion","title":"ArtifactVersion","text":"<p>\u7248\u672c\u5386\u53f2\uff1a</p> <pre><code>class ArtifactVersion(Base):\n    __tablename__ = \"artifact_versions\"\n\n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n\n    # \u590d\u5408\u5916\u952e\n    artifact_id: Mapped[str] = mapped_column(String(64))\n    session_id: Mapped[str] = mapped_column(String(64))\n\n    version: Mapped[int] = mapped_column(Integer)\n    content: Mapped[str] = mapped_column(Text)\n    update_type: Mapped[str] = mapped_column(String(32))  # create/update/update_fuzzy/rewrite\n    changes: Mapped[Optional[List]] = mapped_column(JSON)  # [(old, new), ...]\n    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now)\n\n    artifact: Mapped[\"Artifact\"] = relationship(\"Artifact\", back_populates=\"versions\")\n\n    __table_args__ = (\n        UniqueConstraint(\"artifact_id\", \"session_id\", \"version\"),\n        ForeignKeyConstraint(\n            [\"artifact_id\", \"session_id\"],\n            [\"artifacts.id\", \"artifacts.session_id\"],\n            ondelete=\"CASCADE\"\n        ),\n    )\n</code></pre>"},{"location":"architecture/data-layer/#\u6570\u636e\u5e93\u7ba1\u7406-databasepy","title":"\u6570\u636e\u5e93\u7ba1\u7406 (database.py)","text":""},{"location":"architecture/data-layer/#databasemanager","title":"DatabaseManager","text":"<pre><code>class DatabaseManager:\n    def __init__(\n        self,\n        database_url: Optional[str] = None,\n        echo: bool = False,\n    ):\n        \"\"\"\n        Args:\n            database_url: \u6570\u636e\u5e93\u8fde\u63a5 URL\uff0c\u9ed8\u8ba4\u4e3a SQLite\n            echo: \u662f\u5426\u6253\u5370 SQL \u8bed\u53e5\uff08\u8c03\u8bd5\u7528\uff09\n        \"\"\"\n        if database_url is None:\n            database_url = \"sqlite+aiosqlite:///data/artifactflow.db\"\n        self.database_url = database_url\n        self.echo = echo\n        self._engine: Optional[AsyncEngine] = None\n        self._session_factory: Optional[async_sessionmaker] = None\n        self._initialized = False\n\n    async def initialize(self):\n        \"\"\"\u521d\u59cb\u5316\u6570\u636e\u5e93\uff08\u521b\u5efa\u5f15\u64ce\u3001\u914d\u7f6e WAL\u3001\u521b\u5efa\u8868\uff09\"\"\"\n        self._engine = create_async_engine(self.database_url, echo=self.echo)\n\n        # SQLite WAL \u6a21\u5f0f\u914d\u7f6e\uff08\u63d0\u9ad8\u5e76\u53d1\u6027\u80fd\uff09\n        if \"sqlite\" in self.database_url:\n            async with self._engine.begin() as conn:\n                await conn.execute(text(\"PRAGMA journal_mode=WAL\"))\n                await conn.execute(text(\"PRAGMA foreign_keys=ON\"))\n\n        self._session_factory = async_sessionmaker(\n            bind=self._engine,\n            class_=AsyncSession,\n            expire_on_commit=False,\n            autoflush=False,\n        )\n\n        # \u521b\u5efa\u6240\u6709\u8868\n        async with self._engine.begin() as conn:\n            await conn.run_sync(Base.metadata.create_all)\n\n        self._initialized = True\n\n    @asynccontextmanager\n    async def session(self) -&gt; AsyncGenerator[AsyncSession, None]:\n        \"\"\"\u83b7\u53d6\u6570\u636e\u5e93\u4f1a\u8bdd\uff08\u7eaf\u751f\u547d\u5468\u671f\u7ba1\u7406\uff0c\u4e0d\u81ea\u52a8 commit/rollback\uff09\"\"\"\n        if not self._initialized:\n            await self.initialize()\n\n        session = self._session_factory()\n        try:\n            yield session\n        finally:\n            await session.close()\n\n    async def close(self):\n        \"\"\"\u5173\u95ed\u6570\u636e\u5e93\u8fde\u63a5\"\"\"\n        if self._engine:\n            await self._engine.dispose()\n            self._initialized = False\n</code></pre> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>db_manager = DatabaseManager(\"sqlite+aiosqlite:///data/app.db\")\nawait db_manager.initialize()\n\nasync with db_manager.session() as session:\n    repo = ConversationRepository(session)\n    conversation = await repo.get_by_id(\"xxx\")\n</code></pre>"},{"location":"architecture/data-layer/#repository-\u6a21\u5f0f","title":"Repository \u6a21\u5f0f","text":""},{"location":"architecture/data-layer/#baserepository","title":"BaseRepository","text":"<p>\u901a\u7528 CRUD \u64cd\u4f5c\uff1a</p> <pre><code>class BaseRepository(ABC, Generic[T]):\n    def __init__(self, session: AsyncSession, model_class: Type[T]):\n        self._session = session\n        self._model_class = model_class\n\n    async def get_by_id(self, id: Any) -&gt; Optional[T]:\n        return await self._session.get(self._model_class, id)\n\n    async def get_all(self, *, limit: Optional[int] = None, offset: Optional[int] = None) -&gt; List[T]:\n        query = select(self._model_class)\n        if offset: query = query.offset(offset)\n        if limit: query = query.limit(limit)\n        result = await self._session.execute(query)\n        return list(result.scalars().all())\n\n    async def count(self) -&gt; int:\n        \"\"\"\u83b7\u53d6\u5b9e\u4f53\u603b\u6570\"\"\"\n\n    async def exists(self, id: Any) -&gt; bool:\n        \"\"\"\u68c0\u67e5\u5b9e\u4f53\u662f\u5426\u5b58\u5728\"\"\"\n\n    async def add(self, entity: T) -&gt; T:\n        \"\"\"\u6dfb\u52a0\u65b0\u5b9e\u4f53\uff08flush + commit \u7acb\u5373\u91ca\u653e\u5199\u9501\uff09\"\"\"\n        self._session.add(entity)\n        await self._session.flush()\n        await self._session.commit()\n        await self._session.refresh(entity)\n        return entity\n\n    async def add_all(self, entities: List[T]) -&gt; List[T]:\n        \"\"\"\u6279\u91cf\u6dfb\u52a0\u5b9e\u4f53\"\"\"\n        self._session.add_all(entities)\n        await self._session.flush()\n        await self._session.commit()\n        for entity in entities:\n            await self._session.refresh(entity)\n        return entities\n\n    async def update(self, entity: T) -&gt; T:\n        \"\"\"\u66f4\u65b0\u5b9e\u4f53\uff08\u9700\u5df2\u5728 Session \u4e2d\uff09\"\"\"\n        await self._session.flush()\n        await self._session.commit()\n        await self._session.refresh(entity)\n        return entity\n\n    async def delete(self, entity: T) -&gt; None:\n        \"\"\"\u5220\u9664\u5b9e\u4f53\"\"\"\n        await self._session.delete(entity)\n        await self._session.flush()\n        await self._session.commit()\n\n    async def delete_by_id(self, id: Any) -&gt; bool:\n        \"\"\"\u6839\u636e\u4e3b\u952e\u5220\u9664\"\"\"\n</code></pre>"},{"location":"architecture/data-layer/#conversationrepository","title":"ConversationRepository","text":"<p>\u5bf9\u8bdd\u548c\u6d88\u606f\u64cd\u4f5c\uff1a</p> \u65b9\u6cd5 \u8bf4\u660e <code>create_conversation</code> \u521b\u5efa\u65b0\u5bf9\u8bdd\uff08\u540c\u65f6\u521b\u5efa\u5173\u8054\u7684 ArtifactSession\uff09 <code>get_conversation</code> \u83b7\u53d6\u5bf9\u8bdd\uff08\u53ef\u9009\u9884\u52a0\u8f7d\u6d88\u606f\u548c Artifacts\uff09 <code>get_conversation_or_raise</code> \u83b7\u53d6\u5bf9\u8bdd\uff0c\u4e0d\u5b58\u5728\u5219\u629b\u51fa NotFoundError <code>update_active_branch</code> \u66f4\u65b0\u5bf9\u8bdd\u7684\u6d3b\u52a8\u5206\u652f <code>update_title</code> \u66f4\u65b0\u5bf9\u8bdd\u6807\u9898 <code>list_conversations</code> \u5217\u51fa\u5bf9\u8bdd\uff08\u652f\u6301\u5206\u9875\u3001\u6309 <code>user_id</code> \u8fc7\u6ee4\uff09 <code>delete_conversation</code> \u5220\u9664\u5bf9\u8bdd <code>add_message</code> \u6dfb\u52a0\u6d88\u606f\u5230\u5bf9\u8bdd\uff08\u81ea\u52a8\u66f4\u65b0 active_branch\uff09 <code>get_message</code> \u83b7\u53d6\u5355\u6761\u6d88\u606f <code>get_message_or_raise</code> \u83b7\u53d6\u6d88\u606f\uff0c\u4e0d\u5b58\u5728\u5219\u629b\u51fa NotFoundError <code>update_graph_response</code> \u66f4\u65b0\u6d88\u606f\u7684 Graph \u54cd\u5e94 <code>get_conversation_messages</code> \u83b7\u53d6\u5bf9\u8bdd\u7684\u6240\u6709\u6d88\u606f <code>get_conversation_path</code> \u83b7\u53d6\u4ece\u6839\u5230\u6307\u5b9a\u6d88\u606f\u7684\u8def\u5f84\uff08\u5411\u4e0a\u8ffd\u6eaf\uff09 <code>get_branch_children</code> \u83b7\u53d6\u6d88\u606f\u7684\u5b50\u5206\u652f <code>format_conversation_history</code> \u683c\u5f0f\u5316\u4e3a <code>[{\"role\": \"user\"}, {\"role\": \"assistant\"}, ...]</code> <code>get_branch_structure</code> \u83b7\u53d6\u5bf9\u8bdd\u7684\u5b8c\u6574\u5206\u652f\u7ed3\u6784"},{"location":"architecture/data-layer/#artifactrepository","title":"ArtifactRepository","text":"<p>Artifact \u64cd\u4f5c\uff08\u542b\u4e50\u89c2\u9501\uff09\uff1a</p> \u65b9\u6cd5 \u8bf4\u660e <code>get_session</code> \u83b7\u53d6 ArtifactSession <code>get_session_or_raise</code> \u83b7\u53d6 Session\uff0c\u4e0d\u5b58\u5728\u5219\u629b\u51fa NotFoundError <code>ensure_session_exists</code> \u786e\u4fdd Session \u5b58\u5728\uff08\u4e0d\u5b58\u5728\u5219\u521b\u5efa\uff09 <code>create_artifact</code> \u521b\u5efa Artifact\uff08\u540c\u65f6\u521b\u5efa\u521d\u59cb\u7248\u672c\uff09 <code>get_artifact</code> \u83b7\u53d6 Artifact\uff08\u590d\u5408\u4e3b\u952e\u67e5\u8be2\uff09 <code>get_artifact_or_raise</code> \u83b7\u53d6 Artifact\uff0c\u4e0d\u5b58\u5728\u5219\u629b\u51fa NotFoundError <code>list_artifacts</code> \u5217\u51fa Session \u4e0b\u6240\u6709 Artifacts <code>delete_artifact</code> \u5220\u9664 Artifact <code>update_artifact_content</code> \u4e50\u89c2\u9501\u66f4\u65b0\u5185\u5bb9\uff08\u7248\u672c\u51b2\u7a81\u629b\u51fa VersionConflictError\uff09 <code>rewrite_artifact</code> \u5b8c\u5168\u91cd\u5199\u5185\u5bb9\uff08\u4e50\u89c2\u9501\uff09 <code>update_artifact_title</code> \u66f4\u65b0\u6807\u9898 <code>get_version</code> \u83b7\u53d6\u6307\u5b9a\u7248\u672c\u8bb0\u5f55 <code>get_version_content</code> \u83b7\u53d6\u6307\u5b9a\u7248\u672c\u7684\u5185\u5bb9 <code>list_versions</code> \u5217\u51fa\u7248\u672c\u5386\u53f2\uff08\u4e0d\u542b\u5b8c\u6574\u5185\u5bb9\uff09 <code>get_version_diff</code> \u83b7\u53d6\u4e24\u4e2a\u7248\u672c\u95f4\u7684\u5dee\u5f02 <code>clear_temporary_artifacts</code> \u6e05\u9664\u4e34\u65f6 Artifacts\uff08\u5982 task_plan\uff09 <code>get_artifacts_with_full_content</code> \u6279\u91cf\u83b7\u53d6\u5b8c\u6574\u5185\u5bb9"},{"location":"architecture/data-layer/#userrepository","title":"UserRepository","text":"<p>\u7528\u6237\u64cd\u4f5c\uff1a</p> \u65b9\u6cd5 \u8bf4\u660e <code>get_by_username</code> \u6309\u7528\u6237\u540d\u67e5\u8be2\uff08\u767b\u5f55\uff09 <code>get_by_id</code> \u6309 ID \u67e5\u8be2\uff08\u7ee7\u627f\u81ea BaseRepository\uff09 <code>list_users</code> \u5217\u51fa\u7528\u6237\uff08\u652f\u6301\u5206\u9875\u3001\u53ef\u9009\u5305\u542b\u5df2\u7981\u7528\u7528\u6237\uff09 <code>count_users</code> \u7528\u6237\u603b\u6570"},{"location":"architecture/data-layer/#\u4e50\u89c2\u9501\u673a\u5236","title":"\u4e50\u89c2\u9501\u673a\u5236","text":""},{"location":"architecture/data-layer/#\u4e3a\u4ec0\u4e48\u9700\u8981\u4e50\u89c2\u9501","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u4e50\u89c2\u9501\uff1f","text":"<p>\u591a Agent \u5e76\u53d1\u573a\u666f\u4e0b\uff0c\u53ef\u80fd\u540c\u65f6\u66f4\u65b0\u540c\u4e00\u4e2a Artifact\uff1a</p> <pre><code>Agent A: \u8bfb\u53d6 Artifact (version=1)\nAgent B: \u8bfb\u53d6 Artifact (version=1)\nAgent A: \u66f4\u65b0 Artifact \u2192 version=2\nAgent B: \u66f4\u65b0 Artifact \u2192 \u51b2\u7a81\uff01\n</code></pre>"},{"location":"architecture/data-layer/#\u5904\u7406\u6d41\u7a0b","title":"\u5904\u7406\u6d41\u7a0b","text":"<pre><code>sequenceDiagram\n    participant Agent\n    participant Tool\n    participant Manager\n    participant Repo\n    participant DB\n\n    Agent-&gt;&gt;Tool: update_artifact(id, old_str, new_str)\n    Tool-&gt;&gt;Manager: update_artifact(...)\n    Manager-&gt;&gt;Manager: \u4ece\u7f13\u5b58\u83b7\u53d6 lock_version\n    Manager-&gt;&gt;Repo: update_artifact_content(expected_lock_version)\n    Repo-&gt;&gt;DB: UPDATE ... WHERE lock_version=X RETURNING ...\n\n    alt \u66f4\u65b0\u6210\u529f\uff08lock_version \u5339\u914d\uff09\n        DB-&gt;&gt;Repo: new_version, new_lock_version\n        Repo-&gt;&gt;DB: INSERT INTO artifact_versions ...\n        Repo-&gt;&gt;Manager: \u8fd4\u56de\u66f4\u65b0\u540e\u7684 Artifact\n        Manager-&gt;&gt;Manager: \u66f4\u65b0\u7f13\u5b58\u4e2d\u7684 lock_version\n        Manager-&gt;&gt;Tool: (success, message, match_info)\n        Tool-&gt;&gt;Agent: ToolResult(success=True)\n    else \u66f4\u65b0\u5931\u8d25\uff08lock_version \u4e0d\u5339\u914d\uff09\n        DB-&gt;&gt;Repo: 0 rows affected\n        Repo-&gt;&gt;Repo: \u68c0\u67e5\u662f\u4e0d\u5b58\u5728\u8fd8\u662f\u7248\u672c\u51b2\u7a81\n        Repo-&gt;&gt;Manager: VersionConflictError\n        Manager-&gt;&gt;Manager: \u6e05\u9664\u7f13\u5b58\n        Manager-&gt;&gt;Tool: (False, \"Version conflict\", None)\n        Tool-&gt;&gt;Agent: ToolResult(success=False, error=\"Version conflict\")\n    end</code></pre> <p>\u8bf4\u660e\uff1a<code>lock_version</code> \u7531 <code>ArtifactManager</code> \u5728\u5185\u5b58\u7f13\u5b58\u4e2d\u81ea\u52a8\u7ba1\u7406\uff0cAgent \u65e0\u9700\u611f\u77e5\u7248\u672c\u53f7\u3002</p>"},{"location":"architecture/data-layer/#agent-\u5904\u7406\u51b2\u7a81","title":"Agent \u5904\u7406\u51b2\u7a81","text":"<p>\u5f53\u6536\u5230\u7248\u672c\u51b2\u7a81\u9519\u8bef\u65f6\uff0cAgent \u5e94\u8be5\uff1a</p> <ol> <li>\u91cd\u65b0\u8c03\u7528 <code>read_artifact</code> \u83b7\u53d6\u6700\u65b0\u5185\u5bb9\uff08Manager \u4f1a\u91cd\u65b0\u52a0\u8f7d\u7f13\u5b58\uff09</li> <li>\u57fa\u4e8e\u6700\u65b0\u5185\u5bb9\u91cd\u65b0\u8ba1\u7b97\u53d8\u66f4</li> <li>\u91cd\u8bd5\u66f4\u65b0</li> </ol>"},{"location":"architecture/data-layer/#langgraph-checkpointer","title":"LangGraph Checkpointer","text":"<p>\u9664\u4e86\u4e1a\u52a1\u6570\u636e\uff0cLangGraph \u72b6\u6001\u4e5f\u9700\u8981\u6301\u4e45\u5316\uff1a</p> <pre><code># src/core/graph.py\nasync def create_async_sqlite_checkpointer(db_path: str = \"data/langgraph.db\"):\n    \"\"\"\u521b\u5efa LangGraph \u72b6\u6001\u68c0\u67e5\u70b9\"\"\"\n    import aiosqlite\n    from langgraph.checkpoint.sqlite.aio import AsyncSqliteSaver\n\n    # \u786e\u4fdd\u76ee\u5f55\u5b58\u5728\n    db_dir = os.path.dirname(db_path)\n    if db_dir and not os.path.exists(db_dir):\n        os.makedirs(db_dir, exist_ok=True)\n\n    # \u624b\u52a8\u521b\u5efa\u8fde\u63a5\u4ee5\u4fbf\u914d\u7f6e PRAGMA\n    conn = await aiosqlite.connect(db_path)\n    await conn.execute(\"PRAGMA journal_mode=WAL\")      # WAL \u6a21\u5f0f\u63d0\u9ad8\u5e76\u53d1\n    await conn.execute(\"PRAGMA busy_timeout=5000\")     # 5 \u79d2\u5fd9\u7b49\u5f85\n\n    checkpointer = AsyncSqliteSaver(conn)\n    await checkpointer.setup()\n    return checkpointer\n</code></pre> <p>Checkpointer \u5b58\u50a8\uff1a</p> <ul> <li>\u6bcf\u4e2a <code>thread_id</code> \u7684\u5b8c\u6574\u72b6\u6001\u5386\u53f2</li> <li>\u652f\u6301 <code>interrupt()</code> \u540e\u6062\u590d\u6267\u884c</li> <li>\u5b58\u50a8\u5728\u72ec\u7acb\u7684 SQLite \u6587\u4ef6\uff08<code>data/langgraph.db</code>\uff09</li> </ul>"},{"location":"architecture/tools/","title":"Tool \u7cfb\u7edf","text":"<p>Tool \u7cfb\u7edf\u4e3a Agent \u63d0\u4f9b\u4e0e\u5916\u90e8\u4e16\u754c\u4ea4\u4e92\u7684\u80fd\u529b\uff0c\u5305\u62ec\u641c\u7d22\u3001\u6293\u53d6\u3001Artifact \u64cd\u4f5c\u7b49\u3002</p>"},{"location":"architecture/tools/#\u6a21\u5757\u7ed3\u6784","title":"\u6a21\u5757\u7ed3\u6784","text":"<pre><code>src/tools/\n\u251c\u2500\u2500 base.py              # \u5de5\u5177\u57fa\u7c7b\u548c\u6743\u9650\u5b9a\u4e49\n\u251c\u2500\u2500 registry.py          # \u5de5\u5177\u6ce8\u518c\u4e2d\u5fc3\n\u251c\u2500\u2500 xml_parser.py        # XML \u5de5\u5177\u8c03\u7528\u89e3\u6790\n\u251c\u2500\u2500 prompt_generator.py  # \u5de5\u5177\u63d0\u793a\u8bcd\u751f\u6210\n\u2514\u2500\u2500 implementations/     # \u5177\u4f53\u5de5\u5177\u5b9e\u73b0\n    \u251c\u2500\u2500 call_subagent.py\n    \u251c\u2500\u2500 web_search.py\n    \u251c\u2500\u2500 web_fetch.py\n    \u2514\u2500\u2500 artifact_ops.py\n</code></pre>"},{"location":"architecture/tools/#\u6743\u9650\u7cfb\u7edf-basepy","title":"\u6743\u9650\u7cfb\u7edf (base.py)","text":""},{"location":"architecture/tools/#toolpermission","title":"ToolPermission","text":"<p>\u4e24\u7ea7\u6743\u9650\u6a21\u578b\uff1a</p> <pre><code>class ToolPermission(Enum):\n    AUTO = \"auto\"        # \u81ea\u52a8\u6267\u884c\uff0c\u65e0\u9700\u7528\u6237\u786e\u8ba4\n    CONFIRM = \"confirm\"  # \u6267\u884c\u524d\u9700\u7528\u6237\u786e\u8ba4\uff08\u901a\u8fc7 interrupt \u6682\u505c\uff09\n</code></pre> <p>\u6743\u9650\u5904\u7406\u6d41\u7a0b\uff08\u5728 <code>graph.py</code> \u7684 <code>tool_execution_node</code> \u4e2d\uff09\uff1a</p> <pre><code>flowchart TD\n    A[\u83b7\u53d6\u5de5\u5177\u6743\u9650] --&gt; B{\u6743\u9650\u7ea7\u522b}\n    B --&gt;|AUTO| C[\u76f4\u63a5\u6267\u884c]\n    B --&gt;|CONFIRM| D[\u53d1\u9001 PERMISSION_REQUEST]\n    D --&gt; E[interrupt \u6682\u505c]\n    E --&gt; F{\u7528\u6237\u54cd\u5e94}\n    F --&gt;|approved| C\n    F --&gt;|denied| G[\u8fd4\u56de\u62d2\u7edd\u7ed3\u679c]\n    C --&gt; H[\u53d1\u9001 TOOL_COMPLETE]</code></pre>"},{"location":"architecture/tools/#toolparameter","title":"ToolParameter","text":"<p>\u5de5\u5177\u53c2\u6570\u5b9a\u4e49\uff1a</p> <pre><code>@dataclass\nclass ToolParameter:\n    name: str                    # \u53c2\u6570\u540d\n    type: str                    # \u7c7b\u578b\uff1astring, integer, boolean, array, object\n    description: str             # \u53c2\u6570\u63cf\u8ff0\n    required: bool = True        # \u662f\u5426\u5fc5\u9700\n    default: Any = None          # \u9ed8\u8ba4\u503c\n</code></pre>"},{"location":"architecture/tools/#toolresult","title":"ToolResult","text":"<p>\u5de5\u5177\u6267\u884c\u7ed3\u679c\uff1a</p> <pre><code>@dataclass\nclass ToolResult:\n    success: bool                              # \u6267\u884c\u662f\u5426\u6210\u529f\n    data: Any = None                           # \u7ed3\u679c\u6570\u636e\n    error: Optional[str] = None                # \u9519\u8bef\u4fe1\u606f\n    metadata: Dict[str, Any] = field(default_factory=dict)  # \u5143\u6570\u636e\n\n    def to_dict(self) -&gt; Dict[str, Any]:\n        \"\"\"\u8f6c\u6362\u4e3a\u5b57\u5178\u683c\u5f0f\"\"\"\n</code></pre>"},{"location":"architecture/tools/#basetool-\u57fa\u7c7b","title":"BaseTool \u57fa\u7c7b","text":""},{"location":"architecture/tools/#\u5b9a\u4e49\u5de5\u5177","title":"\u5b9a\u4e49\u5de5\u5177","text":"<pre><code>class BaseTool(ABC):\n    def __init__(\n        self,\n        name: str,\n        description: str,\n        permission: ToolPermission = ToolPermission.AUTO,\n        **kwargs\n    ):\n        self.name = name\n        self.description = description\n        self.permission = permission\n        self.config = kwargs\n\n    @abstractmethod\n    def get_parameters(self) -&gt; List[ToolParameter]:\n        \"\"\"\u8fd4\u56de\u53c2\u6570\u5b9a\u4e49\u5217\u8868\"\"\"\n        pass\n\n    @abstractmethod\n    async def execute(self, **params) -&gt; ToolResult:\n        \"\"\"\u6267\u884c\u5de5\u5177\"\"\"\n        pass\n\n    def validate_params(self, params: Dict[str, Any]) -&gt; Optional[str]:\n        \"\"\"\n        \u9a8c\u8bc1\u53c2\u6570\uff08\u53ef\u9009\u8986\u76d6\uff09\n\n        Returns:\n            None \u8868\u793a\u9a8c\u8bc1\u901a\u8fc7\uff0c\u5b57\u7b26\u4e32\u8868\u793a\u9519\u8bef\u4fe1\u606f\n        \"\"\"\n        # \u9ed8\u8ba4\u5b9e\u73b0\uff1a\u68c0\u67e5\u5fc5\u9700\u53c2\u6570\u548c\u672a\u77e5\u53c2\u6570\n        ...\n\n    async def __call__(self, **params) -&gt; ToolResult:\n        \"\"\"\u4f7f\u5de5\u5177\u53ef\u8c03\u7528\uff08\u5185\u90e8\u8c03\u7528 validate_params \u548c execute\uff09\"\"\"\n</code></pre>"},{"location":"architecture/tools/#\u793a\u4f8bwebsearchtool","title":"\u793a\u4f8b\uff1aWebSearchTool","text":"<pre><code>class WebSearchTool(BaseTool):\n    def __init__(self):\n        super().__init__(\n            name=\"web_search\",\n            description=\"\u641c\u7d22\u4e92\u8054\u7f51\u83b7\u53d6\u4fe1\u606f\",\n            permission=ToolPermission.AUTO\n        )\n\n    def get_parameters(self) -&gt; List[ToolParameter]:\n        return [\n            ToolParameter(\n                name=\"query\",\n                type=\"string\",\n                description=\"\u641c\u7d22\u67e5\u8be2\u8bcd\",\n                required=True\n            ),\n            ToolParameter(\n                name=\"max_results\",\n                type=\"integer\",\n                description=\"\u6700\u5927\u7ed3\u679c\u6570\u91cf\",\n                required=False,\n                default=10\n            )\n        ]\n\n    async def execute(self, query: str, max_results: int = 10, **kwargs) -&gt; ToolResult:\n        try:\n            results = await self._do_search(query, max_results)\n            return ToolResult(success=True, data=results)\n        except Exception as e:\n            return ToolResult(success=False, error=str(e))\n</code></pre>"},{"location":"architecture/tools/#\u5de5\u5177\u6ce8\u518c\u4e2d\u5fc3-registrypy","title":"\u5de5\u5177\u6ce8\u518c\u4e2d\u5fc3 (registry.py)","text":""},{"location":"architecture/tools/#toolregistry","title":"ToolRegistry","text":"<p>\u5168\u5c40\u5de5\u5177\u5e93\u7ba1\u7406\uff1a</p> <pre><code>class ToolRegistry:\n    def __init__(self):\n        self.tool_library: Dict[str, BaseTool] = {}\n        self.agent_toolkits: Dict[str, AgentToolkit] = {}\n\n    def register_tool_to_library(self, tool: BaseTool) -&gt; None:\n        \"\"\"\u6ce8\u518c\u5de5\u5177\u5230\u5168\u5c40\u5e93\"\"\"\n        self.tool_library[tool.name] = tool\n\n    def create_agent_toolkit(\n        self,\n        agent_name: str,\n        tool_names: List[str] = None\n    ) -&gt; AgentToolkit:\n        \"\"\"\u4e3a Agent \u521b\u5efa\u4e13\u5c5e\u5de5\u5177\u96c6\"\"\"\n        toolkit = AgentToolkit(agent_name)\n        if tool_names:\n            for tool_name in tool_names:\n                if tool_name in self.tool_library:\n                    toolkit.add_tool(self.tool_library[tool_name])\n        self.agent_toolkits[agent_name] = toolkit\n        return toolkit\n\n    def get_agent_toolkit(self, agent_name: str) -&gt; Optional[AgentToolkit]:\n        \"\"\"\u83b7\u53d6 Agent \u7684\u5de5\u5177\u5305\"\"\"\n        return self.agent_toolkits.get(agent_name)\n</code></pre>"},{"location":"architecture/tools/#agenttoolkit","title":"AgentToolkit","text":"<p>Agent \u4e13\u5c5e\u5de5\u5177\u96c6\uff1a</p> <pre><code>class AgentToolkit:\n    def __init__(self, agent_name: str):\n        self.agent_name = agent_name\n        self.tools: Dict[str, BaseTool] = {}\n\n    def add_tool(self, tool: BaseTool) -&gt; None:\n        \"\"\"\u6dfb\u52a0\u5de5\u5177\u5230\u5de5\u5177\u5305\"\"\"\n        self.tools[tool.name] = tool\n\n    def add_tools(self, tools: List[BaseTool]) -&gt; None:\n        \"\"\"\u6279\u91cf\u6dfb\u52a0\u5de5\u5177\"\"\"\n        for tool in tools:\n            self.add_tool(tool)\n\n    def get_tool(self, name: str) -&gt; Optional[BaseTool]:\n        return self.tools.get(name)\n\n    def list_tools(self) -&gt; List[BaseTool]:\n        \"\"\"\u8fd4\u56de\u5de5\u5177\u5b9e\u4f8b\u5217\u8868\"\"\"\n        return list(self.tools.values())\n\n    async def execute_tool(self, name: str, params: Dict) -&gt; ToolResult:\n        \"\"\"\n        \u6267\u884c\u5de5\u5177\uff08\u6743\u9650\u68c0\u67e5\u7531 Graph \u5c42\u8d1f\u8d23\uff09\n        \u53c2\u6570\u9a8c\u8bc1\u5728 tool.__call__ \u5185\u90e8\u5904\u7406\n        \"\"\"\n        tool = self.get_tool(name)\n        if not tool:\n            return ToolResult(\n                success=False,\n                error=f\"Tool '{name}' not available in {self.agent_name}'s toolkit\"\n            )\n        return await tool(**params)\n</code></pre>"},{"location":"architecture/tools/#\u521d\u59cb\u5316\u6d41\u7a0b","title":"\u521d\u59cb\u5316\u6d41\u7a0b","text":"<p>\u5de5\u5177\u521d\u59cb\u5316\u5728 <code>create_multi_agent_graph()</code> \u51fd\u6570\u4e2d\u5b8c\u6210\uff08<code>core/graph.py</code>\uff09\uff1a</p> <pre><code># 1. \u521b\u5efa\u5de5\u5177\u6ce8\u518c\u4e2d\u5fc3\nregistry = ToolRegistry()\n\n# 2. \u521b\u5efa\u5de5\u5177\u5217\u8868\ntools = [\n    CallSubagentTool(),\n    WebSearchTool(),\n    WebFetchTool(),\n]\n\n# Artifact \u5de5\u5177\u9700\u8981 manager \u4f9d\u8d56\u6ce8\u5165\nif artifact_manager:\n    tools.extend(create_artifact_tools(artifact_manager))\n\n# 3. \u6ce8\u518c\u6240\u6709\u5de5\u5177\u5230\u5e93\nfor tool in tools:\n    registry.register_tool_to_library(tool)\n\n# 4. \u4e3a\u6bcf\u4e2a Agent \u521b\u5efa toolkit \u5e76\u7ed1\u5b9a\nfor agent in [lead, search, crawl]:\n    if agent.config.required_tools:\n        toolkit = registry.create_agent_toolkit(\n            agent.config.name,\n            tool_names=agent.config.required_tools\n        )\n        agent.toolkit = toolkit\n</code></pre>"},{"location":"architecture/tools/#xml-\u89e3\u6790\u5668-xml_parserpy","title":"XML \u89e3\u6790\u5668 (xml_parser.py)","text":""},{"location":"architecture/tools/#\u5de5\u5177\u8c03\u7528\u683c\u5f0f","title":"\u5de5\u5177\u8c03\u7528\u683c\u5f0f","text":"<p>Agent \u4f7f\u7528 XML \u683c\u5f0f\u53d1\u8d77\u5de5\u5177\u8c03\u7528\uff0c\u6240\u6709\u53c2\u6570\u503c\u4f7f\u7528 CDATA \u5305\u88f9\uff1a</p> <pre><code>&lt;tool_call&gt;\n  &lt;name&gt;web_search&lt;/name&gt;\n  &lt;params&gt;\n    &lt;query&gt;&lt;![CDATA[Python async best practices]]&gt;&lt;/query&gt;\n    &lt;max_results&gt;&lt;![CDATA[10]]&gt;&lt;/max_results&gt;\n  &lt;/params&gt;\n&lt;/tool_call&gt;\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u4f7f\u7528 CDATA\uff1f</p> <ul> <li>\u907f\u514d\u7279\u6b8a\u5b57\u7b26\uff08<code>&lt;</code>, <code>&gt;</code>, <code>&amp;</code>\uff09\u5bfc\u81f4\u89e3\u6790\u5931\u8d25</li> <li>\u652f\u6301\u591a\u884c\u5185\u5bb9\uff08\u5982\u4ee3\u7801\u7247\u6bb5\uff09</li> <li>\u4fdd\u6301\u5185\u5bb9\u539f\u6837\uff0c\u65e0\u9700\u8f6c\u4e49</li> </ul>"},{"location":"architecture/tools/#xmltoolcallparser","title":"XMLToolCallParser","text":"<pre><code>@dataclass\nclass ToolCall:\n    \"\"\"\u5de5\u5177\u8c03\u7528\u6570\u636e\u7ed3\u6784\"\"\"\n    name: str\n    params: Dict[str, Any]\n    raw_text: str = \"\"\n\nclass XMLToolCallParser:\n    @staticmethod\n    def parse_tool_calls(text: str) -&gt; List[ToolCall]:\n        \"\"\"\n        \u89e3\u6790 XML \u5de5\u5177\u8c03\u7528\n\n        Returns:\n            ToolCall \u5bf9\u8c61\u5217\u8868\n        \"\"\"\n        # \u4f7f\u7528 xml.etree.ElementTree \u89e3\u6790\n        # \u81ea\u52a8\u5904\u7406 CDATA\n        # \u81ea\u52a8\u7c7b\u578b\u8f6c\u6362\uff08bool, int, float, string\uff09\n        # \u652f\u6301 fallback \u6b63\u5219\u89e3\u6790\uff08\u5904\u7406 LLM \u683c\u5f0f\u4e0d\u4e25\u683c\u7684\u60c5\u51b5\uff09\n\n# \u4fbf\u6377\u51fd\u6570\ndef parse_tool_calls(text: str) -&gt; List[ToolCall]:\n    return XMLToolCallParser.parse_tool_calls(text)\n</code></pre> <p>\u7c7b\u578b\u8f6c\u6362\u89c4\u5219\uff1a</p> \u539f\u59cb\u503c \u8f6c\u6362\u7ed3\u679c <code>\"true\"</code> / <code>\"false\"</code> <code>bool</code> <code>\"123\"</code> <code>int</code> <code>\"3.14\"</code> <code>float</code> \u5176\u4ed6 <code>str</code>"},{"location":"architecture/tools/#\u63d0\u793a\u8bcd\u751f\u6210\u5668-prompt_generatorpy","title":"\u63d0\u793a\u8bcd\u751f\u6210\u5668 (prompt_generator.py)","text":""},{"location":"architecture/tools/#toolpromptgenerator","title":"ToolPromptGenerator","text":"<p>\u4e3a Agent \u751f\u6210\u5de5\u5177\u4f7f\u7528\u8bf4\u660e\uff1a</p> <pre><code>class ToolPromptGenerator:\n    @staticmethod\n    def generate_tool_instruction(tools: List[BaseTool]) -&gt; str:\n        \"\"\"\n        \u751f\u6210\u5b8c\u6574\u7684\u5de5\u5177\u4f7f\u7528\u8bf4\u660e\n\n        Args:\n            tools: \u5de5\u5177\u5b9e\u4f8b\u5217\u8868\uff08\u901a\u5e38\u6765\u81ea toolkit.list_tools()\uff09\n\n        \u5305\u542b\uff1a\n        - \u53ef\u7528\u5de5\u5177\u5217\u8868\n        - \u6bcf\u4e2a\u5de5\u5177\u7684\u53c2\u6570\u8bf4\u660e\n        - XML \u8c03\u7528\u683c\u5f0f\u793a\u4f8b\uff08\u4f7f\u7528 CDATA\uff09\n        - \u6ce8\u610f\u4e8b\u9879\n        \"\"\"\n\n    @staticmethod\n    def format_tool_result(name: str, result: Dict[str, Any]) -&gt; str:\n        \"\"\"\u683c\u5f0f\u5316\u5de5\u5177\u6267\u884c\u7ed3\u679c\u4e3a XML\"\"\"\n</code></pre> <p>\u751f\u6210\u793a\u4f8b\uff08\u5b9e\u9645\u8f93\u51fa\u683c\u5f0f\uff09\uff1a</p> <pre><code>### web_search\nDescription: Search the web for information using Bocha AI search engine\nParameters:\n  - query: string (required) - Search query using keywords.\n  - freshness: string (optional) - Time range filter: 'noLimit', 'oneDay', ...\n    Default: noLimit\n  - count: integer (optional) - Number of results to return (1-50)\n    Default: 10\nExample:\n&lt;tool_call&gt;\n  &lt;name&gt;web_search&lt;/name&gt;\n  &lt;params&gt;\n    &lt;query&gt;&lt;![CDATA[your_query_here]]&gt;&lt;/query&gt;\n    &lt;freshness&gt;&lt;![CDATA[noLimit]]&gt;&lt;/freshness&gt;\n    &lt;count&gt;&lt;![CDATA[10]]&gt;&lt;/count&gt;\n  &lt;/params&gt;\n&lt;/tool_call&gt;\n</code></pre>"},{"location":"architecture/tools/#\u5185\u7f6e\u5de5\u5177","title":"\u5185\u7f6e\u5de5\u5177","text":"\u5de5\u5177\u540d \u7c7b \u8bf4\u660e \u6743\u9650 <code>call_subagent</code> CallSubagentTool \u8def\u7531\u5230 SubAgent\uff08\u9a8c\u8bc1\u53c2\u6570\u540e\u8bbe\u7f6e\u8def\u7531\uff09 AUTO <code>web_search</code> WebSearchTool \u4e92\u8054\u7f51\u641c\u7d22\uff08\u535a\u67e5 AI\uff09 AUTO <code>web_fetch</code> WebFetchTool \u7f51\u9875/PDF \u5185\u5bb9\u6293\u53d6\uff08crawl4ai\uff09 CONFIRM <code>create_artifact</code> CreateArtifactTool \u521b\u5efa\u65b0 Artifact AUTO <code>read_artifact</code> ReadArtifactTool \u8bfb\u53d6\u5185\u5bb9\uff08\u652f\u6301\u5386\u53f2\u7248\u672c\uff09 AUTO <code>update_artifact</code> UpdateArtifactTool \u589e\u91cf\u66f4\u65b0\uff08\u652f\u6301\u6a21\u7cca\u5339\u914d\uff09 AUTO <code>rewrite_artifact</code> RewriteArtifactTool \u5b8c\u5168\u91cd\u5199\u5185\u5bb9 AUTO <p>\u6ce8\u610f\uff1a<code>call_subagent</code> \u662f\u7279\u6b8a\u7684\u8def\u7531\u5de5\u5177\u3002Agent \u5728 <code>base.py</code> \u4e2d\u68c0\u6d4b\u5230\u6b64\u5de5\u5177\u65f6\uff0c\u4f1a\u5148\u8c03\u7528 <code>execute()</code> \u9a8c\u8bc1\u53c2\u6570\uff08\u5982 agent_name \u662f\u5426\u6709\u6548\uff09\uff0c\u9a8c\u8bc1\u901a\u8fc7\u540e\u518d\u8bbe\u7f6e\u8def\u7531\u4fe1\u606f\uff0c\u7531 Graph \u8def\u7531\u5230\u76ee\u6807 SubAgent\u3002</p>"},{"location":"architecture/tools/#\u6dfb\u52a0\u65b0\u5de5\u5177","title":"\u6dfb\u52a0\u65b0\u5de5\u5177","text":"<p>\u53c2\u89c1 Extension Guide\u3002</p>"}]}