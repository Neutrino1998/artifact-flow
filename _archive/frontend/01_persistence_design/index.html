
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Multi-Agent Research System Built on LangGraph">
      
      
      
        <link rel="canonical" href="https://neutrino.github.io/artifact-flow/_archive/frontend/01_persistence_design/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>ArtifactFlow æŒä¹…åŒ–æ”¹é€ æ–¹æ¡ˆ - ArtifactFlow</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#artifactflow" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="é¡µçœ‰">
    <a href="../../.." title="ArtifactFlow" class="md-header__button md-logo" aria-label="ArtifactFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ArtifactFlow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ArtifactFlow æŒä¹…åŒ–æ”¹é€ æ–¹æ¡ˆ
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="æŸ¥æ‰¾">
        
        <button type="reset" class="md-search__icon md-icon" title="æ¸…ç©ºå½“å‰å†…å®¹" aria-label="æ¸…ç©ºå½“å‰å†…å®¹" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/neutrino/artifact-flow" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    neutrino/artifact-flow
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="æ ‡ç­¾" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../request-lifecycle/" class="md-tabs__link">
        
  
  
    
  
  Request Lifecycle

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../architecture/core/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../streaming/" class="md-tabs__link">
        
  
  
    
  
  Streaming

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../extension-guide/" class="md-tabs__link">
        
  
  
    
  
  Extension Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../api/" class="md-tabs__link">
        
  
  
    
  
  API Reference

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../faq/" class="md-tabs__link">
        
  
  
    
  
  FAQ

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="å¯¼èˆªæ " data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="ArtifactFlow" class="md-nav__button md-logo" aria-label="ArtifactFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ArtifactFlow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/neutrino/artifact-flow" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    neutrino/artifact-flow
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../request-lifecycle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Request Lifecycle
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/data-layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Streaming
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../extension-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Extension Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. æ”¹é€ ç›®æ ‡
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-dual-storage-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. ğŸ†• åŒå±‚å­˜å‚¨ç­–ç•¥ (Dual Storage Strategy)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. ğŸ†• åŒå±‚å­˜å‚¨ç­–ç•¥ (Dual Storage Strategy)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 æ ¸å¿ƒæ¦‚å¿µ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-state-injection" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 çŠ¶æ€æ³¨å…¥æœºåˆ¶ (State Injection)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-thread" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 åˆ†æ”¯å¯¹è¯çš„ Thread ç­–ç•¥
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. ğŸ†• å¼€å‘è§„èŒƒ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. ğŸ†• å¼€å‘è§„èŒƒ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 ä¾èµ–æ³¨å…¥ä¸æ— çŠ¶æ€åŒ–
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-orm" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 ORM è§„èŒƒ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. æ•°æ®åº“ Schema è®¾è®¡
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. æ•°æ®åº“ Schema è®¾è®¡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 æ ¸å¿ƒåŸåˆ™
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 è¡¨ç»“æ„è®¾è®¡
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.2 è¡¨ç»“æ„è®¾è®¡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-conversations" class="md-nav__link">
    <span class="md-ellipsis">
      
        è¡¨1: conversations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-messages" class="md-nav__link">
    <span class="md-ellipsis">
      
        è¡¨2: messages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-artifact_sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        è¡¨3: artifact_sessions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        è¡¨4: artifacts ğŸ†• å¢åŠ ä¹è§‚é”å­—æ®µ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-artifact_versions" class="md-nav__link">
    <span class="md-ellipsis">
      
        è¡¨5: artifact_versions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 ğŸ†• ä¹è§‚é”æœºåˆ¶
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-langgraph-checkpointer" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. ğŸ†• LangGraph Checkpointer é…ç½®
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. ğŸ†• LangGraph Checkpointer é…ç½®">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-memorysaver" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 æ›¿æ¢ MemorySaver
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 é…ç½®å»ºè®®
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. æ¶æ„è®¾è®¡
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. æ¶æ„è®¾è®¡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 åˆ†å±‚æ¶æ„
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 ç¼“å­˜ç­–ç•¥
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. æ–‡ä»¶ç»“æ„è§„åˆ’
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. æ–‡ä»¶ç»“æ„è§„åˆ’">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 æ–°å¢æ–‡ä»¶
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 æ”¹é€ æ–‡ä»¶
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. æ ¸å¿ƒç±»è®¾è®¡è¦ç‚¹
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. æ ¸å¿ƒç±»è®¾è®¡è¦ç‚¹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-databasemanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 DatabaseManager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-conversationrepository" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 ConversationRepository
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-artifactrepository" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.3 ArtifactRepository
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-conversationmanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.4 ConversationManagerï¼ˆæ”¹é€ ï¼‰
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85-artifactmanager-artifactstore" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.5 ArtifactManagerï¼ˆåŸ ArtifactStore æ”¹é€ ï¼‰
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. å®æ–½æ­¥éª¤
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. å®æ–½æ­¥éª¤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-2-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 1: åŸºç¡€è®¾æ–½ï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-manager-2-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Manager å±‚æ”¹é€ ï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-1-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: ä¼˜åŒ–å’Œæ¸…ç†ï¼ˆé¢„è®¡ 1-2 å¤©ï¼‰
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. åç»­æ‰©å±•é¢„ç•™
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. åç»­æ‰©å±•é¢„ç•™">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-phase-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 ç”¨æˆ·ç³»ç»Ÿï¼ˆPhase 2ï¼‰
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 PostgreSQL è¿ç§»
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. æ³¨æ„äº‹é¡¹
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. æ³¨æ„äº‹é¡¹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 å¹¶å‘å®‰å…¨
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 æ•°æ®ä¸€è‡´æ€§
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 å‘åå…¼å®¹
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. ä¾èµ–æ¸…å•
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        é™„å½•ï¼šæ¶æ„æ¼”è¿›è·¯çº¿å›¾
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="artifactflow">ArtifactFlow æŒä¹…åŒ–æ”¹é€ æ–¹æ¡ˆ</h1>
<blockquote>
<p>ç‰ˆæœ¬: v1.1 | ä¼˜å…ˆçº§: P0ï¼ˆAPIå’Œå‰ç«¯çš„å‰ç½®ä¾èµ–ï¼‰</p>
<p>å˜æ›´è®°å½•ï¼š
- v1.1: æ–°å¢åŒå±‚å­˜å‚¨ç­–ç•¥ã€ä¾èµ–æ³¨å…¥è§„èŒƒã€ä¹è§‚é”æœºåˆ¶ã€Checkpointeræ›¿æ¢æ–¹æ¡ˆ</p>
</blockquote>
<h2 id="1">1. æ”¹é€ ç›®æ ‡</h2>
<p>å°†å½“å‰åŸºäºå†…å­˜çš„ <code>ConversationManager</code> å’Œ <code>ArtifactStore</code> æ”¹é€ ä¸º SQLite æŒä¹…åŒ–å­˜å‚¨ï¼Œå®ç°ï¼š</p>
<ol>
<li><strong>æ•°æ®æŒä¹…åŒ–</strong>ï¼šæœåŠ¡é‡å¯åæ•°æ®ä¸ä¸¢å¤±</li>
<li><strong>è§£è€¦å­˜å‚¨</strong>ï¼šConversation å’Œ Artifact ç‹¬ç«‹å­˜å‚¨ï¼Œé€šè¿‡ ID å…³è”</li>
<li><strong>å¯æ‰©å±•æ€§</strong>ï¼šä¸ºåç»­ PostgreSQL è¿ç§»å’Œç”¨æˆ·ç³»ç»Ÿé¢„ç•™æ¥å£</li>
<li><strong>æ€§èƒ½å¹³è¡¡</strong>ï¼šçƒ­æ•°æ®å†…å­˜ç¼“å­˜ + å†·æ•°æ®æ•°æ®åº“å­˜å‚¨</li>
<li><strong>ğŸ†• æ— çŠ¶æ€åŒ–</strong>ï¼šæ”¯æŒå®¹å™¨åŒ–æ°´å¹³æ‰©å±•</li>
</ol>
<hr />
<h2 id="2-dual-storage-strategy">2. ğŸ†• åŒå±‚å­˜å‚¨ç­–ç•¥ (Dual Storage Strategy)</h2>
<h3 id="21">2.1 æ ¸å¿ƒæ¦‚å¿µ</h3>
<p>ç³»ç»Ÿé‡‡ç”¨<strong>åŒå±‚å­˜å‚¨æ¶æ„</strong>ï¼Œæ˜ç¡®åŒºåˆ†ä¸¤ç±»å­˜å‚¨çš„èŒè´£ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>â”‚                      åŒå±‚å­˜å‚¨æ¶æ„                                â”‚
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>â”‚                                                                 â”‚
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>â”‚  â”‚    Application DB       â”‚    â”‚  LangGraph Checkpointer â”‚    â”‚
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>â”‚  â”‚    (SQLite/Postgres)    â”‚    â”‚   (AsyncSqliteSaver)    â”‚    â”‚
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>â”‚  â”‚ è§’è‰²: &quot;é•¿æœŸè®°å¿†&quot;         â”‚    â”‚ è§’è‰²: &quot;çŸ­æœŸå·¥ä½œå°&quot;       â”‚    â”‚
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>â”‚  â”‚ çœŸç›¸æ¥æº (Source of Truth)â”‚   â”‚ æ‰§è¡ŒçŠ¶æ€æš‚å­˜            â”‚    â”‚
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>â”‚  â”‚ èŒè´£:                   â”‚    â”‚ èŒè´£:                   â”‚    â”‚
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>â”‚  â”‚ - UI å±•ç¤º               â”‚    â”‚ - æ‰§è¡Œæ ˆä¿å­˜            â”‚    â”‚
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>â”‚  â”‚ - æœç´¢å’Œå†å²å›æº¯         â”‚    â”‚ - ä¸­æ–­/æ¢å¤çŠ¶æ€         â”‚    â”‚
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>â”‚  â”‚ - è·¨ä¼šè¯æŒä¹…åŒ–          â”‚    â”‚ - Agent å˜é‡çŠ¶æ€        â”‚    â”‚
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>â”‚  â”‚ æ•°æ®:                   â”‚    â”‚ æ•°æ®:                   â”‚    â”‚
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>â”‚  â”‚ - conversations         â”‚    â”‚ - thread states        â”‚    â”‚
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>â”‚  â”‚ - messages              â”‚    â”‚ - interrupt values     â”‚    â”‚
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>â”‚  â”‚ - artifacts             â”‚    â”‚ - agent memories       â”‚    â”‚
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>â”‚  â”‚ - artifact_versions     â”‚    â”‚                         â”‚    â”‚
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>â”‚              â”‚                              â”‚                   â”‚
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>â”‚                         â”‚                                       â”‚
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>â”‚              ExecutionController                                â”‚
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>â”‚              (çŠ¶æ€æ³¨å…¥ &amp; åŒæ­¥)                                   â”‚
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<h3 id="22-state-injection">2.2 çŠ¶æ€æ³¨å…¥æœºåˆ¶ (State Injection)</h3>
<p><strong>å…³é”®åŸåˆ™</strong>ï¼šApp DB æ˜¯çœŸç›¸æ¥æºï¼ŒLangGraph Checkpointer ä»…ç”¨äºæ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<p><strong>å®ç°è¦ç‚¹</strong>ï¼š
1. æ¯æ¬¡å¯åŠ¨æ–°å¯¹è¯æ—¶ï¼Œ<strong>å¼ºåˆ¶</strong>ä» App DB æ‹‰å–æ¸…æ´—è¿‡çš„å†å²è®°å½•
2. å°†å†å²è®°å½•æ³¨å…¥åˆ° Agent State çš„ <code>conversation_history</code> å­—æ®µ
3. è¦†ç›– LangGraph Checkpointer å¯èƒ½æ®‹ç•™çš„æ—§æ•°æ®</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># ExecutionController._execute_new_message() ä¸­çš„é€»è¾‘</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_new_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">conversation_id</span><span class="p">,</span> <span class="n">parent_message_id</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="c1"># 1. ä» App DB è·å–å¯¹è¯å†å²ï¼ˆçœŸç›¸æ¥æºï¼‰</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="n">conversation_history</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_manager</span><span class="o">.</span><span class="n">format_conversation_history_async</span><span class="p">(</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        <span class="n">conv_id</span><span class="o">=</span><span class="n">conversation_id</span><span class="p">,</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>        <span class="n">to_message_id</span><span class="o">=</span><span class="n">parent_message_id</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="c1"># 2. åˆ›å»ºæ–°çš„ thread_idï¼ˆæ¯æ¬¡æ‰§è¡Œéƒ½æ˜¯æ–°çº¿ç¨‹ï¼‰</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">thread_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;thd-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="c1"># 3. æ„å»ºåˆå§‹çŠ¶æ€ï¼Œæ³¨å…¥å†å²è®°å½•</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">create_initial_state</span><span class="p">(</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="n">task</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="n">conversation_history</span><span class="o">=</span><span class="n">conversation_history</span><span class="p">,</span>  <span class="c1"># æ³¨å…¥å†å²</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">thread_id</span><span class="o">=</span><span class="n">thread_id</span><span class="p">,</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="c1"># ...</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="p">)</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="c1"># 4. æ‰§è¡Œå›¾ï¼ˆCheckpointer åªä¿å­˜æœ¬æ¬¡æ‰§è¡ŒçŠ¶æ€ï¼‰</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</code></pre></div>
<h3 id="23-thread">2.3 åˆ†æ”¯å¯¹è¯çš„ Thread ç­–ç•¥</h3>
<p>å½“ç”¨æˆ·åˆ›å»ºåˆ†æ”¯æ—¶ï¼š</p>
<ol>
<li><strong>App DB å±‚</strong>ï¼šè®°å½•æ ‘çŠ¶ç»“æ„ï¼ˆ<code>messages.parent_id</code> æŒ‡å‘åˆ†æ”¯ç‚¹ï¼‰</li>
<li><strong>LangGraph å±‚</strong>ï¼šåˆ›å»º<strong>æ–°çš„</strong> <code>thread_id</code></li>
<li><strong>çŠ¶æ€æ³¨å…¥</strong>ï¼šå°†åˆ†æ”¯ç‚¹ä¹‹å‰çš„å†å²ä½œä¸ºåˆå§‹çŠ¶æ€æ³¨å…¥</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># åˆ†æ”¯åˆ›å»ºæµç¨‹</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conv_id</span><span class="p">,</span> <span class="n">parent_message_id</span><span class="p">,</span> <span class="n">new_content</span><span class="p">):</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="c1"># 1. è·å–ä»æ ¹åˆ°åˆ†æ”¯ç‚¹çš„å†å²</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_manager</span><span class="o">.</span><span class="n">get_message_path</span><span class="p">(</span><span class="n">conv_id</span><span class="p">,</span> <span class="n">parent_message_id</span><span class="p">)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="c1"># 2. åˆ›å»ºæ–°çš„ thread_idï¼ˆä¸å¤ç”¨æ—§åˆ†æ”¯çš„ï¼‰</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">new_thread_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;thd-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="c1"># 3. æ³¨å…¥å†å²åˆ°æ–°æ‰§è¡Œ</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="c1"># ...</span>
</code></pre></div>
<hr />
<h2 id="3">3. ğŸ†• å¼€å‘è§„èŒƒ</h2>
<h3 id="31">3.1 ä¾èµ–æ³¨å…¥ä¸æ— çŠ¶æ€åŒ–</h3>
<p><strong>å¼ºåˆ¶è¦æ±‚</strong>ï¼šåºŸå¼ƒæ‰€æœ‰æ¨¡å—çº§å…¨å±€å•ä¾‹å˜é‡ã€‚</p>
<p><strong>åºŸå¼ƒæ¨¡å¼</strong>ï¼ˆä¸å†ä½¿ç”¨ï¼‰ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># âŒ æ—§ä»£ç  - artifact_ops.py</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">_artifact_store</span> <span class="o">=</span> <span class="n">ArtifactStore</span><span class="p">()</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_artifact_store</span><span class="p">():</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="k">return</span> <span class="n">_artifact_store</span>
</code></pre></div></p>
<p><strong>æ–°æ¨¡å¼</strong>ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># âœ… æ–°ä»£ç  - é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ArtifactManager</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">:</span> <span class="n">ArtifactRepository</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># å®ä¾‹çº§ç¼“å­˜</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1"># âœ… API å±‚ä½¿ç”¨ FastAPI Depends</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_artifact_manager</span><span class="p">(</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">)</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArtifactManager</span><span class="p">:</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">ArtifactRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="k">return</span> <span class="n">ArtifactManager</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>ç›®çš„</strong>ï¼š
- ç¡®ä¿å†…å­˜ä¸­ä¸æ®‹ç•™ç”¨æˆ·çŠ¶æ€
- æ”¯æŒå®¹å™¨åŒ–æ°´å¹³æ‰©å±• (Horizontal Scaling)
- ä¾¿äºå•å…ƒæµ‹è¯•ï¼ˆå¯æ³¨å…¥ Mockï¼‰</p>
<h3 id="32-orm">3.2 ORM è§„èŒƒ</h3>
<p><strong>å¼ºåˆ¶è¦æ±‚</strong>ï¼šæ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»é€šè¿‡ SQLAlchemy ORM æ¨¡å‹è¿›è¡Œï¼Œç¦æ­¢åŸç”Ÿ SQLã€‚</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># âŒ ç¦æ­¢</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM conversations WHERE id = :id&quot;</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">conv_id</span><span class="p">})</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># âœ… å¿…é¡»ä½¿ç”¨ ORM</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">select</span><span class="p">(</span><span class="n">Conversation</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Conversation</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">conv_id</span><span class="p">)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="p">)</span>
</code></pre></div>
<p><strong>ç›®çš„</strong>ï¼šç¡®ä¿ä» SQLite è¿ç§»åˆ° PostgreSQL æ—¶åªéœ€æ›´æ”¹è¿æ¥å­—ç¬¦ä¸²ï¼Œæ— éœ€é‡å†™æŸ¥è¯¢é€»è¾‘ã€‚</p>
<hr />
<h2 id="4-schema">4. æ•°æ®åº“ Schema è®¾è®¡</h2>
<h3 id="41">4.1 æ ¸å¿ƒåŸåˆ™</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>â”‚                      å…³ç³»è®¾è®¡åŸåˆ™                            â”‚
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>â”‚                                                             â”‚
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>â”‚  Conversation â—„â”€â”€1:1â”€â”€â–º ArtifactSession                    â”‚
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>â”‚       â”‚                        â”‚                            â”‚
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>â”‚       â”‚ 1:N                    â”‚ 1:N                        â”‚
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>â”‚       â–¼                        â–¼                            â”‚
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>â”‚   Messages                 Artifacts                        â”‚
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>â”‚       â”‚                        â”‚                            â”‚
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>â”‚       â”‚ tree structure         â”‚ 1:N                        â”‚
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>â”‚       â–¼                        â–¼                            â”‚
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>â”‚   (parent_id)           ArtifactVersions                    â”‚
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<h3 id="42">4.2 è¡¨ç»“æ„è®¾è®¡</h3>
<h4 id="1-conversations">è¡¨1: <code>conversations</code></h4>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>TEXT PRIMARY KEY</td>
<td>conversation_idï¼ŒåŒæ—¶ä¹Ÿæ˜¯å…³è”çš„ session_id</td>
</tr>
<tr>
<td>active_branch</td>
<td>TEXT</td>
<td>å½“å‰æ´»è·ƒçš„å¶å­èŠ‚ç‚¹ message_id</td>
</tr>
<tr>
<td>created_at</td>
<td>TIMESTAMP</td>
<td>åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>updated_at</td>
<td>TIMESTAMP</td>
<td>æœ€åæ›´æ–°æ—¶é—´</td>
</tr>
<tr>
<td>user_id</td>
<td>TEXT NULLABLE</td>
<td>é¢„ç•™ï¼šç”¨æˆ·IDï¼ˆPhase 2ï¼‰</td>
</tr>
<tr>
<td>title</td>
<td>TEXT NULLABLE</td>
<td>å¯¹è¯æ ‡é¢˜ï¼ˆå¯ç”±é¦–æ¡æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆï¼‰</td>
</tr>
<tr>
<td>metadata</td>
<td>JSON</td>
<td>æ‰©å±•å…ƒæ•°æ®</td>
</tr>
</tbody>
</table>
<h4 id="2-messages">è¡¨2: <code>messages</code></h4>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>TEXT PRIMARY KEY</td>
<td>message_id</td>
</tr>
<tr>
<td>conversation_id</td>
<td>TEXT FK</td>
<td>æ‰€å±å¯¹è¯</td>
</tr>
<tr>
<td>parent_id</td>
<td>TEXT NULLABLE</td>
<td>çˆ¶æ¶ˆæ¯IDï¼ˆå®ç°æ ‘ç»“æ„ï¼‰</td>
</tr>
<tr>
<td>content</td>
<td>TEXT</td>
<td>ç”¨æˆ·æ¶ˆæ¯å†…å®¹</td>
</tr>
<tr>
<td>thread_id</td>
<td>TEXT</td>
<td>å…³è”çš„ LangGraph çº¿ç¨‹ID</td>
</tr>
<tr>
<td>graph_response</td>
<td>TEXT NULLABLE</td>
<td>Graph æœ€ç»ˆå“åº”</td>
</tr>
<tr>
<td>created_at</td>
<td>TIMESTAMP</td>
<td>åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>metadata</td>
<td>JSON</td>
<td>æ‰©å±•å…ƒæ•°æ®ï¼ˆå¯å­˜å‚¨ç®€åŒ–çš„æ‰§è¡Œæ‘˜è¦ï¼‰</td>
</tr>
</tbody>
</table>
<h4 id="3-artifact_sessions">è¡¨3: <code>artifact_sessions</code></h4>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>TEXT PRIMARY KEY</td>
<td>session_idï¼ˆä¸ conversation_id ç›¸åŒï¼‰</td>
</tr>
<tr>
<td>created_at</td>
<td>TIMESTAMP</td>
<td>åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>updated_at</td>
<td>TIMESTAMP</td>
<td>æœ€åæ›´æ–°æ—¶é—´</td>
</tr>
</tbody>
</table>
<h4 id="4-artifacts">è¡¨4: <code>artifacts</code> ğŸ†• å¢åŠ ä¹è§‚é”å­—æ®µ</h4>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>TEXT</td>
<td>artifact_id</td>
</tr>
<tr>
<td>session_id</td>
<td>TEXT FK</td>
<td>æ‰€å±ä¼šè¯</td>
</tr>
<tr>
<td>content_type</td>
<td>TEXT</td>
<td>å†…å®¹ç±»å‹ (markdown/python/etc)</td>
</tr>
<tr>
<td>title</td>
<td>TEXT</td>
<td>æ ‡é¢˜</td>
</tr>
<tr>
<td>content</td>
<td>TEXT</td>
<td>ğŸ†• å½“å‰å†…å®¹ï¼ˆå†—ä½™å­˜å‚¨ï¼Œé¿å…æ¯æ¬¡æŸ¥ç‰ˆæœ¬è¡¨ï¼‰</td>
</tr>
<tr>
<td>current_version</td>
<td>INTEGER</td>
<td>å½“å‰ç‰ˆæœ¬å·</td>
</tr>
<tr>
<td><strong>lock_version</strong></td>
<td><strong>INTEGER DEFAULT 1</strong></td>
<td>ğŸ†• <strong>ä¹è§‚é”ç‰ˆæœ¬å·</strong></td>
</tr>
<tr>
<td>created_at</td>
<td>TIMESTAMP</td>
<td>åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>updated_at</td>
<td>TIMESTAMP</td>
<td>æœ€åæ›´æ–°æ—¶é—´</td>
</tr>
<tr>
<td>metadata</td>
<td>JSON</td>
<td>æ‰©å±•å…ƒæ•°æ®</td>
</tr>
<tr>
<td>PRIMARY KEY (id, session_id)</td>
<td></td>
<td>å¤åˆä¸»é”®</td>
</tr>
</tbody>
</table>
<h4 id="5-artifact_versions">è¡¨5: <code>artifact_versions</code></h4>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>INTEGER PRIMARY KEY AUTOINCREMENT</td>
<td>è‡ªå¢ID</td>
</tr>
<tr>
<td>artifact_id</td>
<td>TEXT</td>
<td>æ‰€å± artifact</td>
</tr>
<tr>
<td>session_id</td>
<td>TEXT</td>
<td>æ‰€å±ä¼šè¯</td>
</tr>
<tr>
<td>version</td>
<td>INTEGER</td>
<td>ç‰ˆæœ¬å·</td>
</tr>
<tr>
<td>content</td>
<td>TEXT</td>
<td>ç‰ˆæœ¬å†…å®¹</td>
</tr>
<tr>
<td>update_type</td>
<td>TEXT</td>
<td>æ›´æ–°ç±»å‹ (create/update/rewrite)</td>
</tr>
<tr>
<td>changes</td>
<td>JSON NULLABLE</td>
<td>å˜æ›´è®°å½• [(old, new), ...]</td>
</tr>
<tr>
<td>created_at</td>
<td>TIMESTAMP</td>
<td>åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>UNIQUE (artifact_id, session_id, version)</td>
<td></td>
<td>å”¯ä¸€çº¦æŸ</td>
</tr>
</tbody>
</table>
<h3 id="43">4.3 ğŸ†• ä¹è§‚é”æœºåˆ¶</h3>
<p><strong>å®ç°æ–¹å¼</strong>ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ArtifactRepository</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_artifact</span><span class="p">(</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="n">artifact_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        <span class="n">expected_lock_version</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Artifact</span><span class="p">:</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="sd">        æ›´æ–° Artifact å†…å®¹ï¼ˆå¸¦ä¹è§‚é”ï¼‰</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="sd">        Raises:</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="sd">            VersionConflictError: ç‰ˆæœ¬å†²çªæ—¶æŠ›å‡º</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>            <span class="n">update</span><span class="p">(</span><span class="n">Artifact</span><span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>            <span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>                <span class="n">Artifact</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">artifact_id</span><span class="p">,</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>                <span class="n">Artifact</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">session_id</span><span class="p">,</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>                <span class="n">Artifact</span><span class="o">.</span><span class="n">lock_version</span> <span class="o">==</span> <span class="n">expected_lock_version</span>  <span class="c1"># ä¹è§‚é”æ£€æŸ¥</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="p">)</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>            <span class="o">.</span><span class="n">values</span><span class="p">(</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>                <span class="n">current_version</span><span class="o">=</span><span class="n">Artifact</span><span class="o">.</span><span class="n">current_version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>                <span class="n">lock_version</span><span class="o">=</span><span class="n">Artifact</span><span class="o">.</span><span class="n">lock_version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># é€’å¢é”ç‰ˆæœ¬</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>                <span class="n">updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>            <span class="p">)</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>        <span class="p">)</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>            <span class="k">raise</span> <span class="n">VersionConflictError</span><span class="p">(</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>                <span class="sa">f</span><span class="s2">&quot;Artifact </span><span class="si">{</span><span class="n">artifact_id</span><span class="si">}</span><span class="s2"> has been modified by another process&quot;</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>            <span class="p">)</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_artifact</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">artifact_id</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>å†²çªå¤„ç†ç­–ç•¥</strong>ï¼š
- Agent å·¥å…·è°ƒç”¨å¤±è´¥æ—¶ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯è®© Agent å†³å®šé‡è¯•æˆ–è¯»å–æœ€æ–°ç‰ˆ
- å‰ç«¯å¯å±•ç¤ºå†²çªæç¤ºï¼Œè®©ç”¨æˆ·é€‰æ‹©ä¿ç•™å“ªä¸ªç‰ˆæœ¬</p>
<hr />
<h2 id="5-langgraph-checkpointer">5. ğŸ†• LangGraph Checkpointer é…ç½®</h2>
<h3 id="51-memorysaver">5.1 æ›¿æ¢ MemorySaver</h3>
<p><strong>å½“å‰ä»£ç </strong>ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># graph.py</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">if</span> <span class="n">checkpointer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>  <span class="c1"># âŒ å†…å­˜å­˜å‚¨ï¼Œé‡å¯ä¸¢å¤±</span>
</code></pre></div></p>
<p><strong>æ”¹é€ å</strong>ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># graph.py</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.sqlite.aio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSqliteSaver</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/artifactflow.db&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="k">if</span> <span class="n">checkpointer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="c1"># âœ… ä½¿ç”¨ SQLite æŒä¹…åŒ–ï¼Œä¸ App DB å…±äº«åŒä¸€æ–‡ä»¶</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">AsyncSqliteSaver</span><span class="o">.</span><span class="n">from_conn_string</span><span class="p">(</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>            <span class="sa">f</span><span class="s2">&quot;sqlite+aiosqlite:///</span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="p">)</span>
</code></pre></div></p>
<h3 id="52">5.2 é…ç½®å»ºè®®</h3>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>æ¨èå€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®åº“æ–‡ä»¶</td>
<td><code>data/artifactflow.db</code></td>
<td>ä¸ App DB å…±äº«ï¼Œç®€åŒ–éƒ¨ç½²</td>
</tr>
<tr>
<td>è¿æ¥æ± å¤§å°</td>
<td>5</td>
<td>SQLite æœ‰å†™é”é™åˆ¶ï¼Œä¸å®œè¿‡å¤§</td>
</tr>
<tr>
<td>WAL æ¨¡å¼</td>
<td>å¯ç”¨</td>
<td>æé«˜å¹¶å‘è¯»æ€§èƒ½</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># database.py</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="s2">&quot;sqlite+aiosqlite:///data/artifactflow.db&quot;</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="n">pool_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;check_same_thread&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="c1"># å¯ç”¨ WAL æ¨¡å¼</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">sync_engine</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">)</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_sqlite_pragma</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA journal_mode=WAL&quot;</span><span class="p">)</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="6">6. æ¶æ„è®¾è®¡</h2>
<h3 id="61">6.1 åˆ†å±‚æ¶æ„</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>â”‚                     Application Layer                        â”‚
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>â”‚         (ExecutionController, Agents, Tools)                â”‚
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>                              â”‚
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>                              â–¼
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>â”‚                     Manager Layer (æ”¹é€ é‡ç‚¹)                 â”‚
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>â”‚   â”‚ ConversationManager â”‚   â”‚    ArtifactManager      â”‚    â”‚
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>â”‚   â”‚  - å†…å­˜ç¼“å­˜çƒ­æ•°æ®     â”‚   â”‚  - å†…å­˜ç¼“å­˜çƒ­æ•°æ®        â”‚    â”‚
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>â”‚   â”‚  - è°ƒç”¨ Repository    â”‚   â”‚  - è°ƒç”¨ Repository       â”‚    â”‚
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>â”‚   â”‚  - ğŸ†• ä¾èµ–æ³¨å…¥        â”‚   â”‚  - ğŸ†• ä¾èµ–æ³¨å…¥           â”‚    â”‚
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>                              â”‚
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                              â–¼
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>â”‚                    Repository Layer (æ–°å¢)                   â”‚
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>â”‚   â”‚ConversationRepositoryâ”‚   â”‚  ArtifactRepository    â”‚    â”‚
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>â”‚   â”‚  - CRUD æ“ä½œ         â”‚   â”‚  - CRUD æ“ä½œ            â”‚    â”‚
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>â”‚   â”‚  - æ ‘ç»“æ„æŸ¥è¯¢        â”‚   â”‚  - ç‰ˆæœ¬ç®¡ç†             â”‚    â”‚
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>â”‚   â”‚  - ğŸ†• ORM Only       â”‚   â”‚  - ğŸ†• ä¹è§‚é”            â”‚    â”‚
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>                              â”‚
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>                              â–¼
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>â”‚                     Database Layer (æ–°å¢)                    â”‚
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>â”‚   â”‚                   DatabaseManager                    â”‚  â”‚
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>â”‚   â”‚  - è¿æ¥æ± ç®¡ç†                                        â”‚  â”‚
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>â”‚   â”‚  - äº‹åŠ¡ç®¡ç†                                          â”‚  â”‚
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>â”‚   â”‚  - ğŸ†• WAL æ¨¡å¼                                       â”‚  â”‚
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>â”‚                           â”‚                                  â”‚
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>â”‚              â–¼                         â–¼                    â”‚
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>â”‚     App DB (SQLite)          LangGraph Checkpointer        â”‚
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>â”‚     (conversations,          (AsyncSqliteSaver)            â”‚
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>â”‚      messages, artifacts)    (thread states)               â”‚
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<h3 id="62">6.2 ç¼“å­˜ç­–ç•¥</h3>
<p><strong>çƒ­æ•°æ®å®šä¹‰</strong>ï¼š
- å½“å‰æ´»è·ƒçš„ Conversationï¼ˆæœ€è¿‘è®¿é—®çš„ N ä¸ªï¼‰
- å½“å‰æ´»è·ƒçš„ ArtifactSession
- æœ€è¿‘ä¿®æ”¹çš„ Artifact å†…å®¹</p>
<p><strong>ç¼“å­˜å¤±æ•ˆç­–ç•¥</strong>ï¼š
- LRU æ·˜æ±°ï¼šç¼“å­˜å®¹é‡è¾¾åˆ°é˜ˆå€¼æ—¶æ·˜æ±°æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®
- å†™ç©¿é€ï¼šå†™æ“ä½œåŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
- å»¶è¿ŸåŠ è½½ï¼šé¦–æ¬¡è®¿é—®æ—¶ä»æ•°æ®åº“åŠ è½½åˆ°ç¼“å­˜</p>
<hr />
<h2 id="7">7. æ–‡ä»¶ç»“æ„è§„åˆ’</h2>
<h3 id="71">7.1 æ–°å¢æ–‡ä»¶</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>src/
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>â”œâ”€â”€ db/                          # æ–°å¢ï¼šæ•°æ®åº“å±‚
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>â”‚   â”œâ”€â”€ __init__.py
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>â”‚   â”œâ”€â”€ database.py              # DatabaseManagerï¼šè¿æ¥æ± ã€äº‹åŠ¡ç®¡ç†
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>â”‚   â”œâ”€â”€ models.py                # SQLAlchemy ORM æ¨¡å‹å®šä¹‰
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>â”‚   â””â”€â”€ migrations/              # æ•°æ®åº“è¿ç§»è„šæœ¬
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>â”‚       â”œâ”€â”€ __init__.py
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>â”‚       â””â”€â”€ versions/
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>â”‚           â””â”€â”€ 001_initial_schema.py
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>â”‚
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>â”œâ”€â”€ repositories/                # æ–°å¢ï¼šæ•°æ®è®¿é—®å±‚
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>â”‚   â”œâ”€â”€ __init__.py
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>â”‚   â”œâ”€â”€ base.py                  # BaseRepository æŠ½è±¡ç±»
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>â”‚   â”œâ”€â”€ conversation_repo.py     # ConversationRepository
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>â”‚   â””â”€â”€ artifact_repo.py         # ArtifactRepository
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>â”‚
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>â”œâ”€â”€ core/
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>â”‚   â”œâ”€â”€ conversation_manager.py  # æ”¹é€ ï¼šä» controller.py åˆ†ç¦»
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>â”‚   â””â”€â”€ ... (å…¶ä»–æ–‡ä»¶)
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>â”‚
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>â””â”€â”€ tools/implementations/
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    â””â”€â”€ artifact_ops.py          # æ”¹é€ ï¼šArtifactStore â†’ ArtifactManager
</code></pre></div>
<h3 id="72">7.2 æ”¹é€ æ–‡ä»¶</h3>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>æ”¹é€ å†…å®¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>controller.py</code></td>
<td>å°† <code>ConversationManager</code> ç±»ç§»å‡ºåˆ°ç‹¬ç«‹æ–‡ä»¶ï¼Œæ”¹ä¸ºä½¿ç”¨ Repository</td>
</tr>
<tr>
<td><code>artifact_ops.py</code></td>
<td>å°† <code>ArtifactStore</code> æ”¹é€ ä¸º <code>ArtifactManager</code>ï¼Œåº•å±‚ä½¿ç”¨ Repositoryï¼ŒğŸ†• ç§»é™¤å…¨å±€å•ä¾‹</td>
</tr>
<tr>
<td><code>graph.py</code></td>
<td>ğŸ†• æ›´æ–° Checkpointer ä¸º AsyncSqliteSaver</td>
</tr>
<tr>
<td><code>requirements.txt</code></td>
<td>æ·»åŠ  <code>sqlalchemy&gt;=2.0</code>, <code>aiosqlite</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8">8. æ ¸å¿ƒç±»è®¾è®¡è¦ç‚¹</h2>
<h3 id="81-databasemanager">8.1 DatabaseManager</h3>
<p><strong>èŒè´£</strong>ï¼š
- ç®¡ç†æ•°æ®åº“è¿æ¥ï¼ˆæ”¯æŒå¼‚æ­¥ï¼‰
- æä¾›äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- åˆå§‹åŒ–æ•°æ®åº“ schema
- ğŸ†• é…ç½® WAL æ¨¡å¼</p>
<p><strong>è®¾è®¡è¦ç‚¹</strong>ï¼š
- ä½¿ç”¨ <code>aiosqlite</code> å®ç°å¼‚æ­¥ SQLite è®¿é—®
- æä¾›åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ¥å£ï¼ˆå…¼å®¹ç°æœ‰ä»£ç ï¼‰
- æ•°æ®åº“è·¯å¾„å¯é…ç½®ï¼ˆé»˜è®¤ <code>data/artifactflow.db</code>ï¼‰</p>
<h3 id="82-conversationrepository">8.2 ConversationRepository</h3>
<p><strong>èŒè´£</strong>ï¼š
- Conversation CRUD
- Message CRUD
- æ ‘ç»“æ„æŸ¥è¯¢ï¼ˆè·å–ä»æ ¹åˆ°æŒ‡å®šèŠ‚ç‚¹çš„è·¯å¾„ï¼‰</p>
<p><strong>å…³é”®æ–¹æ³•</strong>ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="o">-</span> <span class="n">create_conversation</span><span class="p">(</span><span class="n">conv_id</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Conversation</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="o">-</span> <span class="n">get_conversation</span><span class="p">(</span><span class="n">conv_id</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Conversation</span><span class="p">]</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="o">-</span> <span class="n">add_message</span><span class="p">(</span><span class="n">conv_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Message</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="o">-</span> <span class="n">get_message_path</span><span class="p">(</span><span class="n">conv_id</span><span class="p">,</span> <span class="n">to_message_id</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="o">-</span> <span class="n">update_response</span><span class="p">(</span><span class="n">conv_id</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="o">-</span> <span class="n">list_conversations</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">List</span><span class="p">[</span><span class="n">Conversation</span><span class="p">]</span>
</code></pre></div></p>
<h3 id="83-artifactrepository">8.3 ArtifactRepository</h3>
<p><strong>èŒè´£</strong>ï¼š
- ArtifactSession CRUD
- Artifact CRUD
- ç‰ˆæœ¬ç®¡ç†
- ğŸ†• ä¹è§‚é”å¹¶å‘æ§åˆ¶</p>
<p><strong>å…³é”®æ–¹æ³•</strong>ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="o">-</span> <span class="n">create_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">ArtifactSession</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="o">-</span> <span class="n">get_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArtifactSession</span><span class="p">]</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="o">-</span> <span class="n">create_artifact</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">artifact_data</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Artifact</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="o">-</span> <span class="n">get_artifact</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">artifact_id</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Artifact</span><span class="p">]</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="o">-</span> <span class="n">update_artifact</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">artifact_id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">expected_lock_version</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Artifact</span>  <span class="c1"># ğŸ†• ä¹è§‚é”</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="o">-</span> <span class="n">save_version</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">artifact_id</span><span class="p">,</span> <span class="n">version_data</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">ArtifactVersion</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="o">-</span> <span class="n">get_version</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">artifact_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArtifactVersion</span><span class="p">]</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="o">-</span> <span class="n">list_artifacts</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span> <span class="err">â†’</span> <span class="n">List</span><span class="p">[</span><span class="n">Artifact</span><span class="p">]</span>
</code></pre></div></p>
<h3 id="84-conversationmanager">8.4 ConversationManagerï¼ˆæ”¹é€ ï¼‰</h3>
<p><strong>æ”¹é€ è¦ç‚¹</strong>ï¼š
- ä¿æŒç°æœ‰ API ä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰
- å†…éƒ¨å¢åŠ  <code>ConversationRepository</code> ä¾èµ–
- å¢åŠ å†…å­˜ç¼“å­˜å±‚ï¼ˆ<code>Dict[str, Conversation]</code>ï¼‰
- å†™æ“ä½œï¼šåŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
- è¯»æ“ä½œï¼šä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼Œmiss æ—¶ä»æ•°æ®åº“åŠ è½½
- ğŸ†• <strong>é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼Œä¸ä½¿ç”¨å…¨å±€å•ä¾‹</strong></p>
<p><strong>ç¼“å­˜ç®¡ç†</strong>ï¼š
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>- æœ€å¤§ç¼“å­˜ conversation æ•°é‡ï¼š100ï¼ˆå¯é…ç½®ï¼‰
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>- æ·˜æ±°ç­–ç•¥ï¼šLRU
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>- æä¾› `load_conversation(conv_id)` æ–¹æ³•æ˜¾å¼åŠ è½½åˆ°ç¼“å­˜
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>- æä¾› `evict_conversation(conv_id)` æ–¹æ³•æ‰‹åŠ¨æ·˜æ±°
</code></pre></div></p>
<h3 id="85-artifactmanager-artifactstore">8.5 ArtifactManagerï¼ˆåŸ ArtifactStore æ”¹é€ ï¼‰</h3>
<p><strong>æ”¹é€ è¦ç‚¹</strong>ï¼š
- ä¿æŒç°æœ‰å·¥å…·è°ƒç”¨ API ä¸å˜
- å†…éƒ¨å¢åŠ  <code>ArtifactRepository</code> ä¾èµ–
- å¢åŠ å†…å­˜ç¼“å­˜ï¼ˆå½“å‰æ´»è·ƒ session çš„ artifactsï¼‰
- <code>Artifact.update()</code> ä¸­çš„ diff-match-patch é€»è¾‘ä¿æŒä¸å˜
- ç‰ˆæœ¬ä¿å­˜æ—¶åŒæ­¥å†™å…¥æ•°æ®åº“
- ğŸ†• <strong>é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼Œä¸ä½¿ç”¨å…¨å±€å•ä¾‹</strong>
- ğŸ†• <strong>æ›´æ–°æ“ä½œä½¿ç”¨ä¹è§‚é”</strong></p>
<hr />
<h2 id="9">9. å®æ–½æ­¥éª¤</h2>
<h3 id="phase-1-2-3">Phase 1: åŸºç¡€è®¾æ–½ï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰</h3>
<ol>
<li><strong>åˆ›å»º <code>db/</code> æ¨¡å—</strong></li>
<li>å®ç° <code>DatabaseManager</code>ï¼ˆå« WAL é…ç½®ï¼‰</li>
<li>ç¼–å†™ SQLAlchemy ORM æ¨¡å‹ï¼ˆå« <code>lock_version</code> å­—æ®µï¼‰</li>
<li>ç¼–å†™åˆå§‹åŒ– migration</li>
<li>
<p>ğŸ†• é…ç½® AsyncSqliteSaver ä¸ App DB å…±äº«</p>
</li>
<li>
<p><strong>åˆ›å»º <code>repositories/</code> æ¨¡å—</strong></p>
</li>
<li>å®ç° <code>BaseRepository</code></li>
<li>å®ç° <code>ConversationRepository</code></li>
<li>
<p>å®ç° <code>ArtifactRepository</code>ï¼ˆå«ä¹è§‚é”ï¼‰</p>
</li>
<li>
<p><strong>ç¼–å†™å•å…ƒæµ‹è¯•</strong></p>
</li>
<li>Repository å±‚çš„ CRUD æµ‹è¯•</li>
<li>æ ‘ç»“æ„æŸ¥è¯¢æµ‹è¯•</li>
<li>ğŸ†• ä¹è§‚é”å†²çªæµ‹è¯•</li>
</ol>
<h3 id="phase-2-manager-2-3">Phase 2: Manager å±‚æ”¹é€ ï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰</h3>
<ol>
<li><strong>åˆ†ç¦» ConversationManager</strong></li>
<li>ä» <code>controller.py</code> ç§»å‡ºåˆ°ç‹¬ç«‹æ–‡ä»¶</li>
<li>æ·»åŠ  Repository ä¾èµ–æ³¨å…¥</li>
<li>å®ç°ç¼“å­˜é€»è¾‘</li>
<li>
<p>ğŸ†• ç§»é™¤å…¨å±€å•ä¾‹æ¨¡å¼</p>
</li>
<li>
<p><strong>æ”¹é€  ArtifactStore â†’ ArtifactManager</strong></p>
</li>
<li>é‡æ„ä¸ºä½¿ç”¨ Repository</li>
<li>ä¿æŒ <code>Artifact</code> ç±»çš„æ ¸å¿ƒé€»è¾‘ä¸å˜</li>
<li>å®ç°ç¼“å­˜é€»è¾‘</li>
<li>ğŸ†• ç§»é™¤å…¨å±€å•ä¾‹ <code>_artifact_store</code></li>
<li>
<p>ğŸ†• é›†æˆä¹è§‚é”</p>
</li>
<li>
<p><strong>æ›´æ–°ä¾èµ–æ–¹</strong></p>
</li>
<li><code>controller.py</code> ä½¿ç”¨æ–°çš„ ConversationManager</li>
<li><code>graph.py</code> ä½¿ç”¨æ–°çš„ ArtifactManager</li>
<li>
<p>ğŸ†• <code>graph.py</code> æ›¿æ¢ MemorySaver ä¸º AsyncSqliteSaver</p>
</li>
<li>
<p><strong>é›†æˆæµ‹è¯•</strong></p>
</li>
<li>è¿è¡Œç°æœ‰çš„ <code>core_graph_test.py</code> ç¡®ä¿åŠŸèƒ½æ­£å¸¸</li>
<li>æ·»åŠ æŒä¹…åŒ–ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹</li>
</ol>
<h3 id="phase-3-1-2">Phase 3: ä¼˜åŒ–å’Œæ¸…ç†ï¼ˆé¢„è®¡ 1-2 å¤©ï¼‰</h3>
<ol>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong></li>
<li>æ·»åŠ æ•°æ®åº“ç´¢å¼•</li>
<li>
<p>ä¼˜åŒ–æ‰¹é‡æŸ¥è¯¢</p>
</li>
<li>
<p><strong>é…ç½®å¤–éƒ¨åŒ–</strong></p>
</li>
<li>æ•°æ®åº“è·¯å¾„é…ç½®</li>
<li>
<p>ç¼“å­˜å¤§å°é…ç½®</p>
</li>
<li>
<p><strong>æ¸…ç†å·¥ä½œ</strong></p>
</li>
<li>ç§»é™¤æ—§çš„å†…å­˜å­˜å‚¨ä»£ç </li>
<li>æ›´æ–°æ–‡æ¡£</li>
</ol>
<hr />
<h2 id="10">10. åç»­æ‰©å±•é¢„ç•™</h2>
<h3 id="101-phase-2">10.1 ç”¨æˆ·ç³»ç»Ÿï¼ˆPhase 2ï¼‰</h3>
<p><strong>é¢„ç•™è®¾è®¡</strong>ï¼š
- <code>conversations</code> è¡¨çš„ <code>user_id</code> å­—æ®µ
- <code>artifact_sessions</code> è¡¨æ·»åŠ  <code>user_id</code> å­—æ®µ
- Repository æ–¹æ³•æ”¯æŒ <code>user_id</code> è¿‡æ»¤</p>
<p><strong>è¿ç§»è·¯å¾„</strong>ï¼š
1. æ·»åŠ  <code>users</code> è¡¨
2. ä¸ºç°æœ‰æ•°æ®æ·»åŠ é»˜è®¤ user_id
3. æ›´æ–° Repository æŸ¥è¯¢æ–¹æ³•
4. æ›´æ–° Manager å±‚ä¼ é€’ user_id</p>
<h3 id="102-postgresql">10.2 PostgreSQL è¿ç§»</h3>
<p><strong>é¢„ç•™è®¾è®¡</strong>ï¼š
- ä½¿ç”¨ SQLAlchemy ORMï¼ˆæ•°æ®åº“æ— å…³ï¼‰
- Repository å±‚æŠ½è±¡æ•°æ®åº“æ“ä½œ
- ä½¿ç”¨ Alembic ç®¡ç† migrations
- ğŸ†• ORM Only è§„èŒƒç¡®ä¿è¿ç§»æ— ç—›</p>
<p><strong>è¿ç§»è·¯å¾„</strong>ï¼š
1. ä¿®æ”¹ <code>DatabaseManager</code> è¿æ¥å­—ç¬¦ä¸²
2. è¿è¡Œ migration
3. æ•°æ®è¿ç§»è„šæœ¬</p>
<hr />
<h2 id="11">11. æ³¨æ„äº‹é¡¹</h2>
<h3 id="111">11.1 å¹¶å‘å®‰å…¨</h3>
<ul>
<li>SQLite åœ¨å†™å…¥æ—¶æœ‰é”ï¼Œéœ€è¦æ³¨æ„å¹¶å‘åœºæ™¯</li>
<li>å»ºè®®ä½¿ç”¨ WAL æ¨¡å¼æé«˜å¹¶å‘æ€§èƒ½</li>
<li>ğŸ†• ä½¿ç”¨ä¹è§‚é”å¤„ç† Artifact å¹¶å‘æ›´æ–°</li>
<li>å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œè€ƒè™‘ç›´æ¥ä½¿ç”¨ PostgreSQL</li>
</ul>
<h3 id="112">11.2 æ•°æ®ä¸€è‡´æ€§</h3>
<ul>
<li>ç¼“å­˜å’Œæ•°æ®åº“å¯èƒ½å‡ºç°ä¸ä¸€è‡´</li>
<li>å…³é”®å†™æ“ä½œä½¿ç”¨äº‹åŠ¡</li>
<li>æä¾›å¼ºåˆ¶åˆ·æ–°ç¼“å­˜çš„æ¥å£</li>
<li>ğŸ†• App DB æ˜¯çœŸç›¸æ¥æºï¼ŒLangGraph Checkpointer ä»…ç”¨äºæ‰§è¡Œ</li>
</ul>
<h3 id="113">11.3 å‘åå…¼å®¹</h3>
<ul>
<li>æ‰€æœ‰ public API ä¿æŒä¸å˜</li>
<li>ç°æœ‰æµ‹è¯•åº”è¯¥å…¨éƒ¨é€šè¿‡</li>
<li>é€šè¿‡ä¾èµ–æ³¨å…¥æ”¯æŒæµ‹è¯•æ—¶ä½¿ç”¨å†…å­˜æ•°æ®åº“</li>
</ul>
<hr />
<h2 id="12">12. ä¾èµ–æ¸…å•</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a># æ–°å¢ä¾èµ–
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>sqlalchemy&gt;=2.0.0
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>aiosqlite&gt;=0.19.0
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>alembic&gt;=1.12.0  # å¯é€‰ï¼šç”¨äºç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“è¿ç§»ç®¡ç†
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>langgraph-checkpoint-sqlite&gt;=1.0.0  # ğŸ†• LangGraph SQLite Checkpointer
</code></pre></div>
<hr />
<h2 id="_1">é™„å½•ï¼šæ¶æ„æ¼”è¿›è·¯çº¿å›¾</h2>
<ol>
<li><strong>Phase 1 (å½“å‰ç›®æ ‡)</strong>ï¼šå•æœº Docker + SQLite</li>
<li>å®ç°åŒå±‚å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±</li>
<li>å®ç°ä¹è§‚é”ï¼Œç¡®ä¿ Artifact æ•°æ®ä¸€è‡´</li>
<li>
<p>ä»£ç å…¨å¼‚æ­¥åŒ–ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥</p>
</li>
<li>
<p><strong>Phase 2 (å°‘é‡å¹¶å‘)</strong>ï¼šåˆ†ç¦»æ•°æ®åº“</p>
</li>
<li>SQLite â†’ PostgreSQL å®¹å™¨</li>
<li>
<p>åˆ©ç”¨ ORM ä¼˜åŠ¿å¹³æ»‘è¿ç§»</p>
</li>
<li>
<p><strong>Phase 3 (ç”Ÿäº§å¹¶å‘)</strong>ï¼šæ°´å¹³æ‰©å±•</p>
</li>
<li>Nginx è´Ÿè½½å‡è¡¡ + å¤šå®ä¾‹ API å®¹å™¨</li>
<li>å¼•å…¥ Redis åšåˆ†å¸ƒå¼ç¼“å­˜å’Œé”</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  å›åˆ°é¡µé¢é¡¶éƒ¨
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>